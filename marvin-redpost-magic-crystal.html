<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvin Redpost: A Magic Crystal? - Level 2-1 - ìˆ˜ë¦¬ë”©ì–´í•™ì›</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #9B59B6 0%, #E91E63 50%, #FF9800 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* í—¤ë” */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #9B59B6, #E91E63);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .logo-text p {
            font-size: 0.9rem;
            color: #666;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #333;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #9B59B6;
            color: white;
            transform: translateY(-2px);
        }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        /* ì±… ìƒì„¸ í™”ë©´ */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-size: 0.9rem;
            color: #666;
        }

        .breadcrumb a {
            color: #9B59B6;
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .book-detail-header {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        .detail-book-cover {
            width: 150px;
            height: 220px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
            font-weight: bold;
            flex-shrink: 0;
            background: linear-gradient(45deg, #9B59B6, #E91E63);
        }

        .book-info {
            flex: 1;
        }

        .book-info h2 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .book-info .author {
            font-size: 1.2rem;
            color: #9B59B6;
            margin-bottom: 20px;
        }

        .book-summary {
            font-size: 1rem;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .book-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #9B59B6;
        }

        .stat-box .label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* ì±•í„° ê·¸ë¦¬ë“œ */
        .chapters-section {
            margin-top: 40px;
        }

        .chapters-section h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .chapter-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .chapter-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .chapter-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a74508, #ffffff);
        }

        .chapter-card.current {
            border-color: #9B59B6;
            background: linear-gradient(135deg, #9B59B608, #ffffff);
        }

        .chapter-card.locked {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .chapter-info h4 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .chapter-info p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
        }

        .chapter-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .chapter-status.completed {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .chapter-status.current {
            background: rgba(155, 89, 182, 0.1);
            color: #9B59B6;
        }

        .chapter-status.locked {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .chapter-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .chapter-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .audio-btn {
            background: linear-gradient(45deg, #9B59B6, #E91E63);
            color: white;
        }

        .quiz-btn {
            background: linear-gradient(45deg, #E91E63, #FF9800);
            color: white;
        }

        .chapter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .chapter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* í•™ìŠµ í™”ë©´ */
        .learning-screen {
            display: none;
        }

        .learning-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .learning-progress {
            background: #f8f9fa;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .learning-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #9B59B6, #E91E63);
            transition: width 0.3s ease;
        }

        .question-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .passage {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.6;
            color: #444;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #9B59B6;
        }

        .option.selected {
            background: rgba(155, 89, 182, 0.1);
            border-color: #9B59B6;
        }

        .learning-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .next-btn {
            background: linear-gradient(45deg, #9B59B6, #E91E63);
            color: white;
        }

        .prev-btn {
            background: #6c757d;
            color: white;
        }

        .submit-btn {
            background: linear-gradient(45deg, #9B59B6, #E91E63);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ê²°ê³¼ í™”ë©´ */
        .result-screen {
            display: none;
            text-align: center;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9B59B6, #E91E63);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .result-stat {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ëª¨ë‹¬ */
        .audio-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .audio-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            position: relative;
        }

        .close-audio {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }

        .audio-player {
            width: 100%;
            margin: 20px 0;
            border-radius: 10px;
        }

        .audio-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .audio-control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-pause-btn {
            background: linear-gradient(45deg, #9B59B6, #E91E63);
            color: white;
        }

        .speed-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .download-btn {
            background: #E91E63;
            color: white;
        }

        .audio-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .audio-info.hidden {
            display: none;
        }

        /* Level 2-1 íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
        .level-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #9B59B6, #E91E63);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .chapters-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .book-detail-header {
                flex-direction: column;
                text-align: center;
            }

            .book-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .learning-controls {
                flex-direction: column;
            }

            .chapter-actions {
                grid-template-columns: 1fr;
            }

            .audio-controls {
                justify-content: center;
                gap: 10px;
            }

            .audio-content {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ’</div>
                <div class="logo-text">
                    <h1>A Magic Crystal?</h1>
                    <p>Level 2-1 - Marvin Redpost ì‹œë¦¬ì¦ˆ #8 by Louis Sachar</p>
                </div>
            </div>
            <div class="nav-buttons">
                <a href="http://www.suelibrary.store/" class="nav-btn">ë©”ì¸ìœ¼ë¡œ</a>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <!-- ì±… ìƒì„¸ í™”ë©´ -->
            <div class="book-detail-screen" id="book-detail-screen">
                <div class="level-badge">Level 2-1</div>
                <div class="breadcrumb">
                    <span>A Magic Crystal?</span>
                </div>

                <div class="book-detail-header">
                    <div class="detail-book-cover">ğŸ’</div>
                    <div class="book-info">
                        <h2>A Magic Crystal?</h2>
                        <div class="author">Louis Sachar - Marvin Redpost ì‹œë¦¬ì¦ˆ #8</div>
                        <div class="book-summary">
                            Marvin Redpost has a girlfriendâ€”not a real girlfriend, just a girl who is a friend. And Casey Happleton is no ordinary girl. She lives in an old firehouse and she has a magic crystal! She wants to share the crystal with Marvin. Could the crystal really be magic? Or is Casey putting her own spell on Marvin? This funny and touching final book in the Marvin Redpost series explores friendship, wishes, and what happens when magic seems too good to be true.
                        </div>
                        <div class="book-stats">
                            <div class="stat-box">
                                <div class="value">9</div>
                                <div class="label">ì±•í„°</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">27</div>
                                <div class="label">ì´ ë¬¸ì œ</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">Level 2-1</div>
                                <div class="label">ë ˆë²¨</div>
                            </div>
                            <div class="stat-box">
                                <div class="value" id="progress-value">0%</div>
                                <div class="label">ì§„ë„</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chapters-section">
                    <h3>ğŸ’ ì±•í„°ë³„ í•™ìŠµ</h3>
                    <div class="chapters-grid" id="chapters-grid">
                        <!-- ì±•í„° ì¹´ë“œë“¤ -->
                    </div>
                </div>
            </div>

            <!-- í•™ìŠµ í™”ë©´ -->
            <div class="learning-screen" id="learning-screen">
                <div class="breadcrumb">
                    <a onclick="showBookDetail()">A Magic Crystal?</a>
                    <span>></span>
                    <span id="learning-chapter-breadcrumb">Chapter 1</span>
                </div>

                <div class="learning-header">
                    <h2 id="learning-title">Chapter 1</h2>
                    <div class="learning-progress">
                        <div class="learning-progress-bar" id="learning-progress-bar" style="width: 0%"></div>
                    </div>
                    <p id="learning-progress-text">ë¬¸ì œ 1 / 3</p>
                </div>

                <div class="question-container" id="question-container">
                    <!-- ë¬¸ì œê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>

                <div class="learning-controls">
                    <button class="control-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>ì´ì „</button>
                    <button class="control-btn next-btn" id="next-btn" onclick="nextQuestion()">ë‹¤ìŒ</button>
                    <button class="control-btn submit-btn" id="submit-btn" onclick="submitAnswers()" style="display: none;">ì œì¶œ</button>
                </div>
            </div>

            <!-- ê²°ê³¼ í™”ë©´ -->
            <div class="result-screen" id="result-screen">
                <div class="breadcrumb">
                    <a onclick="showBookDetail()">A Magic Crystal?</a>
                    <span>></span>
                    <span>ê²°ê³¼</span>
                </div>

                <div class="result-header">
                    <h2>ğŸ‰ í•™ìŠµ ì™„ë£Œ!</h2>
                    <div class="score-circle" id="score-circle">100%</div>
                    <h3 id="result-message">í›Œë¥­í•©ë‹ˆë‹¤!</h3>
                </div>

                <div class="result-details">
                    <div class="result-stat">
                        <h4>ì´ ë¬¸ì œ</h4>
                        <p id="total-questions">3ë¬¸ì œ</p>
                    </div>
                    <div class="result-stat">
                        <h4>ì •ë‹µ</h4>
                        <p id="correct-answers">3ë¬¸ì œ</p>
                    </div>
                    <div class="result-stat">
                        <h4>ì˜¤ë‹µ</h4>
                        <p id="wrong-answers">0ë¬¸ì œ</p>
                    </div>
                    <div class="result-stat">
                        <h4>ì ìˆ˜</h4>
                        <p id="final-score">100ì </p>
                    </div>
                </div>

                <div class="result-actions">
                    <button class="control-btn prev-btn" onclick="retryChapter()">ë‹¤ì‹œ í’€ê¸°</button>
                    <button class="control-btn next-btn" onclick="nextChapter()">ë‹¤ìŒ ì±•í„°</button>
                    <button class="control-btn submit-btn" onclick="showBookDetail()">ì±•í„° ëª©ë¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ëª¨ë‹¬ -->
    <div class="audio-modal" id="audio-modal">
        <div class="audio-content">
            <button class="close-audio" onclick="closeAudioModal()">Ã—</button>
            <h3 id="audio-chapter-title">Chapter 1</h3>
            <p id="audio-chapter-subtitle">A Magic Crystal? - Louis Sachar</p>

            <audio class="audio-player" id="audio-player" controls preload="metadata">
                <source id="audio-source" src="" type="audio/mpeg">
                ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </audio>

            <div class="audio-controls">
                <button class="audio-control-btn play-pause-btn" onclick="togglePlayPause()">â–¶ï¸ ì¬ìƒ</button>
                <button class="audio-control-btn speed-btn" onclick="changeSpeed()">1.0x</button>
                <button class="audio-control-btn download-btn" onclick="downloadAudio()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div class="audio-info" id="audio-info">
                <div id="audio-status" style="margin-top: 10px; font-weight: bold; color: #9B59B6;"></div>
            </div>
        </div>
    </div>

    <script>
        // êµ¬ê¸€ í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ ì˜¤ë””ì˜¤ URL ì„¤ì •
        const AUDIO_BASE_URL = 'https://storage.googleapis.com/kim-mom-reading-audio/audio/';

        // A Magic Crystal ì±•í„°ë³„ ê°œë³„ íŒŒì¼ ë§¤í•‘
        const magicCrystalFileMapping = {
            0: '001.mp3',   // Chapter 1: Casey Happleton
            1: '002.mp3',   // Chapter 2: The Old Firehouse
            2: '003.mp3',   // Chapter 3: The Magic Crystal
            3: '004.mp3',   // Chapter 4: Making Wishes
            4: '005.mp3',   // Chapter 5: Too Many Wishes
            5: '006.mp3',   // Chapter 6: The Big Fight
            6: '007.mp3',   // Chapter 7: Casey Can't Talk
            7: '008.mp3',   // Chapter 8: Is It Really Magic?
            8: '009.mp3'    // Chapter 9: Friends Again
        };

        // ì˜¤ë””ì˜¤ URL ìƒì„± í•¨ìˆ˜
        function getAudioUrl(chapterIndex) {
            const fileName = magicCrystalFileMapping[chapterIndex];
            if (!fileName) {
                console.error(`No audio file mapping found for chapter ${chapterIndex}`);
                return {
                    primary: '',
                    alternatives: ['']
                };
            }
            return {
                primary: `${AUDIO_BASE_URL}MR008_Magic_Crystal/${fileName}`,
                alternatives: [`${AUDIO_BASE_URL}MR008_Magic_Crystal/${fileName}`]
            };
        }

        // ì˜¤ë””ì˜¤ ì¬ìƒ í•¨ìˆ˜
        function playChapterAudio(chapterIndex) {
            const chapter = bookData.chapterList[chapterIndex];
            const audioData = getAudioUrl(chapterIndex);

            console.log(`Playing audio for chapter ${chapterIndex + 1}`);
            console.log(`Audio URL: ${audioData.primary}`);

            document.getElementById('audio-modal').style.display = 'flex';
            document.getElementById('audio-chapter-title').textContent = `Chapter ${chapterIndex + 1}`;
            document.getElementById('audio-chapter-subtitle').textContent = `${bookData.title} - ${bookData.author}`;
            document.getElementById('audio-info').classList.remove('hidden');

            const audioPlayer = document.getElementById('audio-player');
            const audioSource = document.getElementById('audio-source');
            const audioStatus = document.getElementById('audio-status');

            audioStatus.textContent = 'ğŸ”„ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ë¡œë”© ì¤‘...';

            // Check if we have a valid URL
            if (!audioData.primary) {
                audioStatus.innerHTML = `âŒ ì±•í„° ${chapterIndex + 1}ì˜ ì˜¤ë””ì˜¤ íŒŒì¼ ë§¤í•‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                return;
            }

            audioSource.src = audioData.primary;
            audioPlayer.load();

            const successHandler = function() {
                audioStatus.textContent = `âœ… Chapter ${chapterIndex + 1} ë¡œë“œ ì™„ë£Œ!`;
                console.log(`Audio loaded successfully: ${audioData.primary}`);
                
                audioPlayer.play().then(() => {
                    audioStatus.textContent = `ğŸµ Chapter ${chapterIndex + 1} ì¬ìƒ ì¤‘!`;
                    document.querySelector('.play-pause-btn').textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                }).catch(e => {
                    console.log('ìë™ ì¬ìƒ ì°¨ë‹¨ë¨:', e);
                    audioStatus.textContent = `âœ… Chapter ${chapterIndex + 1} ì¤€ë¹„ë¨! â–¶ï¸ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”`;
                });
            };

            const errorHandler = function() {
                console.error(`Audio failed to load: ${audioData.primary}`);
                audioStatus.innerHTML = `âŒ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>íŒŒì¼: ${magicCrystalFileMapping[chapterIndex]}<br>URL: ${audioData.primary}`;
            };

            audioPlayer.addEventListener('canplaythrough', successHandler, { once: true });
            audioPlayer.addEventListener('error', errorHandler, { once: true });

            currentAudio = audioPlayer;
            playbackSpeed = 1.0;
        }

        // ì „ì—­ ë³€ìˆ˜
        let currentChapterIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questions = [];
        let currentAudio = null;
        let playbackSpeed = 1.0;

        // ê¸°ë³¸ ì˜¤ë””ì˜¤ ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤
        function closeAudioModal() {
            document.getElementById('audio-modal').style.display = 'none';
            if (currentAudio) currentAudio.pause();
        }

        function togglePlayPause() {
            if (!currentAudio) return;
            if (currentAudio.paused) {
                currentAudio.play();
                document.querySelector('.play-pause-btn').textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
            } else {
                currentAudio.pause();
                document.querySelector('.play-pause-btn').textContent = 'â–¶ï¸ ì¬ìƒ';
            }
        }

        function changeSpeed() {
            if (!currentAudio) return;
            const speeds = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
            const currentIndex = speeds.indexOf(playbackSpeed);
            playbackSpeed = speeds[(currentIndex + 1) % speeds.length];
            currentAudio.playbackRate = playbackSpeed;
            document.querySelector('.speed-btn').textContent = `${playbackSpeed}x`;
        }

        function downloadAudio() {
            const audioSource = document.getElementById('audio-source');
            if (audioSource.src) {
                const link = document.createElement('a');
                link.href = audioSource.src;
                link.download = `${document.getElementById('audio-chapter-title').textContent}.mp3`;
                link.click();
            }
        }

        // A Magic Crystal? ë„ì„œ ë°ì´í„° (Level 2-1, 9ì±•í„°)
        const bookData = {
            id: 'MR008',
            title: "A Magic Crystal?",
            author: 'Louis Sachar',
            cover: 'ğŸ’',
            progress: 0,
            chapters: 9,
            totalQuestions: 27,
            coverColor: 'linear-gradient(45deg, #9B59B6, #E91E63)',
            summary: "Marvin Redpost has a girlfriendâ€”not a real girlfriend, just a girl who is a friend. And Casey Happleton is no ordinary girl. She lives in an old firehouse and she has a magic crystal! She wants to share the crystal with Marvin. Could the crystal really be magic? Or is Casey putting her own spell on Marvin?",
            chapterList: [
                { title: 'Chapter 1: Casey Happleton', description: 'Marvin meets Casey Happleton, who is not an ordinary girl.', status: 'current', questionCount: 3 },
                { title: 'Chapter 2: The Old Firehouse', description: 'Casey invites Marvin to her house, which is an old firehouse.', status: 'current', questionCount: 3 },
                { title: 'Chapter 3: The Magic Crystal', description: 'Casey shows Marvin her magic crystal that can grant wishes.', status: 'current', questionCount: 3 },
                { title: 'Chapter 4: Making Wishes', description: 'Marvin and Casey start making wishes with the crystal.', status: 'current', questionCount: 3 },
                { title: 'Chapter 5: Too Many Wishes', description: 'The friends get into trouble about how many wishes each should get.', status: 'current', questionCount: 3 },
                { title: 'Chapter 6: The Big Fight', description: 'Marvin and Casey have a big argument about the crystal.', status: 'current', questionCount: 3 },
                { title: 'Chapter 7: Casey Can\'t Talk', description: 'After Marvin wishes Casey would be quiet, she stops talking.', status: 'current', questionCount: 3 },
                { title: 'Chapter 8: Is It Really Magic?', description: 'Marvin wonders if the crystal is really magic or just coincidence.', status: 'current', questionCount: 3 },
                { title: 'Chapter 9: Friends Again', description: 'Marvin and Casey make up and learn about true friendship.', status: 'current', questionCount: 3 }
            ]
        };

        // ë¬¸ì œ ë°ì´í„° (Level 2-1ì— ì í•©í•œ ê°„ë‹¨í•œ ë¬¸ì œë“¤)
        const questionsData = {
            0: [ // Chapter 1
                {
                    passage: "Marvin was confused about when his book report was due. Mrs. North said 'I told you Tuesday,' but Marvin didn't know if she meant she told him last Tuesday or if it was due this Tuesday.",
                    question: "Why was Marvin confused about his book report?",
                    options: ["He forgot to write it", "He didn't know if Mrs. North meant last Tuesday or this Tuesday", "He lost his book", "He was absent from school"],
                    correct: 1
                },
                {
                    passage: "After school, Marvin saw his friends Stuart and Nick arguing about Casey Happleton. They were saying different things about her.",
                    question: "What were Stuart and Nick doing after school?",
                    options: ["Playing basketball", "Arguing about Casey Happleton", "Doing homework", "Walking home together"],
                    correct: 1
                },
                {
                    passage: "Casey Happleton was different from other girls in Marvin's class. She seemed more interesting and mysterious to him.",
                    question: "How did Marvin feel about Casey?",
                    options: ["He thought she was scary", "He found her interesting and mysterious", "He didn't like her", "He thought she was just like everyone else"],
                    correct: 1
                }
            ],
            1: [ // Chapter 2
                {
                    passage: "Casey invited Marvin to come to her house after school. She told him that her house was very special and different from other houses.",
                    question: "What did Casey tell Marvin about her house?",
                    options: ["It was very big", "It was special and different from other houses", "It was very old", "It had many rooms"],
                    correct: 1
                },
                {
                    passage: "When Marvin arrived at Casey's house, he was amazed to see that it was an old firehouse with a fire pole that went down four stories.",
                    question: "What kind of house did Casey live in?",
                    options: ["A regular house", "An old firehouse with a fire pole", "An apartment building", "A mansion"],
                    correct: 1
                },
                {
                    passage: "Casey showed Marvin how to slide down the fire pole from the top floor to the bottom. It looked scary but exciting at the same time.",
                    question: "What did Casey show Marvin how to do?",
                    options: ["Climb stairs", "Slide down the fire pole", "Ring the fire bell", "Look out the window"],
                    correct: 1
                }
            ],
            2: [ // Chapter 3
                {
                    passage: "Casey took Marvin to her room and showed him a beautiful crystal with flecks of green and gold inside it. She told him it was very special.",
                    question: "What did the crystal look like?",
                    options: ["It was completely clear", "It had flecks of green and gold inside", "It was bright red", "It was black and shiny"],
                    correct: 1
                },
                {
                    passage: "Casey explained that the crystal used to be just a regular rock, but then it got struck by lightning and became magical.",
                    question: "According to Casey, how did the crystal become magical?",
                    options: ["She bought it at a store", "It was struck by lightning", "She found it in the ocean", "Her grandmother gave it to her"],
                    correct: 1
                },
                {
                    passage: "Casey told Marvin that if you squeeze the crystal hard enough and make a wish, the wish would come true. She wanted to share it with him.",
                    question: "What did Casey say you had to do to make a wish come true?",
                    options: ["Rub the crystal gently", "Squeeze the crystal hard enough and make a wish", "Hold it up to the light", "Throw it in the air"],
                    correct: 1
                }
            ]
            // ì¶”ê°€ ì±•í„°ë“¤ì€ ìœ ì‚¬í•œ íŒ¨í„´ìœ¼ë¡œ êµ¬ì„±
        };

        // ì±… ìƒì„¸ ì •ë³´ í‘œì‹œ
        function showBookDetail() {
            document.getElementById('book-detail-screen').style.display = 'block';
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            generateChapterGrid();
            updateProgress();
        }

        // ì±•í„° ê·¸ë¦¬ë“œ ìƒì„±
        function generateChapterGrid() {
            const grid = document.getElementById('chapters-grid');
            grid.innerHTML = '';

            bookData.chapterList.forEach((chapter, index) => {
                const chapterCard = document.createElement('div');
                chapterCard.className = `chapter-card ${chapter.status}`;

                chapterCard.innerHTML = `
                    <div class="chapter-header">
                        <div class="chapter-info">
                            <h4>${chapter.title}</h4>
                            <p>${chapter.description} (${chapter.questionCount}ë¬¸ì œ)</p>
                        </div>
                        <div class="chapter-status ${chapter.status}">
                            ${chapter.status === 'completed' ? 'âœ… ì™„ë£Œ' :
                              chapter.status === 'current' ? 'ğŸ“– ì§„í–‰ì¤‘' : 'ğŸ”’ ì ê¹€'}
                        </div>
                    </div>
                    <div class="chapter-actions">
                        <button class="chapter-btn audio-btn" onclick="playChapterAudio(${index})"
                                ${chapter.status === 'locked' ? 'disabled' : ''}>
                            ğŸ§ ì˜¤ë””ì˜¤
                        </button>
                        <button class="chapter-btn quiz-btn" onclick="startLearning(${index})"
                                ${chapter.status === 'locked' ? 'disabled' : ''}>
                            ğŸ“ ë¬¸ì œí’€ê¸°
                        </button>
                    </div>
                `;

                grid.appendChild(chapterCard);
            });
        }

        // ì§„ë„ ì—…ë°ì´íŠ¸
        function updateProgress() {
            const completedChapters = bookData.chapterList.filter(chapter => chapter.status === 'completed').length;
            const progressPercent = Math.round((completedChapters / bookData.chapters) * 100);
            document.getElementById('progress-value').textContent = `${progressPercent}%`;
        }

        // í•™ìŠµ ì‹œì‘
        function startLearning(chapterIndex) {
            if (bookData.chapterList[chapterIndex].status === 'locked') return;

            currentChapterIndex = chapterIndex;
            currentQuestionIndex = 0;
            userAnswers = [];
            questions = questionsData[chapterIndex] || [];

            if (questions.length === 0) {
                alert('ì´ ì±•í„°ì˜ ë¬¸ì œê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('book-detail-screen').style.display = 'none';
            document.getElementById('learning-screen').style.display = 'block';
            document.getElementById('result-screen').style.display = 'none';

            const chapter = bookData.chapterList[chapterIndex];
            document.getElementById('learning-title').textContent = chapter.title;
            document.getElementById('learning-chapter-breadcrumb').textContent = chapter.title;

            showQuestion();
        }

        // ë¬¸ì œ í‘œì‹œ
        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                submitAnswers();
                return;
            }

            const question = questions[currentQuestionIndex];
            const container = document.getElementById('question-container');

            container.innerHTML = `
                <div class="passage">${question.passage}</div>
                <div class="question-text">${question.question}</div>
                <div class="options">
                    ${question.options.map((option, index) =>
                        `<div class="option" onclick="selectOption(${index})" data-index="${index}">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </div>`
                    ).join('')}
                </div>
            `;

            // ì§„ë„ ë°” ì—…ë°ì´íŠ¸
            const progressPercent = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('learning-progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('learning-progress-text').textContent = `ë¬¸ì œ ${currentQuestionIndex + 1} / ${questions.length}`;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').style.display = currentQuestionIndex === questions.length - 1 ? 'none' : 'inline-block';
            document.getElementById('submit-btn').style.display = currentQuestionIndex === questions.length - 1 ? 'inline-block' : 'none';

            // ì´ì „ ë‹µë³€ì´ ìˆë‹¤ë©´ í‘œì‹œ
            if (userAnswers[currentQuestionIndex] !== undefined) {
                const selectedOption = container.querySelector(`[data-index="${userAnswers[currentQuestionIndex]}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
        }

        // ì˜µì…˜ ì„ íƒ
        function selectOption(index) {
            // ê¸°ì¡´ ì„ íƒ ì œê±°
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });

            // ìƒˆ ì„ íƒ ì¶”ê°€
            document.querySelector(`[data-index="${index}"]`).classList.add('selected');
            userAnswers[currentQuestionIndex] = index;
        }

        // ë‹¤ìŒ ë¬¸ì œ
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            }
        }

        // ì´ì „ ë¬¸ì œ
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        // ë‹µì•ˆ ì œì¶œ
        function submitAnswers() {
            let correctCount = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correct) {
                    correctCount++;
                }
            }

            const score = Math.round((correctCount / questions.length) * 100);

            // ì±•í„° ìƒíƒœ ì—…ë°ì´íŠ¸
            if (score >= 70) { // 70ì  ì´ìƒì´ë©´ í†µê³¼
                bookData.chapterList[currentChapterIndex].status = 'completed';

                // ë‹¤ìŒ ì±•í„° ì ê¸ˆ í•´ì œ
                if (currentChapterIndex + 1 < bookData.chapterList.length) {
                    if (bookData.chapterList[currentChapterIndex + 1].status === 'locked') {
                        bookData.chapterList[currentChapterIndex + 1].status = 'current';
                    }
                }
            }

            showResult(correctCount, score);
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult(correctCount, score) {
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';

            document.getElementById('score-circle').textContent = `${score}%`;
            document.getElementById('total-questions').textContent = `${questions.length}ë¬¸ì œ`;
            document.getElementById('correct-answers').textContent = `${correctCount}ë¬¸ì œ`;
            document.getElementById('wrong-answers').textContent = `${questions.length - correctCount}ë¬¸ì œ`;
            document.getElementById('final-score').textContent = `${score}ì `;

            let message = '';
            if (score >= 90) {
                message = 'ğŸŒŸ ì™„ë²½í•©ë‹ˆë‹¤!';
            } else if (score >= 80) {
                message = 'ğŸ‰ í›Œë¥­í•´ìš”!';
            } else if (score >= 70) {
                message = 'ğŸ‘ ì˜í–ˆì–´ìš”!';
            } else {
                message = 'ğŸ’ª ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!';
            }

            document.getElementById('result-message').textContent = message;
        }

        // ì±•í„° ë‹¤ì‹œ í’€ê¸°
        function retryChapter() {
            startLearning(currentChapterIndex);
        }

        // ë‹¤ìŒ ì±•í„°
        function nextChapter() {
            if (currentChapterIndex + 1 < bookData.chapterList.length) {
                if (bookData.chapterList[currentChapterIndex + 1].status !== 'locked') {
                    startLearning(currentChapterIndex + 1);
                } else {
                    showBookDetail();
                }
            } else {
                showBookDetail();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', function() {
            showBookDetail();
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('learning-screen').style.display === 'block') {
                if (e.key === 'ArrowLeft') {
                    previousQuestion();
                } else if (e.key === 'ArrowRight') {
                    nextQuestion();
                } else if (e.key >= '1' && e.key <= '4') {
                    const index = parseInt(e.key) - 1;
                    if (index < questions[currentQuestionIndex]?.options.length) {
                        selectOption(index);
                    }
                }
            }

            if (e.key === 'Escape') {
                closeAudioModal();
            }
        });

        // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', function() {
            const audioPlayer = document.getElementById('audio-player');

            audioPlayer.addEventListener('play', function() {
                document.querySelector('.play-pause-btn').textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
            });

            audioPlayer.addEventListener('pause', function() {
                document.querySelector('.play-pause-btn').textContent = 'â–¶ï¸ ì¬ìƒ';
            });

            audioPlayer.addEventListener('ended', function() {
                document.querySelector('.play-pause-btn').textContent = 'â–¶ï¸ ì¬ìƒ';
            });
        });
    </script>
</body>
</html>