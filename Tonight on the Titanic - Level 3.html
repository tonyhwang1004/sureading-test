<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tonight on the Titanic - Level 3 - ÏàòÎ¶¨Îî©Ïñ¥ÌïôÏõê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #001f3f 0%, #003366 50%, #004080 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Ìó§Îçî */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #001f3f, #004080);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .logo-text p {
            font-size: 0.9rem;
            color: #666;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #333;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #001f3f;
            color: white;
            transform: translateY(-2px);
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        /* Ï±Ö ÏÉÅÏÑ∏ ÌôîÎ©¥ */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-size: 0.9rem;
            color: #666;
        }

        .breadcrumb a {
            color: #001f3f;
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .book-detail-header {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        .detail-book-cover {
            width: 150px;
            height: 220px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
            font-weight: bold;
            flex-shrink: 0;
            background: linear-gradient(45deg, #001f3f, #004080);
        }

        .book-info {
            flex: 1;
        }

        .book-info h2 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .book-info .author {
            font-size: 1.2rem;
            color: #001f3f;
            margin-bottom: 20px;
        }

        .book-summary {
            font-size: 1rem;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .book-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #001f3f;
        }

        .stat-box .label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Ï±ïÌÑ∞ Í∑∏Î¶¨Îìú */
        .chapters-section {
            margin-top: 40px;
        }

        .chapters-section h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .chapter-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .chapter-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .chapter-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a74508, #ffffff);
        }

        .chapter-card.current {
            border-color: #001f3f;
            background: linear-gradient(135deg, #001f3f08, #ffffff);
        }

        .chapter-card.locked {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .chapter-info h4 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .chapter-info p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
        }

        .chapter-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .chapter-status.completed {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .chapter-status.current {
            background: rgba(0, 31, 63, 0.1);
            color: #001f3f;
        }

        .chapter-status.locked {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .chapter-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .chapter-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .audio-btn {
            background: linear-gradient(45deg, #001f3f, #004080);
            color: white;
        }

        .quiz-btn {
            background: linear-gradient(45deg, #003366, #004080);
            color: white;
        }

        .chapter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .chapter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ÌïôÏäµ ÌôîÎ©¥ */
        .learning-screen {
            display: none;
        }

        .learning-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .learning-progress {
            background: #f8f9fa;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .learning-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #001f3f, #004080);
            transition: width 0.3s ease;
        }

        .question-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .passage {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.6;
            color: #444;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #001f3f;
        }

        .option.selected {
            background: rgba(0, 31, 63, 0.1);
            border-color: #001f3f;
        }

        .learning-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .next-btn {
            background: linear-gradient(45deg, #001f3f, #004080);
            color: white;
        }

        .prev-btn {
            background: #6c757d;
            color: white;
        }

        .submit-btn {
            background: linear-gradient(45deg, #001f3f, #004080);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Í≤∞Í≥º ÌôîÎ©¥ */
        .result-screen {
            display: none;
            text-align: center;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(45deg, #001f3f, #004080);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .result-stat {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ Î™®Îã¨ */
        .audio-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .audio-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            position: relative;
        }

        .close-audio {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }

        .audio-player {
            width: 100%;
            margin: 20px 0;
            border-radius: 10px;
        }

        .audio-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .audio-control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-pause-btn {
            background: linear-gradient(45deg, #001f3f, #004080);
            color: white;
        }

        .speed-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .download-btn {
            background: #003366;
            color: white;
        }

        .audio-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .audio-info.hidden {
            display: none;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .chapters-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .book-detail-header {
                flex-direction: column;
                text-align: center;
            }

            .book-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .learning-controls {
                flex-direction: column;
            }

            .chapter-actions {
                grid-template-columns: 1fr;
            }

            .audio-controls {
                justify-content: center;
                gap: 10px;
            }

            .audio-content {
                padding: 30px 20px;
            }
        }

        .new-book-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(45deg, #FF6B9D, #C44569);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Level 3 ÌäπÎ≥Ñ Ïä§ÌÉÄÏùº */
        .level-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #FF6B00, #FF8E53);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ìó§Îçî -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üö¢</div>
                <div class="logo-text">
                    <h1>Tonight on the Titanic</h1>
                    <p>Level 3 - Mary Pope OsborneÏùò Îß§ÏßÅ Ìä∏Î¶¨ ÌïòÏö∞Ïä§ 17Í∂å</p>
                </div>
            </div>
            <div class="nav-buttons">
                <a href="http://www.suelibrary.store/" class="nav-btn">Î©îÏù∏ÏúºÎ°ú</a>
            </div>
        </div>

        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div class="main-content">
            <!-- Ï±Ö ÏÉÅÏÑ∏ ÌôîÎ©¥ -->
            <div class="book-detail-screen" id="book-detail-screen">
                <div class="level-badge">Level 3</div>
                <div class="breadcrumb">
                    <span>Tonight on the Titanic</span>
                </div>

                <div class="book-detail-header">
                    <div class="detail-book-cover">üö¢</div>
                    <div class="book-info">
                        <h2>Tonight on the Titanic</h2>
                        <div class="author">Mary Pope Osborne</div>
                        <div class="book-summary">
                            Jack and Annie travel back to 1912 aboard the famous Titanic on its maiden voyage! They must help a mysterious young man save someone important while experiencing the luxury and tragedy of the world's most famous ship. Learn about the Titanic's passengers, the differences between social classes, and the heroic acts during one of history's most famous disasters.
                        </div>
                        <div class="book-stats">
                            <div class="stat-box">
                                <div class="value">10</div>
                                <div class="label">Ï±ïÌÑ∞</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">50</div>
                                <div class="label">Ï¥ù Î¨∏Ï†ú</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">Level 3</div>
                                <div class="label">Î†àÎ≤®</div>
                            </div>
                            <div class="stat-box">
                                <div class="value" id="progress-value">0%</div>
                                <div class="label">ÏßÑÎèÑ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chapters-section">
                    <h3>üö¢ Ï±ïÌÑ∞Î≥Ñ ÌïôÏäµ</h3>
                    <div class="chapters-grid" id="chapters-grid">
                        <!-- Ï±ïÌÑ∞ Ïπ¥ÎìúÎì§ -->
                    </div>
                </div>
            </div>

            <!-- ÌïôÏäµ ÌôîÎ©¥ -->
            <div class="learning-screen" id="learning-screen">
                <div class="breadcrumb">
                    <a onclick="showBookDetail()">Tonight on the Titanic</a>
                    <span>></span>
                    <span id="learning-chapter-breadcrumb">Chapter 1</span>
                </div>

                <div class="learning-header">
                    <h2 id="learning-title">Chapter 1: A New Mission</h2>
                    <div class="learning-progress">
                        <div class="learning-progress-bar" id="learning-progress-bar" style="width: 0%"></div>
                    </div>
                    <p id="learning-progress-text">Î¨∏Ï†ú 1 / 5</p>
                </div>

                <div class="question-container" id="question-container">
                    <!-- Î¨∏Ï†úÍ∞Ä ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </div>

                <div class="learning-controls">
                    <button class="control-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>Ïù¥Ï†Ñ</button>
                    <button class="control-btn next-btn" id="next-btn" onclick="nextQuestion()">Îã§Ïùå</button>
                    <button class="control-btn submit-btn" id="submit-btn" onclick="submitAnswers()" style="display: none;">Ï†úÏ∂ú</button>
                </div>
            </div>

            <!-- Í≤∞Í≥º ÌôîÎ©¥ -->
            <div class="result-screen" id="result-screen">
                <div class="breadcrumb">
                    <a onclick="showBookDetail()">Tonight on the Titanic</a>
                    <span>></span>
                    <span>Í≤∞Í≥º</span>
                </div>

                <div class="result-header">
                    <h2>üéâ ÌïôÏäµ ÏôÑÎ£å!</h2>
                    <div class="score-circle" id="score-circle">100%</div>
                    <h3 id="result-message">ÌõåÎ•≠Ìï©ÎãàÎã§!</h3>
                </div>

                <div class="result-details">
                    <div class="result-stat">
                        <h4>Ï¥ù Î¨∏Ï†ú</h4>
                        <p id="total-questions">5Î¨∏Ï†ú</p>
                    </div>
                    <div class="result-stat">
                        <h4>Ï†ïÎãµ</h4>
                        <p id="correct-answers">5Î¨∏Ï†ú</p>
                    </div>
                    <div class="result-stat">
                        <h4>Ïò§Îãµ</h4>
                        <p id="wrong-answers">0Î¨∏Ï†ú</p>
                    </div>
                    <div class="result-stat">
                        <h4>Ï†êÏàò</h4>
                        <p id="final-score">100Ï†ê</p>
                    </div>
                </div>

                <div class="result-actions">
                    <button class="control-btn prev-btn" onclick="retryChapter()">Îã§Ïãú ÌíÄÍ∏∞</button>
                    <button class="control-btn next-btn" onclick="nextChapter()">Îã§Ïùå Ï±ïÌÑ∞</button>
                    <button class="control-btn submit-btn" onclick="showBookDetail()">Ï±ïÌÑ∞ Î™©Î°ù</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ Î™®Îã¨ -->
    <div class="audio-modal" id="audio-modal">
        <div class="audio-content">
            <button class="close-audio" onclick="closeAudioModal()">√ó</button>
            <h3 id="audio-chapter-title">Chapter 1: A New Mission</h3>
            <p id="audio-chapter-subtitle">Tonight on the Titanic - Mary Pope Osborne</p>

            <audio class="audio-player" id="audio-player" controls preload="metadata">
                <source id="audio-source" src="" type="audio/mpeg">
                Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ïò§ÎîîÏò§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.
            </audio>

            <div class="audio-controls">
                <button class="audio-control-btn play-pause-btn" onclick="togglePlayPause()">‚ñ∂Ô∏è Ïû¨ÏÉù</button>
                <button class="audio-control-btn speed-btn" onclick="changeSpeed()">1.0x</button>
                <button class="audio-control-btn" onclick="resetToChapterStart()" style="background: #28a745; color: white;">üîÑ Íµ¨Í∞ÑÏ≤òÏùå</button>
                <button class="audio-control-btn download-btn" onclick="downloadAudio()">üì• Îã§Ïö¥Î°úÎìú</button>
            </div>

            <div class="audio-info" id="audio-info">
                <div id="audio-status" style="margin-top: 10px; font-weight: bold; color: #001f3f;"></div>
            </div>
        </div>
    </div>

    <script>
        // üéØ Íµ¨Í∏Ä ÌÅ¥ÎùºÏö∞Îìú Ïä§ÌÜ†Î¶¨ÏßÄ Ïò§ÎîîÏò§ URL ÏÑ§Ï†ï
        const AUDIO_BASE_URL = 'https://storage.googleapis.com/kim-mom-reading-audio/audio/';

        // Magic Tree House 17Í∂å ÎèÑÏÑú Îç∞Ïù¥ÌÑ∞ (10Ï±ïÌÑ∞)
        const bookData = {
            id: 'MTH017',
            title: "Tonight on the Titanic",
            author: 'Mary Pope Osborne',
            cover: 'üö¢',
            progress: 0,
            chapters: 10,
            totalQuestions: 50, // 10Ï±ïÌÑ∞ √ó 5Î¨∏Ï†ú
            coverColor: 'linear-gradient(45deg, #001f3f, #004080)',
            summary: "Jack and Annie travel back to 1912 aboard the famous Titanic on its maiden voyage! They must help a mysterious young man save someone important while experiencing the luxury and tragedy of the world's most famous ship. Learn about the Titanic's passengers, the differences between social classes, and the heroic acts during one of history's most famous disasters.",
            chapterList: [
                { title: 'A New Mission', description: 'Jack and Annie receive a new mission that takes them to the famous Titanic.', status: 'current', questionCount: 5, startTime: 0 },
                { title: 'The Unsinkable Ship', description: 'They board the magnificent Titanic and explore the luxurious ship.', status: 'locked', questionCount: 5, startTime: 300 },
                { title: 'William and Teddy', description: 'They meet a young man named William and his dog Teddy.', status: 'locked', questionCount: 5, startTime: 600 },
                { title: 'Good-bye, Teddy', description: 'William must make a difficult decision about his beloved dog.', status: 'locked', questionCount: 5, startTime: 900 },
                { title: 'First Class', description: 'They explore the first-class areas and meet wealthy passengers.', status: 'locked', questionCount: 5, startTime: 1200 },
                { title: 'The Midnight Star', description: 'They discover the differences between passenger classes aboard the ship.', status: 'locked', questionCount: 5, startTime: 1500 },
                { title: 'Ice!', description: 'The Titanic hits the iceberg and the disaster begins.', status: 'locked', questionCount: 5, startTime: 1800 },
                { title: 'Women and Children First', description: 'Evacuation begins as lifeboats are lowered into the sea.', status: 'locked', questionCount: 5, startTime: 2100 },
                { title: 'A Bright Light', description: 'Jack and Annie help others during the ship\'s final moments.', status: 'locked', questionCount: 5, startTime: 2400 },
                { title: 'A Gift', description: 'They return home with a deeper understanding of courage and sacrifice.', status: 'locked', questionCount: 5, startTime: 2700 }
            ]
        };

        // Î¨∏Ï†ú Îç∞Ïù¥ÌÑ∞ (Ï†ÑÏ≤¥ 10Ï±ïÌÑ∞ ÏôÑÎ£å)
        const questionsData = {
            0: [ // Chapter 1: A New Mission
                {
                    passage: "Jack and Annie found a mysterious book about the Titanic in the tree house, along with a note from Morgan le Fay about a special rescue mission.",
                    question: "What did Jack and Annie find in the tree house?",
                    options: ["A history textbook", "A mysterious book about the Titanic and a note about a rescue mission", "A map of the ocean", "A photo album"],
                    correct: 1
                },
                {
                    passage: "Morgan's note explained that they needed to help someone show kindness to another person aboard the famous ship during its maiden voyage.",
                    question: "What was their mission according to Morgan's note?",
                    options: ["To prevent the disaster", "To help someone show kindness during the maiden voyage", "To find treasure", "To meet the captain"],
                    correct: 1
                },
                {
                    passage: "The book contained pictures of the Titanic, showing it was the largest and most luxurious ship ever built at the time.",
                    question: "What did the book reveal about the Titanic?",
                    options: ["It was a small fishing boat", "It was the largest and most luxurious ship ever built", "It was a warship", "It was already old"],
                    correct: 1
                },
                {
                    passage: "Jack read that the Titanic was called 'unsinkable' because of its advanced design with watertight compartments and modern safety features.",
                    question: "Why was the Titanic called 'unsinkable'?",
                    options: ["Because it was made of wood", "Because of its watertight compartments and safety features", "Because it was very small", "Because it never left port"],
                    correct: 1
                },
                {
                    passage: "Annie was excited about the luxury and glamour, but Jack felt worried because he knew the ship's tragic fate in history.",
                    question: "How did Jack and Annie feel differently about the mission?",
                    options: ["Both were equally excited", "Annie was excited about luxury, Jack worried about the tragedy", "Both were scared", "Jack was excited, Annie was worried"],
                    correct: 1
                }
            ],
            1: [ // Chapter 2: The Unsinkable Ship
                {
                    passage: "Jack and Annie found themselves on the deck of the magnificent Titanic, surrounded by elegantly dressed passengers and crew members in crisp uniforms.",
                    question: "Where did Jack and Annie find themselves?",
                    options: ["In a small boat", "On the deck of the Titanic with elegantly dressed passengers", "In a train station", "At a hotel"],
                    correct: 1
                },
                {
                    passage: "The ship was incredibly massive, with towering smokestacks, gleaming white paint, and luxurious details everywhere they looked.",
                    question: "How did the Titanic appear to Jack and Annie?",
                    options: ["Small and dirty", "Incredibly massive with smokestacks, white paint, and luxury", "Old and rusty", "Dark and scary"],
                    correct: 1
                },
                {
                    passage: "They observed passengers from different social classes, with wealthy first-class travelers in fine clothing and third-class passengers in simpler attire.",
                    question: "What did they observe about the passengers?",
                    options: ["Everyone looked the same", "Different social classes with first-class in fine clothing, third-class simpler", "Only wealthy people", "Only poor people"],
                    correct: 1
                },
                {
                    passage: "The ship's dining rooms, grand staircase, and smoking lounges were decorated with elaborate furnishings that rivaled the finest hotels.",
                    question: "How were the ship's interior spaces decorated?",
                    options: ["Very simply", "With elaborate furnishings rivaling the finest hotels", "With no decorations", "Like a prison"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie were amazed by the ship's modern conveniences, including electric lights, elevators, and even a swimming pool and gymnasium.",
                    question: "What modern conveniences did the ship have?",
                    options: ["None at all", "Electric lights, elevators, swimming pool, and gymnasium", "Only basic furniture", "Just beds and chairs"],
                    correct: 1
                }
            ],
            2: [ // Chapter 3: William and Teddy
                {
                    passage: "Jack and Annie met a lonely young man named William who was traveling alone with his small dog named Teddy.",
                    question: "Who did Jack and Annie meet on the ship?",
                    options: ["The ship's captain", "A lonely young man named William with his dog Teddy", "A famous actress", "A wealthy businessman"],
                    correct: 1
                },
                {
                    passage: "William explained that he was traveling from England to America to start a new life, but he seemed sad and worried about something.",
                    question: "Why was William traveling on the Titanic?",
                    options: ["For a vacation", "To start a new life in America from England", "To visit family", "For business meetings"],
                    correct: 1
                },
                {
                    passage: "Teddy was a friendly little dog who brought joy to William, but ship rules stated that pets weren't allowed in the passenger areas.",
                    question: "What problem did William face with his dog Teddy?",
                    options: ["Teddy was sick", "Ship rules didn't allow pets in passenger areas", "Teddy was too big", "Teddy was lost"],
                    correct: 1
                },
                {
                    passage: "William told Jack and Annie that he was keeping Teddy hidden because he couldn't bear to leave his beloved companion behind.",
                    question: "Why was William keeping Teddy hidden?",
                    options: ["Teddy was valuable", "He couldn't bear to leave his beloved companion behind", "Teddy was dangerous", "He was selling the dog"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie could see that William's love for Teddy was genuine, and they wanted to help him find a solution to keep them together.",
                    question: "How did Jack and Annie feel about William and Teddy?",
                    options: ["They didn't care", "They saw genuine love and wanted to help keep them together", "They thought William was wrong", "They were afraid of the dog"],
                    correct: 1
                }
            ],
            3: [ // Chapter 4: Good-bye, Teddy
                {
                    passage: "A ship officer discovered William with Teddy and told him that the dog must be kept in the ship's cargo area with other animals.",
                    question: "What did the ship officer tell William about Teddy?",
                    options: ["The dog could stay with him", "The dog must be kept in the cargo area with other animals", "The dog had to be thrown overboard", "The dog could go anywhere"],
                    correct: 1
                },
                {
                    passage: "William was heartbroken at the thought of separating from Teddy, who had been his constant companion through difficult times.",
                    question: "How did William feel about separating from Teddy?",
                    options: ["He was happy", "He was heartbroken since Teddy was his constant companion", "He didn't care", "He was angry at the dog"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie tried to comfort William, explaining that sometimes we have to make difficult choices to protect those we love.",
                    question: "What did Jack and Annie tell William about difficult choices?",
                    options: ["Never make them", "Sometimes we make difficult choices to protect those we love", "Always avoid them", "They don't matter"],
                    correct: 1
                },
                {
                    passage: "William reluctantly agreed to take Teddy to the cargo area, but he promised to visit the dog as often as possible during the voyage.",
                    question: "What did William decide to do about Teddy?",
                    options: ["Keep him hidden forever", "Reluctantly take him to cargo but promise to visit often", "Give him away", "Leave him behind"],
                    correct: 1
                },
                {
                    passage: "As they walked to the cargo area, William told Jack and Annie how much Teddy meant to him and how the dog had helped him through lonely times.",
                    question: "What did William tell Jack and Annie about Teddy's importance?",
                    options: ["The dog was just a pet", "Teddy meant a lot and helped him through lonely times", "He didn't really like the dog", "The dog was trouble"],
                    correct: 1
                }
            ],
            4: [ // Chapter 5: First Class
                {
                    passage: "Jack and Annie explored the first-class areas of the ship, where wealthy passengers enjoyed luxurious accommodations and fine dining.",
                    question: "What did Jack and Annie explore on the ship?",
                    options: ["The engine room", "First-class areas with luxurious accommodations and fine dining", "The cargo hold", "The crew quarters"],
                    correct: 1
                },
                {
                    passage: "They observed elegant ladies in beautiful gowns and gentlemen in formal evening wear socializing in the ornate lounges.",
                    question: "What did they observe in the first-class areas?",
                    options: ["People in work clothes", "Elegant ladies in gowns and gentlemen in formal wear socializing", "Empty rooms", "Crew members working"],
                    correct: 1
                },
                {
                    passage: "The first-class dining room featured multiple courses of gourmet food served on fine china with crystal glasses and silver utensils.",
                    question: "What was special about the first-class dining room?",
                    options: ["It served simple food", "Multiple courses of gourmet food on fine china with crystal and silver", "It was always empty", "It only served bread"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie noticed that first-class passengers seemed to live in a completely different world from the third-class passengers below deck.",
                    question: "What did Jack and Annie notice about social classes on the ship?",
                    options: ["Everyone was treated equally", "First-class lived in a completely different world from third-class", "Only first-class passengers existed", "There were no differences"],
                    correct: 1
                },
                {
                    passage: "They met some first-class passengers who were kind and others who seemed to look down on people from lower social classes.",
                    question: "What variety did they find among first-class passengers?",
                    options: ["All were exactly the same", "Some were kind, others looked down on lower social classes", "All were mean", "All were friendly"],
                    correct: 1
                }
            ],
            5: [ // Chapter 6: The Midnight Star
                {
                    passage: "Jack and Annie visited the third-class areas and saw families with children traveling to America with hopes for a better life.",
                    question: "What did Jack and Annie see in the third-class areas?",
                    options: ["Empty rooms", "Families with children hoping for a better life in America", "Only wealthy people", "Ship crew"],
                    correct: 1
                },
                {
                    passage: "The third-class accommodations were much simpler than first-class, with shared bathrooms and smaller rooms, but the passengers were warm and friendly.",
                    question: "How did third-class accommodations compare to first-class?",
                    options: ["They were exactly the same", "Much simpler with shared bathrooms and smaller rooms, but friendly passengers", "They were better than first-class", "They didn't exist"],
                    correct: 1
                },
                {
                    passage: "They listened to passengers tell stories of leaving their old countries behind to seek opportunities and freedom in the New World.",
                    question: "What stories did the third-class passengers tell?",
                    options: ["Stories about being wealthy", "Stories of leaving old countries to seek opportunities in the New World", "Stories about the ship", "Stories about famous people"],
                    correct: 1
                },
                {
                    passage: "A young girl showed Jack and Annie a precious star-shaped locket that was her only reminder of the grandmother she left behind.",
                    question: "What did a young girl show Jack and Annie?",
                    options: ["A valuable diamond", "A precious star-shaped locket reminding her of her grandmother", "A bag of money", "A photograph"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie realized that despite their different circumstances, all the passengers shared common dreams of hope, family, and new beginnings.",
                    question: "What did Jack and Annie realize about all the passengers?",
                    options: ["They had nothing in common", "Despite different circumstances, they shared dreams of hope and new beginnings", "Only wealthy people had dreams", "Everyone was unhappy"],
                    correct: 1
                }
            ],
            6: [ // Chapter 7: Ice!
                {
                    passage: "Late at night, Jack and Annie felt a strange shudder run through the ship as the Titanic struck a massive iceberg in the North Atlantic.",
                    question: "What happened to the Titanic late at night?",
                    options: ["Nothing unusual", "It struck a massive iceberg causing a shudder through the ship", "It reached its destination", "It stopped for fuel"],
                    correct: 1
                },
                {
                    passage: "At first, many passengers didn't realize the severity of the situation, thinking it was just a minor incident that would be quickly resolved.",
                    question: "How did passengers initially react to hitting the iceberg?",
                    options: ["They all panicked immediately", "Many didn't realize the severity, thinking it was minor", "Everyone knew it was serious", "No one noticed"],
                    correct: 1
                },
                {
                    passage: "The ship's crew began assessing the damage and discovered that water was flooding into several compartments below deck.",
                    question: "What did the crew discover after hitting the iceberg?",
                    options: ["No damage at all", "Water was flooding into several compartments below deck", "Only minor scratches", "The ship was fine"],
                    correct: 1
                },
                {
                    passage: "Captain Smith realized that the 'unsinkable' ship was actually going to sink, and he ordered the crew to prepare the lifeboats immediately.",
                    question: "What did Captain Smith realize and order?",
                    options: ["The ship was fine", "The ship was going to sink and ordered lifeboats prepared", "They should speed up", "Nothing needed to be done"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie knew from history that the Titanic didn't have enough lifeboats for all the passengers and crew aboard the ship.",
                    question: "What did Jack and Annie know about the lifeboats?",
                    options: ["There were plenty for everyone", "The ship didn't have enough lifeboats for all passengers and crew", "Lifeboats weren't needed", "Everyone could swim"],
                    correct: 1
                }
            ],
            7: [ // Chapter 8: Women and Children First
                {
                    passage: "The crew began loading lifeboats following the maritime rule of 'women and children first,' while the ship's band played music to keep passengers calm.",
                    question: "What rule did the crew follow when loading lifeboats?",
                    options: ["First come, first served", "Women and children first while the band played to keep calm", "Men only", "No particular order"],
                    correct: 1
                },
                {
                    passage: "Many men, including wealthy first-class passengers, stayed behind to ensure that women and children could escape safely in the limited lifeboats.",
                    question: "What did many men do during the evacuation?",
                    options: ["They pushed ahead of everyone", "They stayed behind to ensure women and children escaped safely", "They hid on the ship", "They jumped overboard"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie watched as families were separated, with fathers and husbands saying goodbye to their wives and children, not knowing if they would see them again.",
                    question: "What emotional scene did Jack and Annie witness?",
                    options: ["Everyone staying together", "Families separating as fathers said goodbye not knowing if they'd meet again", "No one caring about others", "Everyone panicking"],
                    correct: 1
                },
                {
                    passage: "They saw acts of incredible courage and kindness, as people helped strangers and shared their warm clothing with those who were cold.",
                    question: "What positive behaviors did Jack and Annie observe during the disaster?",
                    options: ["Everyone being selfish", "Acts of courage and kindness, helping strangers and sharing clothing", "People fighting each other", "No one helping anyone"],
                    correct: 1
                },
                {
                    passage: "William appeared and told them he was making sure Teddy got into a lifeboat, showing that his love for his dog meant protecting him even if they had to be apart.",
                    question: "What did William do for Teddy during the disaster?",
                    options: ["Left him behind", "Made sure Teddy got into a lifeboat, protecting him even if apart", "Kept him on the ship", "Gave him to someone else"],
                    correct: 1
                }
            ],
            8: [ // Chapter 9: A Bright Light
                {
                    passage: "As the Titanic began to sink more rapidly, Jack and Annie helped guide passengers to the remaining lifeboats and comfort those who were frightened.",
                    question: "What did Jack and Annie do as the ship sank more rapidly?",
                    options: ["They hid in their room", "They helped guide passengers to lifeboats and comforted the frightened", "They jumped overboard", "They did nothing"],
                    correct: 1
                },
                {
                    passage: "They witnessed the ship's lights going out one by one as the Titanic tilted more steeply, but people continued to help each other despite the chaos.",
                    question: "What did they witness as the ship's situation worsened?",
                    options: ["Everyone giving up", "Lights going out as ship tilted, but people still helping each other", "Complete panic with no help", "Nothing happening"],
                    correct: 1
                },
                {
                    passage: "In the ship's final moments, Jack and Annie saw the true character of people - some showed remarkable bravery and selflessness while facing disaster.",
                    question: "What did Jack and Annie learn about people's character during the disaster?",
                    options: ["Everyone was cowardly", "Some showed remarkable bravery and selflessness facing disaster", "No one cared about others", "Everyone was confused"],
                    correct: 1
                },
                {
                    passage: "The tree house appeared with a bright, warm light that guided them away from the sinking ship just as the Titanic disappeared beneath the dark, cold ocean.",
                    question: "How did Jack and Annie escape from the Titanic?",
                    options: ["They swam away", "The tree house appeared with bright light guiding them away", "They used a lifeboat", "They stayed on the ship"],
                    correct: 1
                },
                {
                    passage: "As they watched the tragedy unfold, they understood that they had witnessed both the worst and best of human nature during one of history's most famous disasters.",
                    question: "What did Jack and Annie understand about the Titanic disaster?",
                    options: ["It was just an accident", "They witnessed both the worst and best of human nature", "Only bad things happened", "It wasn't important"],
                    correct: 1
                }
            ],
            9: [ // Chapter 10: A Gift
                {
                    passage: "Back in the tree house, Jack and Annie found William's dog Teddy waiting for them, along with a note explaining that William had made sure the dog survived.",
                    question: "What did Jack and Annie find in the tree house?",
                    options: ["Nothing special", "William's dog Teddy and a note explaining William ensured the dog survived", "A treasure chest", "A history book"],
                    correct: 1
                },
                {
                    passage: "The note revealed that William had shown the greatest kindness by ensuring Teddy's safety even though it meant they had to be separated forever.",
                    question: "What kindness had William shown according to the note?",
                    options: ["He kept the dog with him", "He ensured Teddy's safety even though they'd be separated forever", "He gave the dog away", "He ignored the dog"],
                    correct: 1
                },
                {
                    passage: "Morgan le Fay appeared and explained that true love sometimes means making sacrifices to protect those we care about, even when it breaks our hearts.",
                    question: "What lesson did Morgan le Fay explain about true love?",
                    options: ["Love means keeping everything", "True love sometimes means making sacrifices to protect others", "Love is always easy", "Love doesn't require sacrifice"],
                    correct: 1
                },
                {
                    passage: "She told them that the disaster had brought out both the worst and best in people, showing how crisis can reveal true character and courage.",
                    question: "What did Morgan say the disaster revealed about people?",
                    options: ["Only bad things", "Both the worst and best, showing how crisis reveals character and courage", "Nothing important", "Only good things"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie realized they had learned that heroism isn't just about grand gestures, but also about small acts of kindness and putting others before yourself.",
                    question: "What did Jack and Annie learn about heroism?",
                    options: ["It's only about being famous", "It's not just grand gestures, but small acts of kindness and putting others first", "It doesn't exist", "It's only for adults"],
                    correct: 1
                }
            ]
        };

        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentChapterIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questions = [];
        let currentAudio = null;
        let playbackSpeed = 1.0;

        // üéß ÏûêÎèô Ïò§ÎîîÏò§ URL ÏÉùÏÑ± Ìï®Ïàò
        function getAudioUrl(chapterIndex) {
            const level = 'level3';
            const bookId = 'MTH017';
            const chapterNum = String(chapterIndex + 1).padStart(2, '0');
            
            const possibleFileNames = [
                `${bookId}_chapter${chapterNum}.mp3`,
                `${bookId}_ch${chapterNum}.mp3`,
                `${bookId}_${chapterNum}.mp3`,
                `magic_tree_house_17_chapter${chapterNum}.mp3`,
                `magic_tree_house_17_ch${chapterNum}.mp3`,
                `tonight_on_the_titanic_${chapterNum}.mp3`,
                `mary_pope_osborne_17_chapter${chapterNum}.mp3`,
                `${bookId}.mp3`
            ];
            
            return {
                primary: `${AUDIO_BASE_URL}${level}/${possibleFileNames[0]}`,
                alternatives: possibleFileNames.map(fileName => `${AUDIO_BASE_URL}${level}/${fileName}`)
            };
        }

        // üéß Ïò§ÎîîÏò§ Ïû¨ÏÉù Ìï®Ïàò
        function playChapterAudio(chapterIndex) {
            const chapter = bookData.chapterList[chapterIndex];
            const audioUrls = getAudioUrl(chapterIndex);

            document.getElementById('audio-modal').style.display = 'flex';
            document.getElementById('audio-chapter-title').textContent = `Chapter ${chapterIndex + 1}: ${chapter.title}`;
            document.getElementById('audio-chapter-subtitle').textContent = `${bookData.title} - ${bookData.author}`;

            // Ïò§ÎîîÏò§ Ï†ïÎ≥¥ ÏòÅÏó≠ Îã§Ïãú Î≥¥Ïù¥Í∏∞ (ÏÉàÎ°úÏö¥ Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïãú)
            document.getElementById('audio-info').classList.remove('hidden');

            const audioPlayer = document.getElementById('audio-player');
            const audioSource = document.getElementById('audio-source');
            const audioStatus = document.getElementById('audio-status');

            audioStatus.textContent = 'üîÑ Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ï∞æÎäî Ï§ë...';

            function tryLoadAudio(urlIndex = 0) {
                if (urlIndex >= audioUrls.alternatives.length) {
                    audioStatus.innerHTML = `‚ùå Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`;
                    return;
                }

                const currentUrl = audioUrls.alternatives[urlIndex];
                audioSource.src = currentUrl;
                audioPlayer.load();

                const successHandler = function() {
                    const startTime = chapter.startTime || 0;
                    audioPlayer.currentTime = startTime;
                    audioStatus.innerHTML = `‚úÖ Ïò§ÎîîÏò§ Ï§ÄÎπÑ ÏôÑÎ£å!`;
                };

                const errorHandler = function() {
                    setTimeout(() => tryLoadAudio(urlIndex + 1), 100);
                };

                audioPlayer.addEventListener('canplaythrough', successHandler, { once: true });
                audioPlayer.addEventListener('error', errorHandler, { once: true });
            }

            tryLoadAudio(0);
            currentAudio = audioPlayer;
            playbackSpeed = 1.0;
        }

        // Í∏∞Î≥∏ Ìï®ÏàòÎì§
        function closeAudioModal() {
            document.getElementById('audio-modal').style.display = 'none';
            if (currentAudio) currentAudio.pause();
        }

        function togglePlayPause() {
            if (!currentAudio) return;
            if (currentAudio.paused) {
                currentAudio.play();
                document.querySelector('.play-pause-btn').textContent = '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ';
            } else {
                currentAudio.pause();
                document.querySelector('.play-pause-btn').textContent = '‚ñ∂Ô∏è Ïû¨ÏÉù';
            }
        }

        function changeSpeed() {
            if (!currentAudio) return;
            const speeds = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
            const currentIndex = speeds.indexOf(playbackSpeed);
            playbackSpeed = speeds[(currentIndex + 1) % speeds.length];
            currentAudio.playbackRate = playbackSpeed;
            document.querySelector('.speed-btn').textContent = `${playbackSpeed}x`;
        }

        function resetToChapterStart() {
            if (!currentAudio) return;
            const currentChapter = parseInt(document.getElementById('audio-chapter-title').textContent.match(/Chapter (\d+)/)[1]) - 1;
            currentAudio.currentTime = bookData.chapterList[currentChapter]?.startTime || 0;
        }

        function downloadAudio() {
            const audioSource = document.getElementById('audio-source');
            if (audioSource.src) {
                const link = document.createElement('a');
                link.href = audioSource.src;
                link.download = `${document.getElementById('audio-chapter-title').textContent}.mp3`;
                link.click();
            }
        }

        // Ï±Ö ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
        function showBookDetail() {
            document.getElementById('book-detail-screen').style.display = 'block';
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            generateChapterGrid();
            updateProgress();
        }

        // Ï±ïÌÑ∞ Í∑∏Î¶¨Îìú ÏÉùÏÑ±
        function generateChapterGrid() {
            const grid = document.getElementById('chapters-grid');
            grid.innerHTML = '';

            bookData.chapterList.forEach((chapter, index) => {
                const chapterCard = document.createElement('div');
                chapterCard.className = `chapter-card ${chapter.status}`;

                chapterCard.innerHTML = `
                    <div class="chapter-header">
                        <div class="chapter-info">
                            <h4>Chapter ${index + 1}: ${chapter.title}</h4>
                            <p>${chapter.description} (${chapter.questionCount}Î¨∏Ï†ú)</p>
                        </div>
                        <div class="chapter-status ${chapter.status}">
                            ${chapter.status === 'completed' ? '‚úÖ ÏôÑÎ£å' :
                              chapter.status === 'current' ? 'üìñ ÏßÑÌñâÏ§ë' : 'üîí Ïû†ÍπÄ'}
                        </div>
                    </div>
                    <div class="chapter-actions">
                        <button class="chapter-btn audio-btn" onclick="playChapterAudio(${index})"
                                ${chapter.status === 'locked' ? 'disabled' : ''}>
                            üéß Ïò§ÎîîÏò§
                        </button>
                        <button class="chapter-btn quiz-btn" onclick="startLearning(${index})"
                                ${chapter.status === 'locked' ? 'disabled' : ''}>
                            üìù Î¨∏Ï†úÌíÄÍ∏∞
                        </button>
                    </div>
                `;

                grid.appendChild(chapterCard);
            });
        }

        // ÏßÑÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateProgress() {
            const completedChapters = bookData.chapterList.filter(chapter => chapter.status === 'completed').length;
            const progress = Math.round((completedChapters / bookData.chapters) * 100);
            document.getElementById('progress-value').textContent = progress + '%';
        }

        // ÌïôÏäµ ÏãúÏûë
        function startLearning(chapterIndex) {
            currentChapterIndex = chapterIndex;
            currentQuestionIndex = 0;
            userAnswers = [];
            questions = questionsData[chapterIndex];

            if (!questions || questions.length === 0) {
                alert('Ïù¥ Ï±ïÌÑ∞Ïùò Î¨∏Ï†úÍ∞Ä ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }

            document.getElementById('book-detail-screen').style.display = 'none';
            document.getElementById('learning-screen').style.display = 'block';
            document.getElementById('result-screen').style.display = 'none';

            const chapter = bookData.chapterList[chapterIndex];
            document.getElementById('learning-title').textContent = `Chapter ${chapterIndex + 1}: ${chapter.title}`;
            document.getElementById('learning-chapter-breadcrumb').textContent = `Chapter ${chapterIndex + 1}`;

            showQuestion();
            updateLearningProgress();
        }

        // Î¨∏Ï†ú ÌëúÏãú
        function showQuestion() {
            const question = questions[currentQuestionIndex];
            const container = document.getElementById('question-container');

            container.innerHTML = `
                <div class="question-text">Î¨∏Ï†ú ${currentQuestionIndex + 1}</div>
                <div class="passage">${question.passage}</div>
                <div class="question-text">${question.question}</div>
                <div class="options">
                    ${question.options.map((option, index) =>
                        `<div class="option" onclick="selectOption(${index})" data-index="${index}">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </div>`
                    ).join('')}
                </div>
            `;

            if (userAnswers[currentQuestionIndex] !== undefined) {
                const selectedOption = container.querySelector(`[data-index="${userAnswers[currentQuestionIndex]}"]`);
                if (selectedOption) selectedOption.classList.add('selected');
            }

            updateNavigationButtons();
        }

        // ÏÑ†ÌÉùÏßÄ ÏÑ†ÌÉù
        function selectOption(optionIndex) {
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-index="${optionIndex}"]`).classList.add('selected');
            userAnswers[currentQuestionIndex] = optionIndex;
            updateNavigationButtons();
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
                updateLearningProgress();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
                updateLearningProgress();
            }
        }

        function updateLearningProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('learning-progress-bar').style.width = progress + '%';
            document.getElementById('learning-progress-text').textContent = `Î¨∏Ï†ú ${currentQuestionIndex + 1} / ${questions.length}`;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            prevBtn.disabled = currentQuestionIndex === 0;

            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
                submitBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
                nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
            }
        }

        // ÎãµÏïà Ï†úÏ∂ú
        function submitAnswers() {
            let correctCount = 0;
            questions.forEach((question, index) => {
                if (userAnswers[index] === question.correct) correctCount++;
            });

            const score = Math.round((correctCount / questions.length) * 100);

            if (score >= 70) {
                bookData.chapterList[currentChapterIndex].status = 'completed';
                if (currentChapterIndex < bookData.chapterList.length - 1) {
                    bookData.chapterList[currentChapterIndex + 1].status = 'current';
                }
            }

            showResults(correctCount, questions.length, score);
        }

        // Í≤∞Í≥º ÌëúÏãú
        function showResults(correct, total, score) {
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';

            document.getElementById('score-circle').textContent = score + '%';
            document.getElementById('total-questions').textContent = total + 'Î¨∏Ï†ú';
            document.getElementById('correct-answers').textContent = correct + 'Î¨∏Ï†ú';
            document.getElementById('wrong-answers').textContent = (total - correct) + 'Î¨∏Ï†ú';
            document.getElementById('final-score').textContent = score + 'Ï†ê';

            let message = '';
            if (score >= 90) message = 'ÌõåÎ•≠Ìï©ÎãàÎã§! üåü';
            else if (score >= 80) message = 'ÏûòÌñàÏñ¥Ïöî! üëè';
            else if (score >= 70) message = 'Ï¢ãÏïÑÏöî! üëç';
            else message = 'Îã§Ïãú ÌïúÎ≤à ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî! üí™';

            document.getElementById('result-message').textContent = message;
        }

        function retryChapter() {
            startLearning(currentChapterIndex);
        }

        function nextChapter() {
            if (currentChapterIndex < bookData.chapterList.length - 1) {
                startLearning(currentChapterIndex + 1);
            } else {
                alert('Î™®Îì† Ï±ïÌÑ∞Î•º ÏôÑÎ£åÌñàÏäµÎãàÎã§! üéâ');
                showBookDetail();
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú
        window.addEventListener('load', function() {
            showBookDetail();
            console.log('üö¢ Magic Tree House: Tonight on the Titanic ÌïôÏäµ ÏãúÏä§ÌÖúÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!');
        });

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        document.getElementById('audio-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAudioModal();
        });
    </script>
</body>
</html>