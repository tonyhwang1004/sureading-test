<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffalo Before Breakfast - Level 3 - ÏàòÎ¶¨Îî©Ïñ¥ÌïôÏõê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #CD853F 50%, #F4A460 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Ìó§Îçî */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #8B4513, #CD853F);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .logo-text p {
            font-size: 0.9rem;
            color: #666;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #333;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #8B4513;
            color: white;
            transform: translateY(-2px);
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        /* Ï±Ö ÏÉÅÏÑ∏ ÌôîÎ©¥ */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-size: 0.9rem;
            color: #666;
        }

        .breadcrumb a {
            color: #8B4513;
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .book-detail-header {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        .detail-book-cover {
            width: 150px;
            height: 220px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
            font-weight: bold;
            flex-shrink: 0;
            background: linear-gradient(45deg, #8B4513, #CD853F);
        }

        .book-info {
            flex: 1;
        }

        .book-info h2 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .book-info .author {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 20px;
        }

        .book-summary {
            font-size: 1rem;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .book-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #8B4513;
        }

        .stat-box .label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Ï±ïÌÑ∞ Í∑∏Î¶¨Îìú */
        .chapters-section {
            margin-top: 40px;
        }

        .chapters-section h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .chapter-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .chapter-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .chapter-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a74508, #ffffff);
        }

        .chapter-card.current {
            border-color: #8B4513;
            background: linear-gradient(135deg, #8B451308, #ffffff);
        }

        .chapter-card.locked {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .chapter-info h4 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .chapter-info p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
        }

        .chapter-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .chapter-status.completed {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .chapter-status.current {
            background: rgba(139, 69, 19, 0.1);
            color: #8B4513;
        }

        .chapter-status.locked {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .chapter-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .chapter-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .audio-btn {
            background: linear-gradient(45deg, #8B4513, #CD853F);
            color: white;
        }

        .quiz-btn {
            background: linear-gradient(45deg, #CD853F, #F4A460);
            color: white;
        }

        .chapter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .chapter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ÌïôÏäµ ÌôîÎ©¥ */
        .learning-screen {
            display: none;
        }

        .learning-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .learning-progress {
            background: #f8f9fa;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .learning-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8B4513, #CD853F);
            transition: width 0.3s ease;
        }

        .question-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .passage {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.6;
            color: #444;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #8B4513;
        }

        .option.selected {
            background: rgba(139, 69, 19, 0.1);
            border-color: #8B4513;
        }

        .learning-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .next-btn {
            background: linear-gradient(45deg, #8B4513, #CD853F);
            color: white;
        }

        .prev-btn {
            background: #6c757d;
            color: white;
        }

        .submit-btn {
            background: linear-gradient(45deg, #8B4513, #CD853F);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Í≤∞Í≥º ÌôîÎ©¥ */
        .result-screen {
            display: none;
            text-align: center;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8B4513, #CD853F);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .result-stat {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ Î™®Îã¨ */
        .audio-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .audio-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            position: relative;
        }

        .close-audio {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }

        .audio-player {
            width: 100%;
            margin: 20px 0;
            border-radius: 10px;
        }

        .audio-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .audio-control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-pause-btn {
            background: linear-gradient(45deg, #8B4513, #CD853F);
            color: white;
        }

        .speed-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .download-btn {
            background: #CD853F;
            color: white;
        }

        .audio-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .audio-info.hidden {
            display: none;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .chapters-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .book-detail-header {
                flex-direction: column;
                text-align: center;
            }

            .book-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .learning-controls {
                flex-direction: column;
            }

            .chapter-actions {
                grid-template-columns: 1fr;
            }

            .audio-controls {
                justify-content: center;
                gap: 10px;
            }

            .audio-content {
                padding: 30px 20px;
            }
        }

        .new-book-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(45deg, #FF6B9D, #C44569);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Level 3 ÌäπÎ≥Ñ Ïä§ÌÉÄÏùº */
        .level-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #FF6B00, #FF8E53);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ìó§Îçî -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ü¶¨</div>
                <div class="logo-text">
                    <h1>Buffalo Before Breakfast</h1>
                    <p>Level 3 - Mary Pope OsborneÏùò Îß§ÏßÅ Ìä∏Î¶¨ ÌïòÏö∞Ïä§ 18Í∂å</p>
                </div>
            </div>
            <div class="nav-buttons">
                <a href="http://www.suelibrary.store/" class="nav-btn">Î©îÏù∏ÏúºÎ°ú</a>
            </div>
        </div>

        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div class="main-content">
            <!-- Ï±Ö ÏÉÅÏÑ∏ ÌôîÎ©¥ -->
            <div class="book-detail-screen" id="book-detail-screen">
                <div class="level-badge">Level 3</div>
                <div class="breadcrumb">
                    <span>Buffalo Before Breakfast</span>
                </div>

                <div class="book-detail-header">
                    <div class="detail-book-cover">ü¶¨</div>
                    <div class="book-info">
                        <h2>Buffalo Before Breakfast</h2>
                        <div class="author">Mary Pope Osborne</div>
                        <div class="book-summary">
                            Jack and Annie travel to the Great Plains of 1870s America to help a Lakota grandmother find a sacred buffalo calf! They must learn about Native American culture, the importance of buffalo to Plains tribes, and witness the conflicts between settlers and Native Americans during the period of westward expansion.
                        </div>
                        <div class="book-stats">
                            <div class="stat-box">
                                <div class="value">10</div>
                                <div class="label">Ï±ïÌÑ∞</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">50</div>
                                <div class="label">Ï¥ù Î¨∏Ï†ú</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">Level 3</div>
                                <div class="label">Î†àÎ≤®</div>
                            </div>
                            <div class="stat-box">
                                <div class="value" id="progress-value">0%</div>
                                <div class="label">ÏßÑÎèÑ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chapters-section">
                    <h3>ü¶¨ Ï±ïÌÑ∞Î≥Ñ ÌïôÏäµ</h3>
                    <div class="chapters-grid" id="chapters-grid">
                        <!-- Ï±ïÌÑ∞ Ïπ¥ÎìúÎì§ -->
                    </div>
                </div>
            </div>

            <!-- ÌïôÏäµ ÌôîÎ©¥ -->
            <div class="learning-screen" id="learning-screen">
                <div class="breadcrumb">
                    <a onclick="showBookDetail()">Buffalo Before Breakfast</a>
                    <span>></span>
                    <span id="learning-chapter-breadcrumb">Chapter 1</span>
                </div>

                <div class="learning-header">
                    <h2 id="learning-title">Chapter 1: The Great Plains</h2>
                    <div class="learning-progress">
                        <div class="learning-progress-bar" id="learning-progress-bar" style="width: 0%"></div>
                    </div>
                    <p id="learning-progress-text">Î¨∏Ï†ú 1 / 5</p>
                </div>

                <div class="question-container" id="question-container">
                    <!-- Î¨∏Ï†úÍ∞Ä ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </div>

                <div class="learning-controls">
                    <button class="control-btn prev-btn" id="prev-btn" onclick="previousQuestion()" disabled>Ïù¥Ï†Ñ</button>
                    <button class="control-btn next-btn" id="next-btn" onclick="nextQuestion()">Îã§Ïùå</button>
                    <button class="control-btn submit-btn" id="submit-btn" onclick="submitAnswers()" style="display: none;">Ï†úÏ∂ú</button>
                </div>
            </div>

            <!-- Í≤∞Í≥º ÌôîÎ©¥ -->
            <div class="result-screen" id="result-screen">
                <div class="breadcrumb">
                    <a onclick="showBookDetail()">Buffalo Before Breakfast</a>
                    <span>></span>
                    <span>Í≤∞Í≥º</span>
                </div>

                <div class="result-header">
                    <h2>üéâ ÌïôÏäµ ÏôÑÎ£å!</h2>
                    <div class="score-circle" id="score-circle">100%</div>
                    <h3 id="result-message">ÌõåÎ•≠Ìï©ÎãàÎã§!</h3>
                </div>

                <div class="result-details">
                    <div class="result-stat">
                        <h4>Ï¥ù Î¨∏Ï†ú</h4>
                        <p id="total-questions">5Î¨∏Ï†ú</p>
                    </div>
                    <div class="result-stat">
                        <h4>Ï†ïÎãµ</h4>
                        <p id="correct-answers">5Î¨∏Ï†ú</p>
                    </div>
                    <div class="result-stat">
                        <h4>Ïò§Îãµ</h4>
                        <p id="wrong-answers">0Î¨∏Ï†ú</p>
                    </div>
                    <div class="result-stat">
                        <h4>Ï†êÏàò</h4>
                        <p id="final-score">100Ï†ê</p>
                    </div>
                </div>

                <div class="result-actions">
                    <button class="control-btn prev-btn" onclick="retryChapter()">Îã§Ïãú ÌíÄÍ∏∞</button>
                    <button class="control-btn next-btn" onclick="nextChapter()">Îã§Ïùå Ï±ïÌÑ∞</button>
                    <button class="control-btn submit-btn" onclick="showBookDetail()">Ï±ïÌÑ∞ Î™©Î°ù</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ Î™®Îã¨ -->
    <div class="audio-modal" id="audio-modal">
        <div class="audio-content">
            <button class="close-audio" onclick="closeAudioModal()">√ó</button>
            <h3 id="audio-chapter-title">Chapter 1: The Great Plains</h3>
            <p id="audio-chapter-subtitle">Buffalo Before Breakfast - Mary Pope Osborne</p>

            <audio class="audio-player" id="audio-player" controls preload="metadata">
                <source id="audio-source" src="" type="audio/mpeg">
                Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ïò§ÎîîÏò§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.
            </audio>

            <div class="audio-controls">
                <button class="audio-control-btn play-pause-btn" onclick="togglePlayPause()">‚ñ∂Ô∏è Ïû¨ÏÉù</button>
                <button class="audio-control-btn speed-btn" onclick="changeSpeed()">1.0x</button>
                <button class="audio-control-btn" onclick="resetToChapterStart()" style="background: #28a745; color: white;">üîÑ Íµ¨Í∞ÑÏ≤òÏùå</button>
                <button class="audio-control-btn download-btn" onclick="downloadAudio()">üì• Îã§Ïö¥Î°úÎìú</button>
            </div>

            <div class="audio-info" id="audio-info">
                <div id="audio-status" style="margin-top: 10px; font-weight: bold; color: #8B4513;"></div>
            </div>
        </div>
    </div>

    <script>
        // üéØ Íµ¨Í∏Ä ÌÅ¥ÎùºÏö∞Îìú Ïä§ÌÜ†Î¶¨ÏßÄ Ïò§ÎîîÏò§ URL ÏÑ§Ï†ï
        const AUDIO_BASE_URL = 'https://storage.googleapis.com/kim-mom-reading-audio/audio/';

        // Magic Tree House 18Í∂å ÎèÑÏÑú Îç∞Ïù¥ÌÑ∞ (10Ï±ïÌÑ∞)
        const bookData = {
            id: 'MTH018',
            title: "Buffalo Before Breakfast",
            author: 'Mary Pope Osborne',
            cover: 'ü¶¨',
            progress: 0,
            chapters: 10,
            totalQuestions: 50, // 10Ï±ïÌÑ∞ √ó 5Î¨∏Ï†ú
            coverColor: 'linear-gradient(45deg, #8B4513, #CD853F)',
            summary: "Jack and Annie travel to the Great Plains of 1870s America to help a Lakota grandmother find a sacred buffalo calf! They must learn about Native American culture, the importance of buffalo to Plains tribes, and witness the conflicts between settlers and Native Americans during the period of westward expansion.",
            chapterList: [
                { title: 'The Great Plains', description: 'Jack and Annie arrive on the vast Great Plains of 1870s America.', status: 'current', questionCount: 5, startTime: 0 },
                { title: 'The Lakota Camp', description: 'They discover a Lakota Native American camp and learn about their culture.', status: 'locked', questionCount: 5, startTime: 300 },
                { title: 'Grandmother Spider', description: 'They meet an elderly Lakota grandmother who needs their help.', status: 'locked', questionCount: 5, startTime: 600 },
                { title: 'Sacred Buffalo Calf', description: 'They learn about the sacred white buffalo calf that is missing.', status: 'locked', questionCount: 5, startTime: 900 },
                { title: 'Horse Riders', description: 'They ride horses across the plains searching for the buffalo calf.', status: 'locked', questionCount: 5, startTime: 1200 },
                { title: 'The Buffalo Hunters', description: 'They encounter hunters threatening the buffalo herds.', status: 'locked', questionCount: 5, startTime: 1500 },
                { title: 'The Storm', description: 'A fierce prairie storm tests their courage and determination.', status: 'locked', questionCount: 5, startTime: 1800 },
                { title: 'The Hidden Valley', description: 'They discover a hidden valley where the buffalo calf is safe.', status: 'locked', questionCount: 5, startTime: 2100 },
                { title: 'The Sacred Circle', description: 'They participate in a Lakota ceremony honoring the buffalo.', status: 'locked', questionCount: 5, startTime: 2400 },
                { title: 'The Gift of Thanks', description: 'They return home with a deeper understanding of Native American culture.', status: 'locked', questionCount: 5, startTime: 2700 }
            ]
        };

        // Î¨∏Ï†ú Îç∞Ïù¥ÌÑ∞ (Ï†ÑÏ≤¥ 10Ï±ïÌÑ∞ ÏôÑÎ£å)
        const questionsData = {
            0: [ // Chapter 1: The Great Plains
                {
                    passage: "Jack and Annie found themselves on the vast Great Plains of America in the 1870s, surrounded by endless grasslands stretching to the horizon.",
                    question: "Where did Jack and Annie find themselves?",
                    options: ["In a forest", "On the vast Great Plains of 1870s America with endless grasslands", "In a city", "On a mountain"],
                    correct: 1
                },
                {
                    passage: "The prairie was home to massive herds of American buffalo, also called bison, which numbered in the millions at that time.",
                    question: "What animals lived on the prairie in large numbers?",
                    options: ["Horses", "American buffalo (bison) numbering in the millions", "Cattle", "Sheep"],
                    correct: 1
                },
                {
                    passage: "They could see teepees in the distance, indicating that Native American tribes made their homes on these vast grasslands.",
                    question: "What did they see in the distance that showed Native Americans lived there?",
                    options: ["Log cabins", "Teepees indicating Native American tribes lived there", "Stone houses", "Modern buildings"],
                    correct: 1
                },
                {
                    passage: "The Great Plains were known for their extreme weather, including fierce thunderstorms, blizzards, and tornadoes that could appear suddenly.",
                    question: "What was the Great Plains known for regarding weather?",
                    options: ["Always perfect weather", "Extreme weather including storms, blizzards, and tornadoes", "Only mild rain", "Constant sunshine"],
                    correct: 1
                },
                {
                    passage: "Jack read that this period was a time of great change, as settlers were moving west and conflicts with Native Americans were increasing.",
                    question: "What was happening during this time period on the Great Plains?",
                    options: ["Nothing was changing", "Great change with settlers moving west and increasing conflicts", "Everyone was peaceful", "Only Native Americans lived there"],
                    correct: 1
                }
            ],
            1: [ // Chapter 2: The Lakota Camp
                {
                    passage: "Jack and Annie approached a Lakota camp with beautiful teepees decorated with painted designs and symbols representing their spiritual beliefs.",
                    question: "What did the Lakota teepees look like?",
                    options: ["Plain and simple", "Beautiful with painted designs and spiritual symbols", "Made of stone", "Very small"],
                    correct: 1
                },
                {
                    passage: "They observed that the Lakota people lived in harmony with nature, using every part of the buffalo for food, clothing, shelter, and tools.",
                    question: "How did the Lakota people live with nature?",
                    options: ["They avoided nature", "In harmony, using every part of buffalo for food, clothing, shelter, tools", "They destroyed everything", "They lived separately from animals"],
                    correct: 1
                },
                {
                    passage: "The children in the camp were learning traditional skills like hunting, beadwork, and storytelling that preserved their cultural heritage.",
                    question: "What were Lakota children learning in the camp?",
                    options: ["Modern subjects only", "Traditional skills like hunting, beadwork, storytelling", "Nothing at all", "Only games"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie learned that the Lakota had a deep spiritual connection to the land and believed all living things were interconnected.",
                    question: "What did the Lakota believe about living things?",
                    options: ["Nothing was connected", "All living things were interconnected with deep spiritual connection to land", "Only humans mattered", "Animals were enemies"],
                    correct: 1
                },
                {
                    passage: "The camp was organized in a circle, which represented the sacred hoop of life and the continuous cycle of nature.",
                    question: "How was the Lakota camp organized and why?",
                    options: ["In straight lines", "In a circle representing the sacred hoop of life and nature's cycle", "Randomly scattered", "In a square"],
                    correct: 1
                }
            ],
            2: [ // Chapter 3: Grandmother Spider
                {
                    passage: "Jack and Annie met an elderly Lakota woman known as Grandmother Spider, who was respected for her wisdom and spiritual knowledge.",
                    question: "Who did Jack and Annie meet in the Lakota camp?",
                    options: ["A young warrior", "Grandmother Spider, an elderly woman respected for wisdom", "A chief", "A child"],
                    correct: 1
                },
                {
                    passage: "Grandmother Spider told them that her name came from the spider's ability to weave intricate webs, just as she wove stories and wisdom together.",
                    question: "Why was she called Grandmother Spider?",
                    options: ["She was afraid of spiders", "Like spiders weave webs, she wove stories and wisdom together", "She looked like a spider", "She caught spiders"],
                    correct: 1
                },
                {
                    passage: "She explained that she needed help finding a sacred white buffalo calf that had disappeared from the herd and was very important to her people.",
                    question: "What help did Grandmother Spider need?",
                    options: ["Finding her lost horse", "Finding a sacred white buffalo calf important to her people", "Building a new teepee", "Cooking food"],
                    correct: 1
                },
                {
                    passage: "The white buffalo calf was considered sacred because white buffalo were extremely rare and believed to bring good fortune and spiritual power.",
                    question: "Why was the white buffalo calf considered sacred?",
                    options: ["It was very large", "White buffalo were extremely rare and brought good fortune and spiritual power", "It was the oldest", "It was very fast"],
                    correct: 1
                },
                {
                    passage: "Grandmother Spider told them that finding the calf would help preserve the spiritual balance between her people and the natural world.",
                    question: "What would finding the calf help preserve?",
                    options: ["Their food supply", "The spiritual balance between her people and the natural world", "Their horses", "Their teepees"],
                    correct: 1
                }
            ],
            3: [ // Chapter 4: Sacred Buffalo Calf
                {
                    passage: "Grandmother Spider explained that the white buffalo calf represented hope and renewal for the Lakota people during these difficult times.",
                    question: "What did the white buffalo calf represent for the Lakota people?",
                    options: ["Fear and danger", "Hope and renewal during difficult times", "Anger and war", "Nothing special"],
                    correct: 1
                },
                {
                    passage: "She told them that buffalo were the foundation of Plains Indian life, providing meat for food, hides for clothing and shelter, and bones for tools.",
                    question: "How were buffalo important to Plains Indians?",
                    options: ["Only for decoration", "Foundation of life: meat for food, hides for clothing/shelter, bones for tools", "Just for hunting practice", "Not important at all"],
                    correct: 1
                },
                {
                    passage: "The legend said that White Buffalo Calf Woman had given the Lakota people the sacred pipe and taught them important spiritual ceremonies.",
                    question: "What did White Buffalo Calf Woman give the Lakota according to legend?",
                    options: ["Horses and weapons", "The sacred pipe and taught them spiritual ceremonies", "Gold and jewels", "Modern tools"],
                    correct: 1
                },
                {
                    passage: "Grandmother Spider worried that the increasing number of buffalo hunters was threatening the herds that her people depended on for survival.",
                    question: "What was Grandmother Spider worried about?",
                    options: ["Bad weather", "Buffalo hunters threatening herds her people depended on", "Lack of water", "Enemy tribes"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie learned that the arrival of railroads and settlers was disrupting the traditional way of life for Native American tribes.",
                    question: "What was disrupting the traditional Native American way of life?",
                    options: ["Natural disasters", "The arrival of railroads and settlers", "Disease only", "Other tribes"],
                    correct: 1
                }
            ],
            4: [ // Chapter 5: Horse Riders
                {
                    passage: "Grandmother Spider gave Jack and Annie horses to ride as they searched for the missing white buffalo calf across the vast prairie.",
                    question: "How did Jack and Annie search for the buffalo calf?",
                    options: ["On foot", "On horses given by Grandmother Spider across the prairie", "In a wagon", "By flying"],
                    correct: 1
                },
                {
                    passage: "They learned that horses had transformed Plains Indian life, allowing them to hunt buffalo more effectively and travel great distances.",
                    question: "How had horses transformed Plains Indian life?",
                    options: ["Made life harder", "Allowed more effective buffalo hunting and long-distance travel", "Had no impact", "Only caused problems"],
                    correct: 1
                },
                {
                    passage: "As they rode, they saw enormous herds of buffalo stretching as far as the eye could see, covering the prairie like a brown sea.",
                    question: "What did they see as they rode across the prairie?",
                    options: ["Empty grassland", "Enormous buffalo herds stretching far, covering prairie like a brown sea", "Only small animals", "Nothing but grass"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie marveled at how the Lakota riders moved in perfect harmony with their horses, appearing to be one with the animals.",
                    question: "What impressed Jack and Annie about Lakota riders?",
                    options: ["They rode slowly", "They moved in perfect harmony with horses, appearing as one", "They fell off frequently", "They were afraid of horses"],
                    correct: 1
                },
                {
                    passage: "The prairie seemed endless and wild, with tall grasses waving in the wind and the vast sky stretching overhead like a blue dome.",
                    question: "How did the prairie appear to Jack and Annie?",
                    options: ["Small and confined", "Endless and wild with tall grasses and vast sky like a blue dome", "Full of trees", "Covered with buildings"],
                    correct: 1
                }
            ],
            5: [ // Chapter 6: The Buffalo Hunters
                {
                    passage: "Jack and Annie encountered professional buffalo hunters with powerful rifles who were killing buffalo for their hides and leaving the meat to rot.",
                    question: "What were the buffalo hunters doing that was wasteful?",
                    options: ["Using every part of the buffalo", "Killing buffalo for hides and leaving meat to rot", "Protecting the buffalo", "Only hunting for food"],
                    correct: 1
                },
                {
                    passage: "The hunters explained that they were paid by Eastern companies to supply buffalo hides for leather goods, but they cared nothing about conservation.",
                    question: "Why were the hunters killing so many buffalo?",
                    options: ["For their own food", "Paid by Eastern companies for hides, didn't care about conservation", "To protect settlers", "For sport only"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie witnessed the tragic contrast between the Lakota's respectful use of buffalo and the hunters' wasteful slaughter.",
                    question: "What contrast did Jack and Annie witness?",
                    options: ["No difference in hunting methods", "Lakota's respectful use versus hunters' wasteful slaughter", "Everyone hunted the same way", "Only differences in weapons"],
                    correct: 1
                },
                {
                    passage: "They learned that this massive killing was part of a deliberate strategy to force Native Americans onto reservations by destroying their food source.",
                    question: "What was the real purpose behind the massive buffalo killing?",
                    options: ["Just for profit", "Deliberate strategy to force Native Americans onto reservations", "To feed settlers", "To clear land for farming"],
                    correct: 1
                },
                {
                    passage: "The hunters warned Jack and Annie that the buffalo herds would be gone within a few years if the killing continued at this rate.",
                    question: "What did the hunters predict about the buffalo herds?",
                    options: ["They would increase", "They would be gone within a few years at this killing rate", "They would stay the same", "They would move somewhere else"],
                    correct: 1
                }
            ],
            6: [ // Chapter 7: The Storm
                {
                    passage: "A fierce prairie thunderstorm suddenly appeared on the horizon, with dark clouds, lightning, and strong winds threatening Jack and Annie.",
                    question: "What natural danger appeared while they were searching?",
                    options: ["A gentle rain", "A fierce prairie thunderstorm with dark clouds and lightning", "A light breeze", "Nothing dangerous"],
                    correct: 1
                },
                {
                    passage: "They took shelter in a small ravine as hail the size of marbles pelted the ground and lightning flashed across the darkened sky.",
                    question: "How did Jack and Annie protect themselves from the storm?",
                    options: ["They kept riding", "Took shelter in a small ravine as marble-sized hail fell", "Climbed a tree", "Built a fort"],
                    correct: 1
                },
                {
                    passage: "During the storm, they worried about the white buffalo calf and whether it had found safe shelter from the dangerous weather.",
                    question: "What did Jack and Annie worry about during the storm?",
                    options: ["Only themselves", "Whether the white buffalo calf had found safe shelter", "Their horses only", "Getting wet"],
                    correct: 1
                },
                {
                    passage: "The storm demonstrated the power and unpredictability of nature on the Great Plains, where weather could change in minutes.",
                    question: "What did the storm demonstrate about the Great Plains?",
                    options: ["Weather was always calm", "The power and unpredictability of nature, weather changing in minutes", "Storms never happened", "Weather was always the same"],
                    correct: 1
                },
                {
                    passage: "After the storm passed, they saw a rainbow arcing across the sky, which they hoped was a good sign for finding the sacred calf.",
                    question: "What appeared after the storm that gave them hope?",
                    options: ["More dark clouds", "A rainbow arcing across the sky as a good sign", "More lightning", "Nothing special"],
                    correct: 1
                }
            ],
            7: [ // Chapter 8: The Hidden Valley
                {
                    passage: "Following the rainbow, Jack and Annie discovered a hidden valley protected by hills where the white buffalo calf was grazing peacefully.",
                    question: "Where did Jack and Annie find the white buffalo calf?",
                    options: ["On the open prairie", "In a hidden valley protected by hills where it grazed peacefully", "In the Lakota camp", "Near the hunters"],
                    correct: 1
                },
                {
                    passage: "The valley was like a secret paradise with fresh water, green grass, and protection from both storms and hunters.",
                    question: "What was special about the hidden valley?",
                    options: ["It was empty and dry", "Like a secret paradise with water, grass, and protection from storms/hunters", "It was dangerous", "Nothing was special"],
                    correct: 1
                },
                {
                    passage: "The white buffalo calf was even more beautiful than they had imagined, with pure white fur that seemed to glow in the sunlight.",
                    question: "How did the white buffalo calf appear to Jack and Annie?",
                    options: ["Ordinary looking", "More beautiful than imagined with pure white fur glowing in sunlight", "Sick and weak", "Very small"],
                    correct: 1
                },
                {
                    passage: "They realized that the calf had found this safe haven instinctively, guided by the same natural wisdom that helped all wild animals survive.",
                    question: "How had the white buffalo calf found this safe place?",
                    options: ["By accident", "Instinctively, guided by natural wisdom that helps wild animals survive", "Someone led it there", "It was lost"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie felt privileged to witness this sacred animal in its natural habitat, understanding why it was so important to the Lakota people.",
                    question: "How did Jack and Annie feel about seeing the white buffalo calf?",
                    options: ["Bored and uninterested", "Privileged to witness this sacred animal, understanding its importance", "Afraid and worried", "Disappointed"],
                    correct: 1
                }
            ],
            8: [ // Chapter 9: The Sacred Circle
                {
                    passage: "Jack and Annie carefully guided the white buffalo calf back to the Lakota camp, where Grandmother Spider was waiting with tears of joy.",
                    question: "What happened when they brought the calf back to camp?",
                    options: ["No one cared", "Grandmother Spider was waiting with tears of joy", "Everyone was angry", "The camp was empty"],
                    correct: 1
                },
                {
                    passage: "The entire Lakota community gathered in a sacred circle to welcome the white buffalo calf and give thanks for its safe return.",
                    question: "How did the Lakota community respond to the calf's return?",
                    options: ["They ignored it", "Gathered in a sacred circle to welcome it and give thanks", "They were afraid", "Only a few people came"],
                    correct: 1
                },
                {
                    passage: "Grandmother Spider led a ceremony honoring the buffalo and asking for continued harmony between her people and the natural world.",
                    question: "What ceremony did Grandmother Spider lead?",
                    options: ["A war dance", "A ceremony honoring buffalo and asking for harmony with nature", "A harvest festival", "A wedding ceremony"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie participated in the ceremony, learning about the deep spiritual connection between the Lakota people and all living creatures.",
                    question: "What did Jack and Annie learn from participating in the ceremony?",
                    options: ["Nothing important", "The deep spiritual connection between Lakota people and all living creatures", "Only hunting techniques", "How to make crafts"],
                    correct: 1
                },
                {
                    passage: "The ceremony reminded everyone that all life was sacred and that taking from nature should always be balanced with gratitude and respect.",
                    question: "What important lesson did the ceremony teach?",
                    options: ["Take whatever you want", "All life is sacred, taking from nature should be balanced with gratitude/respect", "Only humans matter", "Animals are not important"],
                    correct: 1
                }
            ],
            9: [ // Chapter 10: The Gift of Thanks
                {
                    passage: "Before leaving, Grandmother Spider gave Jack and Annie a beautiful beaded pouch as a gift to remember their time with the Lakota people.",
                    question: "What gift did Grandmother Spider give Jack and Annie?",
                    options: ["A horse", "A beautiful beaded pouch to remember their time with Lakota", "A weapon", "Food"],
                    correct: 1
                },
                {
                    passage: "She told them that they had learned the most important lesson: that showing respect for all living things creates harmony in the world.",
                    question: "What important lesson did Grandmother Spider say they had learned?",
                    options: ["How to hunt buffalo", "Showing respect for all living things creates harmony", "How to ride horses", "How to make teepees"],
                    correct: 1
                },
                {
                    passage: "Back in the tree house, Jack and Annie reflected on how the buffalo represented the connection between Native Americans and the natural world.",
                    question: "What did Jack and Annie reflect on about the buffalo?",
                    options: ["How dangerous they were", "How buffalo represented connection between Native Americans and nature", "How to hunt them", "How big they were"],
                    correct: 1
                },
                {
                    passage: "They understood that the destruction of the buffalo herds was not just about animals, but about destroying a way of life and spiritual beliefs.",
                    question: "What did they understand about the destruction of buffalo herds?",
                    options: ["It was only about animals", "It destroyed a way of life and spiritual beliefs, not just animals", "It was necessary", "It didn't matter"],
                    correct: 1
                },
                {
                    passage: "Jack and Annie realized they had learned about the importance of living in balance with nature and respecting different cultures and ways of life.",
                    question: "What final lesson did Jack and Annie learn from their adventure?",
                    options: ["Nothing important", "Importance of living in balance with nature and respecting different cultures", "Only about buffalo", "How to survive storms"],
                    correct: 1
                }
            ]
        };

        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentChapterIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questions = [];
        let currentAudio = null;
        let playbackSpeed = 1.0;

        // üéß ÏûêÎèô Ïò§ÎîîÏò§ URL ÏÉùÏÑ± Ìï®Ïàò
        function getAudioUrl(chapterIndex) {
            const level = 'level3';
            const bookId = 'MTH018';
            const chapterNum = String(chapterIndex + 1).padStart(2, '0');
            
            const possibleFileNames = [
                `${bookId}_chapter${chapterNum}.mp3`,
                `${bookId}_ch${chapterNum}.mp3`,
                `${bookId}_${chapterNum}.mp3`,
                `magic_tree_house_18_chapter${chapterNum}.mp3`,
                `magic_tree_house_18_ch${chapterNum}.mp3`,
                `buffalo_before_breakfast_${chapterNum}.mp3`,
                `mary_pope_osborne_18_chapter${chapterNum}.mp3`,
                `${bookId}.mp3`
            ];
            
            return {
                primary: `${AUDIO_BASE_URL}${level}/${possibleFileNames[0]}`,
                alternatives: possibleFileNames.map(fileName => `${AUDIO_BASE_URL}${level}/${fileName}`)
            };
        }

        // üéß Ïò§ÎîîÏò§ Ïû¨ÏÉù Ìï®Ïàò
        function playChapterAudio(chapterIndex) {
            const chapter = bookData.chapterList[chapterIndex];
            const audioUrls = getAudioUrl(chapterIndex);

            document.getElementById('audio-modal').style.display = 'flex';
            document.getElementById('audio-chapter-title').textContent = `Chapter ${chapterIndex + 1}: ${chapter.title}`;
            document.getElementById('audio-chapter-subtitle').textContent = `${bookData.title} - ${bookData.author}`;

            // Ïò§ÎîîÏò§ Ï†ïÎ≥¥ ÏòÅÏó≠ Îã§Ïãú Î≥¥Ïù¥Í∏∞ (ÏÉàÎ°úÏö¥ Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïãú)
            document.getElementById('audio-info').classList.remove('hidden');

            const audioPlayer = document.getElementById('audio-player');
            const audioSource = document.getElementById('audio-source');
            const audioStatus = document.getElementById('audio-status');

            audioStatus.textContent = 'üîÑ Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ï∞æÎäî Ï§ë...';

            function tryLoadAudio(urlIndex = 0) {
                if (urlIndex >= audioUrls.alternatives.length) {
                    audioStatus.innerHTML = `‚ùå Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`;
                    return;
                }

                const currentUrl = audioUrls.alternatives[urlIndex];
                audioSource.src = currentUrl;
                audioPlayer.load();

                const successHandler = function() {
                    const startTime = chapter.startTime || 0;
                    audioPlayer.currentTime = startTime;
                    audioStatus.innerHTML = `‚úÖ Ïò§ÎîîÏò§ Ï§ÄÎπÑ ÏôÑÎ£å!`;
                };

                const errorHandler = function() {
                    setTimeout(() => tryLoadAudio(urlIndex + 1), 100);
                };

                audioPlayer.addEventListener('canplaythrough', successHandler, { once: true });
                audioPlayer.addEventListener('error', errorHandler, { once: true });
            }

            tryLoadAudio(0);
            currentAudio = audioPlayer;
            playbackSpeed = 1.0;
        }

        // Í∏∞Î≥∏ Ìï®ÏàòÎì§
        function closeAudioModal() {
            document.getElementById('audio-modal').style.display = 'none';
            if (currentAudio) currentAudio.pause();
        }

        function togglePlayPause() {
            if (!currentAudio) return;
            if (currentAudio.paused) {
                currentAudio.play();
                document.querySelector('.play-pause-btn').textContent = '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ';
            } else {
                currentAudio.pause();
                document.querySelector('.play-pause-btn').textContent = '‚ñ∂Ô∏è Ïû¨ÏÉù';
            }
        }

        function changeSpeed() {
            if (!currentAudio) return;
            const speeds = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
            const currentIndex = speeds.indexOf(playbackSpeed);
            playbackSpeed = speeds[(currentIndex + 1) % speeds.length];
            currentAudio.playbackRate = playbackSpeed;
            document.querySelector('.speed-btn').textContent = `${playbackSpeed}x`;
        }

        function resetToChapterStart() {
            if (!currentAudio) return;
            const currentChapter = parseInt(document.getElementById('audio-chapter-title').textContent.match(/Chapter (\d+)/)[1]) - 1;
            currentAudio.currentTime = bookData.chapterList[currentChapter]?.startTime || 0;
        }

        function downloadAudio() {
            const audioSource = document.getElementById('audio-source');
            if (audioSource.src) {
                const link = document.createElement('a');
                link.href = audioSource.src;
                link.download = `${document.getElementById('audio-chapter-title').textContent}.mp3`;
                link.click();
            }
        }

        // Ï±Ö ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
        function showBookDetail() {
            document.getElementById('book-detail-screen').style.display = 'block';
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            generateChapterGrid();
            updateProgress();
        }

        // Ï±ïÌÑ∞ Í∑∏Î¶¨Îìú ÏÉùÏÑ±
        function generateChapterGrid() {
            const grid = document.getElementById('chapters-grid');
            grid.innerHTML = '';

            bookData.chapterList.forEach((chapter, index) => {
                const chapterCard = document.createElement('div');
                chapterCard.className = `chapter-card ${chapter.status}`;

                chapterCard.innerHTML = `
                    <div class="chapter-header">
                        <div class="chapter-info">
                            <h4>Chapter ${index + 1}: ${chapter.title}</h4>
                            <p>${chapter.description} (${chapter.questionCount}Î¨∏Ï†ú)</p>
                        </div>
                        <div class="chapter-status ${chapter.status}">
                            ${chapter.status === 'completed' ? '‚úÖ ÏôÑÎ£å' :
                              chapter.status === 'current' ? 'üìñ ÏßÑÌñâÏ§ë' : 'üîí Ïû†ÍπÄ'}
                        </div>
                    </div>
                    <div class="chapter-actions">
                        <button class="chapter-btn audio-btn" onclick="playChapterAudio(${index})"
                                ${chapter.status === 'locked' ? 'disabled' : ''}>
                            üéß Ïò§ÎîîÏò§
                        </button>
                        <button class="chapter-btn quiz-btn" onclick="startLearning(${index})"
                                ${chapter.status === 'locked' ? 'disabled' : ''}>
                            üìù Î¨∏Ï†úÌíÄÍ∏∞
                        </button>
                    </div>
                `;

                grid.appendChild(chapterCard);
            });
        }

        // ÏßÑÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateProgress() {
            const completedChapters = bookData.chapterList.filter(chapter => chapter.status === 'completed').length;
            const progress = Math.round((completedChapters / bookData.chapters) * 100);
            document.getElementById('progress-value').textContent = progress + '%';
        }

        // ÌïôÏäµ ÏãúÏûë
        function startLearning(chapterIndex) {
            currentChapterIndex = chapterIndex;
            currentQuestionIndex = 0;
            userAnswers = [];
            questions = questionsData[chapterIndex];

            if (!questions || questions.length === 0) {
                alert('Ïù¥ Ï±ïÌÑ∞Ïùò Î¨∏Ï†úÍ∞Ä ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }

            document.getElementById('book-detail-screen').style.display = 'none';
            document.getElementById('learning-screen').style.display = 'block';
            document.getElementById('result-screen').style.display = 'none';

            const chapter = bookData.chapterList[chapterIndex];
            document.getElementById('learning-title').textContent = `Chapter ${chapterIndex + 1}: ${chapter.title}`;
            document.getElementById('learning-chapter-breadcrumb').textContent = `Chapter ${chapterIndex + 1}`;

            showQuestion();
            updateLearningProgress();
        }

        // Î¨∏Ï†ú ÌëúÏãú
        function showQuestion() {
            const question = questions[currentQuestionIndex];
            const container = document.getElementById('question-container');

            container.innerHTML = `
                <div class="question-text">Î¨∏Ï†ú ${currentQuestionIndex + 1}</div>
                <div class="passage">${question.passage}</div>
                <div class="question-text">${question.question}</div>
                <div class="options">
                    ${question.options.map((option, index) =>
                        `<div class="option" onclick="selectOption(${index})" data-index="${index}">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </div>`
                    ).join('')}
                </div>
            `;

            if (userAnswers[currentQuestionIndex] !== undefined) {
                const selectedOption = container.querySelector(`[data-index="${userAnswers[currentQuestionIndex]}"]`);
                if (selectedOption) selectedOption.classList.add('selected');
            }

            updateNavigationButtons();
        }

        // ÏÑ†ÌÉùÏßÄ ÏÑ†ÌÉù
        function selectOption(optionIndex) {
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-index="${optionIndex}"]`).classList.add('selected');
            userAnswers[currentQuestionIndex] = optionIndex;
            updateNavigationButtons();
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
                updateLearningProgress();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
                updateLearningProgress();
            }
        }

        function updateLearningProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('learning-progress-bar').style.width = progress + '%';
            document.getElementById('learning-progress-text').textContent = `Î¨∏Ï†ú ${currentQuestionIndex + 1} / ${questions.length}`;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            prevBtn.disabled = currentQuestionIndex === 0;

            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
                submitBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
                nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
            }
        }

        // ÎãµÏïà Ï†úÏ∂ú
        function submitAnswers() {
            let correctCount = 0;
            questions.forEach((question, index) => {
                if (userAnswers[index] === question.correct) correctCount++;
            });

            const score = Math.round((correctCount / questions.length) * 100);

            if (score >= 70) {
                bookData.chapterList[currentChapterIndex].status = 'completed';
                if (currentChapterIndex < bookData.chapterList.length - 1) {
                    bookData.chapterList[currentChapterIndex + 1].status = 'current';
                }
            }

            showResults(correctCount, questions.length, score);
        }

        // Í≤∞Í≥º ÌëúÏãú
        function showResults(correct, total, score) {
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';

            document.getElementById('score-circle').textContent = score + '%';
            document.getElementById('total-questions').textContent = total + 'Î¨∏Ï†ú';
            document.getElementById('correct-answers').textContent = correct + 'Î¨∏Ï†ú';
            document.getElementById('wrong-answers').textContent = (total - correct) + 'Î¨∏Ï†ú';
            document.getElementById('final-score').textContent = score + 'Ï†ê';

            let message = '';
            if (score >= 90) message = 'ÌõåÎ•≠Ìï©ÎãàÎã§! üåü';
            else if (score >= 80) message = 'ÏûòÌñàÏñ¥Ïöî! üëè';
            else if (score >= 70) message = 'Ï¢ãÏïÑÏöî! üëç';
            else message = 'Îã§Ïãú ÌïúÎ≤à ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî! üí™';

            document.getElementById('result-message').textContent = message;
        }

        function retryChapter() {
            startLearning(currentChapterIndex);
        }

        function nextChapter() {
            if (currentChapterIndex < bookData.chapterList.length - 1) {
                startLearning(currentChapterIndex + 1);
            } else {
                alert('Î™®Îì† Ï±ïÌÑ∞Î•º ÏôÑÎ£åÌñàÏäµÎãàÎã§! üéâ');
                showBookDetail();
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú
        window.addEventListener('load', function() {
            showBookDetail();
            console.log('ü¶¨ Magic Tree House: Buffalo Before Breakfast ÌïôÏäµ ÏãúÏä§ÌÖúÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!');
        });

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        document.getElementById('audio-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAudioModal();
        });
    </script>
</body>
</html>