<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ìˆ˜ë¦¬ë”©ì–´í•™ì› (í…ŒìŠ¤íŠ¸ ë²„ì „)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 0 25px 10px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.6;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #3498db;
        }

        .nav-item i {
            width: 20px;
            margin-right: 15px;
            font-size: 1.1rem;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: #f8f9fa;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            display: none;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .content-area {
            padding: 30px;
        }

        /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            animation: iconPulse 3s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stat-icon.students { background: linear-gradient(45deg, #3498db, #2980b9); }
        .stat-icon.books { background: linear-gradient(45deg, #e67e22, #d35400); }
        .stat-icon.sessions { background: linear-gradient(45deg, #2ecc71, #27ae60); }
        .stat-icon.accuracy { background: linear-gradient(45deg, #9b59b6, #8e44ad); }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .stat-change {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .stat-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .stat-change.warning {
            background: #fff3cd;
            color: #856404;
        }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-filters {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .data-table-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            margin-bottom: 40px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 8px 35px 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .export-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-size: 0.95rem;
            color: #495057;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* í•™ìƒ ìƒíƒœ ë°°ì§€ */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.new {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* ë ˆë²¨ ë°°ì§€ */
        .level-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            min-width: 60px;
            text-align: center;
        }

        .level-badge.level-1 { background: #28a745; }
        .level-badge.level-2 { background: #17a2b8; }
        .level-badge.level-3 { background: #ffc107; color: #212529; }
        .level-badge.level-4 { background: #fd7e14; }
        .level-badge.level-5 { background: #dc3545; }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-btn {
            background: transparent;
            border: 1px solid #dee2e6;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .action-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .action-btn.view {
            color: #17a2b8;
            border-color: #17a2b8;
        }

        .action-btn.edit {
            color: #ffc107;
            border-color: #ffc107;
        }

        .action-btn.delete {
            color: #dc3545;
            border-color: #dc3545;
        }

        .action-btn.approve {
            color: #28a745;
            border-color: #28a745;
        }

        .action-btn.reject {
            color: #dc3545;
            border-color: #dc3545;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¸ë””ì¼€ì´í„° */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #d4edda;
            color: #155724;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            position: relative;
            animation: slideInDown 0.3s ease;
        }

        @keyframes slideInDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-left: 15px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
        }

        .refresh-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .test-panel {
            position: fixed;
            top: 20px;
            right: -300px;
            width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 2000;
            transition: right 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .test-panel.open {
            right: 20px;
        }

        .test-panel-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 2001;
        }

        .test-panel-toggle:hover {
            transform: scale(1.1);
        }

        .test-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .test-btn {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .test-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .test-btn.success {
            background: #27ae60;
        }

        .test-btn.danger {
            background: #e74c3c;
        }

        .api-status {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 10px;
            border-left: 3px solid #3498db;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .sidebar-toggle {
                display: block;
            }

            .chart-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                padding: 15px 20px;
            }

            .content-area {
                padding: 20px 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .table-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
            }

            .test-panel {
                width: calc(100% - 40px);
                right: -100%;
            }

            .test-panel.open {
                right: 20px;
            }
        }

        /* QR ì½”ë“œ ìŠ¤íƒ€ì¼ */
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .qr-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            text-align: center;
        }

        .qr-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .qr-code-canvas {
            max-width: 150px;
            max-height: 150px;
        }

        .qr-info {
            text-align: left;
            margin-top: 15px;
        }

        .qr-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .qr-info p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .qr-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .qr-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .qr-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .qr-btn.download {
            background: #2ecc71;
        }

        .qr-btn.download:hover {
            background: #27ae60;
        }

        .qr-btn.delete {
            background: #e74c3c;
        }

        .qr-btn.delete:hover {
            background: #c0392b;
        }

        /* QR ìƒì„± í¼ */
        .qr-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .create-qr-btn {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .create-qr-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .create-qr-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .qr-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ê°œì„ ëœ í…ŒìŠ¤íŠ¸ íŒ¨ë„ -->
    <button class="test-panel-toggle" onclick="toggleTestPanel()" title="í…ŒìŠ¤íŠ¸ íŒ¨ë„ í† ê¸€">
        ğŸ§ª
    </button>

    <div class="test-panel" id="test-panel">
        <h3>
            ğŸ§ª í…ŒìŠ¤íŠ¸ ì½˜íŠ¸ë¡¤
            <button onclick="toggleTestPanel()" style="background: none; border: none; color: #666; cursor: pointer; margin-left: auto;">âœ•</button>
        </h3>
        <button class="test-btn" onclick="simulateNewStudent()">ğŸ‘¥ í•™ìƒ ì¶”ê°€</button>
        <button class="test-btn" onclick="simulateNewBook()">ğŸ“š ë„ì„œ ì¶”ê°€</button>
        <button class="test-btn success" onclick="simulateApproval()">âœ… ì‹ ì²­ ìŠ¹ì¸</button>
        <button class="test-btn" onclick="simulateStudySession()">ğŸ“– í•™ìŠµ ì„¸ì…˜</button>
        <button class="test-btn" onclick="simulateChapterComplete()">ğŸ¯ ì±•í„° ì™„ë£Œ</button>
        <button class="test-btn" onclick="generateRandomActivity()">ğŸ² ëœë¤ í™œë™</button>
        <button class="test-btn danger" onclick="simulateError()">âš ï¸ ì—ëŸ¬ í…ŒìŠ¤íŠ¸</button>
        <button class="test-btn" onclick="generateRandomQR()">ğŸ“± QR ìƒì„±</button>
        <button class="test-btn" onclick="toggleAutoUpdate()">ğŸ”„ ìë™ ì—…ë°ì´íŠ¸</button>
        <div class="api-status" id="api-status">
            API ì‹œë®¬ë ˆì´í„° ì¤€ë¹„ë¨
        </div>
    </div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>ğŸ« ìˆ˜ë¦¬ë”©ì–´í•™ì›</h1>
            <p>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (í…ŒìŠ¤íŠ¸)</p>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">ë©”ì¸</div>
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i>ğŸ“Š</i>
                    <span>ëŒ€ì‹œë³´ë“œ</span>
                </div>
                <div class="nav-item" onclick="showSection('analytics')">
                    <i>ğŸ“ˆ</i>
                    <span>ë¶„ì„ ë¦¬í¬íŠ¸</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">í•™ìƒ ê´€ë¦¬</div>
                <div class="nav-item" onclick="showSection('students')">
                    <i>ğŸ‘¥</i>
                    <span>í•™ìƒ ëª©ë¡</span>
                </div>
                <div class="nav-item" onclick="showSection('activities')">
                    <i>ğŸ“‹</i>
                    <span>í•™ìŠµ í˜„í™©</span>
                </div>
                <div class="nav-item" onclick="showSection('applications')">
                    <i>ğŸ“</i>
                    <span>ê°€ì… ì‹ ì²­</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ì½˜í…ì¸  ê´€ë¦¬</div>
                <div class="nav-item" onclick="showSection('books')">
                    <i>ğŸ“š</i>
                    <span>ë„ì„œ ê´€ë¦¬</span>
                </div>
                <div class="nav-item" onclick="showSection('qr-codes')">
                    <i>ğŸ“±</i>
                    <span>QRì½”ë“œ ê´€ë¦¬</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ì‹œìŠ¤í…œ</div>
                <div class="nav-item" onclick="showSection('settings')">
                    <i>âš™ï¸</i>
                    <span>ì‹œìŠ¤í…œ ì„¤ì •</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content" id="main-content">
        <!-- ìƒë‹¨ ë°” -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
                <h1 class="page-title" id="page-title">ëŒ€ì‹œë³´ë“œ</h1>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</span>
                </div>
                <button id="refresh-btn" class="refresh-btn" onclick="refreshData()">
                    ğŸ”„ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
            <div class="admin-info">
                <div class="admin-avatar">ğŸ‘¨â€ğŸ’¼</div>
                <span id="admin-name">í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì</span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- ì½˜í…ì¸  ì˜ì—­ -->
        <div class="content-area">
            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboard-section" class="content-section">
                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="dashboard-grid">
                    <div class="stat-card" onclick="showSection('students')">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-students">0</div>
                                <div class="stat-label">ì´ í•™ìƒ ìˆ˜</div>
                            </div>
                            <div class="stat-icon students">ğŸ‘¥</div>
                        </div>
                        <div class="stat-change" id="students-change">
                            <span>ğŸ“Š</span>
                            <span>ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>

                    <div class="stat-card" onclick="showSection('books')">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-books">0</div>
                                <div class="stat-label">ë“±ë¡ëœ ë„ì„œ</div>
                            </div>
                            <div class="stat-icon books">ğŸ“š</div>
                        </div>
                        <div class="stat-change" id="books-change">
                            <span>ğŸ“–</span>
                            <span>ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>

                    <div class="stat-card" onclick="showSection('activities')">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-sessions">0</div>
                                <div class="stat-label">ì´ í•™ìŠµ ì„¸ì…˜</div>
                            </div>
                            <div class="stat-icon sessions">ğŸ“–</div>
                        </div>
                        <div class="stat-change" id="sessions-change">
                            <span>ğŸš€</span>
                            <span>ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="avg-accuracy">0%</div>
                                <div class="stat-label">í‰ê·  ì •ë‹µë¥ </div>
                            </div>
                            <div class="stat-icon accuracy">ğŸ¯</div>
                        </div>
                        <div class="stat-change" id="accuracy-change">
                            <span>ğŸ’«</span>
                            <span>ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
                <div class="chart-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">í•™ìŠµ í™œë™ ì¶”ì´</h3>
                            <div class="chart-filters">
                                <button class="filter-btn active" onclick="updateActivityChart('7d')">7ì¼</button>
                                <button class="filter-btn" onclick="updateActivityChart('30d')">30ì¼</button>
                                <button class="filter-btn" onclick="updateActivityChart('90d')">90ì¼</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="activity-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">ë ˆë²¨ë³„ ë¶„í¬</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="level-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ìµœê·¼ í™œë™ í…Œì´ë¸” -->
                <div class="data-table-section">
                    <div class="table-header">
                        <h3 class="table-title">ìµœê·¼ í•™ìŠµ í™œë™</h3>
                        <div class="table-controls">
                            <div class="search-box">
                                <input type="text" class="search-input" placeholder="í•™ìƒ ì´ë¦„ ë˜ëŠ” ë„ì„œëª… ê²€ìƒ‰..." onkeyup="filterTable('recent-activities-table', this.value)">
                                <span class="search-icon">ğŸ”</span>
                            </div>
                            <button class="export-btn" onclick="exportTableData('recent-activities-table', 'recent_activities')">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                    <div id="activities-content">
                        <div id="activities-loading" class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <span>í™œë™ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                        </div>
                        <table class="data-table" id="activities-table">
                            <thead>
                                <tr>
                                    <th>í•™ìƒëª…</th>
                                    <th>ë„ì„œ</th>
                                    <th>ì±•í„°</th>
                                    <th>ì •ë‹µë¥ </th>
                                    <th>í•™ìŠµì‹œê°„</th>
                                    <th>ì™„ë£Œì¼ì‹œ</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activities-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- ë¶„ì„ ë¦¬í¬íŠ¸ ì„¹ì…˜ - ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜ -->
            <div id="analytics-section" class="content-section" style="display: none;">
                <!-- ì‹¤ì‹œê°„ ë¶„ì„ ê°œìš” -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="learning-efficiency">+0%</div>
                                <div class="stat-label">í•™ìŠµ íš¨ìœ¨ì„±</div>
                            </div>
                            <div class="stat-icon accuracy">ğŸ“ˆ</div>
                        </div>
                        <div class="stat-change" id="efficiency-change">
                            <span>ğŸ“Š</span>
                            <span>ì „ì›” ëŒ€ë¹„ ê³„ì‚°ì¤‘...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="satisfaction-score">0.0</div>
                                <div class="stat-label">í‰ê·  ë§Œì¡±ë„</div>
                            </div>
                            <div class="stat-icon students">â­</div>
                        </div>
                        <div class="stat-change" id="satisfaction-change">
                            <span>ğŸŒŸ</span>
                            <span>/5.0 ì </span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="goal-achievement">0%</div>
                                <div class="stat-label">ëª©í‘œ ë‹¬ì„±ë¥ </div>
                            </div>
                            <div class="stat-icon books">ğŸ¯</div>
                        </div>
                        <div class="stat-change" id="goal-change">
                            <span>ğŸš€</span>
                            <span>ì›”ê°„ ëª©í‘œ</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="retention-rate">0%</div>
                                <div class="stat-label">ì¬ë“±ë¡ë¥ </div>
                            </div>
                            <div class="stat-icon sessions">ğŸ”„</div>
                        </div>
                        <div class="stat-change" id="retention-change">
                            <span>ğŸ’¯</span>
                            <span>ë†’ì€ ë§Œì¡±ë„</span>
                        </div>
                    </div>
                </div>

                <!-- ì‹¤ì‹œê°„ ë¶„ì„ ì°¨íŠ¸ -->
                <div class="chart-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">í•™ìŠµ ì„±ê³¼ ë¶„ì„</h3>
                            <div class="chart-filters">
                                <button class="filter-btn active" onclick="updatePerformanceChart('month')">ì›”ê°„</button>
                                <button class="filter-btn" onclick="updatePerformanceChart('quarter')">ë¶„ê¸°</button>
                                <button class="filter-btn" onclick="updatePerformanceChart('year')">ì—°ê°„</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="performance-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">ë ˆë²¨ë³„ ì„±ì·¨ë„</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="achievement-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ì‹¤ì‹œê°„ ì¸ì‚¬ì´íŠ¸ íŒ¨ë„ -->
                <div class="data-table-section">
                    <div class="table-header">
                        <h3 class="table-title">ğŸ“Š ì‹¤ì‹œê°„ í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h3>
                        <div class="table-controls">
                            <button class="export-btn" onclick="generateRealTimeReport()">ğŸ“‹ ì‹¤ì‹œê°„ ë¦¬í¬íŠ¸ ìƒì„±</button>
                        </div>
                    </div>

                    <div id="insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        <!-- ìš°ìˆ˜ ì„±ê³¼ -->
                        <div id="excellent-performance" style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #28a745;">
                            <h4 style="color: #28a745; margin-bottom: 15px;">ğŸ† ìš°ìˆ˜ ì„±ê³¼</h4>
                            <ul id="excellent-list" style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 10px;">â€¢ ë°ì´í„° ë¶„ì„ ì¤‘...</li>
                            </ul>
                        </div>

                        <!-- ê°œì„  í•„ìš” -->
                        <div id="improvement-needed" style="background: #fff3cd; padding: 20px; border-radius: 12px; border-left: 4px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 15px;">âš ï¸ ê°œì„  í•„ìš”</h4>
                            <ul id="improvement-list" style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 10px;">â€¢ ë°ì´í„° ë¶„ì„ ì¤‘...</li>
                            </ul>
                        </div>

                        <!-- ì¶”ì²œ ì‚¬í•­ -->
                        <div id="recommendations" style="background: #d1ecf1; padding: 20px; border-radius: 12px; border-left: 4px solid #17a2b8;">
                            <h4 style="color: #0c5460; margin-bottom: 15px;">ğŸ’¡ ì¶”ì²œ ì‚¬í•­</h4>
                            <ul id="recommendations-list" style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 10px;">â€¢ ë°ì´í„° ë¶„ì„ ì¤‘...</li>
                            </ul>
                        </div>

                        <!-- ì˜ˆì¸¡ ë¶„ì„ -->
                        <div id="predictions" style="background: #f8d7da; padding: 20px; border-radius: 12px; border-left: 4px solid #dc3545;">
                            <h4 style="color: #721c24; margin-bottom: 15px;">ğŸ”® ì˜ˆì¸¡ ë¶„ì„</h4>
                            <ul id="predictions-list" style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 10px;">â€¢ ë°ì´í„° ë¶„ì„ ì¤‘...</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ì‹¤ì‹œê°„ ìƒì„¸ í†µê³„ í…Œì´ë¸” -->
                <div class="data-table-section">
                    <div class="table-header">
                        <h3 class="table-title">ğŸ“ˆ ì‹¤ì‹œê°„ ìƒì„¸ í†µê³„</h3>
                        <div class="table-controls">
                            <select id="analytics-period" onchange="updateAnalyticsPeriod(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                                <option value="all">ì „ì²´ ê¸°ê°„</option>
                                <option value="7d">ì§€ë‚œ 7ì¼</option>
                                <option value="30d" selected>ì§€ë‚œ 30ì¼</option>
                                <option value="90d">ì§€ë‚œ 90ì¼</option>
                            </select>
                            <button class="export-btn" onclick="exportAnalyticsData()">ğŸ“Š CSV ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                    <table class="data-table" id="analytics-stats-table">
                        <thead>
                            <tr>
                                <th>ì§€í‘œ</th>
                                <th>í˜„ì¬ê°’</th>
                                <th>ëª©í‘œê°’</th>
                                <th>ë‹¬ì„±ë¥ </th>
                                <th>ì „ì›” ëŒ€ë¹„</th>
                                <th>íŠ¸ë Œë“œ</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="analytics-stats-body">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë”© ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ë‹¤ë¥¸ ì„¹ì…˜ë“¤... (í•™ìƒ, ë„ì„œ, ì‹ ì²­ ë“±) -->
            <div id="students-section" class="content-section" style="display: none;">
                <div class="data-table-section">
                    <div class="table-header">
                        <h3 class="table-title">í•™ìƒ ëª©ë¡</h3>
                        <div class="table-controls">
                            <div class="search-box">
                                <input type="text" class="search-input" placeholder="í•™ìƒ ê²€ìƒ‰..." onkeyup="filterTable('students-table', this.value)">
                                <span class="search-icon">ğŸ”</span>
                            </div>
                            <button class="export-btn" onclick="exportTableData('students-table', 'students')">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                    <div id="students-content">
                        <div id="students-loading" class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <span>í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                        </div>
                        <table class="data-table" id="students-table-container">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ì´ë¦„</th>
                                    <th>ë ˆë²¨</th>
                                    <th>ì™„ë£Œ ì„¸ì…˜</th>
                                    <th>í‰ê·  ì ìˆ˜</th>
                                    <th>ë§ˆì§€ë§‰ í™œë™</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="students-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ë‹¤ë¥¸ ì„¹ì…˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€... -->
            <!-- ë„ì„œ ê´€ë¦¬ ì„¹ì…˜ - ì™„ì „ êµ¬í˜„ -->
            <div id="books-section" class="content-section" style="display: none;">
                <div class="data-table-section">
                    <div class="table-header">
                        <h3 class="table-title">ğŸ“š ë„ì„œ ê´€ë¦¬</h3>
                        <div class="table-controls">
                            <select id="book-level-filter" onchange="filterBooksByLevel(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                                <option value="all">ì „ì²´ ë ˆë²¨</option>
                                <option value="1">Level 1</option>
                                <option value="2">Level 2</option>
                                <option value="3">Level 3</option>
                                <option value="4">Level 4</option>
                                <option value="5">Level 5</option>
                            </select>
                            <div class="search-box">
                                <input type="text" class="search-input" placeholder="ë„ì„œ ê²€ìƒ‰..." onkeyup="filterTable('books-table', this.value)">
                                <span class="search-icon">ğŸ”</span>
                            </div>
                            <button class="export-btn" onclick="exportTableData('books-table', 'books')">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                            <button class="refresh-btn" onclick="refreshBooksData()" style="margin-left: 10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div id="books-content">
                        <div id="books-loading" class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <span>ë„ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                        </div>
                        <table class="data-table" id="books-table-container">
                            <thead>
                                <tr>
                                    <th>QR ì½”ë“œ</th>
                                    <th>ë„ì„œ ì •ë³´</th>
                                    <th>ë ˆë²¨</th>
                                    <th>í•™ìŠµì ìˆ˜</th>
                                    <th>í‰ê·  ì •ë‹µë¥ </th>
                                    <th>ì™„ë£Œìœ¨</th>
                                    <th>ìµœê·¼ í™œë™</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="books-table">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: #666; padding: 40px;">ë„ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ë„ì„œ í†µê³„ ìš”ì•½ ì¹´ë“œ -->
                <div class="dashboard-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="books-total">0</div>
                                <div class="stat-label">ì´ ë„ì„œ ìˆ˜</div>
                            </div>
                            <div class="stat-icon books">ğŸ“š</div>
                        </div>
                        <div class="stat-change positive">
                            <span>ğŸ“–</span>
                            <span>ì „ì²´ ë„ì„œ</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="books-avg-accuracy">0%</div>
                                <div class="stat-label">ì „ì²´ í‰ê·  ì •ë‹µë¥ </div>
                            </div>
                            <div class="stat-icon accuracy">ğŸ¯</div>
                        </div>
                        <div class="stat-change positive">
                            <span>ğŸ’¯</span>
                            <span>ë„ì„œë³„ í‰ê· </span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="books-total-learners">0</div>
                                <div class="stat-label">ì´ í•™ìŠµì ìˆ˜</div>
                            </div>
                            <div class="stat-icon students">ğŸ‘¥</div>
                        </div>
                        <div class="stat-change positive">
                            <span>ğŸ“ˆ</span>
                            <span>ëª¨ë“  ë„ì„œ í•©ê³„</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="books-avg-completion">0%</div>
                                <div class="stat-label">í‰ê·  ì™„ë£Œìœ¨</div>
                            </div>
                            <div class="stat-icon sessions">âœ…</div>
                        </div>
                        <div class="stat-change positive">
                            <span>ğŸš€</span>
                            <span>ë„ì„œë³„ ì™„ë£Œìœ¨</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="applications-section" class="content-section" style="display: none;">
                <p>ê°€ì… ì‹ ì²­ ì„¹ì…˜</p>
            </div>

            <div id="activities-section" class="content-section" style="display: none;">
                <p>í•™ìŠµ í˜„í™© ì„¹ì…˜</p>
            </div>

            <div id="qr-codes-section" class="content-section" style="display: none;">
                <p>QRì½”ë“œ ê´€ë¦¬ ì„¹ì…˜</p>
            </div>

            <div id="settings-section" class="content-section" style="display: none;">
                <p>ì‹œìŠ¤í…œ ì„¤ì • ì„¹ì…˜</p>
            </div>
        </div>
    </div>
    <script>
        // ===== ì „ì—­ ë³€ìˆ˜ =====
        let currentSection = 'dashboard';
        let charts = {};
        let dashboardData = {};
        let autoRefreshEnabled = true;
        let lastAnalyticsUpdate = Date.now();

        // ===== ì‹¤ì‹œê°„ ë¶„ì„ ë°ì´í„° ê³„ì‚°ê¸° =====
        class RealTimeAnalytics {
            constructor() {
                this.previousMonthData = {
                    totalSessions: 1980,
                    avgAccuracy: 84.2,
                    totalStudents: 142,
                    avgStudyTime: 24.5,
                    completionRate: 72.3
                };
            }

            calculateLearningEfficiency(currentData) {
                const currentEfficiency = (
                    (currentData.avg_accuracy * 0.4) +
                    (currentData.completion_rate * 0.3) +
                    (currentData.participation_rate * 0.3)
                );

                const previousEfficiency = (
                    (this.previousMonthData.avgAccuracy * 0.4) +
                    (this.previousMonthData.completionRate * 0.3) +
                    (85 * 0.3)
                );

                return Math.round(((currentEfficiency - previousEfficiency) / previousEfficiency) * 100);
            }

            calculateSatisfactionScore(accuracyData, completionData) {
                const baseScore = 3.5;
                const accuracyBonus = (accuracyData - 70) * 0.02;
                const completionBonus = (completionData - 60) * 0.015;
                return Math.min(5.0, Math.max(1.0, baseScore + accuracyBonus + completionBonus)).toFixed(1);
            }

            calculateGoalAchievement(currentData) {
                const targets = { accuracy: 85, completion: 80, participation: 90 };
                const achievements = [
                    (currentData.avg_accuracy / targets.accuracy) * 100,
                    (currentData.completion_rate / targets.completion) * 100,
                    (currentData.participation_rate / targets.participation) * 100
                ];
                return Math.round(achievements.reduce((a, b) => a + b, 0) / achievements.length);
            }

            calculateRetentionRate(studentsData) {
                if (!studentsData || studentsData.length === 0) return 85;
                const activeStudents = studentsData.filter(s =>
                    s.status === 'active' && s.last_activity &&
                    new Date(s.last_activity) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
                ).length;
                return Math.round((activeStudents / studentsData.length) * 100);
            }

            generateInsights(currentData, studentsData, activitiesData) {
                const insights = { excellent: [], improvements: [], recommendations: [], predictions: [] };

                // ìš°ìˆ˜ ì„±ê³¼ ë¶„ì„
                if (currentData.avg_accuracy >= 88) {
                    insights.excellent.push(`í‰ê·  ì •ë‹µë¥  ${currentData.avg_accuracy}%ë¡œ ëª©í‘œì¹˜ ì´ˆê³¼ ë‹¬ì„±`);
                }

                if (studentsData) {
                    const topPerformers = studentsData.filter(s => s.avg_accuracy >= 90);
                    if (topPerformers.length > 0) {
                        insights.excellent.push(`${topPerformers.length}ëª…ì˜ í•™ìƒì´ 90% ì´ìƒ ìš°ìˆ˜ ì„±ê³¼`);
                    }
                }

                if (activitiesData && activitiesData.length > 0) {
                    const recentActivities = activitiesData.filter(a =>
                        new Date(a.completed_time) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                    );
                    if (recentActivities.length > 20) {
                        insights.excellent.push(`ì´ë²ˆ ì£¼ í•™ìŠµ í™œë™ì´ ${recentActivities.length}íšŒë¡œ ë§¤ìš° í™œë°œ`);
                    }
                }

                // ê°œì„  í•„ìš” ë¶„ì„
                if (currentData.avg_accuracy < 85) {
                    insights.improvements.push(`ì „ì²´ í‰ê·  ì •ë‹µë¥  ${currentData.avg_accuracy}%ë¡œ ëª©í‘œì¹˜ ë¯¸ë‹¬`);
                }

                if (studentsData) {
                    const strugglingStudents = studentsData.filter(s => s.avg_accuracy < 70);
                    if (strugglingStudents.length > 0) {
                        insights.improvements.push(`${strugglingStudents.length}ëª…ì˜ í•™ìƒì´ ì¶”ê°€ ì§€ì› í•„ìš”`);
                    }
                }

                // ì¶”ì²œ ì‚¬í•­
                insights.recommendations.push('ê°œë³„ ë§ì¶¤í˜• í•™ìŠµ ê³„íš ìˆ˜ë¦½ ê¶Œì¥');
                insights.recommendations.push('ì£¼ë§ íŠ¹ë³„ í•™ìŠµ í”„ë¡œê·¸ë¨ ë„ì… ê³ ë ¤');
                insights.recommendations.push('ìš°ìˆ˜ í•™ìƒ ë©˜í† ë§ ì‹œìŠ¤í…œ í™œìš©');

                // ì˜ˆì¸¡ ë¶„ì„
                const trend = this.calculateLearningEfficiency(currentData);
                if (trend > 0) {
                    insights.predictions.push(`í˜„ì¬ ì¶”ì„¸ë¡œëŠ” ë‹¤ìŒ ë‹¬ ${Math.abs(trend)}% ì„±ê³¼ í–¥ìƒ ì˜ˆìƒ`);
                } else {
                    insights.predictions.push(`í˜„ì¬ ì¶”ì„¸ë¡œëŠ” ë‹¤ìŒ ë‹¬ ${Math.abs(trend)}% ì„±ê³¼ í•˜ë½ ìš°ë ¤`);
                }

                if (studentsData && studentsData.length > 0) {
                    insights.predictions.push(`ì‹ ê·œ í•™ìƒ ìœ ì…ë¥  ${Math.round(Math.random() * 20 + 10)}% ì¦ê°€ ì˜ˆìƒ`);
                }

                return insights;
            }
        }

        // ì „ì—­ ë¶„ì„ê¸° ì¸ìŠ¤í„´ìŠ¤
        const analytics = new RealTimeAnalytics();

        // ===== í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤ ì‹œë®¬ë ˆì´í„° =====
        class TestDatabase {
            constructor() {
                this.init();
            }

            init() {
                if (!localStorage.getItem('testDB_stats')) {
                    this.resetDatabase();
                }
                console.log('ğŸ—„ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');
            }

            resetDatabase() {
                const initialData = {
                    stats: {
                        total_students: 156,
                        total_books: 89,
                        total_sessions: 2341,
                        avg_accuracy: 87.5,
                        new_students_this_month: 12,
                        session_growth: 15.3,
                        completion_rate: 76,
                        participation_rate: 89
                    },
                    students: [
                        {
                            id: 1, name: "ê¹€ì² ìˆ˜", level: 3, total_sessions: 24, avg_accuracy: 88,
                            last_activity: new Date(Date.now() - 1000 * 60 * 30).toISOString(), status: "active"
                        },
                        {
                            id: 2, name: "ì´ì˜í¬", level: 2, total_sessions: 18, avg_accuracy: 92,
                            last_activity: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(), status: "active"
                        },
                        {
                            id: 3, name: "ë°•ë¯¼ìˆ˜", level: 4, total_sessions: 31, avg_accuracy: 85,
                            last_activity: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(), status: "new"
                        }
                    ],
                    books: [
                        { qr_code: "BOOK001", title: "Charlie and the Chocolate Factory", author: "Roald Dahl", level: 3, students_count: 45, avg_accuracy: 88, completion_rate: 76 },
                        { qr_code: "BOOK002", title: "Matilda", author: "Roald Dahl", level: 4, students_count: 32, avg_accuracy: 82, completion_rate: 68 },
                        { qr_code: "BOOK003", title: "The BFG", author: "Roald Dahl", level: 2, students_count: 58, avg_accuracy: 91, completion_rate: 84 }
                    ],
                    applications: [
                        { id: 1, name: "ì •í•˜ëŠ˜", school: "ì„œìš¸ì´ˆë“±í•™êµ", grade: "3í•™ë…„", phone: "010-1234-5678", application_date: new Date(Date.now() - 1000 * 60 * 60 * 24 * 2).toISOString(), status: "pending" }
                    ],
                    activities: [
                        { id: 1, student_name: "ê¹€ì² ìˆ˜", book_title: "Charlie and the Chocolate Factory", chapter: 3, accuracy: 88, duration_minutes: 25, completed_time: new Date(Date.now() - 1000 * 60 * 45).toISOString() },
                        { id: 2, student_name: "ì´ì˜í¬", book_title: "The BFG", chapter: 1, accuracy: 95, duration_minutes: 18, completed_time: new Date(Date.now() - 1000 * 60 * 120).toISOString() },
                        { id: 3, student_name: "ë°•ë¯¼ìˆ˜", book_title: "Matilda", chapter: 5, accuracy: 82, duration_minutes: 32, completed_time: new Date(Date.now() - 1000 * 60 * 180).toISOString() }
                    ],
                    chartData: {
                        activity_chart: { labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'], sessions: [12, 19, 15, 25, 22, 18, 24], accuracy: [85, 87, 83, 89, 91, 86, 88] },
                        level_distribution: { labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'], data: [15, 32, 48, 38, 23] }
                    }
                };

                Object.entries(initialData).forEach(([key, value]) => {
                    localStorage.setItem(`testDB_${key}`, JSON.stringify(value));
                });
            }

            getData(table) {
                const data = localStorage.getItem(`testDB_${table}`);
                return data ? JSON.parse(data) : null;
            }

            setData(table, data) {
                localStorage.setItem(`testDB_${table}`, JSON.stringify(data));
            }

            updateStats() {
                const stats = this.getData('stats');
                const students = this.getData('students');
                const books = this.getData('books');
                const activities = this.getData('activities');

                stats.total_students = students.filter(s => s.status === 'active' || s.status === 'new').length;
                stats.total_books = books.length;
                stats.total_sessions = activities.length;
                stats.avg_accuracy = activities.length > 0 ? Math.round(activities.reduce((sum, a) => sum + a.accuracy, 0) / activities.length) : 0;

                const completedActivities = activities.filter(a => a.accuracy >= 80).length;
                stats.completion_rate = activities.length > 0 ? Math.round((completedActivities / activities.length) * 100) : 0;

                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                const activeStudents = students.filter(s => s.last_activity && new Date(s.last_activity) > weekAgo).length;
                stats.participation_rate = students.length > 0 ? Math.round((activeStudents / students.length) * 100) : 0;

                this.setData('stats', stats);
                return stats;
            }
        }

        const testDB = new TestDatabase();

        // ===== API ì‹œë®¬ë ˆì´í„° =====
        class APISimulator {
            constructor() {
                this.baseDelay = 500;
                this.errorRate = 0;
            }

            async simulate(endpoint, options = {}) {
                updateAPIStatus(`ğŸ“¡ API í˜¸ì¶œ: ${endpoint}`);
                await new Promise(resolve => setTimeout(resolve, this.baseDelay));

                if (Math.random() < this.errorRate) {
                    updateAPIStatus(`âŒ API ì—ëŸ¬: ${endpoint}`);
                    throw new Error(`API Error: ${endpoint} failed`);
                }

                let response;
                switch(endpoint) {
                    case '/api/admin/dashboard/stats':
                        response = { success: true, data: testDB.updateStats() };
                        break;
                    case '/api/admin/dashboard/chart-data':
                        response = { success: true, data: testDB.getData('chartData') };
                        break;
                    case '/api/admin/students':
                        response = { success: true, data: testDB.getData('students') };
                        break;
                    case '/api/admin/books':
                        response = { success: true, data: testDB.getData('books') };
                        break;
                    case '/api/admin/applications':
                        response = { success: true, data: testDB.getData('applications') };
                        break;
                    case '/api/admin/recent-activities':
                        response = { success: true, data: testDB.getData('activities') };
                        break;
                    case '/api/admin/analytics/real-time':
                        const currentData = testDB.updateStats();
                        const studentsData = testDB.getData('students');
                        const activitiesData = testDB.getData('activities');

                        const analyticsData = {
                            learning_efficiency: analytics.calculateLearningEfficiency(currentData),
                            satisfaction_score: analytics.calculateSatisfactionScore(currentData.avg_accuracy, currentData.completion_rate),
                            goal_achievement: analytics.calculateGoalAchievement(currentData),
                            retention_rate: analytics.calculateRetentionRate(studentsData),
                            insights: analytics.generateInsights(currentData, studentsData, activitiesData),
                            detailed_stats: this.generateDetailedStats(currentData)
                        };
                        response = { success: true, data: analyticsData };
                        break;
                    default:
                        throw new Error(`Unknown endpoint: ${endpoint}`);
                }

                updateAPIStatus(`âœ… API ì„±ê³µ: ${endpoint}`);
                return response;
            }

            generateDetailedStats(currentData) {
                return [
                    {
                        metric: 'í‰ê·  í•™ìŠµ ì‹œê°„',
                        current: '28ë¶„',
                        target: '25ë¶„',
                        achievement: 112,
                        change: '+8%',
                        trend: 'ğŸ“ˆ',
                        status: 'excellent'
                    },
                    {
                        metric: 'ì±•í„° ì™„ë£Œìœ¨',
                        current: currentData.completion_rate + '%',
                        target: '80%',
                        achievement: Math.round((currentData.completion_rate / 80) * 100),
                        change: '+5%',
                        trend: 'ğŸ“ˆ',
                        status: currentData.completion_rate >= 80 ? 'excellent' : 'warning'
                    },
                    {
                        metric: 'ì •ë‹µë¥ ',
                        current: currentData.avg_accuracy + '%',
                        target: '85%',
                        achievement: Math.round((currentData.avg_accuracy / 85) * 100),
                        change: '+2%',
                        trend: 'ğŸ“ˆ',
                        status: currentData.avg_accuracy >= 85 ? 'excellent' : 'warning'
                    },
                    {
                        metric: 'í•™ìƒ ì°¸ì—¬ìœ¨',
                        current: currentData.participation_rate + '%',
                        target: '90%',
                        achievement: Math.round((currentData.participation_rate / 90) * 100),
                        change: currentData.participation_rate >= 90 ? '+3%' : '-3%',
                        trend: currentData.participation_rate >= 90 ? 'ğŸ“ˆ' : 'ğŸ“‰',
                        status: currentData.participation_rate >= 85 ? 'excellent' : 'warning'
                    }
                ];
            }

            setErrorRate(rate) {
                this.errorRate = Math.max(0, Math.min(1, rate));
                updateAPIStatus(`âš™ï¸ ì—ëŸ¬ìœ¨ ì„¤ì •: ${(rate * 100).toFixed(0)}%`);
            }
        }

        const apiSim = new APISimulator();

        // ===== API í˜¸ì¶œ í•¨ìˆ˜ =====
        async function apiCall(endpoint, options = {}) {
            try {
                return await apiSim.simulate(endpoint, options);
            } catch (error) {
                console.error(`âŒ API ì—ëŸ¬ (${endpoint}):`, error);
                throw error;
            }
        }
        // ===== ì‹¤ì‹œê°„ ë¶„ì„ ë¦¬í¬íŠ¸ í•¨ìˆ˜ë“¤ =====
        async function loadRealTimeAnalytics() {
            try {
                showAlert('ì‹¤ì‹œê°„ ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');

                const response = await apiCall('/api/admin/analytics/real-time');
                if (response.success) {
                    updateAnalyticsCards(response.data);
                    updateInsightsPanel(response.data.insights);
                    updateDetailedStatsTable(response.data.detailed_stats);
                    loadAnalyticsCharts(response.data);
                    showAlert('ì‹¤ì‹œê°„ ë¶„ì„ ì™„ë£Œ!', 'success');
                } else {
                    throw new Error(response.error || 'ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤íŒ¨:', error);
                showAlert(`ë¶„ì„ ì˜¤ë¥˜: ${error.message}`, 'error');
                setDefaultAnalytics();
            }
        }

        function updateAnalyticsCards(data) {
            // í•™ìŠµ íš¨ìœ¨ì„±
            const efficiencyEl = document.getElementById('learning-efficiency');
            if (efficiencyEl) {
                const efficiency = data.learning_efficiency || 0;
                efficiencyEl.textContent = efficiency > 0 ? `+${efficiency}%` : `${efficiency}%`;

                const changeEl = document.getElementById('efficiency-change');
                if (changeEl) {
                    if (efficiency > 0) {
                        changeEl.innerHTML = '<span>ğŸ“ˆ</span><span>ì „ì›” ëŒ€ë¹„ í–¥ìƒ</span>';
                        changeEl.className = 'stat-change positive';
                    } else if (efficiency < 0) {
                        changeEl.innerHTML = '<span>ğŸ“‰</span><span>ì „ì›” ëŒ€ë¹„ í•˜ë½</span>';
                        changeEl.className = 'stat-change negative';
                    } else {
                        changeEl.innerHTML = '<span>ğŸ“Š</span><span>ì „ì›”ê³¼ ë™ì¼</span>';
                        changeEl.className = 'stat-change';
                    }
                }
            }

            // ë§Œì¡±ë„
            const satisfactionEl = document.getElementById('satisfaction-score');
            if (satisfactionEl) {
                satisfactionEl.textContent = data.satisfaction_score || '0.0';
            }

            // ëª©í‘œ ë‹¬ì„±ë¥ 
            const goalEl = document.getElementById('goal-achievement');
            if (goalEl) {
                const achievement = data.goal_achievement || 0;
                goalEl.textContent = achievement + '%';

                const goalChangeEl = document.getElementById('goal-change');
                if (goalChangeEl) {
                    if (achievement >= 90) {
                        goalChangeEl.innerHTML = '<span>ğŸ¯</span><span>ëª©í‘œ ì´ˆê³¼ ë‹¬ì„±</span>';
                        goalChangeEl.className = 'stat-change positive';
                    } else if (achievement >= 75) {
                        goalChangeEl.innerHTML = '<span>ğŸ“ˆ</span><span>ëª©í‘œ ê·¼ì ‘</span>';
                        goalChangeEl.className = 'stat-change warning';
                    } else {
                        goalChangeEl.innerHTML = '<span>âš ï¸</span><span>ëª©í‘œ ë¯¸ë‹¬</span>';
                        goalChangeEl.className = 'stat-change negative';
                    }
                }
            }

            // ì¬ë“±ë¡ë¥ 
            const retentionEl = document.getElementById('retention-rate');
            if (retentionEl) {
                const retention = data.retention_rate || 0;
                retentionEl.textContent = retention + '%';

                const retentionChangeEl = document.getElementById('retention-change');
                if (retentionChangeEl) {
                    if (retention >= 90) {
                        retentionChangeEl.innerHTML = '<span>ğŸ’¯</span><span>ìš°ìˆ˜í•œ ìœ ì§€ìœ¨</span>';
                        retentionChangeEl.className = 'stat-change positive';
                    } else {
                        retentionChangeEl.innerHTML = '<span>ğŸ“Š</span><span>ê°œì„  í•„ìš”</span>';
                        retentionChangeEl.className = 'stat-change warning';
                    }
                }
            }
        }

        function updateInsightsPanel(insights) {
            // ìš°ìˆ˜ ì„±ê³¼
            const excellentList = document.getElementById('excellent-list');
            if (excellentList && insights.excellent) {
                excellentList.innerHTML = insights.excellent.length > 0
                    ? insights.excellent.map(item => `<li style="margin-bottom: 10px;">â€¢ ${item}</li>`).join('')
                    : '<li style="margin-bottom: 10px;">â€¢ ìš°ìˆ˜ ì„±ê³¼ ë¶„ì„ ì¤‘...</li>';
            }

            // ê°œì„  í•„ìš”
            const improvementList = document.getElementById('improvement-list');
            if (improvementList && insights.improvements) {
                improvementList.innerHTML = insights.improvements.length > 0
                    ? insights.improvements.map(item => `<li style="margin-bottom: 10px;">â€¢ ${item}</li>`).join('')
                    : '<li style="margin-bottom: 10px;">â€¢ ê°œì„  ì‚¬í•­ ì—†ìŒ</li>';
            }

            // ì¶”ì²œ ì‚¬í•­
            const recommendationsList = document.getElementById('recommendations-list');
            if (recommendationsList && insights.recommendations) {
                recommendationsList.innerHTML = insights.recommendations.length > 0
                    ? insights.recommendations.map(item => `<li style="margin-bottom: 10px;">â€¢ ${item}</li>`).join('')
                    : '<li style="margin-bottom: 10px;">â€¢ ì¶”ì²œ ì‚¬í•­ ìƒì„± ì¤‘...</li>';
            }

            // ì˜ˆì¸¡ ë¶„ì„
            const predictionsList = document.getElementById('predictions-list');
            if (predictionsList && insights.predictions) {
                predictionsList.innerHTML = insights.predictions.length > 0
                    ? insights.predictions.map(item => `<li style="margin-bottom: 10px;">â€¢ ${item}</li>`).join('')
                    : '<li style="margin-bottom: 10px;">â€¢ ì˜ˆì¸¡ ë¶„ì„ ì¤‘...</li>';
            }
        }

        function updateDetailedStatsTable(statsData) {
            const tbody = document.getElementById('analytics-stats-body');
            if (!tbody || !statsData) return;

            tbody.innerHTML = '';

            statsData.forEach(stat => {
                const row = document.createElement('tr');

                let statusClass = 'inactive';
                let statusText = 'ë¯¸ë‹¬';
                if (stat.status === 'excellent' || stat.achievement >= 100) {
                    statusClass = 'active';
                    statusText = 'ëª©í‘œ ë‹¬ì„±';
                } else if (stat.achievement >= 90) {
                    statusClass = 'warning';
                    statusText = 'ê±°ì˜ ë‹¬ì„±';
                }

                const changeColor = stat.change.includes('+') ? '#28a745' : '#dc3545';

                row.innerHTML = `
                    <td><strong>${stat.metric}</strong></td>
                    <td>${stat.current}</td>
                    <td>${stat.target}</td>
                    <td>${stat.achievement}%</td>
                    <td style="color: ${changeColor};">${stat.change}</td>
                    <td>${stat.trend}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadAnalyticsCharts(data) {
            // ì„±ê³¼ ë¶„ì„ ì°¨íŠ¸
            const performanceCtx = document.getElementById('performance-chart');
            if (performanceCtx && !charts.performance) {
                const currentData = testDB.updateStats();

                charts.performance = new Chart(performanceCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”'],
                        datasets: [{
                            label: 'í‰ê·  ì •ë‹µë¥  (%)',
                            data: [82, 85, 87, 89, 88, 90, 92, currentData.avg_accuracy],
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        }, {
                            label: 'ì™„ë£Œìœ¨ (%)',
                            data: [70, 73, 75, 78, 76, 79, 82, currentData.completion_rate],
                            backgroundColor: 'rgba(46, 204, 113, 0.8)',
                            borderColor: '#2ecc71',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'ë¹„ìœ¨ (%)' }
                            }
                        }
                    }
                });
            }

            // ë ˆë²¨ë³„ ì„±ì·¨ë„ ì°¨íŠ¸
            const achievementCtx = document.getElementById('achievement-chart');
            if (achievementCtx && !charts.achievement) {
                const studentsData = testDB.getData('students');
                const levelAchievements = [95, 87, 92, 78, 83]; // ê¸°ë³¸ê°’
                const levelSatisfaction = [88, 92, 85, 79, 81]; // ê¸°ë³¸ê°’

                charts.achievement = new Chart(achievementCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'],
                        datasets: [{
                            label: 'ëª©í‘œ ë‹¬ì„±ë¥ ',
                            data: levelAchievements,
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            pointBackgroundColor: '#3498db'
                        }, {
                            label: 'í•™ìŠµ ë§Œì¡±ë„',
                            data: levelSatisfaction,
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            borderColor: '#2ecc71',
                            borderWidth: 2,
                            pointBackgroundColor: '#2ecc71'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { stepSize: 20 }
                            }
                        }
                    }
                });
            }
        }

        function setDefaultAnalytics() {
            document.getElementById('learning-efficiency').textContent = '+0%';
            document.getElementById('satisfaction-score').textContent = '4.0';
            document.getElementById('goal-achievement').textContent = '75%';
            document.getElementById('retention-rate').textContent = '85%';

            const tbody = document.getElementById('analytics-stats-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 40px;">ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // ===== ë¶„ì„ ê´€ë ¨ ì´ë²¤íŠ¸ í•¨ìˆ˜ë“¤ =====
        function updatePerformanceChart(period) {
            document.querySelectorAll('#analytics-section .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ë¡œì§
            if (charts.performance) {
                // ì‹¤ì œë¡œëŠ” ê¸°ê°„ì— ë”°ë¼ ë‹¤ë¥¸ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì•¼ í•¨
                showAlert(`${period} ê¸°ê°„ ì„±ê³¼ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
            }
        }

        function updateAnalyticsPeriod(period) {
            showAlert(`ë¶„ì„ ê¸°ê°„ì„ ${period}ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`, 'info');
            loadRealTimeAnalytics(); // ìƒˆë¡œìš´ ê¸°ê°„ìœ¼ë¡œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        }

        function generateRealTimeReport() {
            showAlert('ğŸ“‹ ì‹¤ì‹œê°„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

            setTimeout(async () => {
                try {
                    const response = await apiCall('/api/admin/analytics/real-time');
                    if (response.success) {
                        const reportData = {
                            generated_at: new Date().toLocaleString('ko-KR'),
                            period: 'ì‹¤ì‹œê°„ ë°ì´í„°',
                            learning_efficiency: response.data.learning_efficiency,
                            satisfaction_score: response.data.satisfaction_score,
                            goal_achievement: response.data.goal_achievement,
                            retention_rate: response.data.retention_rate,
                            insights: response.data.insights,
                            detailed_stats: response.data.detailed_stats
                        };

                        console.log('ğŸ“Š ì‹¤ì‹œê°„ ìƒì„±ëœ ë¦¬í¬íŠ¸:', reportData);
                        showAlert('âœ… ì‹¤ì‹œê°„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì½˜ì†”ì—ì„œ í™•ì¸í•˜ì„¸ìš”.', 'success');
                    } else {
                        throw new Error('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨');
                    }
                } catch (error) {
                    showAlert('ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }, 2000);
        }

        function exportAnalyticsData() {
            try {
                const table = document.getElementById('analytics-stats-table');
                if (!table) {
                    showAlert('ë‚´ë³´ë‚¼ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                const rows = table.querySelectorAll('tr');
                let csvContent = '';

                rows.forEach(row => {
                    const cells = row.querySelectorAll('th, td');
                    const rowData = Array.from(cells).map(cell => {
                        return `"${cell.textContent.replace(/"/g, '""')}"`;
                    });
                    csvContent += rowData.join(',') + '\n';
                });

                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');

                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `analytics_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                showAlert('ğŸ“Š ë¶„ì„ ë°ì´í„°ê°€ CSVë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'success');

            } catch (error) {
                console.error('âŒ ë¶„ì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
                showAlert('ë¶„ì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ===== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ =====
        function generateRandomActivity() {
            // ëœë¤í•œ í•™ìŠµ í™œë™ ìƒì„± (ë¶„ì„ì— ì˜í–¥ì„ ì¤Œ)
            const students = testDB.getData('students');
            const books = testDB.getData('books');
            const activities = testDB.getData('activities');

            if (students.length === 0 || books.length === 0) {
                showAlert('í•™ìƒì´ë‚˜ ë„ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            // ëœë¤ í™œë™ ìƒì„±
            for (let i = 0; i < Math.floor(Math.random() * 3) + 1; i++) {
                const randomStudent = students[Math.floor(Math.random() * students.length)];
                const randomBook = books[Math.floor(Math.random() * books.length)];

                const newActivity = {
                    id: activities.length + i + 1,
                    student_name: randomStudent.name,
                    book_title: randomBook.title,
                    chapter: Math.floor(Math.random() * 10) + 1,
                    accuracy: Math.floor(Math.random() * 40) + 60, // 60-100%
                    duration_minutes: Math.floor(Math.random() * 45) + 15, // 15-60ë¶„
                    completed_time: new Date(Date.now() - Math.random() * 1000 * 60 * 60 * 24).toISOString()
                };

                activities.push(newActivity);

                // í•™ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸
                randomStudent.total_sessions = (randomStudent.total_sessions || 0) + 1;
                randomStudent.avg_accuracy = Math.round((
                    (randomStudent.avg_accuracy * (randomStudent.total_sessions - 1) + newActivity.accuracy)
                    / randomStudent.total_sessions
                ));
                randomStudent.last_activity = newActivity.completed_time;
            }

            testDB.setData('activities', activities);
            testDB.setData('students', students);

            showAlert(`ğŸ² ëœë¤ í™œë™ ${activities.length - testDB.getData('activities').length + 3}ê°œê°€ ìƒì„±ë˜ì–´ ì‹¤ì‹œê°„ ë¶„ì„ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');

            // í˜„ì¬ ë¶„ì„ í˜ì´ì§€ë¼ë©´ ìë™ ìƒˆë¡œê³ ì¹¨
            if (currentSection === 'analytics') {
                setTimeout(() => loadRealTimeAnalytics(), 1000);
            }
        }

        function toggleTestPanel() {
            const panel = document.getElementById('test-panel');
            panel.classList.toggle('open');
        }

        function updateAPIStatus(message) {
            const statusEl = document.getElementById('api-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = message.includes('âŒ') ? '#dc3545' :
                                     message.includes('âœ…') ? '#28a745' : '#6c757d';
            }
        }
        // ===== ê³µí†µ í•¨ìˆ˜ë“¤ =====
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.style.animation = 'fadeInUp 0.3s ease';
            }

            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            }

            const titles = {
                'dashboard': 'ëŒ€ì‹œë³´ë“œ',
                'students': 'í•™ìƒ ê´€ë¦¬',
                'activities': 'í•™ìŠµ í˜„í™©',
                'applications': 'ê°€ì… ì‹ ì²­',
                'books': 'ë„ì„œ ê´€ë¦¬',
                'qr-codes': 'QRì½”ë“œ ê´€ë¦¬',
                'settings': 'ì‹œìŠ¤í…œ ì„¤ì •',
                'analytics': 'ë¶„ì„ ë¦¬í¬íŠ¸'
            };

            document.getElementById('page-title').textContent = titles[sectionName] || 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ';
            currentSection = sectionName;

            loadSectionData(sectionName);
        }

        function loadSectionData(sectionName) {
            switch(sectionName) {
                case 'analytics':
                    loadRealTimeAnalytics(); // ì‹¤ì‹œê°„ ë¶„ì„ ë°ì´í„° ë¡œë“œ
                    break;
                case 'dashboard':
                    loadDashboardData();
                    break;
                // ë‹¤ë¥¸ ì„¹ì…˜ë“¤...
            }
        }

        // ===== ê¸°ë³¸ ëŒ€ì‹œë³´ë“œ í•¨ìˆ˜ë“¤ =====
        async function loadDashboardData() {
            try {
                showAlert('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');

                const statsData = await apiCall('/api/admin/dashboard/stats');
                if (statsData.success) {
                    updateStatCards(statsData.data);
                } else {
                    throw new Error(statsData.error || 'í†µê³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }

                await loadChartData();
                await loadRecentActivities();

                showAlert('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ!', 'success');

            } catch (error) {
                console.error('âŒ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert(`ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
                setDefaultStats();
            }
        }

        function updateStatCards(data) {
            animateCounter('total-students', data.total_students || 0);
            animateCounter('total-books', data.total_books || 0);
            animateCounter('total-sessions', data.total_sessions || 0);

            const avgAccuracy = data.avg_accuracy || 0;
            document.getElementById('avg-accuracy').textContent = avgAccuracy + '%';

            updateChangeIndicators(data);
        }

        function updateChangeIndicators(data) {
            const studentsChange = document.getElementById('students-change');
            const newStudents = data.new_students_this_month || 0;
            if (newStudents > 0) {
                studentsChange.innerHTML = `<span>ğŸ“ˆ</span><span>+${newStudents} ì´ë²ˆ ë‹¬</span>`;
                studentsChange.className = 'stat-change positive';
            } else {
                studentsChange.innerHTML = `<span>ğŸ“Š</span><span>ë³€í™” ì—†ìŒ</span>`;
                studentsChange.className = 'stat-change';
            }
        }

        function animateCounter(elementId, targetValue, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;

            const startValue = 0;
            const duration = 2000;
            const startTime = performance.now();

            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * eased);
                element.textContent = currentValue + suffix;

                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }

            requestAnimationFrame(updateCounter);
        }

        async function loadChartData(period = '7d') {
            try {
                const response = await apiCall('/api/admin/dashboard/chart-data');
                if (response.success) {
                    initializeCharts(response.data);
                } else {
                    throw new Error(response.error || 'ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                initializeChartsWithDefaults();
            }
        }

        function initializeCharts(data) {
            try {
                if (charts.activity) charts.activity.destroy();
                if (charts.levelDistribution) charts.levelDistribution.destroy();

                const activityData = data.activity_chart || { labels: [], sessions: [], accuracy: [] };

                const activityCtx = document.getElementById('activity-chart').getContext('2d');
                charts.activity = new Chart(activityCtx, {
                    type: 'line',
                    data: {
                        labels: activityData.labels,
                        datasets: [{
                            label: 'í•™ìŠµ ì„¸ì…˜',
                            data: activityData.sessions,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'í‰ê·  ì •ë‹µë¥ ',
                            data: activityData.accuracy,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'í•™ìŠµ ì„¸ì…˜ ìˆ˜' } },
                            y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ì •ë‹µë¥  (%)' }, grid: { drawOnChartArea: false } }
                        }
                    }
                });

                const levelData = data.level_distribution || { labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'], data: [0, 0, 0, 0, 0] };

                const levelCtx = document.getElementById('level-distribution-chart').getContext('2d');
                charts.levelDistribution = new Chart(levelCtx, {
                    type: 'doughnut',
                    data: {
                        labels: levelData.labels,
                        datasets: [{
                            data: levelData.data,
                            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        if (total === 0) return `${context.label}: 0ëª… (0%)`;
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed}ëª… (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('âŒ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                initializeChartsWithDefaults();
            }
        }

        function initializeChartsWithDefaults() {
            const defaultData = {
                activity_chart: { labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'], sessions: [0, 0, 0, 0, 0, 0, 0], accuracy: [0, 0, 0, 0, 0, 0, 0] },
                level_distribution: { labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'], data: [0, 0, 0, 0, 0] }
            };
            initializeCharts(defaultData);
        }

        async function loadRecentActivities() {
            try {
                const response = await apiCall('/api/admin/recent-activities');
                if (response.success) {
                    renderRecentActivities(response.data || []);
                }
            } catch (error) {
                console.error('âŒ ìµœê·¼ í™œë™ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function renderRecentActivities(activities) {
            const tbody = document.getElementById('recent-activities-table');
            tbody.innerHTML = '';

            if (!activities || activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">ìµœê·¼ í•™ìŠµ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            activities.forEach((activity, index) => {
                const row = document.createElement('tr');
                row.style.animationDelay = `${index * 0.1}s`;
                row.className = 'table-row-animate';

                const accuracy = activity.accuracy || 0;
                let statusBadge = '';
                if (accuracy >= 90) {
                    statusBadge = '<span class="status-badge active">ìš°ìˆ˜</span>';
                } else if (accuracy >= 70) {
                    statusBadge = '<span class="status-badge new">ì–‘í˜¸</span>';
                } else {
                    statusBadge = '<span class="status-badge inactive">ê°œì„ í•„ìš”</span>';
                }

                row.innerHTML = `
                    <td>${activity.student_name || '-'}</td>
                    <td>${activity.book_title || '-'}</td>
                    <td>Chapter ${activity.chapter || '-'}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${accuracy}%
                            <div style="width: 60px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${accuracy}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                    </td>
                    <td>${activity.duration_minutes || 0}ë¶„</td>
                    <td>${formatDate(activity.completed_time)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="action-btn view" onclick="viewActivity(${activity.id})" title="ìƒì„¸ë³´ê¸°">ğŸ‘ï¸</button>
                        <button class="action-btn edit" onclick="reviewActivity(${activity.id})" title="ê²€í† ">ğŸ“</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ =====
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                return dateString;
            }
        }

        function setDefaultStats() {
            document.getElementById('total-students').textContent = '0';
            document.getElementById('total-books').textContent = '0';
            document.getElementById('total-sessions').textContent = '0';
            document.getElementById('avg-accuracy').textContent = '0%';
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            btn.innerHTML = 'â³ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
            btn.disabled = true;

            try {
                if (currentSection === 'analytics') {
                    await loadRealTimeAnalytics();
                } else if (currentSection === 'dashboard') {
                    await loadDashboardData();
                } else {
                    await loadSectionData(currentSection);
                }
                showAlert('ğŸ”„ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                console.error('âŒ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                showAlert(`ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    btn.innerHTML = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
                    btn.disabled = false;
                }, 1000);
            }
        }

        function startRealTimeUpdates() {
            if (!autoRefreshEnabled) return;

            setInterval(async () => {
                if (autoRefreshEnabled) {
                    try {
                        if (currentSection === 'analytics') {
                            await loadRealTimeAnalytics();
                        } else if (currentSection === 'dashboard') {
                            const response = await apiCall('/api/admin/dashboard/stats');
                            if (response.success) {
                                updateStatCards(response.data);
                            }
                        }
                    } catch (error) {
                        console.warn('âš ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                    }
                }
            }, 30000); // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }

        function showAlert(message, type = 'info') {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = `
                ${message}
                <button style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.7;" onclick="this.parentElement.remove()">Ã—</button>
            `;

            const contentArea = document.querySelector('.content-area');
            contentArea.insertBefore(alertDiv, contentArea.firstChild);

            setTimeout(() => {
                if (alertDiv.parentElement) alertDiv.remove();
            }, 5000);
        }

        // ===== ë”ë¯¸ ì•¡ì…˜ í•¨ìˆ˜ë“¤ =====
        function viewActivity(id) { showAlert(`í™œë™ ID ${id} ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.`, 'info'); }
        function reviewActivity(id) { showAlert(`í™œë™ ID ${id}ë¥¼ ê²€í† í•©ë‹ˆë‹¤.`, 'info'); }
        function simulateNewStudent() { showAlert('ìƒˆ í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'); }
        function simulateNewBook() { showAlert('ìƒˆ ë„ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'); }
        function simulateApproval() { showAlert('ì‹ ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'); }
        function simulateStudySession() { showAlert('ìƒˆë¡œìš´ í•™ìŠµ ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'); }
        function simulateChapterComplete() { showAlert('ì±•í„°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'); }
        function simulateError() { showAlert('ì—ëŸ¬ ëª¨ë“œ í™œì„±í™”!', 'error'); }
        function generateRandomQR() { showAlert('QR ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'); }
        function toggleAutoUpdate() { autoRefreshEnabled = !autoRefreshEnabled; showAlert(`ìë™ ì—…ë°ì´íŠ¸ ${autoRefreshEnabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`, 'info'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); document.getElementById('main-content').classList.toggle('expanded'); }
        function logout() { if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { showAlert('ë¡œê·¸ì•„ì›ƒ ì¤‘...', 'info'); setTimeout(() => window.location.href = '/admin/login', 1000); } }

        // ===== í˜ì´ì§€ ì´ˆê¸°í™” =====
        function initializePage() {
            console.log('ğŸš€ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸ ë²„ì „ ì´ˆê¸°í™”');
            document.getElementById('admin-name').textContent = 'í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì';
            loadDashboardData();
            startRealTimeUpdates();
            showAlert('ğŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.', 'info');
        }

        // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
        window.addEventListener('load', initializePage);
        window.addEventListener('beforeunload', () => { autoRefreshEnabled = false; });

        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .table-row-animate {
                animation: fadeInUp 0.3s ease forwards;
                opacity: 0;
            }
        `;
        document.head.appendChild(style);

        console.log('ğŸ§ª ìˆ˜ë¦¬ë”©ì–´í•™ì› ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ì‹¤ì‹œê°„ ë¶„ì„ ë²„ì „ ë¡œë“œ ì™„ë£Œ');
        console.log('ğŸ“Š ì‹¤ì‹œê°„ ë¶„ì„ ì‹œìŠ¤í…œ í™œì„±í™”');
        console.log('âš¡ ëª¨ë“  íŒ©í„°ê°€ ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë™ì‘');
    </script>
</body>
</html>

<script>
// 1ë‹¨ê³„: ë„ì„œ í†µê³„ ì‹¤ì‹œê°„ ê³„ì‚° ë©”ì„œë“œ ì¶”ê°€
if (typeof testDB !== 'undefined') {
    // TestDatabaseì— ë„ì„œë³„ í†µê³„ ì—…ë°ì´íŠ¸ ë©”ì„œë“œ ì¶”ê°€
    testDB.updateBooksStats = function() {
        console.log('ğŸ“š ë„ì„œ í†µê³„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘...');

        const books = this.getData('books');
        const activities = this.getData('activities');

        if (!books || !activities) {
            console.warn('âš ï¸ ë„ì„œ ë˜ëŠ” í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return books || [];
        }

        books.forEach((book, index) => {
            // í•´ë‹¹ ë„ì„œì˜ ëª¨ë“  í•™ìŠµ í™œë™ í•„í„°ë§
            const bookActivities = activities.filter(activity =>
                activity.book_title === book.title
            );

            // í•´ë‹¹ ë„ì„œë¥¼ í•™ìŠµí•œ ê³ ìœ  í•™ìƒë“¤ ê³„ì‚°
            const uniqueStudents = [...new Set(bookActivities.map(a => a.student_name))];
            const previousCount = book.students_count;
            book.students_count = uniqueStudents.length;

            if (bookActivities.length > 0) {
                // í‰ê·  ì •ë‹µë¥  ê³„ì‚°
                const totalAccuracy = bookActivities.reduce((sum, a) => sum + (a.accuracy || 0), 0);
                const previousAccuracy = book.avg_accuracy;
                book.avg_accuracy = Math.round(totalAccuracy / bookActivities.length);

                // ì™„ë£Œìœ¨ ê³„ì‚° (80% ì´ìƒ ì •ë‹µë¥ ì„ ì™„ë£Œë¡œ ê°„ì£¼)
                const completedSessions = bookActivities.filter(a => (a.accuracy || 0) >= 80).length;
                const previousCompletion = book.completion_rate;
                book.completion_rate = Math.round((completedSessions / bookActivities.length) * 100);

                // ë³€ê²½ì‚¬í•­ ë¡œê¹…
                if (previousCount !== book.students_count || previousAccuracy !== book.avg_accuracy || previousCompletion !== book.completion_rate) {
                    console.log(`ğŸ“Š "${book.title}" í†µê³„ ì—…ë°ì´íŠ¸:`, {
                        í•™ìŠµììˆ˜: `${previousCount} â†’ ${book.students_count}`,
                        í‰ê· ì •ë‹µë¥ : `${previousAccuracy}% â†’ ${book.avg_accuracy}%`,
                        ì™„ë£Œìœ¨: `${previousCompletion}% â†’ ${book.completion_rate}%`
                    });
                }
            } else {
                // í™œë™ì´ ì—†ëŠ” ê²½ìš° 0ìœ¼ë¡œ ì„¤ì •
                book.students_count = 0;
                book.avg_accuracy = 0;
                book.completion_rate = 0;
            }
        });

        this.setData('books', books);
        console.log('âœ… ë„ì„œ í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        return books;
    };

    console.log('ğŸ”§ 1ë‹¨ê³„: TestDatabaseì— updateBooksStats ë©”ì„œë“œ ì¶”ê°€ ì™„ë£Œ');
}
</script>

<script>
// 2ë‹¨ê³„: API ì‹œë®¬ë ˆì´í„° ë„ì„œ ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •
if (typeof apiSim !== 'undefined') {
    // ê¸°ì¡´ simulate ë©”ì„œë“œ ë°±ì—…
    const originalSimulate = apiSim.simulate;

    // simulate ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ
    apiSim.simulate = async function(endpoint, options = {}) {
        updateAPIStatus(`ğŸ“¡ API í˜¸ì¶œ: ${endpoint}`);
        await new Promise(resolve => setTimeout(resolve, this.baseDelay));

        if (Math.random() < this.errorRate) {
            updateAPIStatus(`âŒ API ì—ëŸ¬: ${endpoint}`);
            throw new Error(`API Error: ${endpoint} failed`);
        }

        let response;
        switch(endpoint) {
            case '/api/admin/books':
                console.log('ğŸ“š ë„ì„œ API í˜¸ì¶œ - ì‹¤ì‹œê°„ í†µê³„ ê³„ì‚° ì¤‘...');
                // ì‹¤ì‹œê°„ ë„ì„œ í†µê³„ ì—…ë°ì´íŠ¸ í›„ ë°˜í™˜
                let updatedBooks = [];
                if (typeof testDB !== 'undefined' && testDB.updateBooksStats) {
                    updatedBooks = testDB.updateBooksStats();
                } else {
                    updatedBooks = testDB.getData('books') || [];
                }
                response = {
                    success: true,
                    data: updatedBooks,
                    timestamp: new Date().toISOString(),
                    message: 'ì‹¤ì‹œê°„ ë„ì„œ í†µê³„ ë°˜ì˜ë¨'
                };
                console.log('ğŸ“Š ë„ì„œ API ì‘ë‹µ:', response);
                break;

            case '/api/admin/dashboard/stats':
                response = { success: true, data: testDB.updateStats() };
                break;
            case '/api/admin/dashboard/chart-data':
                response = { success: true, data: testDB.getData('chartData') };
                break;
            case '/api/admin/students':
                response = { success: true, data: testDB.getData('students') };
                break;
            case '/api/admin/applications':
                response = { success: true, data: testDB.getData('applications') };
                break;
            case '/api/admin/recent-activities':
                response = { success: true, data: testDB.getData('activities') };
                break;
            case '/api/admin/analytics/real-time':
                const currentData = testDB.updateStats();
                const studentsData = testDB.getData('students');
                const activitiesData = testDB.getData('activities');

                const analyticsData = {
                    learning_efficiency: analytics.calculateLearningEfficiency(currentData),
                    satisfaction_score: analytics.calculateSatisfactionScore(currentData.avg_accuracy, currentData.completion_rate),
                    goal_achievement: analytics.calculateGoalAchievement(currentData),
                    retention_rate: analytics.calculateRetentionRate(studentsData),
                    insights: analytics.generateInsights(currentData, studentsData, activitiesData),
                    detailed_stats: this.generateDetailedStats(currentData)
                };
                response = { success: true, data: analyticsData };
                break;
            default:
                throw new Error(`Unknown endpoint: ${endpoint}`);
        }

        updateAPIStatus(`âœ… API ì„±ê³µ: ${endpoint}`);
        return response;
    };

    console.log('ğŸ”§ 2ë‹¨ê³„: API ì‹œë®¬ë ˆì´í„° ë„ì„œ ì—”ë“œí¬ì¸íŠ¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}
</script>

<script>
// 3ë‹¨ê³„: í•™ìŠµ í™œë™ ìƒì„± í•¨ìˆ˜ë“¤ì— ë„ì„œ í†µê³„ ìë™ ì—…ë°ì´íŠ¸ ì—°ë™

// simulateStudySession í•¨ìˆ˜ ê°œì„ 
if (typeof simulateStudySession !== 'undefined') {
    const originalSimulateStudySession = simulateStudySession;

    simulateStudySession = function() {
        console.log('ğŸ“– í•™ìŠµ ì„¸ì…˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...');

        const students = testDB.getData('students');
        const books = testDB.getData('books');
        const activities = testDB.getData('activities');

        if (students.length === 0 || books.length === 0) {
            showAlert('í•™ìƒì´ë‚˜ ë„ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        const randomStudent = students[Math.floor(Math.random() * students.length)];
        const randomBook = books[Math.floor(Math.random() * books.length)];

        const newActivity = {
            id: activities.length + 1,
            student_name: randomStudent.name,
            book_title: randomBook.title,
            chapter: Math.floor(Math.random() * 10) + 1,
            accuracy: Math.floor(Math.random() * 30) + 70, // 70-100%
            duration_minutes: Math.floor(Math.random() * 40) + 15, // 15-55ë¶„
            completed_time: new Date().toISOString()
        };

        activities.push(newActivity);
        testDB.setData('activities', activities);

        // í•™ìƒì˜ í†µê³„ ì—…ë°ì´íŠ¸
        randomStudent.total_sessions = (randomStudent.total_sessions || 0) + 1;
        randomStudent.avg_accuracy = Math.round((
            (randomStudent.avg_accuracy * (randomStudent.total_sessions - 1) + newActivity.accuracy)
            / randomStudent.total_sessions
        ));
        randomStudent.last_activity = new Date().toISOString();
        testDB.setData('students', students);

        // ğŸ”¥ ë„ì„œ í†µê³„ ìë™ ì—…ë°ì´íŠ¸
        if (testDB.updateBooksStats) {
            testDB.updateBooksStats();
            console.log('ğŸ“š ë„ì„œ í†µê³„ê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        showAlert(`ğŸ“– ${randomStudent.name}ì˜ ìƒˆë¡œìš´ í•™ìŠµ ì„¸ì…˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (${newActivity.accuracy}% ì •ë‹µë¥ )\në„ì„œ "${randomBook.title}" í†µê³„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

        // í˜„ì¬ ì„¹ì…˜ì´ ê´€ë ¨ í˜ì´ì§€ë¼ë©´ ìƒˆë¡œê³ ì¹¨
        if (currentSection === 'dashboard' || currentSection === 'activities' || currentSection === 'analytics' || currentSection === 'books') {
            setTimeout(() => loadSectionData(currentSection), 500);
        }
    };
}

// generateRandomActivity í•¨ìˆ˜ ê°œì„ 
if (typeof generateRandomActivity !== 'undefined') {
    const originalGenerateRandomActivity = generateRandomActivity;

    generateRandomActivity = function() {
        console.log('ğŸ² ëœë¤ í™œë™ ìƒì„± ì‹œì‘...');

        const students = testDB.getData('students');
        const books = testDB.getData('books');
        const activities = testDB.getData('activities');

        if (students.length === 0 || books.length === 0) {
            showAlert('í•™ìƒì´ë‚˜ ë„ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        const numberOfActivities = Math.floor(Math.random() * 3) + 1;
        const affectedBooks = new Set();

        // ëœë¤ í™œë™ ìƒì„±
        for (let i = 0; i < numberOfActivities; i++) {
            const randomStudent = students[Math.floor(Math.random() * students.length)];
            const randomBook = books[Math.floor(Math.random() * books.length)];

            const newActivity = {
                id: activities.length + i + 1,
                student_name: randomStudent.name,
                book_title: randomBook.title,
                chapter: Math.floor(Math.random() * 10) + 1,
                accuracy: Math.floor(Math.random() * 40) + 60, // 60-100%
                duration_minutes: Math.floor(Math.random() * 45) + 15, // 15-60ë¶„
                completed_time: new Date(Date.now() - Math.random() * 1000 * 60 * 60 * 24).toISOString()
            };

            activities.push(newActivity);
            affectedBooks.add(randomBook.title);

            // í•™ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸
            randomStudent.total_sessions = (randomStudent.total_sessions || 0) + 1;
            randomStudent.avg_accuracy = Math.round((
                (randomStudent.avg_accuracy * (randomStudent.total_sessions - 1) + newActivity.accuracy)
                / randomStudent.total_sessions
            ));
            randomStudent.last_activity = newActivity.completed_time;
        }

        testDB.setData('activities', activities);
        testDB.setData('students', students);

        // ğŸ”¥ ë„ì„œ í†µê³„ ìë™ ì—…ë°ì´íŠ¸
        if (testDB.updateBooksStats) {
            testDB.updateBooksStats();
            console.log('ğŸ“š ì˜í–¥ë°›ì€ ë„ì„œë“¤ì˜ í†µê³„ê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤:', Array.from(affectedBooks));
        }

        showAlert(`ğŸ² ëœë¤ í™œë™ ${numberOfActivities}ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\nì˜í–¥ë°›ì€ ë„ì„œ: ${Array.from(affectedBooks).join(', ')}\në„ì„œ í†µê³„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

        // í˜„ì¬ ë¶„ì„ í˜ì´ì§€ë¼ë©´ ìë™ ìƒˆë¡œê³ ì¹¨
        if (currentSection === 'analytics') {
            setTimeout(() => loadRealTimeAnalytics(), 1000);
        } else if (currentSection === 'books') {
            setTimeout(() => loadBooksData(), 1000);
        } else if (currentSection === 'dashboard') {
            setTimeout(() => loadDashboardData(), 1000);
        }
    };
}

// ë„ì„œ ê´€ë¦¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ ê°œì„ 
async function refreshBooksData() {
    console.log('ğŸ”„ ë„ì„œ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨...');

    // ë„ì„œ í†µê³„ ê°•ì œ ì—…ë°ì´íŠ¸
    if (testDB.updateBooksStats) {
        testDB.updateBooksStats();
    }

    // ë„ì„œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    await loadBooksData();

    showAlert('ğŸ“š ë„ì„œ ë°ì´í„°ê°€ ìµœì‹  í†µê³„ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

console.log('ğŸ”§ 3ë‹¨ê³„: í•™ìŠµ í™œë™ ìƒì„± ì‹œ ë„ì„œ í†µê³„ ìë™ ì—…ë°ì´íŠ¸ ì—°ë™ ì™„ë£Œ');
console.log('âœ… ë„ì„œ ê´€ë¦¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¶• ì™„ë£Œ!');
console.log('ğŸ“‹ í…ŒìŠ¤íŠ¸ ë°©ë²•:');
console.log('1. ë„ì„œ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™');
console.log('2. "ğŸ² ëœë¤ í™œë™" ë˜ëŠ” "ğŸ“– í•™ìŠµ ì„¸ì…˜" ë²„íŠ¼ í´ë¦­');
console.log('3. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­í•˜ì—¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™•ì¸');
</script>

<script>
// ===== 1ë‹¨ê³„: ì™„ì „í•œ ë„ì„œ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„ =====

// ë„ì„œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ì™„ì „ êµ¬í˜„
async function loadBooksData() {
    if (document.getElementById('books-section').style.display === 'none') return;

    console.log('ğŸ“š ë„ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');

    const loadingEl = document.getElementById('books-loading');
    const tableEl = document.getElementById('books-table-container');

    try {
        // ë¡œë”© í‘œì‹œ
        if (loadingEl) loadingEl.style.display = 'flex';
        if (tableEl) tableEl.style.display = 'none';

        // ì‹¤ì‹œê°„ ë„ì„œ í†µê³„ ì—…ë°ì´íŠ¸
        if (typeof testDB !== 'undefined' && testDB.updateBooksStats) {
            testDB.updateBooksStats();
            console.log('ğŸ“Š ë„ì„œ í†µê³„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        const response = await apiCall('/api/admin/books');

        if (response.success) {
            console.log('ğŸ“š ë„ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', response.data);
            renderBooksTable(response.data || []);
            updateBooksSummaryCards(response.data || []);
            if (tableEl) tableEl.style.display = 'table';
        } else {
            throw new Error(response.error || 'ë„ì„œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('âŒ ë„ì„œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert(`ë„ì„œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
        renderBooksError();
    } finally {
        if (loadingEl) loadingEl.style.display = 'none';
    }
}

// ë„ì„œ í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ ì™„ì „ êµ¬í˜„
function renderBooksTable(books) {
    const tbody = document.getElementById('books-table');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!books || books.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; padding: 40px;">ë“±ë¡ëœ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    const activities = testDB.getData('activities') || [];

    books.forEach((book, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.1}s`;
        row.className = 'table-row-animate';
        row.setAttribute('data-book-level', book.level);

        // í•´ë‹¹ ë„ì„œì˜ ìµœê·¼ í™œë™ ì°¾ê¸°
        const bookActivities = activities.filter(a => a.book_title === book.title);
        const lastActivity = bookActivities.length > 0
            ? new Date(Math.max(...bookActivities.map(a => new Date(a.completed_time)))).toISOString()
            : null;

        // ìƒíƒœ ê²°ì •
        let statusClass = 'active';
        let statusText = 'í™œì„±';
        if (book.students_count === 0) {
            statusClass = 'inactive';
            statusText = 'ë¯¸ì‚¬ìš©';
        } else if (book.avg_accuracy < 70) {
            statusClass = 'warning';
            statusText = 'ê´€ì‹¬í•„ìš”';
        }

        // ì™„ë£Œìœ¨ì— ë”°ë¥¸ ìƒ‰ìƒ
        const completionColor = book.completion_rate >= 80 ? '#28a745' :
                               book.completion_rate >= 60 ? '#ffc107' : '#dc3545';

        // ì •ë‹µë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ
        const accuracyColor = book.avg_accuracy >= 85 ? '#28a745' :
                             book.avg_accuracy >= 70 ? '#17a2b8' : '#ffc107';

        row.innerHTML = `
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 40px; height: 40px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                        ğŸ“±
                    </div>
                    <span style="font-family: monospace; font-weight: bold; color: #6c757d;">${book.qr_code || '-'}</span>
                </div>
            </td>
            <td>
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px; color: #2c3e50;">${book.title || '-'}</div>
                    <div style="font-size: 0.85rem; color: #666;">ì €ì: ${book.author || '-'}</div>
                </div>
            </td>
            <td><span class="level-badge level-${book.level || 1}">Level ${book.level || 1}</span></td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <strong style="color: #2c3e50;">${book.students_count || 0}ëª…</strong>
                    <div style="width: 40px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(book.students_count * 2, 100)}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px;"></div>
                    </div>
                </div>
            </td>
            <td>
                <span style="font-weight: 600; color: ${accuracyColor};">
                    ${book.avg_accuracy || 0}%
                </span>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600; color: ${completionColor};">${book.completion_rate || 0}%</span>
                    <div style="width: 60px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${book.completion_rate || 0}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px;"></div>
                    </div>
                </div>
            </td>
            <td>
                <span style="color: ${lastActivity ? '#6c757d' : '#dc3545'}; font-size: 0.9rem;">
                    ${lastActivity ? formatRelativeTime(lastActivity) : 'í™œë™ ì—†ìŒ'}
                </span>
            </td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
                <button class="action-btn view" onclick="viewBookDetails('${book.qr_code}')" title="ìƒì„¸ë³´ê¸°">ğŸ‘ï¸</button>
                <button class="action-btn edit" onclick="editBook('${book.qr_code}')" title="í¸ì§‘">âœï¸</button>
                <button class="action-btn" onclick="generateBookQR('${book.qr_code}')" title="QRìƒì„±" style="color: #6f42c1; border-color: #6f42c1;">ğŸ“±</button>
                <button class="action-btn" onclick="viewBookStats('${book.qr_code}')" title="í†µê³„" style="color: #17a2b8; border-color: #17a2b8;">ğŸ“Š</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    console.log(`ğŸ“š ${books.length}ê°œ ë„ì„œ í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ`);
}

// ë„ì„œ ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateBooksSummaryCards(books) {
    if (!books || books.length === 0) return;

    // ì´ ë„ì„œ ìˆ˜
    const totalEl = document.getElementById('books-total');
    if (totalEl) {
        animateCounter('books-total', books.length);
    }

    // ì „ì²´ í‰ê·  ì •ë‹µë¥ 
    const avgAccuracyEl = document.getElementById('books-avg-accuracy');
    if (avgAccuracyEl) {
        const totalAccuracy = books.reduce((sum, book) => sum + (book.avg_accuracy || 0), 0);
        const avgAccuracy = books.length > 0 ? Math.round(totalAccuracy / books.length) : 0;
        avgAccuracyEl.textContent = avgAccuracy + '%';
    }

    // ì´ í•™ìŠµì ìˆ˜ (ì¤‘ë³µ ì œê±° í•„ìš” ì—†ì´ í•©ê³„)
    const totalLearnersEl = document.getElementById('books-total-learners');
    if (totalLearnersEl) {
        const totalLearners = books.reduce((sum, book) => sum + (book.students_count || 0), 0);
        animateCounter('books-total-learners', totalLearners);
    }

    // í‰ê·  ì™„ë£Œìœ¨
    const avgCompletionEl = document.getElementById('books-avg-completion');
    if (avgCompletionEl) {
        const totalCompletion = books.reduce((sum, book) => sum + (book.completion_rate || 0), 0);
        const avgCompletion = books.length > 0 ? Math.round(totalCompletion / books.length) : 0;
        avgCompletionEl.textContent = avgCompletion + '%';
    }

    console.log('ğŸ“Š ë„ì„œ ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// ë„ì„œ ì—ëŸ¬ ë Œë”ë§
function renderBooksError() {
    const tbody = document.getElementById('books-table');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #dc3545; padding: 40px;">âŒ ë„ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.</td></tr>';
    }
}

// ë„ì„œ ë ˆë²¨ë³„ í•„í„°ë§
function filterBooksByLevel(level) {
    const table = document.getElementById('books-table');
    if (!table) return;

    const rows = table.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const bookLevel = row.getAttribute('data-book-level');

        if (level === 'all' || bookLevel === level) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }

    console.log(`ğŸ“š ë ˆë²¨ ${level} í•„í„° ì ìš©ë¨`);
}

// ë„ì„œ ê´€ë ¨ ì•¡ì…˜ í•¨ìˆ˜ë“¤
function viewBookDetails(qrCode) {
    console.log(`ğŸ“– ë„ì„œ ìƒì„¸ë³´ê¸°: ${qrCode}`);

    const books = testDB.getData('books') || [];
    const book = books.find(b => b.qr_code === qrCode);

    if (book) {
        const activities = testDB.getData('activities') || [];
        const bookActivities = activities.filter(a => a.book_title === book.title);

        let detailMessage = `ğŸ“š ${book.title}\n`;
        detailMessage += `ì €ì: ${book.author}\n`;
        detailMessage += `ë ˆë²¨: ${book.level}\n`;
        detailMessage += `í•™ìŠµì: ${book.students_count}ëª…\n`;
        detailMessage += `í‰ê·  ì •ë‹µë¥ : ${book.avg_accuracy}%\n`;
        detailMessage += `ì™„ë£Œìœ¨: ${book.completion_rate}%\n`;
        detailMessage += `ì´ í•™ìŠµ ì„¸ì…˜: ${bookActivities.length}íšŒ`;

        showAlert(detailMessage, 'info');
    } else {
        showAlert(`ë„ì„œ ${qrCode}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

function editBook(qrCode) {
    showAlert(`ğŸ“ ë„ì„œ ${qrCode} í¸ì§‘ ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.`, 'info');
}

function generateBookQR(qrCode) {
    showAlert(`ğŸ“± ë„ì„œ ${qrCode}ì˜ QRì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.`, 'success');
}

function viewBookStats(qrCode) {
    console.log(`ğŸ“Š ë„ì„œ í†µê³„ ë³´ê¸°: ${qrCode}`);

    const books = testDB.getData('books') || [];
    const book = books.find(b => b.qr_code === qrCode);

    if (book) {
        const activities = testDB.getData('activities') || [];
        const bookActivities = activities.filter(a => a.book_title === book.title);

        const students = [...new Set(bookActivities.map(a => a.student_name))];
        const avgStudyTime = bookActivities.length > 0
            ? Math.round(bookActivities.reduce((sum, a) => sum + (a.duration_minutes || 0), 0) / bookActivities.length)
            : 0;

        let statsMessage = `ğŸ“Š ${book.title} ìƒì„¸ í†µê³„\n\n`;
        statsMessage += `ğŸ¯ ì„±ê³¼ ì§€í‘œ:\n`;
        statsMessage += `â€¢ í•™ìŠµì: ${students.length}ëª…\n`;
        statsMessage += `â€¢ ì´ ì„¸ì…˜: ${bookActivities.length}íšŒ\n`;
        statsMessage += `â€¢ í‰ê·  ì •ë‹µë¥ : ${book.avg_accuracy}%\n`;
        statsMessage += `â€¢ ì™„ë£Œìœ¨: ${book.completion_rate}%\n`;
        statsMessage += `â€¢ í‰ê·  í•™ìŠµì‹œê°„: ${avgStudyTime}ë¶„\n\n`;

        if (students.length > 0) {
            statsMessage += `ğŸ‘¥ í•™ìŠµì ëª©ë¡: ${students.join(', ')}`;
        }

        showAlert(statsMessage, 'info');
    }
}

// ìƒëŒ€ì  ì‹œê°„ í¬ë§· í•¨ìˆ˜
function formatRelativeTime(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return 'ë°©ê¸ˆ ì „';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}ë¶„ ì „`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}ì‹œê°„ ì „`;
        if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}ì¼ ì „`;
        return `${Math.floor(diffInSeconds / 604800)}ì£¼ ì „`;
    } catch (error) {
        return dateString;
    }
}

// ë„ì„œ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨
async function refreshBooksData() {
    console.log('ğŸ”„ ë„ì„œ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
    btn.disabled = true;

    try {
        // ë„ì„œ í†µê³„ ê°•ì œ ì—…ë°ì´íŠ¸
        if (testDB.updateBooksStats) {
            testDB.updateBooksStats();
            console.log('ğŸ“Š ë„ì„œ í†µê³„ ê°•ì œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        // ë„ì„œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        await loadBooksData();

        showAlert('ğŸ“š ë„ì„œ ë°ì´í„°ê°€ ìµœì‹  í†µê³„ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

    } catch (error) {
        console.error('âŒ ë„ì„œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        showAlert(`ë„ì„œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }
}

// loadSectionData í•¨ìˆ˜ì— books ì¼€ì´ìŠ¤ ì¶”ê°€
const originalLoadSectionData = loadSectionData;
loadSectionData = function(sectionName) {
    switch(sectionName) {
        case 'analytics':
            loadRealTimeAnalytics();
            break;
        case 'dashboard':
            loadDashboardData();
            break;
        case 'books':
            loadBooksData(); // ğŸ“š ë„ì„œ ê´€ë¦¬ ë¡œë“œ ì¶”ê°€
            break;
        // ë‹¤ë¥¸ ì„¹ì…˜ë“¤...
        default:
            if (originalLoadSectionData) {
                originalLoadSectionData(sectionName);
            }
    }
};

console.log('âœ… 1ë‹¨ê³„: ë„ì„œ ê´€ë¦¬ ì„¹ì…˜ ì™„ì „ êµ¬í˜„ ì™„ë£Œ!');
console.log('ğŸ“š ê¸°ëŠ¥ ëª©ë¡:');
console.log('â€¢ ì‹¤ì‹œê°„ ë„ì„œ í†µê³„ í…Œì´ë¸”');
console.log('â€¢ ë ˆë²¨ë³„ í•„í„°ë§');
console.log('â€¢ ë„ì„œ ìƒì„¸ ì •ë³´ ë³´ê¸°');
console.log('â€¢ ë„ì„œë³„ í†µê³„ ë¶„ì„');
console.log('â€¢ ìš”ì•½ ì¹´ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸');
console.log('â€¢ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥');
</script>

<script>
// ===== 2ë‹¨ê³„: ë¶„ì„ ë¦¬í¬íŠ¸ í•˜ë“œì½”ë”© ì œê±° ë° ì‹¤ì‹œê°„ ê³„ì‚° êµ¬í˜„ =====

// ë ˆë²¨ë³„ ì„±ì·¨ë„ ì‹¤ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
function calculateLevelAchievements() {
    const students = testDB.getData('students') || [];
    const activities = testDB.getData('activities') || [];

    console.log('ğŸ“Š ë ˆë²¨ë³„ ì„±ì·¨ë„ ì‹¤ì‹œê°„ ê³„ì‚° ì‹œì‘...');

    // ë ˆë²¨ë³„ ë°ì´í„° ì´ˆê¸°í™”
    const levelData = {
        1: { students: [], activities: [], totalAccuracy: 0, totalSatisfaction: 0 },
        2: { students: [], activities: [], totalAccuracy: 0, totalSatisfaction: 0 },
        3: { students: [], activities: [], totalAccuracy: 0, totalSatisfaction: 0 },
        4: { students: [], activities: [], totalAccuracy: 0, totalSatisfaction: 0 },
        5: { students: [], activities: [], totalAccuracy: 0, totalSatisfaction: 0 }
    };

    // í•™ìƒë“¤ì„ ë ˆë²¨ë³„ë¡œ ë¶„ë¥˜
    students.forEach(student => {
        const level = student.level || 1;
        if (levelData[level]) {
            levelData[level].students.push(student);
        }
    });

    // í™œë™ë“¤ì„ í•™ìƒ ë ˆë²¨ë³„ë¡œ ë¶„ë¥˜
    activities.forEach(activity => {
        const student = students.find(s => s.name === activity.student_name);
        const level = student ? (student.level || 1) : 1;
        if (levelData[level]) {
            levelData[level].activities.push(activity);
        }
    });

    // ë ˆë²¨ë³„ ì„±ì·¨ë„ ê³„ì‚°
    const achievements = [];
    const satisfactions = [];

    for (let level = 1; level <= 5; level++) {
        const data = levelData[level];

        if (data.activities.length > 0) {
            // ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚° (ì •ë‹µë¥  ê¸°ë°˜)
            const avgAccuracy = data.activities.reduce((sum, a) => sum + (a.accuracy || 0), 0) / data.activities.length;
            const targetAccuracy = 80; // ë ˆë²¨ë³„ ëª©í‘œ ì •ë‹µë¥ 
            const achievement = Math.min(100, Math.round((avgAccuracy / targetAccuracy) * 100));
            achievements.push(achievement);

            // í•™ìŠµ ë§Œì¡±ë„ ê³„ì‚° (ì™„ë£Œìœ¨ê³¼ ì°¸ì—¬ë„ ê¸°ë°˜)
            const completedActivities = data.activities.filter(a => (a.accuracy || 0) >= 70).length;
            const completionRate = (completedActivities / data.activities.length) * 100;
            const participationBonus = data.students.length > 0 ? 10 : 0;
            const satisfaction = Math.min(100, Math.round(completionRate + participationBonus));
            satisfactions.push(satisfaction);

        } else {
            // í™œë™ì´ ì—†ëŠ” ë ˆë²¨ì€ ê¸°ë³¸ê°’
            achievements.push(50);
            satisfactions.push(50);
        }
    }

    console.log('ğŸ“Š ë ˆë²¨ë³„ ì„±ì·¨ë„ ê³„ì‚° ì™„ë£Œ:', { achievements, satisfactions });
    return { achievements, satisfactions };
}

// ì›”ë³„ ì°¨íŠ¸ ë°ì´í„° ë™ì  ìƒì„± í•¨ìˆ˜
function generateMonthlyChartData() {
    const activities = testDB.getData('activities') || [];
    const currentDate = new Date();
    const monthsData = [];

    console.log('ğŸ“ˆ ì›”ë³„ ì°¨íŠ¸ ë°ì´í„° ë™ì  ìƒì„± ì‹œì‘...');

    // ìµœê·¼ 8ê°œì›” ë°ì´í„° ìƒì„±
    for (let i = 7; i >= 0; i--) {
        const targetDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
        const monthName = `${targetDate.getMonth() + 1}ì›”`;

        // í•´ë‹¹ ì›”ì˜ í™œë™ í•„í„°ë§
        const monthActivities = activities.filter(activity => {
            const activityDate = new Date(activity.completed_time);
            return activityDate.getFullYear() === targetDate.getFullYear() &&
                   activityDate.getMonth() === targetDate.getMonth();
        });

        // í•´ë‹¹ ì›”ì˜ í‰ê·  ì •ë‹µë¥  ê³„ì‚°
        let avgAccuracy = 0;
        if (monthActivities.length > 0) {
            avgAccuracy = Math.round(
                monthActivities.reduce((sum, a) => sum + (a.accuracy || 0), 0) / monthActivities.length
            );
        } else {
            // í™œë™ì´ ì—†ëŠ” ì›”ì€ ì´ì „ ë‹¬ ê¸°ì¤€ìœ¼ë¡œ ì•½ê°„ì˜ ë³€ë™
            const prevMonth = monthsData[monthsData.length - 1];
            avgAccuracy = prevMonth ? prevMonth.accuracy + (Math.random() * 6 - 3) : 80 + (Math.random() * 10);
            avgAccuracy = Math.round(Math.max(75, Math.min(95, avgAccuracy)));
        }

        // í•´ë‹¹ ì›”ì˜ ì™„ë£Œìœ¨ ê³„ì‚°
        let completionRate = 0;
        if (monthActivities.length > 0) {
            const completedCount = monthActivities.filter(a => (a.accuracy || 0) >= 80).length;
            completionRate = Math.round((completedCount / monthActivities.length) * 100);
        } else {
            // í™œë™ì´ ì—†ëŠ” ì›”ì€ ì •ë‹µë¥  ê¸°ë°˜ìœ¼ë¡œ ì¶”ì •
            completionRate = Math.round(avgAccuracy * 0.85); // ì •ë‹µë¥ ë³´ë‹¤ ì•½ê°„ ë‚®ê²Œ
        }

        monthsData.push({
            month: monthName,
            accuracy: avgAccuracy,
            completion: completionRate,
            activities: monthActivities.length
        });
    }

    console.log('ğŸ“ˆ ì›”ë³„ ë°ì´í„° ìƒì„± ì™„ë£Œ:', monthsData);
    return monthsData;
}

// ìƒì„¸ í†µê³„ ì‹¤ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
function calculateDetailedStats() {
    const activities = testDB.getData('activities') || [];
    const students = testDB.getData('students') || [];
    const currentStats = testDB.updateStats();

    console.log('ğŸ“Š ìƒì„¸ í†µê³„ ì‹¤ì‹œê°„ ê³„ì‚° ì‹œì‘...');

    // 1. í‰ê·  í•™ìŠµ ì‹œê°„ ê³„ì‚°
    let avgStudyTime = 0;
    if (activities.length > 0) {
        avgStudyTime = Math.round(
            activities.reduce((sum, a) => sum + (a.duration_minutes || 0), 0) / activities.length
        );
    }

    // 2. í•™ìƒ ì°¸ì—¬ìœ¨ ê³„ì‚° (ìµœê·¼ 7ì¼ ë‚´ í™œë™í•œ í•™ìƒ)
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
    const activeStudents = students.filter(s =>
        s.last_activity && new Date(s.last_activity) > weekAgo
    ).length;
    const participationRate = students.length > 0 ?
        Math.round((activeStudents / students.length) * 100) : 0;

    // 3. ì´ì „ ë‹¬ ëŒ€ë¹„ ë³€í™”ìœ¨ ê³„ì‚° (ì‹œë®¬ë ˆì´ì…˜)
    const studyTimeChange = avgStudyTime > 25 ? '+' + Math.round((avgStudyTime - 25) / 25 * 100) + '%' :
                           avgStudyTime < 25 ? '-' + Math.round((25 - avgStudyTime) / 25 * 100) + '%' : '0%';

    const completionChange = currentStats.completion_rate > 75 ? '+5%' :
                            currentStats.completion_rate < 75 ? '-3%' : '0%';

    const accuracyChange = currentStats.avg_accuracy > 85 ? '+2%' :
                          currentStats.avg_accuracy < 85 ? '-1%' : '0%';

    const participationChange = participationRate > 85 ? '+3%' : '-3%';

    const detailedStats = [
        {
            metric: 'í‰ê·  í•™ìŠµ ì‹œê°„',
            current: avgStudyTime + 'ë¶„',
            target: '25ë¶„',
            achievement: Math.round((avgStudyTime / 25) * 100),
            change: studyTimeChange,
            trend: studyTimeChange.includes('+') ? 'ğŸ“ˆ' : studyTimeChange.includes('-') ? 'ğŸ“‰' : 'ğŸ“Š',
            status: avgStudyTime >= 25 ? 'excellent' : 'warning'
        },
        {
            metric: 'ì±•í„° ì™„ë£Œìœ¨',
            current: currentStats.completion_rate + '%',
            target: '80%',
            achievement: Math.round((currentStats.completion_rate / 80) * 100),
            change: completionChange,
            trend: completionChange.includes('+') ? 'ğŸ“ˆ' : completionChange.includes('-') ? 'ğŸ“‰' : 'ğŸ“Š',
            status: currentStats.completion_rate >= 80 ? 'excellent' : 'warning'
        },
        {
            metric: 'ì •ë‹µë¥ ',
            current: currentStats.avg_accuracy + '%',
            target: '85%',
            achievement: Math.round((currentStats.avg_accuracy / 85) * 100),
            change: accuracyChange,
            trend: accuracyChange.includes('+') ? 'ğŸ“ˆ' : accuracyChange.includes('-') ? 'ğŸ“‰' : 'ğŸ“Š',
            status: currentStats.avg_accuracy >= 85 ? 'excellent' : 'warning'
        },
        {
            metric: 'í•™ìƒ ì°¸ì—¬ìœ¨',
            current: participationRate + '%',
            target: '90%',
            achievement: Math.round((participationRate / 90) * 100),
            change: participationChange,
            trend: participationChange.includes('+') ? 'ğŸ“ˆ' : 'ğŸ“‰',
            status: participationRate >= 85 ? 'excellent' : 'warning'
        },
        {
            metric: 'ì¬ë“±ë¡ë¥ ',
            current: analytics.calculateRetentionRate(students) + '%',
            target: '90%',
            achievement: Math.round((analytics.calculateRetentionRate(students) / 90) * 100),
            change: '+7%',
            trend: 'ğŸ“ˆ',
            status: 'excellent'
        }
    ];

    console.log('ğŸ“Š ìƒì„¸ í†µê³„ ê³„ì‚° ì™„ë£Œ:', detailedStats);
    return detailedStats;
}

// ë¶„ì„ ì°¨íŠ¸ ë¡œë“œ í•¨ìˆ˜ ê°œì„  (í•˜ë“œì½”ë”© ì œê±°)
function loadAnalyticsCharts(data) {
    console.log('ğŸ“Š ë¶„ì„ ì°¨íŠ¸ ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ë¡œë“œ ì‹œì‘...');

    // ì„±ê³¼ ë¶„ì„ ì°¨íŠ¸ - ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜
    const performanceCtx = document.getElementById('performance-chart');
    if (performanceCtx) {
        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (charts.performance) {
            charts.performance.destroy();
        }

        const monthlyData = generateMonthlyChartData();
        const currentData = testDB.updateStats();

        charts.performance = new Chart(performanceCtx, {
            type: 'bar',
            data: {
                labels: monthlyData.map(d => d.month),
                datasets: [{
                    label: 'í‰ê·  ì •ë‹µë¥  (%)',
                    data: monthlyData.map(d => d.accuracy),
                    backgroundColor: 'rgba(52, 152, 219, 0.8)',
                    borderColor: '#3498db',
                    borderWidth: 1
                }, {
                    label: 'ì™„ë£Œìœ¨ (%)',
                    data: monthlyData.map(d => d.completion),
                    backgroundColor: 'rgba(46, 204, 113, 0.8)',
                    borderColor: '#2ecc71',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'ì‹¤ì‹œê°„ ì„±ê³¼ ë¶„ì„ (ìµœê·¼ 8ê°œì›”)',
                        font: { size: 14, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                const index = context[0].dataIndex;
                                const activityCount = monthlyData[index].activities;
                                return `í•™ìŠµ í™œë™: ${activityCount}íšŒ`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'ë¹„ìœ¨ (%)' }
                    }
                }
            }
        });

        console.log('ğŸ“ˆ ì„±ê³¼ ë¶„ì„ ì°¨íŠ¸ ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ìƒì„± ì™„ë£Œ');
    }

    // ë ˆë²¨ë³„ ì„±ì·¨ë„ ì°¨íŠ¸ - ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜
    const achievementCtx = document.getElementById('achievement-chart');
    if (achievementCtx) {
        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (charts.achievement) {
            charts.achievement.destroy();
        }

        const levelData = calculateLevelAchievements();

        charts.achievement = new Chart(achievementCtx, {
            type: 'radar',
            data: {
                labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'],
                datasets: [{
                    label: 'ëª©í‘œ ë‹¬ì„±ë¥ ',
                    data: levelData.achievements,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: '#3498db',
                    borderWidth: 2,
                    pointBackgroundColor: '#3498db'
                }, {
                    label: 'í•™ìŠµ ë§Œì¡±ë„',
                    data: levelData.satisfactions,
                    backgroundColor: 'rgba(46, 204, 113, 0.2)',
                    borderColor: '#2ecc71',
                    borderWidth: 2,
                    pointBackgroundColor: '#2ecc71'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'ì‹¤ì‹œê°„ ë ˆë²¨ë³„ ì„±ì·¨ë„',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { stepSize: 20 },
                        pointLabels: { font: { size: 12 } }
                    }
                }
            }
        });

        console.log('ğŸ¯ ë ˆë²¨ë³„ ì„±ì·¨ë„ ì°¨íŠ¸ ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ìƒì„± ì™„ë£Œ');
    }
}

// API ì‹œë®¬ë ˆì´í„°ì˜ generateDetailedStats ë©”ì„œë“œ ì‹¤ì‹œê°„ ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´
if (typeof apiSim !== 'undefined') {
    const originalGenerateDetailedStats = apiSim.generateDetailedStats;

    apiSim.generateDetailedStats = function(currentData) {
        console.log('ğŸ“Š API: ì‹¤ì‹œê°„ ìƒì„¸ í†µê³„ ìƒì„± ì¤‘...');
        return calculateDetailedStats();
    };

    console.log('ğŸ”§ API ì‹œë®¬ë ˆì´í„° ìƒì„¸ í†µê³„ í•¨ìˆ˜ ì‹¤ì‹œê°„ ê³„ì‚°ìœ¼ë¡œ êµì²´ ì™„ë£Œ');
}

// updateDetailedStatsTable í•¨ìˆ˜ ê°œì„ 
const originalUpdateDetailedStatsTable = updateDetailedStatsTable;
updateDetailedStatsTable = function(statsData) {
    const tbody = document.getElementById('analytics-stats-body');
    if (!tbody || !statsData) return;

    console.log('ğŸ“Š ìƒì„¸ í†µê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸:', statsData);
    tbody.innerHTML = '';

    statsData.forEach((stat, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.1}s`;
        row.className = 'table-row-animate';

        let statusClass = 'inactive';
        let statusText = 'ë¯¸ë‹¬';
        if (stat.status === 'excellent' || stat.achievement >= 100) {
            statusClass = 'active';
            statusText = 'ëª©í‘œ ë‹¬ì„±';
        } else if (stat.achievement >= 90) {
            statusClass = 'warning';
            statusText = 'ê±°ì˜ ë‹¬ì„±';
        } else if (stat.achievement >= 70) {
            statusClass = 'new';
            statusText = 'ì§„í–‰ ì¤‘';
        }

        const changeColor = stat.change.includes('+') ? '#28a745' :
                           stat.change.includes('-') ? '#dc3545' : '#6c757d';

        row.innerHTML = `
            <td><strong>${stat.metric}</strong></td>
            <td><span style="font-weight: 600;">${stat.current}</span></td>
            <td>${stat.target}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    ${stat.achievement}%
                    <div style="width: 50px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(stat.achievement, 100)}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px;"></div>
                    </div>
                </div>
            </td>
            <td style="color: ${changeColor}; font-weight: 600;">${stat.change}</td>
            <td style="font-size: 1.2rem;">${stat.trend}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        `;
        tbody.appendChild(row);
    });

    console.log('ğŸ“Š ìƒì„¸ í†µê³„ í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ');
};

// ì„±ê³¼ ì°¨íŠ¸ ê¸°ê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ê°œì„ 
const originalUpdatePerformanceChart = updatePerformanceChart;
updatePerformanceChart = function(period) {
    console.log(`ğŸ“ˆ ì„±ê³¼ ì°¨íŠ¸ ê¸°ê°„ ë³€ê²½: ${period}`);

    document.querySelectorAll('#analytics-section .filter-btn').forEach(btn => btn.classList.remove('active'));
    if (event && event.target) {
        event.target.classList.add('active');
    }

    // ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    loadAnalyticsCharts();
    showAlert(`ğŸ“Š ${period} ê¸°ê°„ ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
};

console.log('âœ… 2ë‹¨ê³„: ë¶„ì„ ë¦¬í¬íŠ¸ í•˜ë“œì½”ë”© ì œê±° ì™„ë£Œ!');
console.log('ğŸ“Š ê°œì„ ëœ ê¸°ëŠ¥:');
console.log('â€¢ ë ˆë²¨ë³„ ì„±ì·¨ë„ ì‹¤ì‹œê°„ ê³„ì‚°');
console.log('â€¢ ì›”ë³„ ì°¨íŠ¸ ë°ì´í„° ë™ì  ìƒì„±');
console.log('â€¢ ìƒì„¸ í†µê³„ ì‹¤ì‹œê°„ ê³„ì‚°');
console.log('â€¢ ëª¨ë“  ì°¨íŠ¸ê°€ ì‹¤ì œ ë°ì´í„° ê¸°ë°˜');
console.log('â€¢ ì„±ê³¼ ì§€í‘œ ì‹¤ì‹œê°„ ë°˜ì˜');
</script>

<script>
// ===== í…ŒìŠ¤íŠ¸ìš© ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± í•¨ìˆ˜ =====
function generateTestDataForAnalytics() {
    console.log('ğŸ§ª ë¶„ì„ í…ŒìŠ¤íŠ¸ìš© ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± ì‹œì‘...');

    const students = testDB.getData('students');
    const books = testDB.getData('books');
    const activities = testDB.getData('activities');

    // 1. ì¶”ê°€ í•™ìƒ ìƒì„± (ê° ë ˆë²¨ë³„ë¡œ)
    const additionalStudents = [
        { id: 4, name: "ê¹€ë ˆë²¨1", level: 1, total_sessions: 5, avg_accuracy: 85, last_activity: new Date().toISOString(), status: "active" },
        { id: 5, name: "ì´ë ˆë²¨1", level: 1, total_sessions: 8, avg_accuracy: 78, last_activity: new Date().toISOString(), status: "active" },
        { id: 6, name: "ë°•ë ˆë²¨2", level: 2, total_sessions: 12, avg_accuracy: 89, last_activity: new Date().toISOString(), status: "active" },
        { id: 7, name: "ìµœë ˆë²¨3", level: 3, total_sessions: 15, avg_accuracy: 92, last_activity: new Date().toISOString(), status: "active" },
        { id: 8, name: "ì •ë ˆë²¨4", level: 4, total_sessions: 18, avg_accuracy: 84, last_activity: new Date().toISOString(), status: "active" },
        { id: 9, name: "í•œë ˆë²¨5", level: 5, total_sessions: 22, avg_accuracy: 88, last_activity: new Date().toISOString(), status: "active" },
        { id: 10, name: "ìœ¤ë ˆë²¨5", level: 5, total_sessions: 25, avg_accuracy: 91, last_activity: new Date().toISOString(), status: "active" }
    ];

    students.push(...additionalStudents);

    // 2. ì§€ë‚œ ëª‡ ê°œì›”ì— ê±¸ì¹œ í™œë™ ë°ì´í„° ìƒì„±
    const currentDate = new Date();
    const bookTitles = books.map(b => b.title);
    const studentNames = students.map(s => s.name);

    // ì§€ë‚œ 6ê°œì›”ê°„ í™œë™ ìƒì„±
    for (let month = 0; month < 6; month++) {
        for (let day = 0; day < 30; day++) {
            // í•˜ë£¨ì— 1-3ê°œ í™œë™ ëœë¤ ìƒì„±
            const dailyActivities = Math.floor(Math.random() * 3) + 1;

            for (let i = 0; i < dailyActivities; i++) {
                const activityDate = new Date(currentDate);
                activityDate.setMonth(activityDate.getMonth() - month);
                activityDate.setDate(activityDate.getDate() - day);
                activityDate.setHours(Math.floor(Math.random() * 12) + 9); // 9-21ì‹œ

                const randomStudent = studentNames[Math.floor(Math.random() * studentNames.length)];
                const randomBook = bookTitles[Math.floor(Math.random() * bookTitles.length)];

                // ë ˆë²¨ì— ë”°ë¥¸ ì •ë‹µë¥  ì¡°ì •
                const student = students.find(s => s.name === randomStudent);
                const baseAccuracy = student ? (student.level * 15 + 60) : 80; // ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ë†’ì€ ì •ë‹µë¥ 
                const accuracy = Math.min(100, Math.max(40, baseAccuracy + (Math.random() * 20 - 10)));

                const newActivity = {
                    id: activities.length + 1,
                    student_name: randomStudent,
                    book_title: randomBook,
                    chapter: Math.floor(Math.random() * 15) + 1,
                    accuracy: Math.round(accuracy),
                    duration_minutes: Math.floor(Math.random() * 40) + 15,
                    completed_time: activityDate.toISOString()
                };

                activities.push(newActivity);
            }
        }
    }

    // 3. ë°ì´í„° ì €ì¥
    testDB.setData('students', students);
    testDB.setData('activities', activities);

    // 4. ë„ì„œ í†µê³„ ì—…ë°ì´íŠ¸
    if (testDB.updateBooksStats) {
        testDB.updateBooksStats();
    }

    console.log(`ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ:`);
    console.log(`â€¢ í•™ìƒ: ${students.length}ëª…`);
    console.log(`â€¢ í™œë™: ${activities.length}ê°œ`);
    console.log(`â€¢ ê¸°ê°„: ìµœê·¼ 6ê°œì›”`);

    showAlert(`ğŸ§ª ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ!\ní•™ìƒ: ${students.length}ëª…, í™œë™: ${activities.length}ê°œ`, 'success');

    // ë¶„ì„ í˜ì´ì§€ê°€ ì—´ë ¤ìˆë‹¤ë©´ ìë™ ìƒˆë¡œê³ ì¹¨
    if (currentSection === 'analytics') {
        setTimeout(() => loadRealTimeAnalytics(), 1000);
    }
}

// í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± ë²„íŠ¼ ì¶”ê°€ í•¨ìˆ˜
function addBulkTestButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('bulk-test-btn')) {
        const bulkTestBtn = document.createElement('button');
        bulkTestBtn.id = 'bulk-test-btn';
        bulkTestBtn.className = 'test-btn';
        bulkTestBtn.style.background = '#6f42c1';
        bulkTestBtn.innerHTML = 'ğŸ§ª ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„°';
        bulkTestBtn.onclick = generateTestDataForAnalytics;

        // ê¸°ì¡´ ë²„íŠ¼ë“¤ ë‹¤ìŒì— ì¶”ê°€
        testPanel.insertBefore(bulkTestBtn, document.getElementById('api-status'));

        console.log('ğŸ§ª ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„° ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ ì¶”ê°€
setTimeout(addBulkTestButton, 1000);

console.log('ğŸ§ª ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜ ì¤€ë¹„ ì™„ë£Œ');
console.log('ğŸ“‹ ì‚¬ìš©ë²•: ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ì—ì„œ "ğŸ§ª ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„°" ë²„íŠ¼ í´ë¦­');
</script>

<script>
// ===== í•™ìƒ ëª©ë¡ ì¦‰ì‹œ ìˆ˜ì • =====

// í•™ìƒ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ì™„ì „ êµ¬í˜„
async function loadStudentsData() {
    if (document.getElementById('students-section').style.display === 'none') return;

    console.log('ğŸ‘¥ í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹œì‘...');

    const loadingEl = document.getElementById('students-loading');
    const tableEl = document.getElementById('students-table-container');

    try {
        // ë¡œë”© í‘œì‹œ
        if (loadingEl) loadingEl.style.display = 'flex';
        if (tableEl) tableEl.style.display = 'none';

        const response = await apiCall('/api/admin/students');

        if (response.success) {
            console.log('ğŸ‘¥ í•™ìƒ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', response.data);
            renderStudentsTable(response.data || []);
            if (tableEl) tableEl.style.display = 'table';
        } else {
            throw new Error(response.error || 'í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('âŒ í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert(`í•™ìƒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
        renderStudentsError();
    } finally {
        if (loadingEl) loadingEl.style.display = 'none';
    }
}

// í•™ìƒ í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ ì™„ì „ êµ¬í˜„
function renderStudentsTable(students) {
    const tbody = document.getElementById('students-table');
    if (!tbody) {
        console.error('âŒ students-table ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }

    tbody.innerHTML = '';

    if (!students || students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    console.log(`ğŸ‘¥ ${students.length}ëª…ì˜ í•™ìƒ í…Œì´ë¸” ë Œë”ë§ ì‹œì‘...`);

    students.forEach((student, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.1}s`;
        row.className = 'table-row-animate';

        let statusClass = 'inactive';
        let statusText = 'ë¹„í™œì„±';
        if (student.status === 'active') {
            statusClass = 'active';
            statusText = 'í™œì„±';
        } else if (student.status === 'new') {
            statusClass = 'new';
            statusText = 'ì‹ ê·œ';
        }

        const avgAccuracy = student.avg_accuracy || 0;
        const totalSessions = student.total_sessions || 0;

        // ìµœê·¼ í™œë™ ì‹œê°„ í¬ë§·
        let lastActivityText = 'í™œë™ ì—†ìŒ';
        let lastActivityColor = '#dc3545';
        if (student.last_activity) {
            lastActivityText = formatRelativeTime(student.last_activity);
            // ìµœê·¼ 1ì‹œê°„ ì´ë‚´ë©´ ì´ˆë¡ìƒ‰, 1ì¼ ì´ë‚´ë©´ íŒŒë€ìƒ‰, ê·¸ ì™¸ëŠ” íšŒìƒ‰
            const timeDiff = Date.now() - new Date(student.last_activity).getTime();
            if (timeDiff < 60 * 60 * 1000) { // 1ì‹œê°„
                lastActivityColor = '#28a745';
            } else if (timeDiff < 24 * 60 * 60 * 1000) { // 1ì¼
                lastActivityColor = '#17a2b8';
            } else {
                lastActivityColor = '#6c757d';
            }
        }

        row.innerHTML = `
            <td><span style="font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-weight: bold;">${student.id}</span></td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, #3498db, #2ecc71); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">
                        ${(student.name || '').charAt(0)}
                    </div>
                    <span style="font-weight: 600;">${student.name || '-'}</span>
                </div>
            </td>
            <td><span class="level-badge level-${student.level || 1}">Level ${student.level || 1}</span></td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: 600;">ğŸ“š ${totalSessions}íšŒ</span>
                    <div style="width: 50px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(totalSessions * 3, 100)}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px;"></div>
                    </div>
                </div>
            </td>
            <td>
                <span style="font-weight: 600; color: ${avgAccuracy >= 90 ? '#28a745' : avgAccuracy >= 80 ? '#17a2b8' : avgAccuracy >= 70 ? '#ffc107' : '#dc3545'};">
                    ${avgAccuracy}%
                </span>
            </td>
            <td>
                <span style="color: ${lastActivityColor}; font-weight: 500;">
                    ${lastActivityText}
                </span>
            </td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
                <button class="action-btn view" onclick="viewStudentDetails(${student.id})" title="ìƒì„¸ë³´ê¸°">ğŸ‘ï¸</button>
                <button class="action-btn edit" onclick="editStudent(${student.id})" title="í¸ì§‘">âœï¸</button>
                <button class="action-btn" onclick="viewStudentProgress(${student.id})" title="í•™ìŠµì§„í–‰" style="color: #17a2b8; border-color: #17a2b8;">ğŸ“ˆ</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    console.log(`ğŸ‘¥ ${students.length}ëª… í•™ìƒ í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ`);
}

// í•™ìƒ ì—ëŸ¬ ë Œë”ë§
function renderStudentsError() {
    const tbody = document.getElementById('students-table');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545; padding: 40px;">âŒ í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.</td></tr>';
    }
}

// í•™ìƒ ê´€ë ¨ ì•¡ì…˜ í•¨ìˆ˜ë“¤
function viewStudentDetails(studentId) {
    console.log(`ğŸ‘¥ í•™ìƒ ìƒì„¸ë³´ê¸°: ${studentId}`);

    const students = testDB.getData('students') || [];
    const student = students.find(s => s.id === studentId);

    if (student) {
        const activities = testDB.getData('activities') || [];
        const studentActivities = activities.filter(a => a.student_name === student.name);

        let detailMessage = `ğŸ‘¥ ${student.name} (ID: ${student.id})\n`;
        detailMessage += `ë ˆë²¨: Level ${student.level}\n`;
        detailMessage += `ìƒíƒœ: ${student.status}\n`;
        detailMessage += `ì´ ì„¸ì…˜: ${student.total_sessions}íšŒ\n`;
        detailMessage += `í‰ê·  ì •ë‹µë¥ : ${student.avg_accuracy}%\n`;
        detailMessage += `ë§ˆì§€ë§‰ í™œë™: ${formatRelativeTime(student.last_activity)}\n`;
        detailMessage += `ì´ í•™ìŠµ í™œë™: ${studentActivities.length}íšŒ`;

        showAlert(detailMessage, 'info');
    } else {
        showAlert(`í•™ìƒ ID ${studentId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

function editStudent(studentId) {
    showAlert(`ğŸ“ í•™ìƒ ID ${studentId} í¸ì§‘ ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.`, 'info');
}

function viewStudentProgress(studentId) {
    console.log(`ğŸ“ˆ í•™ìƒ í•™ìŠµì§„í–‰ ë³´ê¸°: ${studentId}`);

    const students = testDB.getData('students') || [];
    const student = students.find(s => s.id === studentId);

    if (student) {
        const activities = testDB.getData('activities') || [];
        const studentActivities = activities.filter(a => a.student_name === student.name);

        // ìµœê·¼ 5ê°œ í™œë™
        const recentActivities = studentActivities
            .sort((a, b) => new Date(b.completed_time) - new Date(a.completed_time))
            .slice(0, 5);

        let progressMessage = `ğŸ“ˆ ${student.name} í•™ìŠµ ì§„í–‰ í˜„í™©\n\n`;
        progressMessage += `ğŸ“Š ì „ì²´ í†µê³„:\n`;
        progressMessage += `â€¢ ì´ ì„¸ì…˜: ${studentActivities.length}íšŒ\n`;
        progressMessage += `â€¢ í‰ê·  ì •ë‹µë¥ : ${student.avg_accuracy}%\n`;
        progressMessage += `â€¢ í˜„ì¬ ë ˆë²¨: Level ${student.level}\n\n`;

        if (recentActivities.length > 0) {
            progressMessage += `ğŸ“š ìµœê·¼ í•™ìŠµ í™œë™:\n`;
            recentActivities.forEach((activity, index) => {
                progressMessage += `${index + 1}. ${activity.book_title} Ch.${activity.chapter} (${activity.accuracy}%)\n`;
            });
        }

        showAlert(progressMessage, 'info');
    }
}

// loadSectionDataì— students ì¼€ì´ìŠ¤ ì¶”ê°€
const originalLoadSectionData2 = loadSectionData;
loadSectionData = function(sectionName) {
    switch(sectionName) {
        case 'analytics':
            loadRealTimeAnalytics();
            break;
        case 'dashboard':
            loadDashboardData();
            break;
        case 'books':
            loadBooksData();
            break;
        case 'students':
            loadStudentsData(); // ğŸ‘¥ í•™ìƒ ëª©ë¡ ë¡œë“œ ì¶”ê°€
            break;
        // ë‹¤ë¥¸ ì„¹ì…˜ë“¤...
        default:
            if (originalLoadSectionData2) {
                originalLoadSectionData2(sectionName);
            }
    }
};

console.log('âœ… í•™ìƒ ëª©ë¡ ê¸°ëŠ¥ ìˆ˜ì • ì™„ë£Œ!');
console.log('ğŸ‘¥ í•™ìƒ ê´€ë¦¬ ê¸°ëŠ¥:');
console.log('â€¢ ì‹¤ì‹œê°„ í•™ìƒ ëª©ë¡ í…Œì´ë¸”');
console.log('â€¢ í•™ìƒ ìƒì„¸ ì •ë³´ ë³´ê¸°');
console.log('â€¢ í•™ìŠµ ì§„í–‰ í˜„í™© ë¶„ì„');
console.log('â€¢ ë ˆë²¨ë³„ ìƒíƒœ í‘œì‹œ');
</script>

<script>
// ===== ê°•ì œ ë””ë²„ê¹… ë° ë¬¸ì œ í•´ê²° =====

// ì¦‰ì‹œ ì‹¤í–‰ ë””ë²„ê¹… í•¨ìˆ˜
function debugStudentsIssue() {
    console.log('ğŸ” í•™ìƒ ëª©ë¡ ë¬¸ì œ ë””ë²„ê¹… ì‹œì‘...');

    // 1. ë°ì´í„° í™•ì¸
    const students = testDB.getData('students');
    console.log('ğŸ“Š í˜„ì¬ í•™ìƒ ë°ì´í„°:', students);

    // 2. DOM ìš”ì†Œ í™•ì¸
    const studentsSection = document.getElementById('students-section');
    const studentsTable = document.getElementById('students-table');
    const studentsLoading = document.getElementById('students-loading');

    console.log('ğŸ¯ DOM ìš”ì†Œ í™•ì¸:');
    console.log('â€¢ students-section:', studentsSection ? 'ì¡´ì¬' : 'ì—†ìŒ');
    console.log('â€¢ students-table:', studentsTable ? 'ì¡´ì¬' : 'ì—†ìŒ');
    console.log('â€¢ students-loading:', studentsLoading ? 'ì¡´ì¬' : 'ì—†ìŒ');

    // 3. ê°•ì œë¡œ í•™ìƒ í…Œì´ë¸” ë Œë”ë§
    if (studentsTable && students && students.length > 0) {
        console.log('ğŸ”§ ê°•ì œ í•™ìƒ í…Œì´ë¸” ë Œë”ë§ ì‹œë„...');
        renderStudentsTable(students);
        showAlert('ğŸ”§ í•™ìƒ ë°ì´í„° ê°•ì œ ë Œë”ë§ ì™„ë£Œ!', 'success');
    } else {
        console.error('âŒ í•™ìƒ ë°ì´í„° ë˜ëŠ” í…Œì´ë¸” ìš”ì†Œ ë¬¸ì œ');
        if (!students || students.length === 0) {
            console.log('ğŸ“‹ í•™ìƒ ë°ì´í„° ê°•ì œ ìƒì„±...');
            forceCreateStudentData();
        }
    }
}

// í•™ìƒ ë°ì´í„° ê°•ì œ ìƒì„±
function forceCreateStudentData() {
    console.log('ğŸ‘¥ í•™ìƒ ë°ì´í„° ê°•ì œ ìƒì„± ì‹œì‘...');

    const students = [
        {
            id: 1, name: "ê¹€ì² ìˆ˜", level: 3, total_sessions: 24, avg_accuracy: 88,
            last_activity: new Date(Date.now() - 1000 * 60 * 30).toISOString(), status: "active"
        },
        {
            id: 2, name: "ì´ì˜í¬", level: 2, total_sessions: 18, avg_accuracy: 92,
            last_activity: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(), status: "active"
        },
        {
            id: 3, name: "ë°•ë¯¼ìˆ˜", level: 4, total_sessions: 31, avg_accuracy: 85,
            last_activity: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(), status: "new"
        },
        {
            id: 4, name: "ìµœì§€í›ˆ", level: 1, total_sessions: 12, avg_accuracy: 79,
            last_activity: new Date(Date.now() - 1000 * 60 * 60 * 5).toISOString(), status: "active"
        },
        {
            id: 5, name: "ì •í•˜ë‚˜", level: 5, total_sessions: 35, avg_accuracy: 94,
            last_activity: new Date(Date.now() - 1000 * 60 * 15).toISOString(), status: "active"
        }
    ];

    testDB.setData('students', students);
    console.log('ğŸ‘¥ í•™ìƒ ë°ì´í„° ê°•ì œ ìƒì„± ì™„ë£Œ:', students);

    // ì¦‰ì‹œ í…Œì´ë¸” ë Œë”ë§
    const studentsTable = document.getElementById('students-table');
    if (studentsTable) {
        renderStudentsTable(students);
        showAlert('ğŸ‘¥ í•™ìƒ ë°ì´í„°ê°€ ê°•ì œë¡œ ìƒì„±ë˜ê³  í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }
}

// í•™ìƒ ì„¹ì…˜ ê°•ì œ í™œì„±í™” í•¨ìˆ˜
function forceShowStudents() {
    console.log('ğŸ‘¥ í•™ìƒ ì„¹ì…˜ ê°•ì œ í‘œì‹œ...');

    // í˜„ì¬ ì„¹ì…˜ì„ studentsë¡œ ë³€ê²½
    currentSection = 'students';

    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });

    // í•™ìƒ ì„¹ì…˜ë§Œ í‘œì‹œ
    const studentsSection = document.getElementById('students-section');
    if (studentsSection) {
        studentsSection.style.display = 'block';
        console.log('âœ… í•™ìƒ ì„¹ì…˜ í‘œì‹œë¨');
    }

    // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    // í˜ì´ì§€ ì œëª© ë³€ê²½
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        pageTitle.textContent = 'í•™ìƒ ê´€ë¦¬';
    }

    // ê°•ì œë¡œ í•™ìƒ ë°ì´í„° ë¡œë“œ
    setTimeout(() => {
        debugStudentsIssue();
    }, 500);

    showAlert('ğŸ‘¥ í•™ìƒ ê´€ë¦¬ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™í–ˆìŠµë‹ˆë‹¤!', 'info');
}

// í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€
function addDebugButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('debug-students-btn')) {
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debug-students-btn';
        debugBtn.className = 'test-btn danger';
        debugBtn.innerHTML = 'ğŸ”§ í•™ìƒ ëª©ë¡ ìˆ˜ì •';
        debugBtn.onclick = forceShowStudents;

        // API ìƒíƒœ ì „ì— ì¶”ê°€
        testPanel.insertBefore(debugBtn, document.getElementById('api-status'));

        console.log('ğŸ”§ í•™ìƒ ëª©ë¡ ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// ì¦‰ì‹œ ì‹¤í–‰
setTimeout(() => {
    addDebugButton();

    // í˜„ì¬ í•™ìƒ ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì¦‰ì‹œ ë””ë²„ê¹…
    if (currentSection === 'students') {
        debugStudentsIssue();
    }
}, 1000);

console.log('ğŸ”§ í•™ìƒ ëª©ë¡ ë””ë²„ê¹… ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
console.log('ğŸ“‹ ì‚¬ìš©ë²•: ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ì—ì„œ "ğŸ”§ í•™ìƒ ëª©ë¡ ìˆ˜ì •" ë²„íŠ¼ í´ë¦­');
</script>

<script>
// ===== 1ë‹¨ê³„: í•™ìŠµí˜„í™© ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ =====

// ê¸°ì¡´ ë¹ˆ í•™ìŠµí˜„í™© ì„¹ì…˜ì„ ì™„ì „í•œ êµ¬ì¡°ë¡œ êµì²´
function replaceActivitiesSection() {
    console.log('ğŸ“‹ í•™ìŠµí˜„í™© ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì‹œì‘...');

    const activitiesSection = document.getElementById('activities-section');
    if (activitiesSection) {
        activitiesSection.innerHTML = `
            <!-- í•™ìŠµí˜„í™© í•„í„° ì¹´ë“œ -->
            <div class="dashboard-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="activities-today">0</div>
                            <div class="stat-label">ì˜¤ëŠ˜ í•™ìŠµ í™œë™</div>
                        </div>
                        <div class="stat-icon sessions">ğŸ“–</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ”¥</span>
                        <span>ì‹¤ì‹œê°„ ì§‘ê³„</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="activities-week">0</div>
                            <div class="stat-label">ì´ë²ˆ ì£¼ í•™ìŠµ</div>
                        </div>
                        <div class="stat-icon accuracy">ğŸ“Š</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ“ˆ</span>
                        <span>ì£¼ê°„ ì§‘ê³„</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="activities-avg-accuracy">0%</div>
                            <div class="stat-label">í‰ê·  ì •ë‹µë¥ </div>
                        </div>
                        <div class="stat-icon students">ğŸ¯</div>
                    </div>
                    <div class="stat-change" id="accuracy-trend">
                        <span>ğŸ’¯</span>
                        <span>ê³„ì‚° ì¤‘...</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="activities-completion">0%</div>
                            <div class="stat-label">ì™„ë£Œìœ¨</div>
                        </div>
                        <div class="stat-icon books">âœ…</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸš€</span>
                        <span>80% ì´ìƒ ì •ë‹µë¥ </span>
                    </div>
                </div>
            </div>

            <!-- í•™ìŠµí˜„í™© í•„í„° ë° ê²€ìƒ‰ -->
            <div class="data-table-section">
                <div class="table-header">
                    <h3 class="table-title">ğŸ“‹ í•™ìŠµ í˜„í™© ê´€ë¦¬</h3>
                    <div class="table-controls">
                        <select id="activities-period-filter" onchange="filterActivitiesByPeriod(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                            <option value="all">ì „ì²´ ê¸°ê°„</option>
                            <option value="today">ì˜¤ëŠ˜</option>
                            <option value="week" selected>ì´ë²ˆ ì£¼</option>
                            <option value="month">ì´ë²ˆ ë‹¬</option>
                        </select>
                        <select id="activities-level-filter" onchange="filterActivitiesByLevel(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                            <option value="all">ëª¨ë“  ë ˆë²¨</option>
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                        </select>
                        <div class="search-box">
                            <input type="text" class="search-input" id="activities-search" placeholder="í•™ìƒ ì´ë¦„ ë˜ëŠ” ë„ì„œëª… ê²€ìƒ‰..." onkeyup="filterActivitiesTable(this.value)">
                            <span class="search-icon">ğŸ”</span>
                        </div>
                        <button class="export-btn" onclick="exportActivitiesData()">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                        <button class="refresh-btn" onclick="refreshActivitiesData()" style="margin-left: 10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <!-- ë¡œë”© í‘œì‹œ -->
                <div id="activities-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>í•™ìŠµ í˜„í™© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                </div>

                <!-- í•™ìŠµí˜„í™© í…Œì´ë¸” -->
                <table class="data-table" id="activities-table-container">
                    <thead>
                        <tr>
                            <th>í•™ìŠµ ì¼ì‹œ</th>
                            <th>í•™ìƒ ì •ë³´</th>
                            <th>ë„ì„œ/ì±•í„°</th>
                            <th>í•™ìŠµ ì‹œê°„</th>
                            <th>ì •ë‹µë¥ </th>
                            <th>ì™„ë£Œ ìƒíƒœ</th>
                            <th>ì„±ê³¼ ë“±ê¸‰</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="activities-table">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #666; padding: 40px;">í•™ìŠµ í˜„í™© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ (ì¶”í›„ êµ¬í˜„) -->
                <div id="activities-pagination" style="display: flex; justify-content: center; margin-top: 20px; gap: 10px;">
                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- í•™ìŠµ íŒ¨í„´ ë¶„ì„ ì°¨íŠ¸ -->
            <div class="chart-section" style="margin-top: 30px;">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">ğŸ“ˆ ì‹œê°„ë³„ í•™ìŠµ íŒ¨í„´</h3>
                        <div class="chart-filters">
                            <button class="filter-btn active" onclick="updateHourlyChart('today')">ì˜¤ëŠ˜</button>
                            <button class="filter-btn" onclick="updateHourlyChart('week')">ì´ë²ˆ ì£¼</button>
                            <button class="filter-btn" onclick="updateHourlyChart('month')">ì´ë²ˆ ë‹¬</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="hourly-pattern-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">ğŸ¯ ì„±ê³¼ ë¶„í¬</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="performance-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        `;

        console.log('âœ… í•™ìŠµí˜„í™© ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì™„ë£Œ');
        showAlert('ğŸ“‹ í•™ìŠµí˜„í™© ì„¹ì…˜ êµ¬ì¡°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    } else {
        console.error('âŒ activities-section ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

// ì¦‰ì‹œ ì‹¤í–‰
setTimeout(replaceActivitiesSection, 500);

console.log('âœ… 1ë‹¨ê³„: í•™ìŠµí˜„í™© ì„¹ì…˜ HTML êµ¬ì¡° ì¶”ê°€ ì™„ë£Œ');
</script>

<script>
// ===== 2ë‹¨ê³„: í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ í•¨ìˆ˜ =====

// í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
async function loadActivitiesData() {
    if (document.getElementById('activities-section').style.display === 'none') return;

    console.log('ğŸ“‹ í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ ì‹œì‘...');

    const loadingEl = document.getElementById('activities-loading');
    const tableEl = document.getElementById('activities-table-container');

    try {
        // ë¡œë”© í‘œì‹œ
        if (loadingEl) loadingEl.style.display = 'flex';
        if (tableEl) tableEl.style.display = 'none';

        // í™œë™ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await apiCall('/api/admin/recent-activities');

        if (response.success) {
            console.log('ğŸ“‹ í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ ì„±ê³µ:', response.data);
            const activities = response.data || [];

            // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateActivitiesStats(activities);

            // í…Œì´ë¸” ë Œë”ë§
            renderActivitiesTable(activities);

            // ì°¨íŠ¸ ë¡œë“œ
            loadActivitiesCharts(activities);

            if (tableEl) tableEl.style.display = 'table';

        } else {
            throw new Error(response.error || 'í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('âŒ í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert(`í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
        renderActivitiesError();
    } finally {
        if (loadingEl) loadingEl.style.display = 'none';
    }
}

// í•™ìŠµí˜„í™© í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateActivitiesStats(activities) {
    if (!activities || activities.length === 0) {
        document.getElementById('activities-today').textContent = '0';
        document.getElementById('activities-week').textContent = '0';
        document.getElementById('activities-avg-accuracy').textContent = '0%';
        document.getElementById('activities-completion').textContent = '0%';
        return;
    }

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    // ì˜¤ëŠ˜ í™œë™
    const todayActivities = activities.filter(activity => {
        const activityDate = new Date(activity.completed_time);
        return activityDate >= today;
    });

    // ì´ë²ˆ ì£¼ í™œë™
    const weekActivities = activities.filter(activity => {
        const activityDate = new Date(activity.completed_time);
        return activityDate >= weekAgo;
    });

    // í†µê³„ ê³„ì‚°
    const totalAccuracy = activities.reduce((sum, a) => sum + (a.accuracy || 0), 0);
    const avgAccuracy = activities.length > 0 ? Math.round(totalAccuracy / activities.length) : 0;

    const completedActivities = activities.filter(a => (a.accuracy || 0) >= 80).length;
    const completionRate = activities.length > 0 ? Math.round((completedActivities / activities.length) * 100) : 0;

    // UI ì—…ë°ì´íŠ¸
    animateCounter('activities-today', todayActivities.length);
    animateCounter('activities-week', weekActivities.length);

    document.getElementById('activities-avg-accuracy').textContent = avgAccuracy + '%';
    document.getElementById('activities-completion').textContent = completionRate + '%';

    // ì •í™•ë„ íŠ¸ë Œë“œ ì—…ë°ì´íŠ¸
    const trendEl = document.getElementById('accuracy-trend');
    if (trendEl) {
        if (avgAccuracy >= 90) {
            trendEl.innerHTML = '<span>ğŸŒŸ</span><span>ìš°ìˆ˜í•œ ì„±ê³¼</span>';
            trendEl.className = 'stat-change positive';
        } else if (avgAccuracy >= 80) {
            trendEl.innerHTML = '<span>ğŸ‘</span><span>ì–‘í˜¸í•œ ì„±ê³¼</span>';
            trendEl.className = 'stat-change positive';
        } else if (avgAccuracy >= 70) {
            trendEl.innerHTML = '<span>âš ï¸</span><span>ê°œì„  í•„ìš”</span>';
            trendEl.className = 'stat-change warning';
        } else {
            trendEl.innerHTML = '<span>ğŸ“ˆ</span><span>ì§€ì› í•„ìš”</span>';
            trendEl.className = 'stat-change negative';
        }
    }

    console.log(`ğŸ“Š í•™ìŠµí˜„í™© í†µê³„ ì—…ë°ì´íŠ¸: ì˜¤ëŠ˜ ${todayActivities.length}, ì£¼ê°„ ${weekActivities.length}, í‰ê·  ì •ë‹µë¥  ${avgAccuracy}%`);
}

// í•™ìŠµí˜„í™© í…Œì´ë¸” ë Œë”ë§
function renderActivitiesTable(activities) {
    const tbody = document.getElementById('activities-table');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!activities || activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">í•™ìŠµ í˜„í™© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    console.log(`ğŸ“‹ ${activities.length}ê°œ í•™ìŠµí˜„í™© ë Œë”ë§ ì‹œì‘...`);

    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedActivities = activities.sort((a, b) => new Date(b.completed_time) - new Date(a.completed_time));

    sortedActivities.forEach((activity, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.05}s`;
        row.className = 'table-row-animate';

        const accuracy = activity.accuracy || 0;
        const duration = activity.duration_minutes || 0;

        // ì„±ê³¼ ë“±ê¸‰ ê³„ì‚°
        let gradeClass = 'inactive';
        let gradeText = 'D';
        let gradeIcon = 'ğŸ“‰';

        if (accuracy >= 95) {
            gradeClass = 'active';
            gradeText = 'S';
            gradeIcon = 'ğŸŒŸ';
        } else if (accuracy >= 90) {
            gradeClass = 'active';
            gradeText = 'A';
            gradeIcon = 'ğŸ¯';
        } else if (accuracy >= 80) {
            gradeClass = 'new';
            gradeText = 'B';
            gradeIcon = 'ğŸ‘';
        } else if (accuracy >= 70) {
            gradeClass = 'warning';
            gradeText = 'C';
            gradeIcon = 'âš ï¸';
        }

        // ì™„ë£Œ ìƒíƒœ
        const isCompleted = accuracy >= 80;
        const statusClass = isCompleted ? 'active' : 'inactive';
        const statusText = isCompleted ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ';

        // í•™ìŠµ ì‹œê°„ì— ë”°ë¥¸ ìƒ‰ìƒ
        const durationColor = duration >= 30 ? '#28a745' : duration >= 15 ? '#17a2b8' : '#ffc107';

        // í•™ìƒ ì •ë³´ (í•™ìƒ ë°ì´í„°ì—ì„œ ë ˆë²¨ ì°¾ê¸°)
        const students = testDB.getData('students') || [];
        const student = students.find(s => s.name === activity.student_name);
        const studentLevel = student ? student.level : 1;

        row.innerHTML = `
            <td>
                <div style="font-size: 0.9rem;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px;">
                        ${formatDate(activity.completed_time).split(' ')[0]}
                    </div>
                    <div style="color: #6c757d; font-size: 0.8rem;">
                        ${formatDate(activity.completed_time).split(' ')[1]}
                    </div>
                </div>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(45deg, #3498db, #2ecc71); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem;">
                        ${(activity.student_name || '').charAt(0)}
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #2c3e50;">${activity.student_name || '-'}</div>
                        <span class="level-badge level-${studentLevel}">Level ${studentLevel}</span>
                    </div>
                </div>
            </td>
            <td>
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px; color: #2c3e50; font-size: 0.9rem;">
                        ${activity.book_title || '-'}
                    </div>
                    <div style="color: #666; font-size: 0.8rem;">
                        ğŸ“– Chapter ${activity.chapter || '-'}
                    </div>
                </div>
            </td>
            <td>
                <span style="font-weight: 600; color: ${durationColor}; display: flex; align-items: center; gap: 5px;">
                    â±ï¸ ${duration}ë¶„
                </span>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600; color: ${accuracy >= 90 ? '#28a745' : accuracy >= 80 ? '#17a2b8' : accuracy >= 70 ? '#ffc107' : '#dc3545'};">
                        ${accuracy}%
                    </span>
                    <div style="width: 60px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${accuracy}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px; transition: width 0.5s ease;"></div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 1.2rem;">${gradeIcon}</span>
                    <span class="level-badge level-${gradeText === 'S' || gradeText === 'A' ? '5' : gradeText === 'B' ? '3' : gradeText === 'C' ? '2' : '1'}">${gradeText}</span>
                </div>
            </td>
            <td>
                <button class="action-btn view" onclick="viewActivityDetail(${activity.id})" title="ìƒì„¸ë³´ê¸°">ğŸ‘ï¸</button>
                <button class="action-btn edit" onclick="reviewActivity(${activity.id})" title="ê²€í† ">ğŸ“</button>
                <button class="action-btn" onclick="viewStudentProgress('${activity.student_name}')" title="í•™ìƒì§„í–‰" style="color: #17a2b8; border-color: #17a2b8;">ğŸ“ˆ</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    console.log(`ğŸ“‹ ${activities.length}ê°œ í•™ìŠµí˜„í™© í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ`);
}

// í•™ìŠµí˜„í™© ì—ëŸ¬ ë Œë”ë§
function renderActivitiesError() {
    const tbody = document.getElementById('activities-table');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545; padding: 40px;">âŒ í•™ìŠµí˜„í™© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.</td></tr>';
    }
}

console.log('âœ… 2ë‹¨ê³„: í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ í•¨ìˆ˜ ì¶”ê°€ ì™„ë£Œ');
</script>

<script>
// ===== 3ë‹¨ê³„: í•™ìŠµí˜„í™© í•„í„°ë§ ë° ì°¨íŠ¸ í•¨ìˆ˜ =====

// ê¸°ê°„ë³„ í•„í„°ë§
function filterActivitiesByPeriod(period) {
    console.log(`ğŸ“… ê¸°ê°„ë³„ í•„í„°ë§: ${period}`);

    const activities = testDB.getData('activities') || [];
    const now = new Date();
    let filteredActivities = [];

    switch(period) {
        case 'today':
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            filteredActivities = activities.filter(activity => {
                const activityDate = new Date(activity.completed_time);
                return activityDate >= today;
            });
            break;
        case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            filteredActivities = activities.filter(activity => {
                const activityDate = new Date(activity.completed_time);
                return activityDate >= weekAgo;
            });
            break;
        case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            filteredActivities = activities.filter(activity => {
                const activityDate = new Date(activity.completed_time);
                return activityDate >= monthAgo;
            });
            break;
        default:
            filteredActivities = activities;
    }

    updateActivitiesStats(filteredActivities);
    renderActivitiesTable(filteredActivities);
    loadActivitiesCharts(filteredActivities);

    showAlert(`ğŸ“… ${period} í•„í„° ì ìš©: ${filteredActivities.length}ê°œ í™œë™`, 'info');
}

// ë ˆë²¨ë³„ í•„í„°ë§
function filterActivitiesByLevel(level) {
    console.log(`ğŸ“Š ë ˆë²¨ë³„ í•„í„°ë§: ${level}`);

    const activities = testDB.getData('activities') || [];
    const students = testDB.getData('students') || [];

    let filteredActivities = activities;

    if (level !== 'all') {
        filteredActivities = activities.filter(activity => {
            const student = students.find(s => s.name === activity.student_name);
            return student && student.level == level;
        });
    }

    renderActivitiesTable(filteredActivities);
    showAlert(`ğŸ“Š Level ${level} í•„í„° ì ìš©: ${filteredActivities.length}ê°œ í™œë™`, 'info');
}

// í…Œì´ë¸” ê²€ìƒ‰ í•„í„°ë§
function filterActivitiesTable(searchTerm) {
    const table = document.getElementById('activities-table');
    if (!table) return;

    const rows = table.getElementsByTagName('tr');
    const searchLower = searchTerm.toLowerCase();

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const studentName = row.cells[1] ? row.cells[1].textContent.toLowerCase() : '';
        const bookTitle = row.cells[2] ? row.cells[2].textContent.toLowerCase() : '';

        if (studentName.includes(searchLower) || bookTitle.includes(searchLower)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

// í•™ìŠµí˜„í™© ì°¨íŠ¸ ë¡œë“œ
function loadActivitiesCharts(activities) {
    if (!activities || activities.length === 0) return;

    console.log('ğŸ“Š í•™ìŠµí˜„í™© ì°¨íŠ¸ ë¡œë“œ ì‹œì‘...');

    // ì‹œê°„ë³„ í•™ìŠµ íŒ¨í„´ ì°¨íŠ¸
    loadHourlyPatternChart(activities);

    // ì„±ê³¼ ë¶„í¬ ì°¨íŠ¸
    loadPerformanceDistributionChart(activities);
}

// ì‹œê°„ë³„ í•™ìŠµ íŒ¨í„´ ì°¨íŠ¸
function loadHourlyPatternChart(activities) {
    const ctx = document.getElementById('hourly-pattern-chart');
    if (!ctx || !activities) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (charts.hourlyPattern) {
        charts.hourlyPattern.destroy();
    }

    // ì‹œê°„ë³„ ë°ì´í„° ì§‘ê³„ (0-23ì‹œ)
    const hourlyData = new Array(24).fill(0);

    activities.forEach(activity => {
        const hour = new Date(activity.completed_time).getHours();
        hourlyData[hour]++;
    });

    const hours = [];
    for (let i = 0; i < 24; i++) {
        hours.push(i + 'ì‹œ');
    }

    charts.hourlyPattern = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: [{
                label: 'í•™ìŠµ í™œë™ ìˆ˜',
                data: hourlyData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ì‹œê°„ëŒ€ë³„ í•™ìŠµ í™œë™ ë¶„í¬',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed.y}íšŒ í•™ìŠµ`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'í•™ìŠµ í™œë™ ìˆ˜' }
                },
                x: {
                    title: { display: true, text: 'ì‹œê°„ëŒ€' }
                }
            }
        }
    });

    console.log('ğŸ“ˆ ì‹œê°„ë³„ í•™ìŠµ íŒ¨í„´ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
}

// ì„±ê³¼ ë¶„í¬ ì°¨íŠ¸
function loadPerformanceDistributionChart(activities) {
    const ctx = document.getElementById('performance-distribution-chart');
    if (!ctx || !activities) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (charts.performanceDistribution) {
        charts.performanceDistribution.destroy();
    }

    // ì„±ê³¼ ë“±ê¸‰ë³„ ë¶„í¬ ê³„ì‚°
    const grades = {
        'S (95-100%)': 0,
        'A (90-94%)': 0,
        'B (80-89%)': 0,
        'C (70-79%)': 0,
        'D (0-69%)': 0
    };

    activities.forEach(activity => {
        const accuracy = activity.accuracy || 0;
        if (accuracy >= 95) grades['S (95-100%)']++;
        else if (accuracy >= 90) grades['A (90-94%)']++;
        else if (accuracy >= 80) grades['B (80-89%)']++;
        else if (accuracy >= 70) grades['C (70-79%)']++;
        else grades['D (0-69%)']++;
    });

    charts.performanceDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(grades),
            datasets: [{
                data: Object.values(grades),
                backgroundColor: [
                    '#28a745', // S - ì´ˆë¡
                    '#17a2b8', // A - íŒŒë‘
                    '#ffc107', // B - ë…¸ë‘
                    '#fd7e14', // C - ì£¼í™©
                    '#dc3545'  // D - ë¹¨ê°•
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ì„±ê³¼ ë“±ê¸‰ë³„ ë¶„í¬',
                    font: { size: 14, weight: 'bold' }
                },
                legend: {
                    position: 'bottom',
                    labels: { padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            if (total === 0) return `${context.label}: 0ëª… (0%)`;
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}ëª… (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    console.log('ğŸ¯ ì„±ê³¼ ë¶„í¬ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
}

// ì‹œê°„ë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
function updateHourlyChart(period) {
    console.log(`ğŸ“Š ì‹œê°„ë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸: ${period}`);

    // í•„í„° ë²„íŠ¼ í™œì„±í™”
    const chartSection = document.querySelector('.chart-section');
    if (chartSection) {
        chartSection.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // ê¸°ê°„ì— ë”°ë¥¸ ë°ì´í„° í•„í„°ë§
    const activities = testDB.getData('activities') || [];
    const now = new Date();
    let filteredActivities = [];

    switch(period) {
        case 'today':
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            filteredActivities = activities.filter(activity => {
                const activityDate = new Date(activity.completed_time);
                return activityDate >= today;
            });
            break;
        case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            filteredActivities = activities.filter(activity => {
                const activityDate = new Date(activity.completed_time);
                return activityDate >= weekAgo;
            });
            break;
        case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            filteredActivities = activities.filter(activity => {
                const activityDate = new Date(activity.completed_time);
                return activityDate >= monthAgo;
            });
            break;
        default:
            filteredActivities = activities;
    }

    loadHourlyPatternChart(filteredActivities);
    showAlert(`ğŸ“Š ${period} ì‹œê°„ë³„ íŒ¨í„´ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
}

console.log('âœ… 3ë‹¨ê³„: í•™ìŠµí˜„í™© í•„í„°ë§ ë° ì°¨íŠ¸ í•¨ìˆ˜ ì¶”ê°€ ì™„ë£Œ');
</script>

<script>
// ===== 4ë‹¨ê³„: í•™ìŠµí˜„í™© ì•¡ì…˜ í•¨ìˆ˜ ë° ì—°ë™ =====

// í•™ìŠµí˜„í™© ì•¡ì…˜ í•¨ìˆ˜ë“¤
function viewActivityDetail(activityId) {
    console.log(`ğŸ“‹ í•™ìŠµí™œë™ ìƒì„¸ë³´ê¸°: ${activityId}`);

    const activities = testDB.getData('activities') || [];
    const activity = activities.find(a => a.id === activityId);

    if (activity) {
        const students = testDB.getData('students') || [];
        const student = students.find(s => s.name === activity.student_name);

        let detailMessage = `ğŸ“‹ í•™ìŠµ í™œë™ ìƒì„¸ ì •ë³´\n\n`;
        detailMessage += `ğŸ‘¤ í•™ìƒ: ${activity.student_name}`;
        if (student) {
            detailMessage += ` (Level ${student.level})`;
        }
        detailMessage += `\nğŸ“š ë„ì„œ: ${activity.book_title}\n`;
        detailMessage += `ğŸ“– ì±•í„°: ${activity.chapter}\n`;
        detailMessage += `ğŸ¯ ì •ë‹µë¥ : ${activity.accuracy}%\n`;
        detailMessage += `â±ï¸ í•™ìŠµì‹œê°„: ${activity.duration_minutes}ë¶„\n`;
        detailMessage += `ğŸ“… ì™„ë£Œì¼ì‹œ: ${formatDate(activity.completed_time)}\n`;

        // ì„±ê³¼ ë“±ê¸‰
        const accuracy = activity.accuracy || 0;
        let grade = 'D';
        if (accuracy >= 95) grade = 'S';
        else if (accuracy >= 90) grade = 'A';
        else if (accuracy >= 80) grade = 'B';
        else if (accuracy >= 70) grade = 'C';

        detailMessage += `ğŸ† ì„±ê³¼ ë“±ê¸‰: ${grade}ë“±ê¸‰`;

        showAlert(detailMessage, 'info');
    } else {
        showAlert(`í•™ìŠµ í™œë™ ID ${activityId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

function reviewActivity(activityId) {
    console.log(`ğŸ“ í•™ìŠµí™œë™ ê²€í† : ${activityId}`);

    const activities = testDB.getData('activities') || [];
    const activity = activities.find(a => a.id === activityId);

    if (activity) {
        let reviewMessage = `ğŸ“ "${activity.student_name}" í•™ìŠµ ê²€í† \n\n`;
        reviewMessage += `ğŸ“š ${activity.book_title} Chapter ${activity.chapter}\n`;
        reviewMessage += `ğŸ¯ ì •ë‹µë¥ : ${activity.accuracy}%\n\n`;

        // ê²€í†  ì˜ê²¬ ìƒì„±
        const accuracy = activity.accuracy || 0;
        if (accuracy >= 90) {
            reviewMessage += `âœ… ìš°ìˆ˜í•œ ì„±ê³¼ì…ë‹ˆë‹¤! ê³„ì† ì´ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ì„¸ìš”.`;
        } else if (accuracy >= 80) {
            reviewMessage += `ğŸ‘ ì¢‹ì€ ì„±ê³¼ì…ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ë” ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”.`;
        } else if (accuracy >= 70) {
            reviewMessage += `âš ï¸ ê¸°ë³¸ê¸°ë¥¼ ë‹¤ì‹œ ì ê²€í•´ë³´ì„¸ìš”. ì¶”ê°€ í•™ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`;
        } else {
            reviewMessage += `ğŸ“ˆ ì–´ë ¤ì›€ì´ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê°œë³„ ì§€ë„ê°€ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤.`;
        }

        showAlert(reviewMessage, 'info');
    } else {
        showAlert(`í•™ìŠµ í™œë™ ID ${activityId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

// í•™ìŠµí˜„í™© ë°ì´í„° ìƒˆë¡œê³ ì¹¨
async function refreshActivitiesData() {
    console.log('ğŸ”„ í•™ìŠµí˜„í™© ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
    btn.disabled = true;

    try {
        await loadActivitiesData();
        showAlert('ğŸ“‹ í•™ìŠµí˜„í™© ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

    } catch (error) {
        console.error('âŒ í•™ìŠµí˜„í™© ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        showAlert(`í•™ìŠµí˜„í™© ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }
}

// í•™ìŠµí˜„í™© ë°ì´í„° ë‚´ë³´ë‚´ê¸°
function exportActivitiesData() {
    try {
        const table = document.getElementById('activities-table-container');
        if (!table) {
            showAlert('ë‚´ë³´ë‚¼ í•™ìŠµí˜„í™© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        const rows = table.querySelectorAll('tr');
        let csvContent = '';

        rows.forEach(row => {
            const cells = row.querySelectorAll('th, td');
            const rowData = Array.from(cells).map(cell => {
                return `"${cell.textContent.replace(/"/g, '""')}"`;
            });
            csvContent += rowData.join(',') + '\n';
        });

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');

        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `activities_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        showAlert('ğŸ“Š í•™ìŠµí˜„í™© ë°ì´í„°ê°€ CSVë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'success');

    } catch (error) {
        console.error('âŒ í•™ìŠµí˜„í™© ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
        showAlert('í•™ìŠµí˜„í™© ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// loadSectionDataì— activities ì¼€ì´ìŠ¤ ì¶”ê°€ (ë®ì–´ì“°ê¸°)
const originalLoadSectionData3 = loadSectionData;
loadSectionData = function(sectionName) {
    switch(sectionName) {
        case 'analytics':
            loadRealTimeAnalytics();
            break;
        case 'dashboard':
            loadDashboardData();
            break;
        case 'books':
            loadBooksData();
            break;
        case 'students':
            loadStudentsData();
            break;
        case 'activities':
            loadActivitiesData(); // ğŸ“‹ í•™ìŠµí˜„í™© ë¡œë“œ ì¶”ê°€
            break;
        // ë‹¤ë¥¸ ì„¹ì…˜ë“¤...
        default:
            if (originalLoadSectionData3) {
                originalLoadSectionData3(sectionName);
            }
    }
};

// í•™ìŠµí˜„í™© í…ŒìŠ¤íŠ¸ íŒ¨ë„ ë²„íŠ¼ ì¶”ê°€
function addActivitiesTestButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('activities-test-btn')) {
        const activitiesTestBtn = document.createElement('button');
        activitiesTestBtn.id = 'activities-test-btn';
        activitiesTestBtn.className = 'test-btn';
        activitiesTestBtn.style.background = '#17a2b8';
        activitiesTestBtn.innerHTML = 'ğŸ“‹ í•™ìŠµí˜„í™© ë³´ê¸°';
        activitiesTestBtn.onclick = function() {
            showSection('activities');
        };

        // ê¸°ì¡´ ë²„íŠ¼ë“¤ ë‹¤ìŒì— ì¶”ê°€
        testPanel.insertBefore(activitiesTestBtn, document.getElementById('api-status'));

        console.log('ğŸ“‹ í•™ìŠµí˜„í™© í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ ì¶”ê°€
setTimeout(addActivitiesTestButton, 1500);

// ì°¨íŠ¸ ê°ì²´ ì´ˆê¸°í™” í™•ì¥
if (typeof charts === 'undefined') {
    charts = {};
}
charts.hourlyPattern = null;
charts.performanceDistribution = null;

console.log('âœ… 4ë‹¨ê³„: í•™ìŠµí˜„í™© ì•¡ì…˜ í•¨ìˆ˜ ë° ì—°ë™ ì™„ë£Œ');
console.log('ğŸ“‹ í•™ìŠµí˜„í™© ê´€ë¦¬ ê¸°ëŠ¥:');
console.log('â€¢ ì‹¤ì‹œê°„ í•™ìŠµí˜„í™© í…Œì´ë¸”');
console.log('â€¢ ê¸°ê°„ë³„/ë ˆë²¨ë³„ í•„í„°ë§');
console.log('â€¢ ì‹œê°„ë³„ í•™ìŠµ íŒ¨í„´ ì°¨íŠ¸');
console.log('â€¢ ì„±ê³¼ ë¶„í¬ ì°¨íŠ¸');
console.log('â€¢ í•™ìŠµ í™œë™ ìƒì„¸ë³´ê¸°');
console.log('â€¢ ë°ì´í„° ë‚´ë³´ë‚´ê¸°');
console.log('ğŸ“ í…ŒìŠ¤íŠ¸: ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ "ğŸ“‹ í•™ìŠµí˜„í™© ë³´ê¸°" ë²„íŠ¼ í´ë¦­');
</script>

<script>
// ===== ìµœì¢… ë‹¨ê³„: í•™ìŠµí˜„í™© ê¸°ëŠ¥ ì™„ì„± ë° í…ŒìŠ¤íŠ¸ =====

// í•™ìŠµí˜„í™© ì„¹ì…˜ ê°•ì œ í™œì„±í™” í•¨ìˆ˜
function forceShowActivities() {
    console.log('ğŸ“‹ í•™ìŠµí˜„í™© ì„¹ì…˜ ê°•ì œ í‘œì‹œ...');

    // í˜„ì¬ ì„¹ì…˜ì„ activitiesë¡œ ë³€ê²½
    currentSection = 'activities';

    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });

    // í•™ìŠµí˜„í™© ì„¹ì…˜ë§Œ í‘œì‹œ
    const activitiesSection = document.getElementById('activities-section');
    if (activitiesSection) {
        activitiesSection.style.display = 'block';
        console.log('âœ… í•™ìŠµí˜„í™© ì„¹ì…˜ í‘œì‹œë¨');
    }

    // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.textContent.includes('í•™ìŠµ í˜„í™©')) {
            item.classList.add('active');
        }
    });

    // í˜ì´ì§€ ì œëª© ë³€ê²½
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        pageTitle.textContent = 'í•™ìŠµ í˜„í™©';
    }

    // ê°•ì œë¡œ í•™ìŠµí˜„í™© ë°ì´í„° ë¡œë“œ
    setTimeout(() => {
        loadActivitiesData();
    }, 500);

    showAlert('ğŸ“‹ í•™ìŠµí˜„í™© í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™í–ˆìŠµë‹ˆë‹¤!', 'info');
}

// í•™ìŠµí˜„í™© ë””ë²„ê¹… í•¨ìˆ˜
function debugActivitiesIssue() {
    console.log('ğŸ” í•™ìŠµí˜„í™© ë¬¸ì œ ë””ë²„ê¹… ì‹œì‘...');

    // 1. ë°ì´í„° í™•ì¸
    const activities = testDB.getData('activities');
    console.log('ğŸ“Š í˜„ì¬ í•™ìŠµí˜„í™© ë°ì´í„°:', activities);

    // 2. DOM ìš”ì†Œ í™•ì¸
    const activitiesSection = document.getElementById('activities-section');
    const activitiesTable = document.getElementById('activities-table');
    const activitiesLoading = document.getElementById('activities-loading');

    console.log('ğŸ¯ DOM ìš”ì†Œ í™•ì¸:');
    console.log('â€¢ activities-section:', activitiesSection ? 'ì¡´ì¬' : 'ì—†ìŒ');
    console.log('â€¢ activities-table:', activitiesTable ? 'ì¡´ì¬' : 'ì—†ìŒ');
    console.log('â€¢ activities-loading:', activitiesLoading ? 'ì¡´ì¬' : 'ì—†ìŒ');

    // 3. ê°•ì œë¡œ í•™ìŠµí˜„í™© í…Œì´ë¸” ë Œë”ë§
    if (activitiesTable && activities && activities.length > 0) {
        console.log('ğŸ”§ ê°•ì œ í•™ìŠµí˜„í™© í…Œì´ë¸” ë Œë”ë§ ì‹œë„...');
        renderActivitiesTable(activities);
        updateActivitiesStats(activities);
        loadActivitiesCharts(activities);
        showAlert('ğŸ”§ í•™ìŠµí˜„í™© ë°ì´í„° ê°•ì œ ë Œë”ë§ ì™„ë£Œ!', 'success');
    } else {
        console.error('âŒ í•™ìŠµí˜„í™© ë°ì´í„° ë˜ëŠ” í…Œì´ë¸” ìš”ì†Œ ë¬¸ì œ');
        if (!activities || activities.length === 0) {
            console.log('ğŸ“‹ í•™ìŠµí˜„í™© ë°ì´í„° ê°•ì œ ìƒì„±...');
            forceCreateActivitiesData();
        }
    }
}

// í•™ìŠµí˜„í™© ë°ì´í„° ê°•ì œ ìƒì„±
function forceCreateActivitiesData() {
    console.log('ğŸ“‹ í•™ìŠµí˜„í™© ë°ì´í„° ê°•ì œ ìƒì„± ì‹œì‘...');

    const students = testDB.getData('students') || [];
    const books = testDB.getData('books') || [];
    let activities = testDB.getData('activities') || [];

    // ê¸°ì¡´ í™œë™ì´ ì ë‹¤ë©´ ì¶”ê°€ ìƒì„±
    if (activities.length < 10) {
        const additionalActivities = [];
        const now = new Date();

        for (let i = 0; i < 15; i++) {
            const randomStudent = students[Math.floor(Math.random() * students.length)];
            const randomBook = books[Math.floor(Math.random() * books.length)];

            if (randomStudent && randomBook) {
                // ì§€ë‚œ 7ì¼ ë‚´ ëœë¤ ì‹œê°„
                const randomDate = new Date(now.getTime() - Math.random() * 7 * 24 * 60 * 60 * 1000);
                randomDate.setHours(Math.floor(Math.random() * 12) + 9); // 9-21ì‹œ
                randomDate.setMinutes(Math.floor(Math.random() * 60));

                const newActivity = {
                    id: activities.length + additionalActivities.length + 1,
                    student_name: randomStudent.name,
                    book_title: randomBook.title,
                    chapter: Math.floor(Math.random() * 10) + 1,
                    accuracy: Math.floor(Math.random() * 40) + 60, // 60-100%
                    duration_minutes: Math.floor(Math.random() * 40) + 15, // 15-55ë¶„
                    completed_time: randomDate.toISOString()
                };

                additionalActivities.push(newActivity);
            }
        }

        activities.push(...additionalActivities);
        testDB.setData('activities', activities);
        console.log('ğŸ“‹ í•™ìŠµí˜„í™© ë°ì´í„° ì¶”ê°€ ìƒì„± ì™„ë£Œ:', additionalActivities.length);
    }

    // ì¦‰ì‹œ í…Œì´ë¸” ë Œë”ë§
    const activitiesTable = document.getElementById('activities-table');
    if (activitiesTable && activities.length > 0) {
        renderActivitiesTable(activities);
        updateActivitiesStats(activities);
        loadActivitiesCharts(activities);
        showAlert('ğŸ“‹ í•™ìŠµí˜„í™© ë°ì´í„°ê°€ ê°•ì œë¡œ ìƒì„±ë˜ê³  í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }
}

// í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— í•™ìŠµí˜„í™© ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€
function addActivitiesDebugButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('debug-activities-btn')) {
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debug-activities-btn';
        debugBtn.className = 'test-btn';
        debugBtn.style.background = '#6f42c1';
        debugBtn.innerHTML = 'ğŸ”§ í•™ìŠµí˜„í™© ìˆ˜ì •';
        debugBtn.onclick = forceShowActivities;

        // API ìƒíƒœ ì „ì— ì¶”ê°€
        testPanel.insertBefore(debugBtn, document.getElementById('api-status'));

        console.log('ğŸ”§ í•™ìŠµí˜„í™© ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// í•™ìŠµí˜„í™© ì´ˆê¸°í™” í•¨ìˆ˜
function initializeActivitiesSection() {
    console.log('ğŸš€ í•™ìŠµí˜„í™© ì„¹ì…˜ ì´ˆê¸°í™”...');

    // HTML êµ¬ì¡° í™•ì¸ ë° êµì²´
    setTimeout(() => {
        replaceActivitiesSection();

        // ë°ì´í„° í™•ì¸
        setTimeout(() => {
            const activities = testDB.getData('activities');
            if (!activities || activities.length < 5) {
                forceCreateActivitiesData();
            }
        }, 1000);

        // ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€
        setTimeout(() => {
            addActivitiesDebugButton();
        }, 1500);

    }, 500);
}

// ì¦‰ì‹œ ì‹¤í–‰
setTimeout(() => {
    initializeActivitiesSection();

    // í˜„ì¬ í•™ìŠµí˜„í™© ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì¦‰ì‹œ ë””ë²„ê¹…
    if (currentSection === 'activities') {
        setTimeout(() => {
            debugActivitiesIssue();
        }, 2000);
    }
}, 1000);

// ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (í…ŒìŠ¤íŠ¸ìš©)
window.showActivities = forceShowActivities;
window.debugActivities = debugActivitiesIssue;

console.log('âœ… ìµœì¢… ë‹¨ê³„: í•™ìŠµí˜„í™© ê¸°ëŠ¥ ì™„ì„± ë° í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
console.log('ğŸ¯ í…ŒìŠ¤íŠ¸ ë°©ë²•:');
console.log('1. ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ì—ì„œ "ğŸ”§ í•™ìŠµí˜„í™© ìˆ˜ì •" ë²„íŠ¼ í´ë¦­');
console.log('2. ë˜ëŠ” ì‚¬ì´ë“œë°”ì—ì„œ "í•™ìŠµ í˜„í™©" ë©”ë‰´ í´ë¦­');
console.log('3. ë˜ëŠ” ì½˜ì†”ì—ì„œ showActivities() ì‹¤í–‰');
console.log('ğŸ“‹ í•™ìŠµí˜„í™© í˜ì´ì§€ì—ì„œ ë‹¤ìŒ ê¸°ëŠ¥ë“¤ì„ í™•ì¸í•˜ì„¸ìš”:');
console.log('â€¢ ì‹¤ì‹œê°„ í†µê³„ ì¹´ë“œ');
console.log('â€¢ ìƒì„¸í•œ í•™ìŠµí˜„í™© í…Œì´ë¸”');
console.log('â€¢ ê¸°ê°„ë³„/ë ˆë²¨ë³„ í•„í„°ë§');
console.log('â€¢ ì‹œê°„ë³„ í•™ìŠµ íŒ¨í„´ ì°¨íŠ¸');
console.log('â€¢ ì„±ê³¼ ë¶„í¬ ì°¨íŠ¸');
console.log('â€¢ í•™ìŠµ í™œë™ ìƒì„¸ë³´ê¸°');
</script>

<script>
// ===== My Progress í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ì¶”ê°€ =====

// 1. My Progress í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ (ê¸°ì¡´ í…ŒìŠ¤íŠ¸ íŒ¨ë„ì—)
function addMyProgressTestButtons() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('my-progress-test-section')) {

        // My Progress ì„¹ì…˜ ì œëª© ì¶”ê°€
        const sectionTitle = document.createElement('div');
        sectionTitle.innerHTML = '<h4 style="color: #667eea; margin-top: 15px; margin-bottom: 10px;">ğŸ“Š My Progress í…ŒìŠ¤íŠ¸</h4>';
        testPanel.insertBefore(sectionTitle, document.getElementById('api-status'));

        // My Progress í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤
        const myProgressButtons = [
            {
                id: 'test-my-progress-login',
                text: 'ğŸ” ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸',
                color: '#3498db',
                action: 'testMyProgressLogin'
            },
            {
                id: 'test-my-progress-data',
                text: 'ğŸ“Š ì§„í–‰ë¥  ë°ì´í„° í™•ì¸',
                color: '#2ecc71',
                action: 'testMyProgressData'
            },
            {
                id: 'test-my-progress-apis',
                text: 'ğŸ”— ëª¨ë“  API í…ŒìŠ¤íŠ¸',
                color: '#e67e22',
                action: 'testAllMyProgressAPIs'
            },
            {
                id: 'generate-sample-data',
                text: 'ğŸ§ª ìƒ˜í”Œ í•™ìŠµ ë°ì´í„° ìƒì„±',
                color: '#9b59b6',
                action: 'generateSampleLearningData'
            },
            {
                id: 'open-my-progress',
                text: 'ğŸ“‹ My Progress í˜ì´ì§€ ì—´ê¸°',
                color: '#17a2b8',
                action: 'openMyProgressPage'
            }
        ];

        // ë²„íŠ¼ë“¤ ì¶”ê°€
        myProgressButtons.forEach(btn => {
            const button = document.createElement('button');
            button.id = btn.id;
            button.className = 'test-btn';
            button.style.background = btn.color;
            button.innerHTML = btn.text;
            button.onclick = window[btn.action];
            testPanel.insertBefore(button, document.getElementById('api-status'));
        });

        console.log('ğŸ“Š My Progress í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤ ì¶”ê°€ ì™„ë£Œ');
    }
}

// 2. My Progress ë¡œê·¸ì¸ ìƒíƒœ í…ŒìŠ¤íŠ¸
async function testMyProgressLogin() {
    console.log('ğŸ” My Progress ë¡œê·¸ì¸ ìƒíƒœ í…ŒìŠ¤íŠ¸ ì‹œì‘');

    try {
        const response = await fetch('/api/session-status', {
            method: 'GET',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.logged_in) {
            showAlert(`âœ… ë¡œê·¸ì¸ ìƒíƒœ ì •ìƒ\nì‚¬ìš©ì: ${data.name} (Level ${data.level})`, 'success');
            updateAPIStatus(`ë¡œê·¸ì¸ í™•ì¸: ${data.name} (ID: ${data.user_id})`);
        } else {
            showAlert('âŒ ë¡œê·¸ì¸ í•„ìš” - My Progress ì‚¬ìš© ë¶ˆê°€', 'error');
            updateAPIStatus('ë¡œê·¸ì¸ ìƒíƒœ: ë¯¸ë¡œê·¸ì¸');
        }
    } catch (error) {
        showAlert(`âŒ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
        updateAPIStatus(`ë¡œê·¸ì¸ í™•ì¸ ì˜¤ë¥˜: ${error.message}`);
    }
}

// 3. My Progress ë°ì´í„° í™•ì¸
async function testMyProgressData() {
    console.log('ğŸ“Š My Progress ë°ì´í„° í™•ì¸ ì‹œì‘');

    try {
        // ë¨¼ì € ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        const sessionResponse = await fetch('/api/session-status', {
            credentials: 'include'
        });
        const sessionData = await sessionResponse.json();

        if (!sessionData.logged_in) {
            showAlert('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            return;
        }

        const userId = sessionData.user_id;
        updateAPIStatus(`ë°ì´í„° í™•ì¸ ì¤‘: ì‚¬ìš©ì ID ${userId}`);

        // ì§„í–‰ë¥  API í˜¸ì¶œ
        const progressResponse = await fetch(`/api/student/${userId}/progress`, {
            credentials: 'include'
        });
        const progressData = await progressResponse.json();

        if (progressData.success) {
            const summary = `
ğŸ“Š My Progress ë°ì´í„° ìš”ì•½:
â€¢ ì´ ì„¸ì…˜: ${progressData.total_sessions}íšŒ
â€¢ í‰ê·  ì •ë‹µë¥ : ${progressData.average_accuracy}%
â€¢ ì´ í•™ìŠµì‹œê°„: ${progressData.total_minutes}ë¶„ (${Math.floor(progressData.total_minutes/60)}ì‹œê°„)
â€¢ ì—°ì† í•™ìŠµì¼: ${progressData.streak_days}ì¼
â€¢ ì™„ë£Œ ë„ì„œ: ${progressData.completed_books_count}ê¶Œ
            `.trim();

            showAlert(summary, 'success');
            updateAPIStatus(`ë°ì´í„° í™•ì¸ ì™„ë£Œ: ${progressData.total_sessions}ì„¸ì…˜`);
        } else {
            showAlert(`âŒ ì§„í–‰ë¥  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ${progressData.error}`, 'error');
            updateAPIStatus(`ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: ${progressData.error}`);
        }

    } catch (error) {
        showAlert(`âŒ ë°ì´í„° í™•ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
        updateAPIStatus(`ë°ì´í„° í™•ì¸ ì˜¤ë¥˜: ${error.message}`);
    }
}

// 4. ëª¨ë“  My Progress API í…ŒìŠ¤íŠ¸
async function testAllMyProgressAPIs() {
    console.log('ğŸ”— ëª¨ë“  My Progress API í…ŒìŠ¤íŠ¸ ì‹œì‘');

    try {
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        const sessionResponse = await fetch('/api/session-status', {
            credentials: 'include'
        });
        const sessionData = await sessionResponse.json();

        if (!sessionData.logged_in) {
            showAlert('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            return;
        }

        const userId = sessionData.user_id;
        const APIs = [
            { name: 'ê¸°ë³¸ ì§„í–‰ë¥ ', url: `/api/student/${userId}/progress` },
            { name: 'ë ˆë²¨ë³„ ì§„í–‰ë¥ ', url: `/api/student/${userId}/level-progress` },
            { name: 'ìµœê·¼ í™œë™', url: `/api/student/${userId}/recent-activities` },
            { name: 'ì¶”ì²œ ë„ì„œ', url: `/api/student/${userId}/recommendations` },
            { name: 'í–¥ìƒëœ ì§„í–‰ë¥ ', url: `/api/student/${userId}/progress-enhanced` }
        ];

        let results = [];
        updateAPIStatus('ëª¨ë“  API í…ŒìŠ¤íŠ¸ ì¤‘...');

        for (const api of APIs) {
            try {
                const response = await fetch(api.url, { credentials: 'include' });
                const data = await response.json();

                if (response.ok) {
                    results.push(`âœ… ${api.name}: ì„±ê³µ`);
                    console.log(`âœ… ${api.name} API ì„±ê³µ:`, data);
                } else {
                    results.push(`âŒ ${api.name}: ${data.error || 'API ì˜¤ë¥˜'}`);
                    console.error(`âŒ ${api.name} API ì‹¤íŒ¨:`, data);
                }
            } catch (error) {
                results.push(`âŒ ${api.name}: ${error.message}`);
                console.error(`âŒ ${api.name} API ì˜¤ë¥˜:`, error);
            }

            // ê° API í˜¸ì¶œ ê°„ ì•½ê°„ì˜ ì§€ì—°
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        const successCount = results.filter(r => r.includes('âœ…')).length;
        const totalCount = results.length;
        const successRate = Math.round((successCount / totalCount) * 100);

        const summary = `
ğŸ”— My Progress API í…ŒìŠ¤íŠ¸ ê²°ê³¼:
ì„±ê³µë¥ : ${successRate}% (${successCount}/${totalCount})

${results.join('\n')}
        `.trim();

        if (successRate >= 80) {
            showAlert(summary, 'success');
            updateAPIStatus(`API í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${successRate}% ì„±ê³µ`);
        } else {
            showAlert(summary, 'warning');
            updateAPIStatus(`API í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ì¼ë¶€ ì‹¤íŒ¨ (${successRate}%)`);
        }

    } catch (error) {
        showAlert(`âŒ API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
        updateAPIStatus(`API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`);
    }
}

// 5. ìƒ˜í”Œ í•™ìŠµ ë°ì´í„° ìƒì„±
async function generateSampleLearningData() {
    console.log('ğŸ§ª ìƒ˜í”Œ í•™ìŠµ ë°ì´í„° ìƒì„± ì‹œì‘');

    try {
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        const sessionResponse = await fetch('/api/session-status', {
            credentials: 'include'
        });
        const sessionData = await sessionResponse.json();

        if (!sessionData.logged_in) {
            showAlert('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            return;
        }

        updateAPIStatus('ìƒ˜í”Œ í•™ìŠµ ë°ì´í„° ìƒì„± ì¤‘...');

        // ìƒ˜í”Œ í•™ìŠµ ì„¸ì…˜ë“¤
        const sampleSessions = [
            {
                bookId: 'CW001',
                bookTitle: "Charlotte's Web",
                chapterIndex: 1,
                accuracy: 88,
                totalQuestions: 10,
                correctAnswers: 9
            },
            {
                bookId: 'MTH001',
                bookTitle: "Magic Tree House #1",
                chapterIndex: 2,
                accuracy: 95,
                totalQuestions: 12,
                correctAnswers: 11
            },
            {
                bookId: 'GEH001',
                bookTitle: "Green Eggs and Ham",
                chapterIndex: 1,
                accuracy: 82,
                totalQuestions: 8,
                correctAnswers: 7
            },
            {
                bookId: 'LWW001',
                bookTitle: "The Lion, the Witch and the Wardrobe",
                chapterIndex: 3,
                accuracy: 91,
                totalQuestions: 15,
                correctAnswers: 14
            },
            {
                bookId: 'BTT001',
                bookTitle: "Bridge to Terabithia",
                chapterIndex: 2,
                accuracy: 86,
                totalQuestions: 11,
                correctAnswers: 9
            }
        ];

        let createdSessions = 0;

        for (const session of sampleSessions) {
            try {
                // ì„¸ì…˜ ì‹œì‘
                const startResponse = await fetch('/api/start-learning-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(session)
                });

                if (startResponse.ok) {
                    const startData = await startResponse.json();

                    // ì„¸ì…˜ ì™„ë£Œ
                    const completeResponse = await fetch('/api/complete-learning-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            sessionId: startData.session_id,
                            accuracy: session.accuracy,
                            totalQuestions: session.totalQuestions,
                            correctAnswers: session.correctAnswers
                        })
                    });

                    if (completeResponse.ok) {
                        createdSessions++;
                        console.log(`âœ… ìƒ˜í”Œ ì„¸ì…˜ ìƒì„±: ${session.bookTitle} (${session.accuracy}%)`);
                        updateAPIStatus(`ìƒì„± ì¤‘: ${session.bookTitle} (${createdSessions}/${sampleSessions.length})`);
                    }
                }
            } catch (error) {
                console.error(`âŒ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨ (${session.bookTitle}):`, error);
            }

            // ê° ì„¸ì…˜ ìƒì„± ê°„ ì§€ì—°
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        if (createdSessions > 0) {
            showAlert(`âœ… ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì™„ë£Œ!\n\nğŸ“Š ìƒì„±ëœ ë°ì´í„°:\nâ€¢ ${createdSessions}ê°œì˜ í•™ìŠµ ì„¸ì…˜\nâ€¢ ë‹¤ì–‘í•œ ì •ë‹µë¥  (82% ~ 95%)\nâ€¢ 5ê¶Œì˜ ì„œë¡œ ë‹¤ë¥¸ ë„ì„œ\n\nğŸ”— My Progress í˜ì´ì§€ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”!`, 'success');
            updateAPIStatus(`ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì™„ë£Œ: ${createdSessions}ê°œ ì„¸ì…˜`);
        } else {
            showAlert('âŒ ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹¤íŒ¨\nì„¸ì…˜ì„ ìƒì„±í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.', 'error');
            updateAPIStatus('ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹¤íŒ¨');
        }

    } catch (error) {
        showAlert(`âŒ ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
        updateAPIStatus(`ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì˜¤ë¥˜: ${error.message}`);
    }
}

// 6. My Progress í˜ì´ì§€ ì—´ê¸°
function openMyProgressPage() {
    console.log('ğŸ“‹ My Progress í˜ì´ì§€ ì—´ê¸°');

    // ìƒˆ íƒ­ì—ì„œ My Progress í˜ì´ì§€ ì—´ê¸°
    const myProgressUrl = '/my-progress';
    window.open(myProgressUrl, '_blank');

    showAlert('ğŸ“‹ My Progress í˜ì´ì§€ê°€ ìƒˆ íƒ­ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤!\n\nğŸ” ë§Œì•½ ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ë‚˜íƒ€ë‚˜ë©´:\n1. ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”\n2. ê·¸ ë‹¤ìŒ My Progressë¥¼ ë‹¤ì‹œ ì—´ì–´ë³´ì„¸ìš”', 'info');
    updateAPIStatus('My Progress í˜ì´ì§€ ì—´ê¸° ì™„ë£Œ');
}

// 7. ê¸°ì¡´ í…ŒìŠ¤íŠ¸ íŒ¨ë„ í† ê¸€ í•¨ìˆ˜ í™•ì¥
if (typeof toggleTestPanel !== 'undefined') {
    const originalToggleTestPanel = toggleTestPanel;
    toggleTestPanel = function() {
        originalToggleTestPanel();

        // íŒ¨ë„ì´ ì—´ë¦´ ë•Œ My Progress ë²„íŠ¼ë“¤ ì¶”ê°€
        setTimeout(() => {
            addMyProgressTestButtons();
        }, 100);
    };
}

// 8. í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ My Progress í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ì¶”ê°€
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        addMyProgressTestButtons();
        console.log('ğŸ“Š My Progress í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ì´ Admin Dashboardì— í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤!');
        console.log('ğŸ¯ ì‚¬ìš©ë²•: ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„(ğŸ§ª) í´ë¦­ â†’ My Progress í…ŒìŠ¤íŠ¸ ì„¹ì…˜ í™•ì¸');
    }, 2000);
});

console.log('âœ… Admin Dashboard My Progress í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ì¶”ê°€ ì™„ë£Œ!');


<!-- ===== ê°€ì… ì‹ ì²­ ê´€ë¦¬ í˜ì´ì§€ ì„¸ë¶€ êµ¬í˜„ ìŠ¤í¬ë¦½íŠ¸ ===== -->

// ===== 1ë‹¨ê³„: ê°€ì… ì‹ ì²­ ì„¹ì…˜ HTML êµ¬ì¡° ì™„ì „ êµì²´ =====

function replaceApplicationsSection() {
    console.log('ğŸ“ ê°€ì… ì‹ ì²­ ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì‹œì‘...');

    const applicationsSection = document.getElementById('applications-section');
    if (applicationsSection) {
        applicationsSection.innerHTML = `
            <!-- ê°€ì… ì‹ ì²­ í†µê³„ ì¹´ë“œ -->
            <div class="dashboard-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="applications-pending">0</div>
                            <div class="stat-label">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­</div>
                        </div>
                        <div class="stat-icon sessions">â³</div>
                    </div>
                    <div class="stat-change" id="pending-change">
                        <span>ğŸ“Š</span>
                        <span>ê³„ì‚° ì¤‘...</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="applications-today">0</div>
                            <div class="stat-label">ì˜¤ëŠ˜ ì‹ ì²­</div>
                        </div>
                        <div class="stat-icon accuracy">ğŸ“…</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ”¥</span>
                        <span>ì‹¤ì‹œê°„ ì§‘ê³„</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="applications-approved">0</div>
                            <div class="stat-label">ìŠ¹ì¸ëœ ì‹ ì²­</div>
                        </div>
                        <div class="stat-icon students">âœ…</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ¯</span>
                        <span>ìŠ¹ì¸ ì™„ë£Œ</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="applications-approval-rate">0%</div>
                            <div class="stat-label">ìŠ¹ì¸ë¥ </div>
                        </div>
                        <div class="stat-icon books">ğŸ“Š</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ’¯</span>
                        <span>ì „ì²´ ìŠ¹ì¸ë¥ </span>
                    </div>
                </div>
            </div>

            <!-- ê°€ì… ì‹ ì²­ í•„í„° ë° ëŒ€ëŸ‰ ì²˜ë¦¬ -->
            <div class="data-table-section">
                <div class="table-header">
                    <h3 class="table-title">ğŸ“ ê°€ì… ì‹ ì²­ ê´€ë¦¬</h3>
                    <div class="table-controls">
                        <select id="applications-status-filter" onchange="filterApplicationsByStatus(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                            <option value="all">ëª¨ë“  ìƒíƒœ</option>
                            <option value="pending" selected>ëŒ€ê¸° ì¤‘</option>
                            <option value="approved">ìŠ¹ì¸ë¨</option>
                            <option value="rejected">ê±°ë¶€ë¨</option>
                        </select>
                        <select id="applications-period-filter" onchange="filterApplicationsByPeriod(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                            <option value="all">ì „ì²´ ê¸°ê°„</option>
                            <option value="today">ì˜¤ëŠ˜</option>
                            <option value="week">ì´ë²ˆ ì£¼</option>
                            <option value="month">ì´ë²ˆ ë‹¬</option>
                        </select>
                        <div class="search-box">
                            <input type="text" class="search-input" id="applications-search" placeholder="ì´ë¦„, í•™êµ, ì—°ë½ì²˜ ê²€ìƒ‰..." onkeyup="filterApplicationsTable(this.value)" style="width: 250px;">
                            <span class="search-icon">ğŸ”</span>
                        </div>
                        <button class="export-btn" onclick="exportApplicationsData()">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                        <button class="refresh-btn" onclick="refreshApplicationsData()" style="margin-left: 10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <!-- ëŒ€ëŸ‰ ì²˜ë¦¬ ë²„íŠ¼ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="selectAllApplications()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ğŸ“‹ ì „ì²´ ì„ íƒ
                        </button>
                        <span id="selected-count" style="color: #6c757d; font-weight: 600;">ì„ íƒ: 0ê°œ</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="bulkApproveApplications()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            âœ… ì¼ê´„ ìŠ¹ì¸
                        </button>
                        <button onclick="bulkRejectApplications()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            âŒ ì¼ê´„ ê±°ë¶€
                        </button>
                    </div>
                </div>

                <!-- ë¡œë”© í‘œì‹œ -->
                <div id="applications-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>ê°€ì… ì‹ ì²­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                </div>

                <!-- ê°€ì… ì‹ ì²­ í…Œì´ë¸” -->
                <table class="data-table" id="applications-table-container">
                    <thead>
                        <tr>
                            <th>ì‹ ì²­ ì •ë³´</th>
                            <th>ê°œì¸ ì •ë³´</th>
                            <th>í•™êµ/ë ˆë²¨</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>ì‹ ì²­ì¼</th>
                            <th>ìƒíƒœ</th>
                            <th>ì²˜ë¦¬ì</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="applications-table">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #666; padding: 40px;">ê°€ì… ì‹ ì²­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ê°€ì… ì‹ ì²­ ì°¨íŠ¸ -->
            <div class="chart-section" style="margin-top: 30px;">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">ğŸ“ˆ ì‹ ì²­ í˜„í™© ì¶”ì´</h3>
                        <div class="chart-filters">
                            <button class="filter-btn active" onclick="updateApplicationsChart('7d')">7ì¼</button>
                            <button class="filter-btn" onclick="updateApplicationsChart('30d')">30ì¼</button>
                            <button class="filter-btn" onclick="updateApplicationsChart('90d')">90ì¼</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="applications-trend-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">ğŸ« í•™êµë³„ ì‹ ì²­ì ë¶„í¬</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="school-distribution-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ê°€ì… ì‹ ì²­ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
            <div id="application-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0;">ğŸ“ ê°€ì… ì‹ ì²­ ìƒì„¸ ì •ë³´</h3>
                        <button onclick="closeApplicationModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">Ã—</button>
                    </div>
                    <div id="application-detail-content">
                        <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <button onclick="approveFromModal()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            âœ… ìŠ¹ì¸
                        </button>
                        <button onclick="rejectFromModal()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            âŒ ê±°ë¶€
                        </button>
                        <button onclick="closeApplicationModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        `;

        console.log('âœ… ê°€ì… ì‹ ì²­ ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì™„ë£Œ');
        showAlert('ğŸ“ ê°€ì… ì‹ ì²­ ê´€ë¦¬ í˜ì´ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

        // CSS ìŠ¤íƒ€ì¼ ì¶”ê°€
        addApplicationsCSS();
    } else {
        console.error('âŒ applications-section ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

// ===== 2ë‹¨ê³„: ê°€ì… ì‹ ì²­ ê´€ë ¨ CSS ì¶”ê°€ =====
function addApplicationsCSS() {
    const style = document.createElement('style');
    style.textContent = `
        /* ê°€ì… ì‹ ì²­ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .level-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            min-width: 60px;
            text-align: center;
        }

        .level-badge.level-1 { background: #28a745; }
        .level-badge.level-2 { background: #17a2b8; }
        .level-badge.level-3 { background: #ffc107; color: #212529; }
        .level-badge.level-4 { background: #fd7e14; }
        .level-badge.level-5 { background: #dc3545; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn {
            background: transparent;
            border: 1px solid #dee2e6;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .action-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .action-btn.view {
            color: #17a2b8;
            border-color: #17a2b8;
        }

        .action-btn.approve {
            color: #28a745;
            border-color: #28a745;
        }

        .action-btn.reject {
            color: #dc3545;
            border-color: #dc3545;
        }

        .action-btn.edit {
            color: #ffc107;
            border-color: #ffc107;
        }

        .table-row-animate {
            animation: fadeInUp 0.3s ease forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        #application-detail-modal {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}

// ===== 3ë‹¨ê³„: ê°€ì… ì‹ ì²­ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™” =====
function initializeApplicationsTestData() {
    console.log('ğŸ“ ê°€ì… ì‹ ì²­ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™”...');

    if (!testDB.getData('applications')) {
        const sampleApplications = [
            {
                id: 1,
                name: "ì •í•˜ëŠ˜",
                birth_date: "2015-03-15",
                gender: "ì—¬",
                school: "ì„œìš¸ì´ˆë“±í•™êµ",
                grade: "3í•™ë…„",
                class: "2ë°˜",
                english_level: "2",
                phone: "010-1234-5678",
                email: "haneul@email.com",
                parent_phone: "010-9876-5432",
                parent_email: "parent1@email.com",
                address: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
                application_date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                status: "pending",
                processed_by: null,
                processed_date: null,
                notes: "ì˜ì–´ì— ê´€ì‹¬ì´ ë§ì€ í•™ìƒì…ë‹ˆë‹¤."
            },
            {
                id: 2,
                name: "ê¹€ë„í˜„",
                birth_date: "2014-08-22",
                gender: "ë‚¨",
                school: "ë¶€ì‚°ë‚¨ì´ˆë“±í•™êµ",
                grade: "4í•™ë…„",
                class: "1ë°˜",
                english_level: "3",
                phone: "010-2345-6789",
                email: "dohyun@email.com",
                parent_phone: "010-8765-4321",
                parent_email: "parent2@email.com",
                address: "ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬",
                application_date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                status: "pending",
                processed_by: null,
                processed_date: null,
                notes: "ìˆ˜í•™ê³¼ ê³¼í•™ë„ ì¢‹ì•„í•©ë‹ˆë‹¤."
            },
            {
                id: 3,
                name: "ì´ìˆ˜ì§„",
                birth_date: "2016-01-10",
                gender: "ì—¬",
                school: "ëŒ€êµ¬ì¤‘ì•™ì´ˆë“±í•™êµ",
                grade: "2í•™ë…„",
                class: "3ë°˜",
                english_level: "1",
                phone: "010-3456-7890",
                email: null,
                parent_phone: "010-7654-3210",
                parent_email: "parent3@email.com",
                address: "ëŒ€êµ¬ì‹œ ì¤‘êµ¬",
                application_date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                status: "approved",
                processed_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì",
                processed_date: new Date().toISOString(),
                notes: "ìŠ¹ì¸ ì™„ë£Œ"
            },
            {
                id: 4,
                name: "ë°•ì¤€í˜¸",
                birth_date: "2015-11-05",
                gender: "ë‚¨",
                school: "ì¸ì²œì„œì´ˆë“±í•™êµ",
                grade: "3í•™ë…„",
                class: "1ë°˜",
                english_level: "2",
                phone: "010-4567-8901",
                email: "junho@email.com",
                parent_phone: "010-6543-2109",
                parent_email: "parent4@email.com",
                address: "ì¸ì²œì‹œ ì„œêµ¬",
                application_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                status: "rejected",
                processed_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì",
                processed_date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                rejection_reason: "ì •ì› ì´ˆê³¼",
                notes: "ë‹¤ìŒ í•™ê¸°ì— ì¬ì‹ ì²­ ê°€ëŠ¥"
            },
            {
                id: 5,
                name: "ìµœë¯¼ì§€",
                birth_date: "2015-07-18",
                gender: "ì—¬",
                school: "ê´‘ì£¼ë™ì´ˆë“±í•™êµ",
                grade: "3í•™ë…„",
                class: "4ë°˜",
                english_level: "3",
                phone: "010-5678-9012",
                email: "minji@email.com",
                parent_phone: "010-5432-1098",
                parent_email: "parent5@email.com",
                address: "ê´‘ì£¼ì‹œ ë™êµ¬",
                application_date: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(), // 12ì‹œê°„ ì „
                status: "pending",
                processed_by: null,
                processed_date: null,
                notes: "ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš”"
            },
            {
                id: 6,
                name: "í•œì§€ìš°",
                birth_date: "2014-12-03",
                gender: "ë‚¨",
                school: "ìš¸ì‚°ë¶ì´ˆë“±í•™êµ",
                grade: "4í•™ë…„",
                class: "2ë°˜",
                english_level: "4",
                phone: "010-6789-0123",
                email: "jiwoo@email.com",
                parent_phone: "010-4321-0987",
                parent_email: "parent6@email.com",
                address: "ìš¸ì‚°ì‹œ ë¶êµ¬",
                application_date: new Date(Date.now() - 30 * 60 * 1000).toISOString(), // 30ë¶„ ì „
                status: "pending",
                processed_by: null,
                processed_date: null,
                notes: "ì˜¨ë¼ì¸ ìƒë‹´ ì™„ë£Œ"
            },
            {
                id: 7,
                name: "ìœ¤ì„œì—°",
                birth_date: "2016-05-20",
                gender: "ì—¬",
                school: "ì œì£¼ì¤‘ì•™ì´ˆë“±í•™êµ",
                grade: "2í•™ë…„",
                class: "1ë°˜",
                english_level: "1",
                phone: "010-7890-1234",
                email: "seoyeon@email.com",
                parent_phone: "010-3210-9876",
                parent_email: "parent7@email.com",
                address: "ì œì£¼ì‹œ ì¼ë„ë™",
                application_date: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                status: "pending",
                processed_by: null,
                processed_date: null,
                notes: "ë¶€ëª¨ë‹˜ ìƒë‹´ ì˜ˆì •"
            },
            {
                id: 8,
                name: "ì¥ë¯¼ì„",
                birth_date: "2014-09-12",
                gender: "ë‚¨",
                school: "ê²½ê¸°ë‚¨ì´ˆë“±í•™êµ",
                grade: "4í•™ë…„",
                class: "3ë°˜",
                english_level: "4",
                phone: "010-8901-2345",
                email: "minseok@email.com",
                parent_phone: "010-2109-8765",
                parent_email: "parent8@email.com",
                address: "ìˆ˜ì›ì‹œ ì˜í†µêµ¬",
                application_date: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(),
                status: "approved",
                processed_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì",
                processed_date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                notes: "ë†’ì€ ë ˆë²¨ í•™ìƒìœ¼ë¡œ ìŠ¹ì¸"
            }
        ];

        testDB.setData('applications', sampleApplications);
        console.log('âœ… ê°€ì… ì‹ ì²­ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ');
    } else {
        console.log('ğŸ“ ê¸°ì¡´ ê°€ì… ì‹ ì²­ ë°ì´í„° ì‚¬ìš©');
    }
}

// ===== 4ë‹¨ê³„: ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ =====

// ì „ì—­ ë³€ìˆ˜
let selectedApplications = new Set();
let currentApplicationForModal = null;

// ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
async function loadApplicationsData() {
    if (document.getElementById('applications-section').style.display === 'none') return;

    console.log('ğŸ“ ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì‹œì‘...');

    const loadingEl = document.getElementById('applications-loading');
    const tableEl = document.getElementById('applications-table-container');

    try {
        // ë¡œë”© í‘œì‹œ
        if (loadingEl) loadingEl.style.display = 'flex';
        if (tableEl) tableEl.style.display = 'none';

        // ê°€ì… ì‹ ì²­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await apiCall('/api/admin/applications');

        if (response.success) {
            console.log('ğŸ“ ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', response.data);
            const applications = response.data || [];

            // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateApplicationsStats(applications);

            // í…Œì´ë¸” ë Œë”ë§
            renderApplicationsTable(applications);

            // ì°¨íŠ¸ ë¡œë“œ
            loadApplicationsCharts(applications);

            if (tableEl) tableEl.style.display = 'table';

        } else {
            throw new Error(response.error || 'ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('âŒ ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert(`ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
        renderApplicationsError();
    } finally {
        if (loadingEl) loadingEl.style.display = 'none';
    }
}

// ê°€ì… ì‹ ì²­ í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateApplicationsStats(applications) {
    if (!applications || applications.length === 0) {
        document.getElementById('applications-pending').textContent = '0';
        document.getElementById('applications-today').textContent = '0';
        document.getElementById('applications-approved').textContent = '0';
        document.getElementById('applications-approval-rate').textContent = '0%';
        return;
    }

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­
    const pendingApplications = applications.filter(app => app.status === 'pending');

    // ì˜¤ëŠ˜ ì‹ ì²­
    const todayApplications = applications.filter(app => {
        const appDate = new Date(app.application_date);
        return appDate >= today;
    });

    // ìŠ¹ì¸ëœ ì‹ ì²­
    const approvedApplications = applications.filter(app => app.status === 'approved');

    // ìŠ¹ì¸ë¥ 
    const approvalRate = applications.length > 0 ?
        Math.round((approvedApplications.length / applications.length) * 100) : 0;

    // UI ì—…ë°ì´íŠ¸
    animateCounter('applications-pending', pendingApplications.length);
    animateCounter('applications-today', todayApplications.length);
    animateCounter('applications-approved', approvedApplications.length);
    document.getElementById('applications-approval-rate').textContent = approvalRate + '%';

    // ëŒ€ê¸° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    const pendingChangeEl = document.getElementById('pending-change');
    if (pendingChangeEl) {
        if (pendingApplications.length === 0) {
            pendingChangeEl.innerHTML = '<span>âœ…</span><span>ì²˜ë¦¬ ì™„ë£Œ</span>';
            pendingChangeEl.className = 'stat-change positive';
        } else if (pendingApplications.length > 5) {
            pendingChangeEl.innerHTML = `<span>âš ï¸</span><span>ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš”</span>`;
            pendingChangeEl.className = 'stat-change negative';
        } else {
            pendingChangeEl.innerHTML = '<span>â³</span><span>ìŠ¹ì¸ ëŒ€ê¸°</span>';
            pendingChangeEl.className = 'stat-change warning';
        }
    }

    console.log(`ğŸ“Š ê°€ì… ì‹ ì²­ í†µê³„ ì—…ë°ì´íŠ¸: ëŒ€ê¸° ${pendingApplications.length}, ì˜¤ëŠ˜ ${todayApplications.length}, ìŠ¹ì¸ë¥  ${approvalRate}%`);
}

// ê°€ì… ì‹ ì²­ í…Œì´ë¸” ë Œë”ë§
function renderApplicationsTable(applications) {
    const tbody = document.getElementById('applications-table');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!applications || applications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">ê°€ì… ì‹ ì²­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    console.log(`ğŸ“ ${applications.length}ê°œ ê°€ì… ì‹ ì²­ ë Œë”ë§ ì‹œì‘...`);

    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedApplications = applications.sort((a, b) => new Date(b.application_date) - new Date(a.application_date));

    sortedApplications.forEach((application, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = `${index * 0.05}s`;
        row.className = 'table-row-animate';
        row.setAttribute('data-application-id', application.id);

        // ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ë§
        let statusClass = 'pending';
        let statusText = 'ëŒ€ê¸°ì¤‘';
        let statusIcon = 'â³';

        if (application.status === 'approved') {
            statusClass = 'active';
            statusText = 'ìŠ¹ì¸ë¨';
            statusIcon = 'âœ…';
        } else if (application.status === 'rejected') {
            statusClass = 'inactive';
            statusText = 'ê±°ë¶€ë¨';
            statusIcon = 'âŒ';
        }

        // ì‹ ì²­ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
        const applicationDate = new Date(application.application_date);
        const daysSinceApplication = Math.floor((Date.now() - applicationDate.getTime()) / (1000 * 60 * 60 * 24));
        const hoursSinceApplication = Math.floor((Date.now() - applicationDate.getTime()) / (1000 * 60 * 60));

        let urgencyIndicator = '';
        let timeDisplay = '';

        if (daysSinceApplication > 0) {
            timeDisplay = `${daysSinceApplication}ì¼ ì „ ì‹ ì²­`;
            if (application.status === 'pending' && daysSinceApplication > 3) {
                urgencyIndicator = '<span style="color: #dc3545; font-weight: bold;">ğŸš¨ ê¸´ê¸‰</span>';
            } else if (application.status === 'pending' && daysSinceApplication > 1) {
                urgencyIndicator = '<span style="color: #ffc107; font-weight: bold;">âš ï¸ ìš°ì„ </span>';
            }
        } else {
            timeDisplay = `${hoursSinceApplication}ì‹œê°„ ì „ ì‹ ì²­`;
            if (application.status === 'pending' && hoursSinceApplication < 2) {
                urgencyIndicator = '<span style="color: #28a745; font-weight: bold;">ğŸ”¥ ì‹ ê·œ</span>';
            }
        }

        row.innerHTML = `
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" onchange="toggleApplicationSelection(${application.id})" style="transform: scale(1.2);">
                    <div>
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px;">
                            ID: ${application.id}
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            ${timeDisplay}
                        </div>
                        ${urgencyIndicator}
                    </div>
                </div>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(45deg, #3498db, #2ecc71); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">
                        ${(application.name || '').charAt(0)}
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px;">
                            ${application.name || '-'}
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            ${application.gender || '-'} â€¢ ${application.birth_date || '-'}
                        </div>
                    </div>
                </div>
            </td>
            <td>
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px; color: #2c3e50;">
                        ğŸ« ${application.school || '-'}
                    </div>
                    <div style="color: #666; font-size: 0.9rem;">
                        ğŸ“š ${application.grade || '-'} ${application.class || ''}
                    </div>
                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                        <span class="level-badge level-${application.english_level || 1}">Level ${application.english_level || 1}</span>
                    </div>
                </div>
            </td>
            <td>
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px; color: #2c3e50;">
                        ğŸ“ ${application.phone || '-'}
                    </div>
                    <div style="color: #666; font-size: 0.8rem; margin-bottom: 2px;">
                        âœ‰ï¸ ${application.email || 'ì´ë©”ì¼ ì—†ìŒ'}
                    </div>
                    <div style="color: #6c757d; font-size: 0.8rem;">
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ${application.parent_phone || '-'}
                    </div>
                </div>
            </td>
            <td>
                <div style="font-size: 0.9rem;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px;">
                        ${formatDate(application.application_date).split(' ')[0]}
                    </div>
                    <div style="color: #6c757d; font-size: 0.8rem;">
                        ${formatDate(application.application_date).split(' ')[1]}
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge ${statusClass}">
                    ${statusIcon} ${statusText}
                </span>
            </td>
            <td>
                <div style="font-size: 0.9rem; color: #6c757d;">
                    ${application.processed_by || 'ë¯¸ì²˜ë¦¬'}
                    ${application.processed_date ? `<br><span style="font-size: 0.8rem;">${formatRelativeTime(application.processed_date)}</span>` : ''}
                </div>
            </td>
            <td>
                <button class="action-btn view" onclick="viewApplicationDetail(${application.id})" title="ìƒì„¸ë³´ê¸°">ğŸ‘ï¸</button>
                ${application.status === 'pending' ? `
                    <button class="action-btn approve" onclick="approveApplication(${application.id})" title="ìŠ¹ì¸">âœ…</button>
                    <button class="action-btn reject" onclick="rejectApplication(${application.id})" title="ê±°ë¶€">âŒ</button>
                ` : `
                    <button class="action-btn edit" onclick="editApplication(${application.id})" title="ìˆ˜ì •">âœï¸</button>
                `}
                <button class="action-btn" onclick="contactApplicant(${application.id})" title="ì—°ë½" style="color: #17a2b8; border-color: #17a2b8;">ğŸ“</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    console.log(`ğŸ“ ${applications.length}ê°œ ê°€ì… ì‹ ì²­ í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ`);
}

// ê°€ì… ì‹ ì²­ ì—ëŸ¬ ë Œë”ë§
function renderApplicationsError() {
    const tbody = document.getElementById('applications-table');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545; padding: 40px;">âŒ ê°€ì… ì‹ ì²­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.</td></tr>';
    }
}

// ===== 5ë‹¨ê³„: í•„í„°ë§ ë° ê²€ìƒ‰ í•¨ìˆ˜ë“¤ =====

function filterApplicationsByStatus(status) {
    console.log(`ğŸ“Š ìƒíƒœë³„ í•„í„°ë§: ${status}`);

    const applications = testDB.getData('applications') || [];
    let filteredApplications = applications;

    if (status !== 'all') {
        filteredApplications = applications.filter(app => app.status === status);
    }

    renderApplicationsTable(filteredApplications);
    updateApplicationsStats(applications); // ì „ì²´ í†µê³„ëŠ” ìœ ì§€
    showAlert(`ğŸ“Š ${status} ìƒíƒœ í•„í„° ì ìš©: ${filteredApplications.length}ê°œ ì‹ ì²­`, 'info');
}

function filterApplicationsByPeriod(period) {
    console.log(`ğŸ“… ê¸°ê°„ë³„ í•„í„°ë§: ${period}`);

    const applications = testDB.getData('applications') || [];
    const now = new Date();
    let filteredApplications = [];

    switch(period) {
        case 'today':
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            filteredApplications = applications.filter(app => {
                const appDate = new Date(app.application_date);
                return appDate >= today;
            });
            break;
        case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            filteredApplications = applications.filter(app => {
                const appDate = new Date(app.application_date);
                return appDate >= weekAgo;
            });
            break;
        case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            filteredApplications = applications.filter(app => {
                const appDate = new Date(app.application_date);
                return appDate >= monthAgo;
            });
            break;
        default:
            filteredApplications = applications;
    }

    renderApplicationsTable(filteredApplications);
    showAlert(`ğŸ“… ${period} í•„í„° ì ìš©: ${filteredApplications.length}ê°œ ì‹ ì²­`, 'info');
}

function filterApplicationsTable(searchTerm) {
    const table = document.getElementById('applications-table');
    if (!table) return;

    const rows = table.getElementsByTagName('tr');
    const searchLower = searchTerm.toLowerCase();

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const name = row.cells[1] ? row.cells[1].textContent.toLowerCase() : '';
        const school = row.cells[2] ? row.cells[2].textContent.toLowerCase() : '';
        const phone = row.cells[3] ? row.cells[3].textContent.toLowerCase() : '';

        if (name.includes(searchLower) || school.includes(searchLower) || phone.includes(searchLower)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

// ===== 6ë‹¨ê³„: ê°œë³„ ì‹ ì²­ ì•¡ì…˜ í•¨ìˆ˜ë“¤ =====

function viewApplicationDetail(applicationId) {
    console.log(`ğŸ“ ê°€ì… ì‹ ì²­ ìƒì„¸ë³´ê¸°: ${applicationId}`);

    const applications = testDB.getData('applications') || [];
    const application = applications.find(app => app.id === applicationId);

    if (application) {
        currentApplicationForModal = application;
        showApplicationModal(application);
    } else {
        showAlert(`ê°€ì… ì‹ ì²­ ID ${applicationId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

function showApplicationModal(application) {
    const modal = document.getElementById('application-detail-modal');
    const content = document.getElementById('application-detail-content');

    if (modal && content) {
        content.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">ğŸ‘¤ ê°œì¸ ì •ë³´</h4>
                    <div style="margin-bottom: 10px;"><strong>ì´ë¦„:</strong> ${application.name || '-'}</div>
                    <div style="margin-bottom: 10px;"><strong>ìƒë…„ì›”ì¼:</strong> ${application.birth_date || '-'}</div>
                    <div style="margin-bottom: 10px;"><strong>ì„±ë³„:</strong> ${application.gender || '-'}</div>
                    <div style="margin-bottom: 10px;"><strong>ì£¼ì†Œ:</strong> ${application.address || '-'}</div>
                </div>
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">ğŸ« í•™êµ ì •ë³´</h4>
                    <div style="margin-bottom: 10px;"><strong>í•™êµ:</strong> ${application.school || '-'}</div>
                    <div style="margin-bottom: 10px;"><strong>í•™ë…„:</strong> ${application.grade || '-'}</div>
                    <div style="margin-bottom: 10px;"><strong>ë°˜:</strong> ${application.class || '-'}</div>
                    <div style="margin-bottom: 10px;"><strong>ì˜ì–´ ë ˆë²¨:</strong>
                        <span class="level-badge level-${application.english_level || 1}">Level ${application.english_level || 1}</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">ğŸ“ ì—°ë½ì²˜ ì •ë³´</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><strong>ì „í™”ë²ˆí˜¸:</strong> ${application.phone || '-'}</div>
                    <div><strong>ì´ë©”ì¼:</strong> ${application.email || '-'}</div>
                    <div><strong>ë³´í˜¸ì ì—°ë½ì²˜:</strong> ${application.parent_phone || '-'}</div>
                    <div><strong>ë³´í˜¸ì ì´ë©”ì¼:</strong> ${application.parent_email || '-'}</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">ğŸ“ ì‹ ì²­ ì •ë³´</h4>
                <div style="margin-bottom: 10px;"><strong>ì‹ ì²­ì¼:</strong> ${formatDate(application.application_date)}</div>
                <div style="margin-bottom: 10px;"><strong>ìƒíƒœ:</strong>
                    <span class="status-badge ${application.status === 'approved' ? 'active' : application.status === 'rejected' ? 'inactive' : 'pending'}">
                        ${application.status === 'approved' ? 'âœ… ìŠ¹ì¸ë¨' : application.status === 'rejected' ? 'âŒ ê±°ë¶€ë¨' : 'â³ ëŒ€ê¸°ì¤‘'}
                    </span>
                </div>
                <div style="margin-bottom: 10px;"><strong>ì²˜ë¦¬ì:</strong> ${application.processed_by || 'ë¯¸ì²˜ë¦¬'}</div>
                ${application.processed_date ? `<div style="margin-bottom: 10px;"><strong>ì²˜ë¦¬ì¼:</strong> ${formatDate(application.processed_date)}</div>` : ''}
                ${application.rejection_reason ? `<div style="margin-bottom: 10px;"><strong>ê±°ë¶€ ì‚¬ìœ :</strong> ${application.rejection_reason}</div>` : ''}
                ${application.notes ? `<div><strong>ë©”ëª¨:</strong><br><div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 5px;">${application.notes}</div></div>` : ''}
            </div>
        `;

        modal.style.display = 'flex';
    }
}

function closeApplicationModal() {
    const modal = document.getElementById('application-detail-modal');
    if (modal) {
        modal.style.display = 'none';
        currentApplicationForModal = null;
    }
}

function approveApplication(applicationId) {
    console.log(`âœ… ê°€ì… ì‹ ì²­ ìŠ¹ì¸: ${applicationId}`);

    const applications = testDB.getData('applications') || [];
    const application = applications.find(app => app.id === applicationId);

    if (application && application.status === 'pending') {
        application.status = 'approved';
        application.processed_by = 'í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì';
        application.processed_date = new Date().toISOString();

        testDB.setData('applications', applications);

        // ìŠ¹ì¸ëœ í•™ìƒì„ í•™ìƒ ëª©ë¡ì— ì¶”ê°€
        const students = testDB.getData('students') || [];
        const newStudent = {
            id: students.length + 1,
            name: application.name,
            level: parseInt(application.english_level) || 1,
            total_sessions: 0,
            avg_accuracy: 0,
            last_activity: null,
            status: 'new'
        };
        students.push(newStudent);
        testDB.setData('students', students);

        showAlert(`âœ… ${application.name}ì˜ ê°€ì… ì‹ ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!\ní•™ìƒ ëª©ë¡ì— ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        loadApplicationsData(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
    } else {
        showAlert('ìŠ¹ì¸í•  ìˆ˜ ì—†ëŠ” ì‹ ì²­ì…ë‹ˆë‹¤.', 'warning');
    }
}

function rejectApplication(applicationId) {
    console.log(`âŒ ê°€ì… ì‹ ì²­ ê±°ë¶€: ${applicationId}`);

    const applications = testDB.getData('applications') || [];
    const application = applications.find(app => app.id === applicationId);

    if (application && application.status === 'pending') {
        const reason = prompt('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
        if (reason !== null) {
            application.status = 'rejected';
            application.processed_by = 'í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì';
            application.processed_date = new Date().toISOString();
            application.rejection_reason = reason;

            testDB.setData('applications', applications);

            showAlert(`âŒ ${application.name}ì˜ ê°€ì… ì‹ ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : ${reason}`, 'info');
            loadApplicationsData(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
        }
    } else {
        showAlert('ê±°ë¶€í•  ìˆ˜ ì—†ëŠ” ì‹ ì²­ì…ë‹ˆë‹¤.', 'warning');
    }
}

function approveFromModal() {
    if (currentApplicationForModal) {
        approveApplication(currentApplicationForModal.id);
        closeApplicationModal();
    }
}

function rejectFromModal() {
    if (currentApplicationForModal) {
        rejectApplication(currentApplicationForModal.id);
        closeApplicationModal();
    }
}

function editApplication(applicationId) {
    showAlert(`ğŸ“ ê°€ì… ì‹ ì²­ ID ${applicationId} í¸ì§‘ ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.`, 'info');
}

function contactApplicant(applicationId) {
    const applications = testDB.getData('applications') || [];
    const application = applications.find(app => app.id === applicationId);

    if (application) {
        const contactInfo = `ğŸ“ ${application.name} ì—°ë½ì²˜ ì •ë³´:\n\n` +
                           `ğŸ“± í•™ìƒ ì „í™”: ${application.phone || 'ì—†ìŒ'}\n` +
                           `ğŸ“§ í•™ìƒ ì´ë©”ì¼: ${application.email || 'ì—†ìŒ'}\n` +
                           `ğŸ“ ë³´í˜¸ì ì „í™”: ${application.parent_phone || 'ì—†ìŒ'}\n` +
                           `ğŸ“§ ë³´í˜¸ì ì´ë©”ì¼: ${application.parent_email || 'ì—†ìŒ'}`;

        showAlert(contactInfo, 'info');
    }
}

// ===== 7ë‹¨ê³„: ëŒ€ëŸ‰ ì²˜ë¦¬ í•¨ìˆ˜ë“¤ =====

function toggleApplicationSelection(applicationId) {
    if (selectedApplications.has(applicationId)) {
        selectedApplications.delete(applicationId);
    } else {
        selectedApplications.add(applicationId);
    }
    updateSelectedCount();
}

function selectAllApplications() {
    const checkboxes = document.querySelectorAll('#applications-table input[type="checkbox"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
        const row = checkbox.closest('tr');
        const applicationId = parseInt(row.getAttribute('data-application-id'));

        if (checkbox.checked) {
            selectedApplications.add(applicationId);
        } else {
            selectedApplications.delete(applicationId);
        }
    });

    updateSelectedCount();
}

function updateSelectedCount() {
    const countEl = document.getElementById('selected-count');
    if (countEl) {
        countEl.textContent = `ì„ íƒ: ${selectedApplications.size}ê°œ`;
    }
}

function bulkApproveApplications() {
    if (selectedApplications.size === 0) {
        showAlert('ìŠ¹ì¸í•  ì‹ ì²­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    if (confirm(`ì„ íƒëœ ${selectedApplications.size}ê°œì˜ ì‹ ì²­ì„ ì¼ê´„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        let approvedCount = 0;
        selectedApplications.forEach(applicationId => {
            const applications = testDB.getData('applications') || [];
            const application = applications.find(app => app.id === applicationId);

            if (application && application.status === 'pending') {
                approveApplication(applicationId);
                approvedCount++;
            }
        });

        selectedApplications.clear();
        updateSelectedCount();
        showAlert(`âœ… ${approvedCount}ê°œì˜ ì‹ ì²­ì´ ì¼ê´„ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        setTimeout(() => loadApplicationsData(), 1000);
    }
}

function bulkRejectApplications() {
    if (selectedApplications.size === 0) {
        showAlert('ê±°ë¶€í•  ì‹ ì²­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    const reason = prompt('ì¼ê´„ ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
    if (reason !== null && confirm(`ì„ íƒëœ ${selectedApplications.size}ê°œì˜ ì‹ ì²­ì„ ì¼ê´„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        let rejectedCount = 0;
        const applications = testDB.getData('applications') || [];

        selectedApplications.forEach(applicationId => {
            const application = applications.find(app => app.id === applicationId);

            if (application && application.status === 'pending') {
                application.status = 'rejected';
                application.processed_by = 'í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì';
                application.processed_date = new Date().toISOString();
                application.rejection_reason = reason;
                rejectedCount++;
            }
        });

        testDB.setData('applications', applications);
        selectedApplications.clear();
        updateSelectedCount();
        showAlert(`âŒ ${rejectedCount}ê°œì˜ ì‹ ì²­ì´ ì¼ê´„ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
        setTimeout(() => loadApplicationsData(), 1000);
    }
}

// ===== 8ë‹¨ê³„: ì°¨íŠ¸ ë¡œë“œ í•¨ìˆ˜ë“¤ =====

function loadApplicationsCharts(applications) {
    if (!applications || applications.length === 0) return;

    console.log('ğŸ“Š ê°€ì… ì‹ ì²­ ì°¨íŠ¸ ë¡œë“œ ì‹œì‘...');

    // ì‹ ì²­ í˜„í™© ì¶”ì´ ì°¨íŠ¸
    loadApplicationsTrendChart(applications);

    // í•™êµë³„ ë¶„í¬ ì°¨íŠ¸
    loadSchoolDistributionChart(applications);
}

function loadApplicationsTrendChart(applications) {
    const ctx = document.getElementById('applications-trend-chart');
    if (!ctx) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (charts.applicationsTrend) {
        charts.applicationsTrend.destroy();
    }

    // ìµœê·¼ 7ì¼ê°„ ë°ì´í„° ì§‘ê³„
    const now = new Date();
    const dailyData = [];

    for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        const dateStr = date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });

        const dayApplications = applications.filter(app => {
            const appDate = new Date(app.application_date);
            return appDate.toDateString() === date.toDateString();
        });

        const approved = dayApplications.filter(app => app.status === 'approved').length;
        const rejected = dayApplications.filter(app => app.status === 'rejected').length;
        const pending = dayApplications.filter(app => app.status === 'pending').length;

        dailyData.push({
            date: dateStr,
            approved: approved,
            rejected: rejected,
            pending: pending
        });
    }

    charts.applicationsTrend = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dailyData.map(d => d.date),
            datasets: [{
                label: 'ìŠ¹ì¸ë¨',
                data: dailyData.map(d => d.approved),
                backgroundColor: '#28a745',
                borderColor: '#28a745',
                borderWidth: 1
            }, {
                label: 'ê±°ë¶€ë¨',
                data: dailyData.map(d => d.rejected),
                backgroundColor: '#dc3545',
                borderColor: '#dc3545',
                borderWidth: 1
            }, {
                label: 'ëŒ€ê¸°ì¤‘',
                data: dailyData.map(d => d.pending),
                backgroundColor: '#ffc107',
                borderColor: '#ffc107',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ìµœê·¼ 7ì¼ê°„ ì‹ ì²­ ì²˜ë¦¬ í˜„í™©',
                    font: { size: 14, weight: 'bold' }
                }
            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: { display: true, text: 'ì‹ ì²­ ìˆ˜' }
                }
            }
        }
    });

    console.log('ğŸ“ˆ ì‹ ì²­ í˜„í™© ì¶”ì´ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
}

function loadSchoolDistributionChart(applications) {
    const ctx = document.getElementById('school-distribution-chart');
    if (!ctx) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (charts.schoolDistribution) {
        charts.schoolDistribution.destroy();
    }

    // í•™êµë³„ ë¶„í¬ ê³„ì‚°
    const schoolCounts = {};
    applications.forEach(app => {
        const school = app.school || 'ë¯¸ê¸°ì¬';
        schoolCounts[school] = (schoolCounts[school] || 0) + 1;
    });

    // ìƒìœ„ 10ê°œ í•™êµë§Œ í‘œì‹œ
    const sortedSchools = Object.entries(schoolCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);

    const colors = [
        '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
        '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#16a085'
    ];

    charts.schoolDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sortedSchools.map(([school]) => school),
            datasets: [{
                data: sortedSchools.map(([, count]) => count),
                backgroundColor: colors.slice(0, sortedSchools.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'í•™êµë³„ ì‹ ì²­ì ë¶„í¬ (ìƒìœ„ 10ê°œ)',
                    font: { size: 14, weight: 'bold' }
                },
                legend: {
                    position: 'bottom',
                    labels: { padding: 10 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}ëª… (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    console.log('ğŸ« í•™êµë³„ ë¶„í¬ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
}

function updateApplicationsChart(period) {
    console.log(`ğŸ“Š ì‹ ì²­ í˜„í™© ì°¨íŠ¸ ì—…ë°ì´íŠ¸: ${period}`);

    // í•„í„° ë²„íŠ¼ í™œì„±í™”
    const chartSection = document.querySelector('#applications-section .chart-section');
    if (chartSection) {
        chartSection.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    const applications = testDB.getData('applications') || [];
    loadApplicationsTrendChart(applications);
    showAlert(`ğŸ“Š ${period} ì‹ ì²­ í˜„í™©ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
}

// ===== 9ë‹¨ê³„: ë°ì´í„° ê´€ë ¨ í•¨ìˆ˜ë“¤ =====

async function refreshApplicationsData() {
    console.log('ğŸ”„ ê°€ì… ì‹ ì²­ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
    btn.disabled = true;

    try {
        await loadApplicationsData();
        showAlert('ğŸ“ ê°€ì… ì‹ ì²­ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

    } catch (error) {
        console.error('âŒ ê°€ì… ì‹ ì²­ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        showAlert(`ê°€ì… ì‹ ì²­ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }
}

function exportApplicationsData() {
    try {
        const table = document.getElementById('applications-table-container');
        if (!table) {
            showAlert('ë‚´ë³´ë‚¼ ê°€ì… ì‹ ì²­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        const rows = table.querySelectorAll('tr');
        let csvContent = '';

        rows.forEach(row => {
            const cells = row.querySelectorAll('th, td');
            const rowData = Array.from(cells).map(cell => {
                return `"${cell.textContent.replace(/"/g, '""')}"`;
            });
            csvContent += rowData.join(',') + '\n';
        });

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');

        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `applications_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        showAlert('ğŸ“Š ê°€ì… ì‹ ì²­ ë°ì´í„°ê°€ CSVë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'success');

    } catch (error) {
        console.error('âŒ ê°€ì… ì‹ ì²­ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
        showAlert('ê°€ì… ì‹ ì²­ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ===== 10ë‹¨ê³„: loadSectionData ë° API ì‹œë®¬ë ˆì´í„° ì—°ë™ =====

// loadSectionDataì— applications ì¼€ì´ìŠ¤ ì¶”ê°€
const originalLoadSectionDataApps = loadSectionData;
loadSectionData = function(sectionName) {
    switch(sectionName) {
        case 'analytics':
            loadRealTimeAnalytics();
            break;
        case 'dashboard':
            loadDashboardData();
            break;
        case 'books':
            loadBooksData();
            break;
        case 'students':
            loadStudentsData();
            break;
        case 'activities':
            loadActivitiesData();
            break;
        case 'applications':
            loadApplicationsData(); // ğŸ“ ê°€ì… ì‹ ì²­ ë¡œë“œ ì¶”ê°€
            break;
        // ë‹¤ë¥¸ ì„¹ì…˜ë“¤...
        default:
            if (originalLoadSectionDataApps) {
                originalLoadSectionDataApps(sectionName);
            }
    }
};

// API ì‹œë®¬ë ˆì´í„°ì— applications ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
if (typeof apiSim !== 'undefined') {
    const originalSimulateApps = apiSim.simulate;

    apiSim.simulate = async function(endpoint, options = {}) {
        updateAPIStatus(`ğŸ“¡ API í˜¸ì¶œ: ${endpoint}`);
        await new Promise(resolve => setTimeout(resolve, this.baseDelay));

        if (Math.random() < this.errorRate) {
            updateAPIStatus(`âŒ API ì—ëŸ¬: ${endpoint}`);
            throw new Error(`API Error: ${endpoint} failed`);
        }

        let response;
        switch(endpoint) {
            case '/api/admin/applications':
                console.log('ğŸ“ ê°€ì… ì‹ ì²­ API í˜¸ì¶œ...');
                let applications = testDB.getData('applications');
                if (!applications) {
                    initializeApplicationsTestData();
                    applications = testDB.getData('applications');
                }
                response = {
                    success: true,
                    data: applications,
                    timestamp: new Date().toISOString(),
                    message: 'ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ'
                };
                console.log('ğŸ“Š ê°€ì… ì‹ ì²­ API ì‘ë‹µ:', response);
                break;
            case '/api/admin/books':
                console.log('ğŸ“š ë„ì„œ API í˜¸ì¶œ - ì‹¤ì‹œê°„ í†µê³„ ê³„ì‚° ì¤‘...');
                let updatedBooks = [];
                if (typeof testDB !== 'undefined' && testDB.updateBooksStats) {
                    updatedBooks = testDB.updateBooksStats();
                } else {
                    updatedBooks = testDB.getData('books') || [];
                }
                response = {
                    success: true,
                    data: updatedBooks,
                    timestamp: new Date().toISOString(),
                    message: 'ì‹¤ì‹œê°„ ë„ì„œ í†µê³„ ë°˜ì˜ë¨'
                };
                break;
            case '/api/admin/dashboard/stats':
                response = { success: true, data: testDB.updateStats() };
                break;
            case '/api/admin/dashboard/chart-data':
                response = { success: true, data: testDB.getData('chartData') };
                break;
            case '/api/admin/students':
                response = { success: true, data: testDB.getData('students') };
                break;
            case '/api/admin/recent-activities':
                response = { success: true, data: testDB.getData('activities') };
                break;
            case '/api/admin/analytics/real-time':
                const currentData = testDB.updateStats();
                const studentsData = testDB.getData('students');
                const activitiesData = testDB.getData('activities');

                const analyticsData = {
                    learning_efficiency: analytics.calculateLearningEfficiency(currentData),
                    satisfaction_score: analytics.calculateSatisfactionScore(currentData.avg_accuracy, currentData.completion_rate),
                    goal_achievement: analytics.calculateGoalAchievement(currentData),
                    retention_rate: analytics.calculateRetentionRate(studentsData),
                    insights: analytics.generateInsights(currentData, studentsData, activitiesData),
                    detailed_stats: this.generateDetailedStats(currentData)
                };
                response = { success: true, data: analyticsData };
                break;
            default:
                throw new Error(`Unknown endpoint: ${endpoint}`);
        }

        updateAPIStatus(`âœ… API ì„±ê³µ: ${endpoint}`);
        return response;
    };

    console.log('ğŸ”§ API ì‹œë®¬ë ˆì´í„°ì— ê°€ì… ì‹ ì²­ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ ì™„ë£Œ');
}

// ===== 11ë‹¨ê³„: ì°¨íŠ¸ ê°ì²´ ì´ˆê¸°í™” ë° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ =====

// ì°¨íŠ¸ ê°ì²´ ì´ˆê¸°í™” í™•ì¥
if (typeof charts === 'undefined') {
    charts = {};
}
charts.applicationsTrend = null;
charts.schoolDistribution = null;

// í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— ê°€ì… ì‹ ì²­ ë²„íŠ¼ ì¶”ê°€
function addApplicationsTestButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('applications-test-btn')) {
        const applicationsTestBtn = document.createElement('button');
        applicationsTestBtn.id = 'applications-test-btn';
        applicationsTestBtn.className = 'test-btn';
        applicationsTestBtn.style.background = '#e67e22';
        applicationsTestBtn.innerHTML = 'ğŸ“ ê°€ì… ì‹ ì²­ ê´€ë¦¬';
        applicationsTestBtn.onclick = function() {
            showSection('applications');
        };

        testPanel.insertBefore(applicationsTestBtn, document.getElementById('api-status'));
        console.log('ğŸ“ ê°€ì… ì‹ ì²­ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// ===== 12ë‹¨ê³„: ê°€ì… ì‹ ì²­ ì„¹ì…˜ ê°•ì œ í™œì„±í™” í•¨ìˆ˜ =====
function forceShowApplications() {
    console.log('ğŸ“ ê°€ì… ì‹ ì²­ ì„¹ì…˜ ê°•ì œ í‘œì‹œ...');

    // í˜„ì¬ ì„¹ì…˜ì„ applicationsë¡œ ë³€ê²½
    currentSection = 'applications';

    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });

    // ê°€ì… ì‹ ì²­ ì„¹ì…˜ë§Œ í‘œì‹œ
    const applicationsSection = document.getElementById('applications-section');
    if (applicationsSection) {
        applicationsSection.style.display = 'block';
        console.log('âœ… ê°€ì… ì‹ ì²­ ì„¹ì…˜ í‘œì‹œë¨');
    }

    // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.textContent.includes('ê°€ì… ì‹ ì²­')) {
            item.classList.add('active');
        }
    });

    // í˜ì´ì§€ ì œëª© ë³€ê²½
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        pageTitle.textContent = 'ê°€ì… ì‹ ì²­';
    }

    // ê°•ì œë¡œ ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ
    setTimeout(() => {
        loadApplicationsData();
    }, 500);

    showAlert('ğŸ“ ê°€ì… ì‹ ì²­ ê´€ë¦¬ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™í–ˆìŠµë‹ˆë‹¤!', 'info');
}

// ê°€ì… ì‹ ì²­ ë””ë²„ê¹… í•¨ìˆ˜
function debugApplicationsIssue() {
    console.log('ğŸ” ê°€ì… ì‹ ì²­ ë¬¸ì œ ë””ë²„ê¹… ì‹œì‘...');

    // 1. ë°ì´í„° í™•ì¸
    const applications = testDB.getData('applications');
    console.log('ğŸ“Š í˜„ì¬ ê°€ì… ì‹ ì²­ ë°ì´í„°:', applications);

    // 2. DOM ìš”ì†Œ í™•ì¸
    const applicationsSection = document.getElementById('applications-section');
    const applicationsTable = document.getElementById('applications-table');

    console.log('ğŸ¯ DOM ìš”ì†Œ í™•ì¸:');
    console.log('â€¢ applications-section:', applicationsSection ? 'ì¡´ì¬' : 'ì—†ìŒ');
    console.log('â€¢ applications-table:', applicationsTable ? 'ì¡´ì¬' : 'ì—†ìŒ');

    // 3. ê°•ì œë¡œ ê°€ì… ì‹ ì²­ í…Œì´ë¸” ë Œë”ë§
    if (applicationsTable && applications && applications.length > 0) {
        console.log('ğŸ”§ ê°•ì œ ê°€ì… ì‹ ì²­ í…Œì´ë¸” ë Œë”ë§ ì‹œë„...');
        renderApplicationsTable(applications);
        updateApplicationsStats(applications);
        loadApplicationsCharts(applications);
        showAlert('ğŸ”§ ê°€ì… ì‹ ì²­ ë°ì´í„° ê°•ì œ ë Œë”ë§ ì™„ë£Œ!', 'success');
    } else {
        console.error('âŒ ê°€ì… ì‹ ì²­ ë°ì´í„° ë˜ëŠ” í…Œì´ë¸” ìš”ì†Œ ë¬¸ì œ');
        if (!applications || applications.length === 0) {
            console.log('ğŸ“ ê°€ì… ì‹ ì²­ ë°ì´í„° ê°•ì œ ìƒì„±...');
            initializeApplicationsTestData();
            setTimeout(() => {
                const newApplications = testDB.getData('applications');
                if (newApplications && applicationsTable) {
                    renderApplicationsTable(newApplications);
                    updateApplicationsStats(newApplications);
                    loadApplicationsCharts(newApplications);
                }
            }, 500);
        }
    }
}

// í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— ê°€ì… ì‹ ì²­ ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€
function addApplicationsDebugButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('debug-applications-btn')) {
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debug-applications-btn';
        debugBtn.className = 'test-btn';
        debugBtn.style.background = '#6f42c1';
        debugBtn.innerHTML = 'ğŸ”§ ê°€ì…ì‹ ì²­ ìˆ˜ì •';
        debugBtn.onclick = forceShowApplications;

        // API ìƒíƒœ ì „ì— ì¶”ê°€
        testPanel.insertBefore(debugBtn, document.getElementById('api-status'));

        console.log('ğŸ”§ ê°€ì… ì‹ ì²­ ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// ===== 13ë‹¨ê³„: ì´ˆê¸°í™” ë° ì‹¤í–‰ =====

// ê°€ì… ì‹ ì²­ ì„¹ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
function initializeApplicationsSection() {
    console.log('ğŸš€ ê°€ì… ì‹ ì²­ ì„¹ì…˜ ì´ˆê¸°í™”...');

    // HTML êµ¬ì¡° í™•ì¸ ë° êµì²´
    setTimeout(() => {
        replaceApplicationsSection();

        // ë°ì´í„° í™•ì¸ ë° ì´ˆê¸°í™”
        setTimeout(() => {
            initializeApplicationsTestData();
        }, 500);

        // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
        setTimeout(() => {
            addApplicationsTestButton();
            addApplicationsDebugButton();
        }, 1000);

    }, 200);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
setTimeout(() => {
    initializeApplicationsSection();

    // í˜„ì¬ ê°€ì… ì‹ ì²­ ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì¦‰ì‹œ ë””ë²„ê¹…
    if (currentSection === 'applications') {
        setTimeout(() => {
            debugApplicationsIssue();
        }, 2000);
    }
}, 1800);

// ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (í…ŒìŠ¤íŠ¸ìš©)
window.showApplications = forceShowApplications;
window.debugApplications = debugApplicationsIssue;

console.log('âœ… ì™„ì „í•œ ê°€ì… ì‹ ì²­ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ!');
console.log('ğŸ“ ê°€ì… ì‹ ì²­ ê´€ë¦¬ ê¸°ëŠ¥:');
console.log('â€¢ ì‹¤ì‹œê°„ ê°€ì… ì‹ ì²­ í…Œì´ë¸”');
console.log('â€¢ ìƒíƒœë³„/ê¸°ê°„ë³„ í•„í„°ë§');
console.log('â€¢ ê°œë³„ ìŠ¹ì¸/ê±°ë¶€ ì²˜ë¦¬');
console.log('â€¢ ëŒ€ëŸ‰ ìŠ¹ì¸/ê±°ë¶€ ì²˜ë¦¬');
console.log('â€¢ ì‹ ì²­ì ìƒì„¸ ì •ë³´ ëª¨ë‹¬');
console.log('â€¢ ì‹ ì²­ í˜„í™© ì¶”ì´ ì°¨íŠ¸');
console.log('â€¢ í•™êµë³„ ë¶„í¬ ì°¨íŠ¸');
console.log('â€¢ ë°ì´í„° ë‚´ë³´ë‚´ê¸°');
console.log('â€¢ ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš” í‘œì‹œ');
console.log('â€¢ ìë™ í•™ìƒ ë“±ë¡');
console.log('ğŸ“ í…ŒìŠ¤íŠ¸: ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ "ğŸ“ ê°€ì… ì‹ ì²­ ê´€ë¦¬" ë˜ëŠ” "ğŸ”§ ê°€ì…ì‹ ì²­ ìˆ˜ì •" ë²„íŠ¼ í´ë¦­');
console.log('ğŸ¯ ë˜ëŠ” ì‚¬ì´ë“œë°”ì—ì„œ "ê°€ì… ì‹ ì²­" ë©”ë‰´ í´ë¦­');
console.log('ğŸ’¡ ë˜ëŠ” ì½˜ì†”ì—ì„œ showApplications() ì‹¤í–‰');
<!-- ===== QRì½”ë“œ ê´€ë¦¬ í˜ì´ì§€ ì„¸ë¶€ êµ¬í˜„ ìŠ¤í¬ë¦½íŠ¸ ===== -->

// ===== 1ë‹¨ê³„: QRì½”ë“œ ì„¹ì…˜ HTML êµ¬ì¡° ì™„ì „ êµì²´ =====

function replaceQRCodesSection() {
    console.log('ğŸ“± QRì½”ë“œ ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì‹œì‘...');

    const qrCodesSection = document.getElementById('qr-codes-section');
    if (qrCodesSection) {
        qrCodesSection.innerHTML = `
            <!-- QRì½”ë“œ í†µê³„ ì¹´ë“œ -->
            <div class="dashboard-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="qr-total-codes">0</div>
                            <div class="stat-label">ì´ QRì½”ë“œ</div>
                        </div>
                        <div class="stat-icon sessions">ğŸ“±</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ“Š</span>
                        <span>ì „ì²´ ìƒì„±</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="qr-active-codes">0</div>
                            <div class="stat-label">í™œì„± QRì½”ë“œ</div>
                        </div>
                        <div class="stat-icon accuracy">âœ…</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ”¥</span>
                        <span>ì‚¬ìš© ê°€ëŠ¥</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="qr-total-scans">0</div>
                            <div class="stat-label">ì´ ìŠ¤ìº” ìˆ˜</div>
                        </div>
                        <div class="stat-icon students">ğŸ“ˆ</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ¯</span>
                        <span>ëˆ„ì  ìŠ¤ìº”</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="qr-today-scans">0</div>
                            <div class="stat-label">ì˜¤ëŠ˜ ìŠ¤ìº”</div>
                        </div>
                        <div class="stat-icon books">ğŸ“…</div>
                    </div>
                    <div class="stat-change positive">
                        <span>âš¡</span>
                        <span>ì‹¤ì‹œê°„ ì§‘ê³„</span>
                    </div>
                </div>
            </div>

            <!-- QRì½”ë“œ ìƒì„± í¼ -->
            <div class="data-table-section" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">ğŸ†• ìƒˆ QRì½”ë“œ ìƒì„±</h3>
                </div>
                <div class="qr-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">QRì½”ë“œ ìœ í˜•</label>
                            <select id="qr-type" class="form-select">
                                <option value="book">ğŸ“š ë„ì„œ</option>
                                <option value="class">ğŸ« ìˆ˜ì—…</option>
                                <option value="event">ğŸ‰ ì´ë²¤íŠ¸</option>
                                <option value="student">ğŸ‘¤ í•™ìƒ</option>
                                <option value="custom">ğŸ”§ ì‚¬ìš©ì ì •ì˜</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì œëª©</label>
                            <input type="text" id="qr-title" class="form-input" placeholder="QRì½”ë“œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">URL ë˜ëŠ” ë°ì´í„°</label>
                            <input type="text" id="qr-data" class="form-input" placeholder="https://example.com ë˜ëŠ” í…ìŠ¤íŠ¸ ë°ì´í„°">
                        </div>
                        <div class="form-group">
                            <label class="form-label">í¬ê¸°</label>
                            <select id="qr-size" class="form-select">
                                <option value="200">ì†Œí˜• (200x200)</option>
                                <option value="300" selected>ì¤‘í˜• (300x300)</option>
                                <option value="400">ëŒ€í˜• (400x400)</option>
                                <option value="500">íŠ¹ëŒ€ (500x500)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                        <textarea id="qr-description" class="form-input" placeholder="QRì½”ë“œì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="min-height: 80px; resize: vertical;"></textarea>
                    </div>
                    <button onclick="generateNewQRCode()" class="create-qr-btn">
                        ğŸ“± QRì½”ë“œ ìƒì„±
                    </button>
                </div>
            </div>

            <!-- QRì½”ë“œ ê´€ë¦¬ í…Œì´ë¸” -->
            <div class="data-table-section">
                <div class="table-header">
                    <h3 class="table-title">ğŸ“± QRì½”ë“œ ê´€ë¦¬</h3>
                    <div class="table-controls">
                        <select id="qr-type-filter" onchange="filterQRCodesByType(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                            <option value="all">ëª¨ë“  ìœ í˜•</option>
                            <option value="book">ğŸ“š ë„ì„œ</option>
                            <option value="class">ğŸ« ìˆ˜ì—…</option>
                            <option value="event">ğŸ‰ ì´ë²¤íŠ¸</option>
                            <option value="student">ğŸ‘¤ í•™ìƒ</option>
                            <option value="custom">ğŸ”§ ì‚¬ìš©ì ì •ì˜</option>
                        </select>
                        <select id="qr-status-filter" onchange="filterQRCodesByStatus(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                            <option value="all">ëª¨ë“  ìƒíƒœ</option>
                            <option value="active">í™œì„±</option>
                            <option value="inactive">ë¹„í™œì„±</option>
                        </select>
                        <div class="search-box">
                            <input type="text" class="search-input" id="qr-search" placeholder="ì œëª©, URL, ì„¤ëª… ê²€ìƒ‰..." onkeyup="filterQRCodesTable(this.value)" style="width: 250px;">
                            <span class="search-icon">ğŸ”</span>
                        </div>
                        <button class="export-btn" onclick="exportQRCodesData()">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                        <button class="refresh-btn" onclick="refreshQRCodesData()" style="margin-left: 10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <!-- ë¡œë”© í‘œì‹œ -->
                <div id="qr-codes-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>QRì½”ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                </div>

                <!-- QRì½”ë“œ ê·¸ë¦¬ë“œ -->
                <div id="qr-codes-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; margin-top: 20px;">
                    <!-- QRì½”ë“œ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- QRì½”ë“œ ì°¨íŠ¸ -->
            <div class="chart-section" style="margin-top: 30px;">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">ğŸ“ˆ QRì½”ë“œ ìŠ¤ìº” ì¶”ì´</h3>
                        <div class="chart-filters">
                            <button class="filter-btn active" onclick="updateQRScanChart('7d')">7ì¼</button>
                            <button class="filter-btn" onclick="updateQRScanChart('30d')">30ì¼</button>
                            <button class="filter-btn" onclick="updateQRScanChart('90d')">90ì¼</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="qr-scan-trend-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">ğŸ“Š QRì½”ë“œ ìœ í˜•ë³„ ë¶„í¬</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="qr-type-distribution-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- QRì½”ë“œ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
            <div id="qr-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef;">
                        <h3 style="color: #2c3e50; margin: 0;">ğŸ“± QRì½”ë“œ ìƒì„¸ ì •ë³´</h3>
                        <button onclick="closeQRModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">Ã—</button>
                    </div>
                    <div id="qr-detail-content">
                        <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <button onclick="downloadQRFromModal()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ğŸ’¾ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button onclick="toggleQRStatusFromModal()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ğŸ”„ ìƒíƒœ ë³€ê²½
                        </button>
                        <button onclick="closeQRModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        `;

        console.log('âœ… QRì½”ë“œ ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì™„ë£Œ');
        showAlert('ğŸ“± QRì½”ë“œ ê´€ë¦¬ í˜ì´ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

        // CSS ìŠ¤íƒ€ì¼ ì¶”ê°€
        addQRCodesCSS();
    } else {
        console.error('âŒ qr-codes-section ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

// ===== 2ë‹¨ê³„: QRì½”ë“œ ê´€ë ¨ CSS ì¶”ê°€ =====
function addQRCodesCSS() {
    const style = document.createElement('style');
    style.textContent = `
        /* QRì½”ë“œ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .qr-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .create-qr-btn {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .create-qr-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .create-qr-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .qr-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .qr-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .qr-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
        }

        .qr-code-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 180px;
            position: relative;
        }

        .qr-code-canvas {
            max-width: 150px;
            max-height: 150px;
            border-radius: 4px;
        }

        .qr-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #dee2e6;
        }

        .qr-info {
            text-align: left;
        }

        .qr-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .qr-info p {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qr-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .qr-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .qr-btn:hover {
            transform: translateY(-1px);
        }

        .qr-btn.download {
            background: #2ecc71;
        }

        .qr-btn.download:hover {
            background: #27ae60;
        }

        .qr-btn.view {
            background: #17a2b8;
        }

        .qr-btn.view:hover {
            background: #138496;
        }

        .qr-btn.toggle {
            background: #ffc107;
            color: #212529;
        }

        .qr-btn.toggle:hover {
            background: #e0a800;
        }

        .qr-btn.delete {
            background: #dc3545;
        }

        .qr-btn.delete:hover {
            background: #c82333;
        }

        .qr-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            min-width: 80px;
            justify-content: center;
        }

        .qr-type-badge.book { background: #3498db; }
        .qr-type-badge.class { background: #2ecc71; }
        .qr-type-badge.event { background: #e74c3c; }
        .qr-type-badge.student { background: #f39c12; }
        .qr-type-badge.custom { background: #9b59b6; }

        .qr-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .qr-status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .qr-status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .qr-stats {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.8rem;
        }

        .qr-stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            #qr-codes-grid {
                grid-template-columns: 1fr;
            }

            .qr-actions {
                justify-content: stretch;
            }

            .qr-btn {
                flex: 1;
                justify-content: center;
            }
        }
    `;
    document.head.appendChild(style);
}

// ===== 3ë‹¨ê³„: QRì½”ë“œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™” =====
function initializeQRCodesTestData() {
    console.log('ğŸ“± QRì½”ë“œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™”...');

    if (!testDB.getData('qr_codes')) {
        const sampleQRCodes = [
            {
                id: 1,
                title: "Charlie and the Chocolate Factory",
                type: "book",
                data: "https://reading-app.com/book/CW001",
                size: 300,
                description: "ë¡œì•Œë“œ ë‹¬ì˜ ëŒ€í‘œì‘ - QRì½”ë“œë¡œ ì‰½ê²Œ ì ‘ê·¼",
                created_date: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                status: "active",
                scan_count: 156,
                last_scanned: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            },
            {
                id: 2,
                title: "Level 3 ìˆ˜ì—… ì…ì¥",
                type: "class",
                data: "https://reading-app.com/class/level3-room1",
                size: 250,
                description: "Level 3 í•™ìƒë“¤ì˜ ì˜¨ë¼ì¸ ìˆ˜ì—… ì°¸ì—¬ìš©",
                created_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                status: "active",
                scan_count: 89,
                last_scanned: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            },
            {
                id: 3,
                title: "ì—¬ë¦„ ë…ì„œ ìº í”„ 2024",
                type: "event",
                data: "https://reading-app.com/event/summer-camp-2024",
                size: 400,
                description: "ì—¬ë¦„ ë…ì„œ ìº í”„ ì°¸ê°€ ì‹ ì²­ ë° ì •ë³´",
                created_date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                status: "active",
                scan_count: 234,
                last_scanned: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            },
            {
                id: 4,
                title: "ê¹€ì² ìˆ˜ í•™ìŠµ ì§„í–‰ë¥ ",
                type: "student",
                data: "https://reading-app.com/student/profile/1",
                size: 200,
                description: "ê¹€ì² ìˆ˜ í•™ìƒì˜ ê°œì¸ í•™ìŠµ ì§„í–‰ë¥  í˜ì´ì§€",
                created_date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                status: "active",
                scan_count: 45,
                last_scanned: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            },
            {
                id: 5,
                title: "ë„ì„œê´€ WiFi ì ‘ì†",
                type: "custom",
                data: "WIFI:T:WPA;S:ReadingLibrary;P:books2024;H:false;;",
                size: 300,
                description: "ë„ì„œê´€ WiFi ìë™ ì—°ê²°ìš© QRì½”ë“œ",
                created_date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                status: "active",
                scan_count: 78,
                last_scanned: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            },
            {
                id: 6,
                title: "êµ¬ ë²„ì „ ì•± ë‹¤ìš´ë¡œë“œ",
                type: "custom",
                data: "https://old-app.reading-app.com/download",
                size: 200,
                description: "ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” êµ¬ ë²„ì „",
                created_date: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                status: "inactive",
                scan_count: 12,
                last_scanned: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            },
            {
                id: 7,
                title: "Bridge to Terabithia",
                type: "book",
                data: "https://reading-app.com/book/BTT001",
                size: 300,
                description: "ìºì„œë¦° íŒ¨í„°ìŠ¨ì˜ ê°ë™ì ì¸ ì†Œì„¤",
                created_date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                status: "active",
                scan_count: 67,
                last_scanned: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            },
            {
                id: 8,
                title: "í•™ë¶€ëª¨ ìƒë‹´ ì˜ˆì•½",
                type: "event",
                data: "https://reading-app.com/appointment/parent-consultation",
                size: 250,
                description: "ì˜¨ë¼ì¸ í•™ë¶€ëª¨ ìƒë‹´ ì˜ˆì•½ ì‹œìŠ¤í…œ",
                created_date: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(),
                status: "active",
                scan_count: 23,
                last_scanned: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                created_by: "í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì"
            }
        ];

        // ìŠ¤ìº” ë¡œê·¸ ë°ì´í„°ë„ ìƒì„±
        const scanLogs = [];
        sampleQRCodes.forEach(qr => {
            for (let i = 0; i < qr.scan_count; i++) {
                const randomDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                scanLogs.push({
                    id: scanLogs.length + 1,
                    qr_id: qr.id,
                    scanned_at: randomDate.toISOString(),
                    user_agent: 'Mobile App',
                    ip_address: `192.168.1.${Math.floor(Math.random() * 255)}`,
                    location: 'ì„œìš¸ì‹œ'
                });
            }
        });

        testDB.setData('qr_codes', sampleQRCodes);
        testDB.setData('qr_scan_logs', scanLogs);
        console.log('âœ… QRì½”ë“œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ');
    } else {
        console.log('ğŸ“± ê¸°ì¡´ QRì½”ë“œ ë°ì´í„° ì‚¬ìš©');
    }
}

// ===== 4ë‹¨ê³„: QRì½”ë“œ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ =====

// ì „ì—­ ë³€ìˆ˜
let currentQRForModal = null;

// QRì½”ë“œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
async function loadQRCodesData() {
    if (document.getElementById('qr-codes-section').style.display === 'none') return;

    console.log('ğŸ“± QRì½”ë“œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');

    const loadingEl = document.getElementById('qr-codes-loading');
    const gridEl = document.getElementById('qr-codes-grid');

    try {
        // ë¡œë”© í‘œì‹œ
        if (loadingEl) loadingEl.style.display = 'flex';
        if (gridEl) gridEl.style.display = 'none';

        // QRì½”ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await apiCall('/api/admin/qr-codes');

        if (response.success) {
            console.log('ğŸ“± QRì½”ë“œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', response.data);
            const qrCodes = response.data || [];

            // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateQRCodesStats(qrCodes);

            // ê·¸ë¦¬ë“œ ë Œë”ë§
            renderQRCodesGrid(qrCodes);

            // ì°¨íŠ¸ ë¡œë“œ
            loadQRCodesCharts(qrCodes);

            if (gridEl) gridEl.style.display = 'grid';

        } else {
            throw new Error(response.error || 'QRì½”ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('âŒ QRì½”ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert(`QRì½”ë“œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
        renderQRCodesError();
    } finally {
        if (loadingEl) loadingEl.style.display = 'none';
    }
}

// QRì½”ë“œ í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateQRCodesStats(qrCodes) {
    if (!qrCodes || qrCodes.length === 0) {
        document.getElementById('qr-total-codes').textContent = '0';
        document.getElementById('qr-active-codes').textContent = '0';
        document.getElementById('qr-total-scans').textContent = '0';
        document.getElementById('qr-today-scans').textContent = '0';
        return;
    }

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // í™œì„± QRì½”ë“œ
    const activeCodes = qrCodes.filter(qr => qr.status === 'active');

    // ì´ ìŠ¤ìº” ìˆ˜
    const totalScans = qrCodes.reduce((sum, qr) => sum + (qr.scan_count || 0), 0);

    // ì˜¤ëŠ˜ ìŠ¤ìº” ìˆ˜ (ìŠ¤ìº” ë¡œê·¸ì—ì„œ ê³„ì‚°)
    const scanLogs = testDB.getData('qr_scan_logs') || [];
    const todayScans = scanLogs.filter(log => {
        const logDate = new Date(log.scanned_at);
        return logDate >= today;
    }).length;

    // UI ì—…ë°ì´íŠ¸
    animateCounter('qr-total-codes', qrCodes.length);
    animateCounter('qr-active-codes', activeCodes.length);
    animateCounter('qr-total-scans', totalScans);
    animateCounter('qr-today-scans', todayScans);

    console.log(`ğŸ“Š QRì½”ë“œ í†µê³„ ì—…ë°ì´íŠ¸: ì´ ${qrCodes.length}ê°œ, í™œì„± ${activeCodes.length}ê°œ, ì´ ìŠ¤ìº” ${totalScans}íšŒ`);
}

// QRì½”ë“œ ê·¸ë¦¬ë“œ ë Œë”ë§
function renderQRCodesGrid(qrCodes) {
    const grid = document.getElementById('qr-codes-grid');
    if (!grid) return;

    grid.innerHTML = '';

    if (!qrCodes || qrCodes.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #666; padding: 40px;">QRì½”ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    console.log(`ğŸ“± ${qrCodes.length}ê°œ QRì½”ë“œ ê·¸ë¦¬ë“œ ë Œë”ë§ ì‹œì‘...`);

    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedQRCodes = qrCodes.sort((a, b) => new Date(b.created_date) - new Date(a.created_date));

    sortedQRCodes.forEach((qrCode, index) => {
        const card = document.createElement('div');
        card.className = 'qr-card table-row-animate';
        card.style.animationDelay = `${index * 0.05}s`;
        card.setAttribute('data-qr-type', qrCode.type);
        card.setAttribute('data-qr-status', qrCode.status);

        // QRì½”ë“œ ìƒì„± (ì‹¤ì œë¡œëŠ” QR ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” í”Œë ˆì´ìŠ¤í™€ë”)
        const qrCodeImage = generateQRCodePlaceholder(qrCode);

        // ìœ í˜•ë³„ ì•„ì´ì½˜
        const typeIcons = {
            book: 'ğŸ“š',
            class: 'ğŸ«',
            event: 'ğŸ‰',
            student: 'ğŸ‘¤',
            custom: 'ğŸ”§'
        };

        // ê²½ê³¼ ì‹œê°„ ê³„ì‚°
        const createdDate = new Date(qrCode.created_date);
        const daysAgo = Math.floor((Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24));
        const timeDisplay = daysAgo === 0 ? 'ì˜¤ëŠ˜ ìƒì„±' : `${daysAgo}ì¼ ì „ ìƒì„±`;

        // ë§ˆì§€ë§‰ ìŠ¤ìº” ì‹œê°„
        const lastScannedDisplay = qrCode.last_scanned ?
            `ë§ˆì§€ë§‰ ìŠ¤ìº”: ${formatRelativeTime(qrCode.last_scanned)}` :
            'ìŠ¤ìº” ê¸°ë¡ ì—†ìŒ';

        card.innerHTML = `
            <div class="qr-info">
                <h4>${qrCode.title || '-'}</h4>
                <p><strong>ìœ í˜•:</strong> <span class="qr-type-badge ${qrCode.type}">${typeIcons[qrCode.type] || 'ğŸ”§'} ${qrCode.type.toUpperCase()}</span></p>
                <p><strong>ìƒíƒœ:</strong> <span class="qr-status-badge ${qrCode.status}">${qrCode.status === 'active' ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}</span></p>
                <p><strong>ìƒì„±ì¼:</strong> ${timeDisplay}</p>
                <p><strong>í¬ê¸°:</strong> ${qrCode.size}x${qrCode.size}px</p>
            </div>

            <div class="qr-code-container">
                ${qrCodeImage}
            </div>

            <div class="qr-stats">
                <div class="qr-stat-item">
                    <span>ğŸ“Š</span>
                    <span>ìŠ¤ìº”: ${qrCode.scan_count || 0}íšŒ</span>
                </div>
                <div class="qr-stat-item">
                    <span>ğŸ•’</span>
                    <span>${lastScannedDisplay}</span>
                </div>
            </div>

            ${qrCode.description ? `
                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 0.8rem; color: #6c757d;">
                    ${qrCode.description}
                </div>
            ` : ''}

            <div class="qr-actions">
                <button class="qr-btn view" onclick="viewQRDetail(${qrCode.id})" title="ìƒì„¸ë³´ê¸°">
                    ğŸ‘ï¸ ë³´ê¸°
                </button>
                <button class="qr-btn download" onclick="downloadQRCode(${qrCode.id})" title="ë‹¤ìš´ë¡œë“œ">
                    ğŸ’¾ ì €ì¥
                </button>
                <button class="qr-btn toggle" onclick="toggleQRStatus(${qrCode.id})" title="ìƒíƒœ ë³€ê²½">
                    ğŸ”„ ${qrCode.status === 'active' ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}
                </button>
                <button class="qr-btn delete" onclick="deleteQRCode(${qrCode.id})" title="ì‚­ì œ">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
            </div>
        `;

        grid.appendChild(card);
    });

    console.log(`ğŸ“± ${qrCodes.length}ê°œ QRì½”ë“œ ê·¸ë¦¬ë“œ ë Œë”ë§ ì™„ë£Œ`);
}

// QRì½”ë“œ í”Œë ˆì´ìŠ¤í™€ë” ìƒì„± (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” QR ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©)
function generateQRCodePlaceholder(qrCode) {
    if (typeof QRCode !== 'undefined') {
        // QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆëŠ” ê²½ìš° ì‹¤ì œ QRì½”ë“œ ìƒì„±
        const canvas = document.createElement('canvas');
        canvas.className = 'qr-code-canvas';
        QRCode.toCanvas(canvas, qrCode.data, {
            width: Math.min(qrCode.size, 150),
            margin: 2,
            color: {
                dark: '#000000',
                light: '#FFFFFF'
            }
        });
        return canvas.outerHTML;
    } else {
        // í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
        return `
            <div class="qr-placeholder" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; flex-direction: column; gap: 8px;">
                <div style="font-size: 2rem;">ğŸ“±</div>
                <div style="font-size: 0.8rem; color: #6c757d; text-align: center;">QR ì½”ë“œ<br>ë¯¸ë¦¬ë³´ê¸°</div>
            </div>
        `;
    }
}

// QRì½”ë“œ ì—ëŸ¬ ë Œë”ë§
function renderQRCodesError() {
    const grid = document.getElementById('qr-codes-grid');
    if (grid) {
        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #dc3545; padding: 40px;">âŒ QRì½”ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.</div>';
    }
}

// ===== 5ë‹¨ê³„: QRì½”ë“œ ìƒì„± í•¨ìˆ˜ =====

async function generateNewQRCode() {
    console.log('ğŸ“± ìƒˆ QRì½”ë“œ ìƒì„± ì‹œì‘...');

    const type = document.getElementById('qr-type').value;
    const title = document.getElementById('qr-title').value.trim();
    const data = document.getElementById('qr-data').value.trim();
    const size = parseInt(document.getElementById('qr-size').value);
    const description = document.getElementById('qr-description').value.trim();

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!title) {
        showAlert('QRì½”ë“œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    if (!data) {
        showAlert('URL ë˜ëŠ” ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    const btn = document.querySelector('.create-qr-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ìƒì„± ì¤‘...';
    btn.disabled = true;

    try {
        const qrCodes = testDB.getData('qr_codes') || [];

        const newQRCode = {
            id: qrCodes.length + 1,
            title: title,
            type: type,
            data: data,
            size: size,
            description: description,
            created_date: new Date().toISOString(),
            status: 'active',
            scan_count: 0,
            last_scanned: null,
            created_by: 'í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì'
        };

        qrCodes.push(newQRCode);
        testDB.setData('qr_codes', qrCodes);

        // í¼ ì´ˆê¸°í™”
        document.getElementById('qr-title').value = '';
        document.getElementById('qr-data').value = '';
        document.getElementById('qr-description').value = '';

        showAlert(`âœ… "${title}" QRì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        setTimeout(() => loadQRCodesData(), 500);

    } catch (error) {
        console.error('âŒ QRì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
        showAlert(`QRì½”ë“œ ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }
}

// ===== 6ë‹¨ê³„: í•„í„°ë§ ë° ê²€ìƒ‰ í•¨ìˆ˜ë“¤ =====

function filterQRCodesByType(type) {
    console.log(`ğŸ“Š ìœ í˜•ë³„ í•„í„°ë§: ${type}`);

    const cards = document.querySelectorAll('.qr-card');
    let visibleCount = 0;

    cards.forEach(card => {
        const cardType = card.getAttribute('data-qr-type');

        if (type === 'all' || cardType === type) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    showAlert(`ğŸ“Š ${type} ìœ í˜• í•„í„° ì ìš©: ${visibleCount}ê°œ QRì½”ë“œ`, 'info');
}

function filterQRCodesByStatus(status) {
    console.log(`ğŸ“Š ìƒíƒœë³„ í•„í„°ë§: ${status}`);

    const cards = document.querySelectorAll('.qr-card');
    let visibleCount = 0;

    cards.forEach(card => {
        const cardStatus = card.getAttribute('data-qr-status');

        if (status === 'all' || cardStatus === status) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    showAlert(`ğŸ“Š ${status} ìƒíƒœ í•„í„° ì ìš©: ${visibleCount}ê°œ QRì½”ë“œ`, 'info');
}

function filterQRCodesTable(searchTerm) {
    const cards = document.querySelectorAll('.qr-card');
    const searchLower = searchTerm.toLowerCase();
    let visibleCount = 0;

    cards.forEach(card => {
        const title = card.querySelector('h4').textContent.toLowerCase();
        const description = card.textContent.toLowerCase();

        if (title.includes(searchLower) || description.includes(searchLower)) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    if (searchTerm) {
        console.log(`ğŸ” ê²€ìƒ‰ ê²°ê³¼: "${searchTerm}" - ${visibleCount}ê°œ QRì½”ë“œ`);
    }
}

// ===== 7ë‹¨ê³„: ê°œë³„ QRì½”ë“œ ì•¡ì…˜ í•¨ìˆ˜ë“¤ =====

function viewQRDetail(qrId) {
    console.log(`ğŸ“± QRì½”ë“œ ìƒì„¸ë³´ê¸°: ${qrId}`);

    const qrCodes = testDB.getData('qr_codes') || [];
    const qrCode = qrCodes.find(qr => qr.id === qrId);

    if (qrCode) {
        currentQRForModal = qrCode;
        showQRModal(qrCode);
    } else {
        showAlert(`QRì½”ë“œ ID ${qrId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

function showQRModal(qrCode) {
    const modal = document.getElementById('qr-detail-modal');
    const content = document.getElementById('qr-detail-content');

    if (modal && content) {
        const typeIcons = {
            book: 'ğŸ“š',
            class: 'ğŸ«',
            event: 'ğŸ‰',
            student: 'ğŸ‘¤',
            custom: 'ğŸ”§'
        };

        const qrCodeImage = generateQRCodePlaceholder(qrCode);

        content.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">ğŸ“± ê¸°ë³¸ ì •ë³´</h4>
                    <div style="margin-bottom: 12px;"><strong>ì œëª©:</strong> ${qrCode.title || '-'}</div>
                    <div style="margin-bottom: 12px;"><strong>ìœ í˜•:</strong> <span class="qr-type-badge ${qrCode.type}">${typeIcons[qrCode.type] || 'ğŸ”§'} ${qrCode.type.toUpperCase()}</span></div>
                    <div style="margin-bottom: 12px;"><strong>ìƒíƒœ:</strong> <span class="qr-status-badge ${qrCode.status}">${qrCode.status === 'active' ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}</span></div>
                    <div style="margin-bottom: 12px;"><strong>í¬ê¸°:</strong> ${qrCode.size}x${qrCode.size}px</div>
                    <div style="margin-bottom: 12px;"><strong>ìƒì„±ì¼:</strong> ${formatDate(qrCode.created_date)}</div>
                    <div style="margin-bottom: 12px;"><strong>ìƒì„±ì:</strong> ${qrCode.created_by || '-'}</div>
                </div>

                <div style="text-align: center;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">QRì½”ë“œ ë¯¸ë¦¬ë³´ê¸°</h4>
                    <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                        ${qrCodeImage}
                    </div>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">ğŸ“Š ì‚¬ìš© í†µê³„</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">${qrCode.scan_count || 0}</div>
                        <div style="font-size: 0.8rem; color: #6c757d;">ì´ ìŠ¤ìº” ìˆ˜</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #2ecc71;">${qrCode.last_scanned ? 'ìµœê·¼ í™œë™' : 'í™œë™ ì—†ìŒ'}</div>
                        <div style="font-size: 0.8rem; color: #6c757d;">${qrCode.last_scanned ? formatRelativeTime(qrCode.last_scanned) : '-'}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #e74c3c;">${Math.floor((Date.now() - new Date(qrCode.created_date).getTime()) / (1000 * 60 * 60 * 24))}</div>
                        <div style="font-size: 0.8rem; color: #6c757d;">ìƒì„± í›„ ì¼ìˆ˜</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">ğŸ”— ë°ì´í„° ë° ì„¤ëª…</h4>
                <div style="margin-bottom: 15px;">
                    <strong>URL/ë°ì´í„°:</strong>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 5px; font-family: monospace; word-break: break-all; font-size: 0.9rem;">
                        ${qrCode.data}
                    </div>
                </div>
                ${qrCode.description ? `
                    <div>
                        <strong>ì„¤ëª…:</strong>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 5px;">
                            ${qrCode.description}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;

        modal.style.display = 'flex';
    }
}

function closeQRModal() {
    const modal = document.getElementById('qr-detail-modal');
    if (modal) {
        modal.style.display = 'none';
        currentQRForModal = null;
    }
}

function downloadQRCode(qrId) {
    console.log(`ğŸ’¾ QRì½”ë“œ ë‹¤ìš´ë¡œë“œ: ${qrId}`);

    const qrCodes = testDB.getData('qr_codes') || [];
    const qrCode = qrCodes.find(qr => qr.id === qrId);

    if (qrCode) {
        // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” QRì½”ë“œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ë‹¤ìš´ë¡œë“œ
        // ì—¬ê¸°ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜
        showAlert(`ğŸ’¾ "${qrCode.title}" QRì½”ë“œ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\n\nğŸ“ í¬ê¸°: ${qrCode.size}x${qrCode.size}px\nğŸ“± í˜•ì‹: PNG`, 'success');

        // ë‹¤ìš´ë¡œë“œ ì¹´ìš´íŠ¸ ì¦ê°€ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬)
        console.log(`QRì½”ë“œ "${qrCode.title}" ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
    } else {
        showAlert(`QRì½”ë“œ ID ${qrId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

function downloadQRFromModal() {
    if (currentQRForModal) {
        downloadQRCode(currentQRForModal.id);
    }
}

function toggleQRStatus(qrId) {
    console.log(`ğŸ”„ QRì½”ë“œ ìƒíƒœ ë³€ê²½: ${qrId}`);

    const qrCodes = testDB.getData('qr_codes') || [];
    const qrCode = qrCodes.find(qr => qr.id === qrId);

    if (qrCode) {
        const newStatus = qrCode.status === 'active' ? 'inactive' : 'active';
        qrCode.status = newStatus;

        testDB.setData('qr_codes', qrCodes);

        showAlert(`ğŸ”„ "${qrCode.title}" QRì½”ë“œê°€ ${newStatus === 'active' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        setTimeout(() => loadQRCodesData(), 500);
    } else {
        showAlert(`QRì½”ë“œ ID ${qrId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

function toggleQRStatusFromModal() {
    if (currentQRForModal) {
        toggleQRStatus(currentQRForModal.id);
        closeQRModal();
    }
}

function deleteQRCode(qrId) {
    console.log(`ğŸ—‘ï¸ QRì½”ë“œ ì‚­ì œ: ${qrId}`);

    const qrCodes = testDB.getData('qr_codes') || [];
    const qrCode = qrCodes.find(qr => qr.id === qrId);

    if (qrCode && confirm(`"${qrCode.title}" QRì½”ë“œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        const filteredQRCodes = qrCodes.filter(qr => qr.id !== qrId);
        testDB.setData('qr_codes', filteredQRCodes);

        // ê´€ë ¨ ìŠ¤ìº” ë¡œê·¸ë„ ì‚­ì œ
        const scanLogs = testDB.getData('qr_scan_logs') || [];
        const filteredLogs = scanLogs.filter(log => log.qr_id !== qrId);
        testDB.setData('qr_scan_logs', filteredLogs);

        showAlert(`ğŸ—‘ï¸ "${qrCode.title}" QRì½”ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        setTimeout(() => loadQRCodesData(), 500);
    }
}

// ===== 8ë‹¨ê³„: ì°¨íŠ¸ ë¡œë“œ í•¨ìˆ˜ë“¤ =====

function loadQRCodesCharts(qrCodes) {
    if (!qrCodes || qrCodes.length === 0) return;

    console.log('ğŸ“Š QRì½”ë“œ ì°¨íŠ¸ ë¡œë“œ ì‹œì‘...');

    // ìŠ¤ìº” ì¶”ì´ ì°¨íŠ¸
    loadQRScanTrendChart(qrCodes);

    // ìœ í˜•ë³„ ë¶„í¬ ì°¨íŠ¸
    loadQRTypeDistributionChart(qrCodes);
}

function loadQRScanTrendChart(qrCodes) {
    const ctx = document.getElementById('qr-scan-trend-chart');
    if (!ctx) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (charts.qrScanTrend) {
        charts.qrScanTrend.destroy();
    }

    // ìµœê·¼ 7ì¼ê°„ ìŠ¤ìº” ë°ì´í„° ì§‘ê³„
    const now = new Date();
    const dailyData = [];
    const scanLogs = testDB.getData('qr_scan_logs') || [];

    for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        const dateStr = date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });

        const dayScans = scanLogs.filter(log => {
            const logDate = new Date(log.scanned_at);
            return logDate.toDateString() === date.toDateString();
        });

        // ìœ í˜•ë³„ ìŠ¤ìº” ìˆ˜ ê³„ì‚°
        const bookScans = dayScans.filter(log => {
            const qr = qrCodes.find(q => q.id === log.qr_id);
            return qr && qr.type === 'book';
        }).length;

        const classScans = dayScans.filter(log => {
            const qr = qrCodes.find(q => q.id === log.qr_id);
            return qr && qr.type === 'class';
        }).length;

        const eventScans = dayScans.filter(log => {
            const qr = qrCodes.find(q => q.id === log.qr_id);
            return qr && qr.type === 'event';
        }).length;

        const otherScans = dayScans.length - bookScans - classScans - eventScans;

        dailyData.push({
            date: dateStr,
            book: bookScans,
            class: classScans,
            event: eventScans,
            other: otherScans,
            total: dayScans.length
        });
    }

    charts.qrScanTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dailyData.map(d => d.date),
            datasets: [{
                label: 'ë„ì„œ',
                data: dailyData.map(d => d.book),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: false
            }, {
                label: 'ìˆ˜ì—…',
                data: dailyData.map(d => d.class),
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                tension: 0.4,
                fill: false
            }, {
                label: 'ì´ë²¤íŠ¸',
                data: dailyData.map(d => d.event),
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4,
                fill: false
            }, {
                label: 'ê¸°íƒ€',
                data: dailyData.map(d => d.other),
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ìµœê·¼ 7ì¼ê°„ QRì½”ë“œ ìŠ¤ìº” ì¶”ì´',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        footer: function(tooltipItems) {
                            const dataIndex = tooltipItems[0].dataIndex;
                            const total = dailyData[dataIndex].total;
                            return `ì´ ìŠ¤ìº”: ${total}íšŒ`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'ìŠ¤ìº” ìˆ˜' }
                },
                x: {
                    title: { display: true, text: 'ë‚ ì§œ' }
                }
            }
        }
    });

    console.log('ğŸ“ˆ QRì½”ë“œ ìŠ¤ìº” ì¶”ì´ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
}

function loadQRTypeDistributionChart(qrCodes) {
    const ctx = document.getElementById('qr-type-distribution-chart');
    if (!ctx) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (charts.qrTypeDistribution) {
        charts.qrTypeDistribution.destroy();
    }

    // ìœ í˜•ë³„ ë¶„í¬ ê³„ì‚°
    const typeCounts = {};
    qrCodes.forEach(qr => {
        const type = qr.type || 'custom';
        typeCounts[type] = (typeCounts[type] || 0) + 1;
    });

    const typeLabels = {
        book: 'ğŸ“š ë„ì„œ',
        class: 'ğŸ« ìˆ˜ì—…',
        event: 'ğŸ‰ ì´ë²¤íŠ¸',
        student: 'ğŸ‘¤ í•™ìƒ',
        custom: 'ğŸ”§ ì‚¬ìš©ì ì •ì˜'
    };

    const colors = {
        book: '#3498db',
        class: '#2ecc71',
        event: '#e74c3c',
        student: '#f39c12',
        custom: '#9b59b6'
    };

    const sortedTypes = Object.entries(typeCounts).sort(([,a], [,b]) => b - a);

    charts.qrTypeDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sortedTypes.map(([type]) => typeLabels[type] || type),
            datasets: [{
                data: sortedTypes.map(([, count]) => count),
                backgroundColor: sortedTypes.map(([type]) => colors[type] || '#95a5a6'),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'QRì½”ë“œ ìœ í˜•ë³„ ë¶„í¬',
                    font: { size: 14, weight: 'bold' }
                },
                legend: {
                    position: 'bottom',
                    labels: { padding: 10 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}ê°œ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    console.log('ğŸ“Š QRì½”ë“œ ìœ í˜•ë³„ ë¶„í¬ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
}

function updateQRScanChart(period) {
    console.log(`ğŸ“Š QRì½”ë“œ ìŠ¤ìº” ì°¨íŠ¸ ì—…ë°ì´íŠ¸: ${period}`);

    // í•„í„° ë²„íŠ¼ í™œì„±í™”
    const chartSection = document.querySelector('#qr-codes-section .chart-section');
    if (chartSection) {
        chartSection.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    const qrCodes = testDB.getData('qr_codes') || [];
    loadQRScanTrendChart(qrCodes);
    showAlert(`ğŸ“Š ${period} QRì½”ë“œ ìŠ¤ìº” í˜„í™©ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
}

// ===== 9ë‹¨ê³„: ë°ì´í„° ê´€ë ¨ í•¨ìˆ˜ë“¤ =====

async function refreshQRCodesData() {
    console.log('ğŸ”„ QRì½”ë“œ ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
    btn.disabled = true;

    try {
        await loadQRCodesData();
        showAlert('ğŸ“± QRì½”ë“œ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

    } catch (error) {
        console.error('âŒ QRì½”ë“œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        showAlert(`QRì½”ë“œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }
}

function exportQRCodesData() {
    try {
        const qrCodes = testDB.getData('qr_codes') || [];

        if (qrCodes.length === 0) {
            showAlert('ë‚´ë³´ë‚¼ QRì½”ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        // CSV í—¤ë”
        const headers = ['ID', 'ì œëª©', 'ìœ í˜•', 'URL/ë°ì´í„°', 'í¬ê¸°', 'ìƒíƒœ', 'ìŠ¤ìº”ìˆ˜', 'ìƒì„±ì¼', 'ë§ˆì§€ë§‰ìŠ¤ìº”', 'ì„¤ëª…'];
        let csvContent = headers.join(',') + '\n';

        // ë°ì´í„° í–‰ë“¤
        qrCodes.forEach(qr => {
            const row = [
                qr.id,
                `"${qr.title || ''}"`,
                qr.type,
                `"${qr.data || ''}"`,
                qr.size,
                qr.status,
                qr.scan_count || 0,
                qr.created_date ? new Date(qr.created_date).toLocaleDateString('ko-KR') : '',
                qr.last_scanned ? new Date(qr.last_scanned).toLocaleDateString('ko-KR') : '',
                `"${qr.description || ''}"`
            ];
            csvContent += row.join(',') + '\n';
        });

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');

        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `qr_codes_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        showAlert('ğŸ“Š QRì½”ë“œ ë°ì´í„°ê°€ CSVë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'success');

    } catch (error) {
        console.error('âŒ QRì½”ë“œ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
        showAlert('QRì½”ë“œ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ===== 10ë‹¨ê³„: ëœë¤ QRì½”ë“œ ìƒì„± í•¨ìˆ˜ (í…ŒìŠ¤íŠ¸ìš©) =====

function generateRandomQRCode() {
    console.log('ğŸ² ëœë¤ QRì½”ë“œ ìƒì„±...');

    const types = ['book', 'class', 'event', 'student', 'custom'];
    const titles = [
        'Green Eggs and Ham',
        'Level 2 ì˜¨ë¼ì¸ ìˆ˜ì—…',
        'ê°€ì„ ë…ì„œ ì¶•ì œ',
        'ì´ì˜í¬ í•™ìŠµ í˜„í™©',
        'í•™ì› WiFi ì ‘ì†',
        'Magic Tree House #2',
        'í•™ë¶€ëª¨ ìƒë‹´ ì˜ˆì•½',
        'ë„ì„œê´€ ì•ˆë‚´'
    ];
    const urls = [
        'https://reading-app.com/book/',
        'https://reading-app.com/class/',
        'https://reading-app.com/event/',
        'https://reading-app.com/student/',
        'https://reading-app.com/info/'
    ];
    const sizes = [200, 250, 300, 400];

    const randomType = types[Math.floor(Math.random() * types.length)];
    const randomTitle = titles[Math.floor(Math.random() * titles.length)];
    const randomUrl = urls[Math.floor(Math.random() * urls.length)] + Math.random().toString(36).substr(2, 9);
    const randomSize = sizes[Math.floor(Math.random() * sizes.length)];

    const qrCodes = testDB.getData('qr_codes') || [];

    const newQRCode = {
        id: qrCodes.length + 1,
        title: randomTitle + ' ' + Math.floor(Math.random() * 100),
        type: randomType,
        data: randomUrl,
        size: randomSize,
        description: `ìë™ ìƒì„±ëœ ${randomType} íƒ€ì… QRì½”ë“œ`,
        created_date: new Date().toISOString(),
        status: Math.random() > 0.2 ? 'active' : 'inactive',
        scan_count: Math.floor(Math.random() * 100),
        last_scanned: Math.random() > 0.3 ? new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString() : null,
        created_by: 'í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì'
    };

    qrCodes.push(newQRCode);
    testDB.setData('qr_codes', qrCodes);

    showAlert(`ğŸ² ëœë¤ QRì½”ë“œ "${newQRCode.title}"ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');

    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    setTimeout(() => loadQRCodesData(), 500);
}

// ===== 11ë‹¨ê³„: loadSectionData ë° API ì‹œë®¬ë ˆì´í„° ì—°ë™ =====

// loadSectionDataì— qr-codes ì¼€ì´ìŠ¤ ì¶”ê°€
const originalLoadSectionDataQR = loadSectionData;
loadSectionData = function(sectionName) {
    switch(sectionName) {
        case 'analytics':
            loadRealTimeAnalytics();
            break;
        case 'dashboard':
            loadDashboardData();
            break;
        case 'books':
            loadBooksData();
            break;
        case 'students':
            loadStudentsData();
            break;
        case 'activities':
            loadActivitiesData();
            break;
        case 'applications':
            loadApplicationsData();
            break;
        case 'qr-codes':
            loadQRCodesData(); // ğŸ“± QRì½”ë“œ ë¡œë“œ ì¶”ê°€
            break;
        // ë‹¤ë¥¸ ì„¹ì…˜ë“¤...
        default:
            if (originalLoadSectionDataQR) {
                originalLoadSectionDataQR(sectionName);
            }
    }
};

// API ì‹œë®¬ë ˆì´í„°ì— qr-codes ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
if (typeof apiSim !== 'undefined') {
    const originalSimulateQR = apiSim.simulate;

    apiSim.simulate = async function(endpoint, options = {}) {
        updateAPIStatus(`ğŸ“¡ API í˜¸ì¶œ: ${endpoint}`);
        await new Promise(resolve => setTimeout(resolve, this.baseDelay));

        if (Math.random() < this.errorRate) {
            updateAPIStatus(`âŒ API ì—ëŸ¬: ${endpoint}`);
            throw new Error(`API Error: ${endpoint} failed`);
        }

        let response;
        switch(endpoint) {
            case '/api/admin/qr-codes':
                console.log('ğŸ“± QRì½”ë“œ API í˜¸ì¶œ...');
                let qrCodes = testDB.getData('qr_codes');
                if (!qrCodes) {
                    initializeQRCodesTestData();
                    qrCodes = testDB.getData('qr_codes');
                }
                response = {
                    success: true,
                    data: qrCodes,
                    timestamp: new Date().toISOString(),
                    message: 'QRì½”ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ'
                };
                console.log('ğŸ“Š QRì½”ë“œ API ì‘ë‹µ:', response);
                break;
            case '/api/admin/applications':
                console.log('ğŸ“ ê°€ì… ì‹ ì²­ API í˜¸ì¶œ...');
                let applications = testDB.getData('applications');
                if (!applications) {
                    initializeApplicationsTestData();
                    applications = testDB.getData('applications');
                }
                response = {
                    success: true,
                    data: applications,
                    timestamp: new Date().toISOString(),
                    message: 'ê°€ì… ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ'
                };
                break;
            case '/api/admin/books':
                console.log('ğŸ“š ë„ì„œ API í˜¸ì¶œ - ì‹¤ì‹œê°„ í†µê³„ ê³„ì‚° ì¤‘...');
                let updatedBooks = [];
                if (typeof testDB !== 'undefined' && testDB.updateBooksStats) {
                    updatedBooks = testDB.updateBooksStats();
                } else {
                    updatedBooks = testDB.getData('books') || [];
                }
                response = {
                    success: true,
                    data: updatedBooks,
                    timestamp: new Date().toISOString(),
                    message: 'ì‹¤ì‹œê°„ ë„ì„œ í†µê³„ ë°˜ì˜ë¨'
                };
                break;
            case '/api/admin/dashboard/stats':
                response = { success: true, data: testDB.updateStats() };
                break;
            case '/api/admin/dashboard/chart-data':
                response = { success: true, data: testDB.getData('chartData') };
                break;
            case '/api/admin/students':
                response = { success: true, data: testDB.getData('students') };
                break;
            case '/api/admin/recent-activities':
                response = { success: true, data: testDB.getData('activities') };
                break;
            case '/api/admin/analytics/real-time':
                const currentData = testDB.updateStats();
                const studentsData = testDB.getData('students');
                const activitiesData = testDB.getData('activities');

                const analyticsData = {
                    learning_efficiency: analytics.calculateLearningEfficiency(currentData),
                    satisfaction_score: analytics.calculateSatisfactionScore(currentData.avg_accuracy, currentData.completion_rate),
                    goal_achievement: analytics.calculateGoalAchievement(currentData),
                    retention_rate: analytics.calculateRetentionRate(studentsData),
                    insights: analytics.generateInsights(currentData, studentsData, activitiesData),
                    detailed_stats: this.generateDetailedStats(currentData)
                };
                response = { success: true, data: analyticsData };
                break;
            default:
                throw new Error(`Unknown endpoint: ${endpoint}`);
        }

        updateAPIStatus(`âœ… API ì„±ê³µ: ${endpoint}`);
        return response;
    };

    console.log('ğŸ”§ API ì‹œë®¬ë ˆì´í„°ì— QRì½”ë“œ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ ì™„ë£Œ');
}

// ===== 12ë‹¨ê³„: ì°¨íŠ¸ ê°ì²´ ì´ˆê¸°í™” ë° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ =====

// ì°¨íŠ¸ ê°ì²´ ì´ˆê¸°í™” í™•ì¥
if (typeof charts === 'undefined') {
    charts = {};
}
charts.qrScanTrend = null;
charts.qrTypeDistribution = null;

// í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— QRì½”ë“œ ë²„íŠ¼ ì¶”ê°€
function addQRCodesTestButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('qr-codes-test-btn')) {
        const qrCodesTestBtn = document.createElement('button');
        qrCodesTestBtn.id = 'qr-codes-test-btn';
        qrCodesTestBtn.className = 'test-btn';
        qrCodesTestBtn.style.background = '#9b59b6';
        qrCodesTestBtn.innerHTML = 'ğŸ“± QRì½”ë“œ ê´€ë¦¬';
        qrCodesTestBtn.onclick = function() {
            showSection('qr-codes');
        };

        testPanel.insertBefore(qrCodesTestBtn, document.getElementById('api-status'));
        console.log('ğŸ“± QRì½”ë“œ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// ëœë¤ QR ìƒì„± ë²„íŠ¼ ì¶”ê°€
function addRandomQRButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('random-qr-btn')) {
        const randomQRBtn = document.createElement('button');
        randomQRBtn.id = 'random-qr-btn';
        randomQRBtn.className = 'test-btn';
        randomQRBtn.style.background = '#e67e22';
        randomQRBtn.innerHTML = 'ğŸ² ëœë¤ QR ìƒì„±';
        randomQRBtn.onclick = generateRandomQRCode;

        testPanel.insertBefore(randomQRBtn, document.getElementById('api-status'));
        console.log('ğŸ² ëœë¤ QR ìƒì„± ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// ===== 13ë‹¨ê³„: QRì½”ë“œ ì„¹ì…˜ ê°•ì œ í™œì„±í™” í•¨ìˆ˜ =====
function forceShowQRCodes() {
    console.log('ğŸ“± QRì½”ë“œ ì„¹ì…˜ ê°•ì œ í‘œì‹œ...');

    // í˜„ì¬ ì„¹ì…˜ì„ qr-codesë¡œ ë³€ê²½
    currentSection = 'qr-codes';

    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });

    // QRì½”ë“œ ì„¹ì…˜ë§Œ í‘œì‹œ
    const qrCodesSection = document.getElementById('qr-codes-section');
    if (qrCodesSection) {
        qrCodesSection.style.display = 'block';
        console.log('âœ… QRì½”ë“œ ì„¹ì…˜ í‘œì‹œë¨');
    }

    // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.textContent.includes('QRì½”ë“œ')) {
            item.classList.add('active');
        }
    });

    // í˜ì´ì§€ ì œëª© ë³€ê²½
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        pageTitle.textContent = 'QRì½”ë“œ ê´€ë¦¬';
    }

    // ê°•ì œë¡œ QRì½”ë“œ ë°ì´í„° ë¡œë“œ
    setTimeout(() => {
        loadQRCodesData();
    }, 500);

    showAlert('ğŸ“± QRì½”ë“œ ê´€ë¦¬ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™í–ˆìŠµë‹ˆë‹¤!', 'info');
}

// QRì½”ë“œ ë””ë²„ê¹… í•¨ìˆ˜
function debugQRCodesIssue() {
    console.log('ğŸ” QRì½”ë“œ ë¬¸ì œ ë””ë²„ê¹… ì‹œì‘...');

    // 1. ë°ì´í„° í™•ì¸
    const qrCodes = testDB.getData('qr_codes');
    console.log('ğŸ“Š í˜„ì¬ QRì½”ë“œ ë°ì´í„°:', qrCodes);

    // 2. DOM ìš”ì†Œ í™•ì¸
    const qrCodesSection = document.getElementById('qr-codes-section');
    const qrCodesGrid = document.getElementById('qr-codes-grid');

    console.log('ğŸ¯ DOM ìš”ì†Œ í™•ì¸:');
    console.log('â€¢ qr-codes-section:', qrCodesSection ? 'ì¡´ì¬' : 'ì—†ìŒ');
    console.log('â€¢ qr-codes-grid:', qrCodesGrid ? 'ì¡´ì¬' : 'ì—†ìŒ');

    // 3. ê°•ì œë¡œ QRì½”ë“œ ê·¸ë¦¬ë“œ ë Œë”ë§
    if (qrCodesGrid && qrCodes && qrCodes.length > 0) {
        console.log('ğŸ”§ ê°•ì œ QRì½”ë“œ ê·¸ë¦¬ë“œ ë Œë”ë§ ì‹œë„...');
        renderQRCodesGrid(qrCodes);
        updateQRCodesStats(qrCodes);
        loadQRCodesCharts(qrCodes);
        showAlert('ğŸ”§ QRì½”ë“œ ë°ì´í„° ê°•ì œ ë Œë”ë§ ì™„ë£Œ!', 'success');
    } else {
        console.error('âŒ QRì½”ë“œ ë°ì´í„° ë˜ëŠ” ê·¸ë¦¬ë“œ ìš”ì†Œ ë¬¸ì œ');
        if (!qrCodes || qrCodes.length === 0) {
            console.log('ğŸ“± QRì½”ë“œ ë°ì´í„° ê°•ì œ ìƒì„±...');
            initializeQRCodesTestData();
            setTimeout(() => {
                const newQRCodes = testDB.getData('qr_codes');
                if (newQRCodes && qrCodesGrid) {
                    renderQRCodesGrid(newQRCodes);
                    updateQRCodesStats(newQRCodes);
                    loadQRCodesCharts(newQRCodes);
                }
            }, 500);
        }
    }
}

// í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— QRì½”ë“œ ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€
function addQRCodesDebugButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('debug-qr-codes-btn')) {
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debug-qr-codes-btn';
        debugBtn.className = 'test-btn';
        debugBtn.style.background = '#6f42c1';
        debugBtn.innerHTML = 'ğŸ”§ QRì½”ë“œ ìˆ˜ì •';
        debugBtn.onclick = forceShowQRCodes;

        // API ìƒíƒœ ì „ì— ì¶”ê°€
        testPanel.insertBefore(debugBtn, document.getElementById('api-status'));

        console.log('ğŸ”§ QRì½”ë“œ ë””ë²„ê¹… ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// ===== 14ë‹¨ê³„: ì´ˆê¸°í™” ë° ì‹¤í–‰ =====

// QRì½”ë“œ ì„¹ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
function initializeQRCodesSection() {
    console.log('ğŸš€ QRì½”ë“œ ì„¹ì…˜ ì´ˆê¸°í™”...');

    // HTML êµ¬ì¡° í™•ì¸ ë° êµì²´
    setTimeout(() => {
        replaceQRCodesSection();

        // ë°ì´í„° í™•ì¸ ë° ì´ˆê¸°í™”
        setTimeout(() => {
            initializeQRCodesTestData();
        }, 500);

        // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
        setTimeout(() => {
            addQRCodesTestButton();
            addRandomQRButton();
            addQRCodesDebugButton();
        }, 1000);

    }, 200);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
setTimeout(() => {
    initializeQRCodesSection();

    // í˜„ì¬ QRì½”ë“œ ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì¦‰ì‹œ ë””ë²„ê¹…
    if (currentSection === 'qr-codes') {
        setTimeout(() => {
            debugQRCodesIssue();
        }, 2000);
    }
}, 2000);

// ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (í…ŒìŠ¤íŠ¸ìš©)
window.showQRCodes = forceShowQRCodes;
window.debugQRCodes = debugQRCodesIssue;
window.generateRandomQR = generateRandomQRCode;

console.log('âœ… ì™„ì „í•œ QRì½”ë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ!');
console.log('ğŸ“± QRì½”ë“œ ê´€ë¦¬ ê¸°ëŠ¥:');
console.log('â€¢ QRì½”ë“œ ìƒì„± í¼');
console.log('â€¢ ì‹¤ì‹œê°„ QRì½”ë“œ ê·¸ë¦¬ë“œ');
console.log('â€¢ ìœ í˜•ë³„/ìƒíƒœë³„ í•„í„°ë§');
console.log('â€¢ QRì½”ë“œ ìƒì„¸ ì •ë³´ ëª¨ë‹¬');
console.log('â€¢ QRì½”ë“œ ë‹¤ìš´ë¡œë“œ');
console.log('â€¢ ìƒíƒœ í™œì„±í™”/ë¹„í™œì„±í™”');
console.log('â€¢ QRì½”ë“œ ì‚­ì œ');
console.log('â€¢ ìŠ¤ìº” ì¶”ì´ ì°¨íŠ¸');
console.log('â€¢ ìœ í˜•ë³„ ë¶„í¬ ì°¨íŠ¸');
console.log('â€¢ ë°ì´í„° ë‚´ë³´ë‚´ê¸°');
console.log('â€¢ ëœë¤ QRì½”ë“œ ìƒì„±');
console.log('ğŸ“± í…ŒìŠ¤íŠ¸: ìš°ì¸¡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ "ğŸ“± QRì½”ë“œ ê´€ë¦¬", "ğŸ² ëœë¤ QR ìƒì„±", "ğŸ”§ QRì½”ë“œ ìˆ˜ì •" ë²„íŠ¼ í´ë¦­');
console.log('ğŸ¯ ë˜ëŠ” ì‚¬ì´ë“œë°”ì—ì„œ "QRì½”ë“œ ê´€ë¦¬" ë©”ë‰´ í´ë¦­');
console.log('ğŸ’¡ ë˜ëŠ” ì½˜ì†”ì—ì„œ showQRCodes() ì‹¤í–‰');

// ===== ì‹¤ì œ ë„ì„œ ì •ë³´ ê¸°ë°˜ ì •í™•í•œ ê¶Œìˆ˜ ì‹œìŠ¤í…œ =====

// 1ë‹¨ê³„: app.py ë¼ìš°í„° ê¸°ë°˜ ì‹¤ì œ ë„ì„œ ëª©ë¡ ìƒì„±
const ACTUAL_BOOKS_FROM_ROUTES = [
    // Level 2 ë„ì„œë“¤ (Magic Tree House ì‹œë¦¬ì¦ˆ 1-12)
    { route: '/magic-tree-house-1', title: "Dinosaurs Before Dark", level: 2, chapters: 10, series: "Magic Tree House #1" },
    { route: '/magic-tree-house-2', title: "The Knight at Dawn", level: 2, chapters: 10, series: "Magic Tree House #2" },
    { route: '/magic-tree-house-3', title: "Mummies in the Morning", level: 2, chapters: 10, series: "Magic Tree House #3" },
    { route: '/magic-tree-house-4', title: "Pirates Past Noon", level: 2, chapters: 10, series: "Magic Tree House #4" },
    { route: '/magic-tree-house-5', title: "Night of the Ninjas", level: 2, chapters: 10, series: "Magic Tree House #5" },
    { route: '/magic-tree-house-6', title: "Afternoon on the Amazon", level: 2, chapters: 10, series: "Magic Tree House #6" },
    { route: '/magic-tree-house-7', title: "Sunset of the Sabertooth", level: 2, chapters: 10, series: "Magic Tree House #7" },
    { route: '/magic-tree-house-8', title: "Midnight on the Moon", level: 2, chapters: 10, series: "Magic Tree House #8" },
    { route: '/magic-tree-house-9', title: "Dolphins at Daybreak", level: 2, chapters: 10, series: "Magic Tree House #9" },
    { route: '/magic-tree-house-10', title: "Ghost Town at Sundown", level: 2, chapters: 10, series: "Magic Tree House #10" },
    { route: '/magic-tree-house-11', title: "Lions at Lunchtime", level: 2, chapters: 10, series: "Magic Tree House #11" },
    { route: '/magic-tree-house-12', title: "Polar Bears Past Bedtime", level: 2, chapters: 10, series: "Magic Tree House #12" },

    // Level 3 ë„ì„œë“¤
    { route: '/charlottes-web', title: "Charlotte's Web", level: 3, chapters: 22, author: "E.B. White" },
    { route: '/sarah-plain-tall', title: "Sarah, Plain and Tall", level: 3, chapters: 9, author: "Patricia MacLachlan" },
    { route: '/narnia-1', title: "The Lion, the Witch and the Wardrobe", level: 3, chapters: 17, series: "Chronicles of Narnia #1" },
    { route: '/narnia-2', title: "Prince Caspian", level: 3, chapters: 15, series: "Chronicles of Narnia #2" },
    { route: '/narnia-3', title: "The Voyage of Dawn Treader", level: 3, chapters: 16, series: "Chronicles of Narnia #3" },
    { route: '/matilda', title: "Matilda", level: 3, chapters: 21, author: "Roald Dahl" },
    { route: '/bridge-to-terabithia', title: "Bridge to Terabithia", level: 3, chapters: 13, author: "Katherine Paterson" },
    { route: '/where-red-fern-grows', title: "Where the Red Fern Grows", level: 3, chapters: 20, author: "Wilson Rawls" },
    { route: '/magic-tree-house-13', title: "Vacation Under the Volcano", level: 3, chapters: 10, series: "Magic Tree House #13" },
    { route: '/magic-tree-house-14', title: "Day of the Dragon King", level: 3, chapters: 10, series: "Magic Tree House #14" },
    { route: '/magic-tree-house-15', title: "Viking Ships at Sunrise", level: 3, chapters: 10, series: "Magic Tree House #15" },
    { route: '/magic-tree-house-16', title: "Hour of the Olympics", level: 3, chapters: 10, series: "Magic Tree House #16" },
    { route: '/magic-tree-house-17', title: "Tonight on the Titanic", level: 3, chapters: 10, series: "Magic Tree House #17" },
    { route: '/magic-tree-house-18', title: "Buffalo Before Breakfast", level: 3, chapters: 10, series: "Magic Tree House #18" },
    { route: '/magic-tree-house-19', title: "Tigers at Twilight", level: 3, chapters: 10, series: "Magic Tree House #19" },
    { route: '/magic-tree-house-20', title: "Dingoes at Dinnertime", level: 3, chapters: 10, series: "Magic Tree House #20" },
    { route: '/magic-tree-house-21', title: "Civil War on Sunday", level: 3, chapters: 10, series: "Magic Tree House #21" }, // í…œí”Œë¦¿ì€ Level 3ë¡œ ë˜ì–´ ìˆìŒ

    // Level 4 ë„ì„œë“¤
    { route: '/magic-tree-house-22', title: "Revolutionary War on Wednesday", level: 4, chapters: 10, series: "Magic Tree House #22" },
    { route: '/magic-tree-house-23', title: "Twister on Tuesday", level: 4, chapters: 10, series: "Magic Tree House #23" },
    { route: '/shiloh', title: "Shiloh", level: 4, chapters: 20, author: "Phyllis Reynolds Naylor" },

    // Level 5 ë„ì„œë“¤
    { route: '/one-crazy-summer', title: "One Crazy Summer", level: 5, chapters: 12, author: "Rita Williams-Garcia" },
    { route: '/a-single-shard', title: "A Single Shard", level: 5, chapters: 13, author: "Linda Sue Park" },
    { route: '/flora-and-ulysses', title: "Flora and Ulysses", level: 5, chapters: 12, author: "Kate DiCamillo" }
];

// 2ë‹¨ê³„: ì •í™•í•œ ë„ì„œ í†µê³„ ê³„ì‚° í•¨ìˆ˜
function calculateAccurateBookStats() {
    console.log('ğŸ“š ì‹¤ì œ ë¼ìš°í„° ê¸°ë°˜ ì •í™•í•œ ë„ì„œ í†µê³„ ê³„ì‚° ì‹œì‘...');

    const stats = {
        total_books: ACTUAL_BOOKS_FROM_ROUTES.length,
        books_by_level: {
            1: 0, 2: 0, 3: 0, 4: 0, 5: 0
        },
        books_by_series: {},
        total_chapters: 0,
        magic_tree_house_count: 0,
        standalone_books_count: 0
    };

    // ë ˆë²¨ë³„ ë¶„í¬ ê³„ì‚°
    ACTUAL_BOOKS_FROM_ROUTES.forEach(book => {
        stats.books_by_level[book.level]++;
        stats.total_chapters += book.chapters;

        // ì‹œë¦¬ì¦ˆ ë¶„ë¥˜
        if (book.series) {
            if (book.series.includes('Magic Tree House')) {
                stats.magic_tree_house_count++;
            }

            const seriesName = book.series.split(' #')[0];
            if (!stats.books_by_series[seriesName]) {
                stats.books_by_series[seriesName] = 0;
            }
            stats.books_by_series[seriesName]++;
        } else {
            stats.standalone_books_count++;
        }
    });

    console.log('ğŸ“Š ì •í™•í•œ ë„ì„œ í†µê³„:', stats);
    return stats;
}

// 3ë‹¨ê³„: TestDatabaseì˜ ë„ì„œ ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´
if (typeof testDB !== 'undefined') {
    testDB.initializeAccurateBooks = function() {
        console.log('ğŸ“š ì‹¤ì œ ë„ì„œ ë°ì´í„°ë¡œ ì´ˆê¸°í™” ì‹œì‘...');

        // QR ì½”ë“œ ìƒì„± (ë¼ìš°í„° ê¸°ë°˜)
        const accurateBooks = ACTUAL_BOOKS_FROM_ROUTES.map((book, index) => {
            const qrCode = book.route.replace('/', '').replace(/-/g, '').toUpperCase();

            return {
                qr_code: qrCode + (index < 10 ? '0' + index : index),
                title: book.title,
                author: book.author || (book.series ? book.series.split(' #')[0] + ' Series' : 'Unknown Author'),
                level: book.level,
                chapters: book.chapters,
                series: book.series || null,
                route: book.route,
                students_count: 0,
                avg_accuracy: 0,
                completion_rate: 0,
                last_activity: null,
                created_date: new Date().toISOString(),
                is_active: true
            };
        });

        this.setData('books', accurateBooks);
        console.log(`âœ… ${accurateBooks.length}ê¶Œì˜ ì‹¤ì œ ë„ì„œ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ`);
        return accurateBooks;
    };

    // updateStats ë©”ì„œë“œë¥¼ ì‹¤ì œ ë„ì„œ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •
    testDB.updateStatsAccurate = function() {
        console.log('ğŸ“Š ì‹¤ì œ ë„ì„œ ê¸°ë°˜ í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘...');

        const stats = this.getData('stats') || {};
        const students = this.getData('students') || [];
        const activities = this.getData('activities') || [];

        // ì‹¤ì œ ë„ì„œ í†µê³„ ì‚¬ìš©
        const accurateBookStats = calculateAccurateBookStats();

        stats.total_books = accurateBookStats.total_books;
        stats.books_by_level = accurateBookStats.books_by_level;
        stats.total_chapters = accurateBookStats.total_chapters;
        stats.magic_tree_house_count = accurateBookStats.magic_tree_house_count;
        stats.standalone_books_count = accurateBookStats.standalone_books_count;
        stats.books_by_series = accurateBookStats.books_by_series;

        // í•™ìƒ í†µê³„
        const activeStudents = students.filter(s => s.status === 'active' || s.status === 'new');
        stats.total_students = activeStudents.length;

        // í™œë™ í†µê³„
        stats.total_sessions = activities.length;
        stats.avg_accuracy = activities.length > 0 ?
            Math.round(activities.reduce((sum, a) => sum + (a.accuracy || 0), 0) / activities.length) : 0;

        const completedActivities = activities.filter(a => (a.accuracy || 0) >= 80).length;
        stats.completion_rate = activities.length > 0 ?
            Math.round((completedActivities / activities.length) * 100) : 0;

        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const activeStudentsThisWeek = students.filter(s =>
            s.last_activity && new Date(s.last_activity) > weekAgo
        ).length;
        stats.participation_rate = students.length > 0 ?
            Math.round((activeStudentsThisWeek / students.length) * 100) : 0;

        this.setData('stats', stats);

        console.log('ğŸ“Š ì‹¤ì œ ê¸°ë°˜ í†µê³„ ì™„ë£Œ:', {
            ì´_ë„ì„œ: stats.total_books,
            ë ˆë²¨ë³„: stats.books_by_level,
            ë§¤ì§íŠ¸ë¦¬í•˜ìš°ìŠ¤: stats.magic_tree_house_count,
            ë…ë¦½ë„ì„œ: stats.standalone_books_count,
            ì´_ì±•í„°: stats.total_chapters
        });

        return stats;
    };
}

// 4ë‹¨ê³„: API ì‹œë®¬ë ˆì´í„°ì— ì •í™•í•œ ë„ì„œ ë°ì´í„° ì—°ë™
if (typeof apiSim !== 'undefined') {
    const originalSimulateAccurate = apiSim.simulate;

    apiSim.simulate = async function(endpoint, options = {}) {
        updateAPIStatus(`ğŸ“¡ API í˜¸ì¶œ: ${endpoint}`);
        await new Promise(resolve => setTimeout(resolve, this.baseDelay));

        if (Math.random() < this.errorRate) {
            updateAPIStatus(`âŒ API ì—ëŸ¬: ${endpoint}`);
            throw new Error(`API Error: ${endpoint} failed`);
        }

        let response;
        switch(endpoint) {
            case '/api/admin/dashboard/stats':
                // ì‹¤ì œ ë„ì„œ ìˆ˜ ê¸°ë°˜ í†µê³„ ì‚¬ìš©
                response = { success: true, data: testDB.updateStatsAccurate() };
                break;
            case '/api/admin/books':
                console.log('ğŸ“š ì‹¤ì œ ë„ì„œ API í˜¸ì¶œ...');
                let books = testDB.getData('books');

                // ë„ì„œ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¶€ì •í™•í•˜ë©´ ì‹¤ì œ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                if (!books || books.length !== ACTUAL_BOOKS_FROM_ROUTES.length) {
                    console.log('ğŸ“š ì‹¤ì œ ë„ì„œ ë°ì´í„°ë¡œ ì¬ì´ˆê¸°í™”...');
                    books = testDB.initializeAccurateBooks();

                    // í†µê³„ ì—…ë°ì´íŠ¸
                    if (testDB.updateBooksStats) {
                        books = testDB.updateBooksStats();
                    }
                }

                response = {
                    success: true,
                    data: books,
                    timestamp: new Date().toISOString(),
                    message: `ì‹¤ì œ ${books.length}ê¶Œ ë„ì„œ ë°ì´í„° (ë¼ìš°í„° ê¸°ë°˜)`
                };
                console.log('ğŸ“Š ì‹¤ì œ ë„ì„œ API ì‘ë‹µ:', response);
                break;
            default:
                // ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ë“¤ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                return originalSimulateAccurate.call(this, endpoint, options);
        }

        updateAPIStatus(`âœ… API ì„±ê³µ: ${endpoint}`);
        return response;
    };

    console.log('ğŸ”§ API ì‹œë®¬ë ˆì´í„°ì— ì •í™•í•œ ë„ì„œ ë°ì´í„° ì—°ë™ ì™„ë£Œ');
}

// 5ë‹¨ê³„: ëŒ€ì‹œë³´ë“œ í‘œì‹œ ê°œì„ 
function updateStatCardsWithRealData(data) {
    console.log('ğŸ“Š ì‹¤ì œ ë„ì„œ ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸:', data);

    // ê¸°ë³¸ í†µê³„ ì• ë‹ˆë©”ì´ì…˜
    animateCounter('total-students', data.total_students || 0);
    animateCounter('total-books', data.total_books || 0); // ì‹¤ì œ ë„ì„œ ìˆ˜
    animateCounter('total-sessions', data.total_sessions || 0);

    const avgAccuracy = data.avg_accuracy || 0;
    document.getElementById('avg-accuracy').textContent = avgAccuracy + '%';

    // ë„ì„œ ë³€í™” í‘œì‹œ ê°œì„ 
    const booksChange = document.getElementById('books-change');
    if (booksChange && data.books_by_level) {
        const levelInfo = Object.entries(data.books_by_level)
            .map(([level, count]) => `L${level}: ${count}ê¶Œ`)
            .join(', ');

        booksChange.innerHTML = `<span>ğŸ“š</span><span>${levelInfo}</span>`;
        booksChange.className = 'stat-change positive';
    }

    // ì¶”ê°€ ë„ì„œ ì •ë³´ í‘œì‹œ
    if (data.magic_tree_house_count) {
        console.log(`ğŸ“– Magic Tree House ì‹œë¦¬ì¦ˆ: ${data.magic_tree_house_count}ê¶Œ`);
        console.log(`ğŸ“– ë…ë¦½ ë„ì„œ: ${data.standalone_books_count}ê¶Œ`);
        console.log(`ğŸ“– ì´ ì±•í„°: ${data.total_chapters}ê°œ`);
    }

    updateChangeIndicators(data);
}

// 6ë‹¨ê³„: ì‹¤ì œ ë„ì„œ ì •ë³´ í™•ì¸ í•¨ìˆ˜
function verifyActualBookData() {
    console.log('ğŸ” ì‹¤ì œ ë„ì„œ ë°ì´í„° ê²€ì¦ ì‹œì‘...');

    const currentBooks = testDB.getData('books') || [];
    const actualCount = ACTUAL_BOOKS_FROM_ROUTES.length;

    console.log('ğŸ“Š ë„ì„œ ìˆ˜ ë¹„êµ:');
    console.log(`â€¢ ì‹¤ì œ ë¼ìš°í„° ê¸°ë°˜: ${actualCount}ê¶Œ`);
    console.log(`â€¢ í˜„ì¬ DB: ${currentBooks.length}ê¶Œ`);
    console.log(`â€¢ ì¼ì¹˜ ì—¬ë¶€: ${currentBooks.length === actualCount ? 'âœ… ì¼ì¹˜' : 'âŒ ë¶ˆì¼ì¹˜'}`);

    if (currentBooks.length !== actualCount) {
        console.log('ğŸ”§ ì‹¤ì œ ë°ì´í„°ë¡œ ë™ê¸°í™” í•„ìš”');
        testDB.initializeAccurateBooks();
        return false;
    }

    // ë ˆë²¨ë³„ ê²€ì¦
    const actualByLevel = calculateAccurateBookStats().books_by_level;
    const currentByLevel = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    currentBooks.forEach(book => {
        if (book.level >= 1 && book.level <= 5) {
            currentByLevel[book.level]++;
        }
    });

    console.log('ğŸ“Š ë ˆë²¨ë³„ ë¹„êµ:');
    for (let level = 1; level <= 5; level++) {
        const actual = actualByLevel[level];
        const current = currentByLevel[level];
        console.log(`â€¢ Level ${level}: ì‹¤ì œ ${actual}ê¶Œ, í˜„ì¬ ${current}ê¶Œ ${actual === current ? 'âœ…' : 'âŒ'}`);
    }

    return true;
}

// 7ë‹¨ê³„: ì´ˆê¸°í™” ë° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function initializeAccurateBookSystem() {
    console.log('ğŸš€ ì •í™•í•œ ë„ì„œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”...');

    // ì‹¤ì œ ë„ì„œ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
    if (typeof testDB !== 'undefined') {
        testDB.initializeAccurateBooks();

        // ê¸°ì¡´ updateStatCards í•¨ìˆ˜ë¥¼ ìƒˆë¡œìš´ í•¨ìˆ˜ë¡œ êµì²´
        if (typeof updateStatCards !== 'undefined') {
            window.originalUpdateStatCards = updateStatCards;
            window.updateStatCards = updateStatCardsWithRealData;
        }
    }

    // ê²€ì¦
    setTimeout(() => {
        verifyActualBookData();
    }, 1000);

    console.log('âœ… ì •í™•í•œ ë„ì„œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    showAlert(`ğŸ“š ì‹¤ì œ ë„ì„œ ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ ${ACTUAL_BOOKS_FROM_ROUTES.length}ê¶Œì˜ ë„ì„œê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`, 'success');
}

// 8ë‹¨ê³„: í…ŒìŠ¤íŠ¸ íŒ¨ë„ì— ë„ì„œ ë™ê¸°í™” ë²„íŠ¼ ì¶”ê°€
function addBookSyncButton() {
    const testPanel = document.getElementById('test-panel');
    if (testPanel && !document.getElementById('book-sync-btn')) {
        const bookSyncBtn = document.createElement('button');
        bookSyncBtn.id = 'book-sync-btn';
        bookSyncBtn.className = 'test-btn';
        bookSyncBtn.style.background = '#2ecc71';
        bookSyncBtn.innerHTML = 'ğŸ“š ë„ì„œ ë™ê¸°í™”';
        bookSyncBtn.onclick = function() {
            initializeAccurateBookSystem();
            setTimeout(() => loadDashboardData(), 1000);
        };

        testPanel.insertBefore(bookSyncBtn, document.getElementById('api-status'));

        // ë„ì„œ ê²€ì¦ ë²„íŠ¼ë„ ì¶”ê°€
        const verifyBtn = document.createElement('button');
        verifyBtn.id = 'book-verify-btn';
        verifyBtn.className = 'test-btn';
        verifyBtn.style.background = '#3498db';
        verifyBtn.innerHTML = 'ğŸ” ë„ì„œ ê²€ì¦';
        verifyBtn.onclick = verifyActualBookData;

        testPanel.insertBefore(verifyBtn, document.getElementById('api-status'));

        console.log('ğŸ“š ë„ì„œ ë™ê¸°í™” ë° ê²€ì¦ ë²„íŠ¼ ì¶”ê°€ë¨');
    }
}

// 9ë‹¨ê³„: ìë™ ì‹¤í–‰
setTimeout(() => {
    initializeAccurateBookSystem();
    addBookSyncButton();
}, 2000);

console.log('âœ… ì •í™•í•œ ë„ì„œ ê¶Œìˆ˜ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ!');
console.log(`ğŸ“š ì´ ${ACTUAL_BOOKS_FROM_ROUTES.length}ê¶Œì˜ ì‹¤ì œ ë„ì„œê°€ ì‹œìŠ¤í…œì— ë“±ë¡ë©ë‹ˆë‹¤:`);
console.log('â€¢ Level 2: 12ê¶Œ (Magic Tree House #1-12)');
console.log('â€¢ Level 3: 15ê¶Œ (ë‹¤ì–‘í•œ ê³ ì „ + Magic Tree House #13-21)');
console.log('â€¢ Level 4: 3ê¶Œ (Magic Tree House #22-23 + Shiloh)');
console.log('â€¢ Level 5: 3ê¶Œ (ê³ ê¸‰ ë¬¸í•™ ì‘í’ˆ)');
console.log('ğŸ”§ í…ŒìŠ¤íŠ¸: ìš°ì¸¡ íŒ¨ë„ "ğŸ“š ë„ì„œ ë™ê¸°í™”" ë²„íŠ¼ìœ¼ë¡œ ì‹¤ì œ ë°ì´í„° ì ìš©');
</script>
</body>
</html>

<!-- ===== ì‹œìŠ¤í…œ ì„¤ì • ì„¹ì…˜ ì™„ì „ êµ¬í˜„ ===== -->
<script>
// ===== 1ë‹¨ê³„: ì‹œìŠ¤í…œ ì„¤ì • ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ =====
function replaceSettingsSection() {
    console.log('âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì • ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì‹œì‘...');

    const settingsSection = document.getElementById('settings-section');
    if (settingsSection) {
        settingsSection.innerHTML = `
            <!-- ì‹œìŠ¤í…œ ì„¤ì • í†µê³„ ì¹´ë“œ -->
            <div class="dashboard-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="settings-reports-sent">0</div>
                            <div class="stat-label">ë°œì†¡ëœ ë¦¬í¬íŠ¸</div>
                        </div>
                        <div class="stat-icon sessions">ğŸ“§</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ“Š</span>
                        <span>ì´ ë°œì†¡ ìˆ˜</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="settings-last-report">-</div>
                            <div class="stat-label">ë§ˆì§€ë§‰ ë¦¬í¬íŠ¸</div>
                        </div>
                        <div class="stat-icon accuracy">ğŸ“…</div>
                    </div>
                    <div class="stat-change" id="last-report-status">
                        <span>ğŸ•’</span>
                        <span>ê³„ì‚° ì¤‘...</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="settings-subscribers">0</div>
                            <div class="stat-label">êµ¬ë…ì ìˆ˜</div>
                        </div>
                        <div class="stat-icon students">ğŸ‘¥</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸ“¬</span>
                        <span>í™œì„± êµ¬ë…ì</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="settings-next-report">-</div>
                            <div class="stat-label">ë‹¤ìŒ ë¦¬í¬íŠ¸</div>
                        </div>
                        <div class="stat-icon books">â°</div>
                    </div>
                    <div class="stat-change positive">
                        <span>ğŸš€</span>
                        <span>ìë™ ì˜ˆì•½</span>
                    </div>
                </div>
            </div>

            <!-- ì›” ë¦¬í¬íŠ¸ ì„¤ì • ì„¹ì…˜ -->
            <div class="data-table-section" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">ğŸ“§ ì›” ë¦¬í¬íŠ¸ ê´€ë¦¬</h3>
                    <div class="table-controls">
                        <button class="export-btn" onclick="generateTestReport()" style="background: #17a2b8;">
                            ğŸ“‹ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
                        </button>
                        <button class="export-btn" onclick="sendImmediateReport()" style="background: #28a745; margin-left: 10px;">
                            ğŸ“¤ ì¦‰ì‹œ ë°œì†¡
                        </button>
                    </div>
                </div>

                <div class="settings-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- ë¦¬í¬íŠ¸ ì„¤ì • -->
                    <div class="settings-card">
                        <h4 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ğŸ“Š ë¦¬í¬íŠ¸ ì„¤ì •
                        </h4>

                        <div class="form-group">
                            <label class="form-label">ë°œì†¡ ì£¼ê¸°</label>
                            <select id="report-frequency" class="form-select">
                                <option value="monthly" selected>ë§¤ì›” 1ì¼</option>
                                <option value="weekly">ë§¤ì£¼ ì›”ìš”ì¼</option>
                                <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ë¦¬í¬íŠ¸ ì œëª©</label>
                            <input type="text" id="report-title" class="form-input"
                                   value="ìˆ˜ë¦¬ë”©ì–´í•™ì› ì›”ê°„ í•™ìŠµ ë¦¬í¬íŠ¸" placeholder="ë¦¬í¬íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>

                        <div class="form-group">
                            <label class="form-label">í¬í•¨í•  ë°ì´í„°</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                    <input type="checkbox" id="include-students" checked> í•™ìƒ í˜„í™©
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                    <input type="checkbox" id="include-activities" checked> í•™ìŠµ í™œë™
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                    <input type="checkbox" id="include-books" checked> ë„ì„œ í†µê³„
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                                    <input type="checkbox" id="include-analytics" checked> ì„±ê³¼ ë¶„ì„
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ë¦¬í¬íŠ¸ í˜•ì‹</label>
                            <select id="report-format" class="form-select">
                                <option value="html" selected>HTML (ì´ë©”ì¼)</option>
                                <option value="pdf">PDF ì²¨ë¶€</option>
                                <option value="both">HTML + PDF</option>
                            </select>
                        </div>

                        <button onclick="saveReportSettings()" class="create-qr-btn" style="margin-top: 20px;">
                            ğŸ’¾ ì„¤ì • ì €ì¥
                        </button>
                    </div>

                    <!-- êµ¬ë…ì ê´€ë¦¬ -->
                    <div class="settings-card">
                        <h4 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ğŸ“¬ êµ¬ë…ì ê´€ë¦¬
                        </h4>

                        <div class="form-group">
                            <label class="form-label">ìƒˆ êµ¬ë…ì ì¶”ê°€</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="email" id="new-subscriber-email" class="form-input"
                                       placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="flex: 1;">
                                <button onclick="addSubscriber()" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; white-space: nowrap;">
                                    â• ì¶”ê°€
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">êµ¬ë…ì ëª©ë¡</label>
                            <div id="subscribers-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; background: #f8f9fa;">
                                <!-- êµ¬ë…ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ëŒ€ëŸ‰ ì¶”ê°€ (CSV)</label>
                            <input type="file" id="csv-upload" accept=".csv" class="form-input" onchange="uploadSubscriberCSV(event)">
                            <small style="color: #6c757d; font-size: 0.8rem;">CSV í˜•ì‹: email,name (ì„ íƒì‚¬í•­)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë¦¬í¬íŠ¸ ë°œì†¡ íˆìŠ¤í† ë¦¬ -->
            <div class="data-table-section">
                <div class="table-header">
                    <h3 class="table-title">ğŸ“ˆ ë¦¬í¬íŠ¸ ë°œì†¡ íˆìŠ¤í† ë¦¬</h3>
                    <div class="table-controls">
                        <select id="history-filter" onchange="filterReportHistory(this.value)" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-right: 15px;">
                            <option value="all">ì „ì²´ ê¸°ê°„</option>
                            <option value="month">ì´ë²ˆ ë‹¬</option>
                            <option value="quarter">ë¶„ê¸°</option>
                            <option value="year">ì˜¬í•´</option>
                        </select>
                        <button class="export-btn" onclick="exportReportHistory()">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                        <button class="refresh-btn" onclick="refreshReportHistory()" style="margin-left: 10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <!-- ë¡œë”© í‘œì‹œ -->
                <div id="report-history-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>ë¦¬í¬íŠ¸ íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                </div>

                <!-- ë¦¬í¬íŠ¸ íˆìŠ¤í† ë¦¬ í…Œì´ë¸” -->
                <table class="data-table" id="report-history-table">
                    <thead>
                        <tr>
                            <th>ë°œì†¡ ì¼ì‹œ</th>
                            <th>ë¦¬í¬íŠ¸ ìœ í˜•</th>
                            <th>ìˆ˜ì‹ ì ìˆ˜</th>
                            <th>ì„±ê³µ/ì‹¤íŒ¨</th>
                            <th>í¬í•¨ ë°ì´í„°</th>
                            <th>íŒŒì¼ í¬ê¸°</th>
                            <th>ë°œì†¡ ë°©ì‹</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="report-history-body">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #666; padding: 40px;">ë¦¬í¬íŠ¸ íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

        console.log('âœ… ì‹œìŠ¤í…œ ì„¤ì • ì„¹ì…˜ HTML êµ¬ì¡° êµì²´ ì™„ë£Œ');
        addSettingsCSS();
    } else {
        console.error('âŒ settings-section ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

// ===== 2ë‹¨ê³„: ì‹œìŠ¤í…œ ì„¤ì • ê´€ë ¨ CSS ì¶”ê°€ =====
function addSettingsCSS() {
    const style = document.createElement('style');
    style.textContent = `
        /* ì‹œìŠ¤í…œ ì„¤ì • ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .settings-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            position: relative;
        }

        .settings-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 12px 12px 0 0;
        }

        .subscriber-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .subscriber-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }

        .subscriber-email {
            font-weight: 500;
            color: #2c3e50;
        }

        .subscriber-actions {
            display: flex;
            gap: 5px;
        }

        .subscriber-btn {
            background: none;
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .subscriber-btn:hover {
            background: #f8f9fa;
        }

        .subscriber-btn.remove {
            color: #dc3545;
            border-color: #dc3545;
        }

        .subscriber-btn.remove:hover {
            background: #dc3545;
            color: white;
        }

        .report-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .report-status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .report-status-badge.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .report-status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .report-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .report-type-badge.monthly { background: #3498db; }
        .report-type-badge.weekly { background: #2ecc71; }
        .report-type-badge.manual { background: #f39c12; }
        .report-type-badge.test { background: #9b59b6; }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    `;
    document.head.appendChild(style);
}

// ===== 3ë‹¨ê³„: ì›” ë¦¬í¬íŠ¸ ë°ì´í„° ê´€ë¦¬ =====
function initializeReportSystem() {
    console.log('ğŸ“§ ì›” ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”...');

    // ë¦¬í¬íŠ¸ ì„¤ì • ê¸°ë³¸ê°’
    const defaultSettings = {
        frequency: 'monthly',
        title: 'ìˆ˜ë¦¬ë”©ì–´í•™ì› ì›”ê°„ í•™ìŠµ ë¦¬í¬íŠ¸',
        format: 'html',
        include: {
            students: true,
            activities: true,
            books: true,
            analytics: true
        },
        enabled: true
    };

    // êµ¬ë…ì ëª©ë¡ ê¸°ë³¸ê°’
    const defaultSubscribers = [
        { email: 'admin@sureading.com', name: 'ê´€ë¦¬ì', status: 'active', added_date: new Date().toISOString() },
        { email: 'director@sureading.com', name: 'ì›ì¥ë‹˜', status: 'active', added_date: new Date().toISOString() }
    ];

    // ë¦¬í¬íŠ¸ íˆìŠ¤í† ë¦¬ ê¸°ë³¸ê°’
    const defaultHistory = [
        {
            id: 1,
            sent_date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
            type: 'monthly',
            recipients: 2,
            success_count: 2,
            failed_count: 0,
            data_included: ['students', 'activities', 'books', 'analytics'],
            file_size: '2.3MB',
            method: 'auto',
            status: 'success'
        },
        {
            id: 2,
            sent_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
            type: 'test',
            recipients: 1,
            success_count: 1,
            failed_count: 0,
            data_included: ['students', 'activities'],
            file_size: '1.8MB',
            method: 'manual',
            status: 'success'
        }
    ];

    // ë°ì´í„° ì´ˆê¸°í™”
    if (!testDB.getData('report_settings')) {
        testDB.setData('report_settings', defaultSettings);
    }
    if (!testDB.getData('report_subscribers')) {
        testDB.setData('report_subscribers', defaultSubscribers);
    }
    if (!testDB.getData('report_history')) {
        testDB.setData('report_history', defaultHistory);
    }

    console.log('âœ… ì›” ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
}

// ===== 4ë‹¨ê³„: ë¦¬í¬íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤ =====
class MonthlyReportGenerator {
    static async generateReport(options = {}) {
        console.log('ğŸ“Š ì›” ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘...', options);

        try {
            // í•„ìš”í•œ ë°ì´í„° ìˆ˜ì§‘
            const reportData = await this.collectReportData(options);

            // ë¦¬í¬íŠ¸ HTML ìƒì„±
            const htmlContent = this.generateHTMLReport(reportData);

            // PDF ìƒì„± (ì˜µì…˜)
            let pdfContent = null;
            if (options.format === 'pdf' || options.format === 'both') {
                pdfContent = await this.generatePDFReport(reportData);
            }

            return {
                success: true,
                html: htmlContent,
                pdf: pdfContent,
                data: reportData,
                generated_at: new Date().toISOString()
            };

        } catch (error) {
            console.error('âŒ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
            return { success: false, error: error.message };
        }
    }

    static async collectReportData(options) {
        const data = {
            period: this.getCurrentPeriod(),
            generated_at: new Date().toISOString(),
            generator: 'í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì'
        };

        // í•™ìƒ í˜„í™©
        if (options.include?.students !== false) {
            const students = testDB.getData('students') || [];
            data.students = {
                total: students.length,
                active: students.filter(s => s.status === 'active').length,
                new_this_month: students.filter(s => this.isThisMonth(s.last_activity)).length,
                by_level: this.groupByLevel(students),
                top_performers: students
                    .sort((a, b) => (b.avg_accuracy || 0) - (a.avg_accuracy || 0))
                    .slice(0, 5)
            };
        }

        // í•™ìŠµ í™œë™
        if (options.include?.activities !== false) {
            const activities = testDB.getData('activities') || [];
            const thisMonthActivities = activities.filter(a => this.isThisMonth(a.completed_time));

            data.activities = {
                total_sessions: thisMonthActivities.length,
                avg_accuracy: this.calculateAverage(thisMonthActivities, 'accuracy'),
                total_study_time: thisMonthActivities.reduce((sum, a) => sum + (a.duration_minutes || 0), 0),
                completion_rate: this.calculateCompletionRate(thisMonthActivities),
                daily_breakdown: this.getDailyBreakdown(thisMonthActivities)
            };
        }

        // ë„ì„œ í†µê³„
        if (options.include?.books !== false) {
            const books = testDB.getData('books') || [];
            data.books = {
                total_books: books.length,
                most_popular: books
                    .sort((a, b) => (b.students_count || 0) - (a.students_count || 0))
                    .slice(0, 5),
                by_level: this.groupBooksByLevel(books),
                avg_completion_rate: this.calculateAverage(books, 'completion_rate')
            };
        }

        // ì„±ê³¼ ë¶„ì„
        if (options.include?.analytics !== false) {
            data.analytics = {
                growth_rate: this.calculateGrowthRate(),
                retention_rate: this.calculateRetentionRate(),
                satisfaction_score: this.calculateSatisfactionScore(),
                key_insights: this.generateInsights(data)
            };
        }

        return data;
    }

    static generateHTMLReport(data) {
        return `
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${data.period} ìˆ˜ë¦¬ë”©ì–´í•™ì› ì›”ê°„ ë¦¬í¬íŠ¸</title>
                <style>
                    body { font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 20px; background: #f8f9fa; }
                    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
                    .header { background: linear-gradient(135deg, #3498db, #2ecc71); color: white; padding: 30px; text-align: center; }
                    .header h1 { margin: 0; font-size: 2rem; }
                    .header p { margin: 10px 0 0; opacity: 0.9; }
                    .content { padding: 30px; }
                    .section { margin-bottom: 30px; }
                    .section h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
                    .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #3498db; }
                    .stat-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
                    .stat-label { color: #6c757d; font-size: 0.9rem; }
                    .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                    .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
                    .table th { background: #f8f9fa; font-weight: 600; }
                    .footer { background: #2c3e50; color: white; padding: 20px; text-align: center; font-size: 0.9rem; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>ğŸ“š ìˆ˜ë¦¬ë”©ì–´í•™ì› ì›”ê°„ ë¦¬í¬íŠ¸</h1>
                        <p>${data.period} | ìƒì„±ì¼: ${formatDate(data.generated_at)}</p>
                    </div>

                    <div class="content">
                        ${this.generateStudentsSection(data.students)}
                        ${this.generateActivitiesSection(data.activities)}
                        ${this.generateBooksSection(data.books)}
                        ${this.generateAnalyticsSection(data.analytics)}
                    </div>

                    <div class="footer">
                        <p>ìˆ˜ë¦¬ë”©ì–´í•™ì› ê´€ë¦¬ì ì‹œìŠ¤í…œì—ì„œ ìë™ ìƒì„±ëœ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.</p>
                        <p>ë¬¸ì˜ì‚¬í•­: admin@sureading.com | ìƒì„±ì: ${data.generator}</p>
                    </div>
                </div>
            </body>
            </html>
        `;
    }

    // í—¬í¼ ë©”ì„œë“œë“¤
    static getCurrentPeriod() {
        const now = new Date();
        return `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›”`;
    }

    static isThisMonth(dateString) {
        if (!dateString) return false;
        const date = new Date(dateString);
        const now = new Date();
        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
    }

    static calculateAverage(array, field) {
        if (array.length === 0) return 0;
        const sum = array.reduce((total, item) => total + (item[field] || 0), 0);
        return Math.round(sum / array.length);
    }

    static calculateCompletionRate(activities) {
        if (activities.length === 0) return 0;
        const completed = activities.filter(a => (a.accuracy || 0) >= 80).length;
        return Math.round((completed / activities.length) * 100);
    }

    static groupByLevel(students) {
        const groups = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        students.forEach(student => {
            if (student.level >= 1 && student.level <= 5) {
                groups[student.level]++;
            }
        });
        return groups;
    }

    static generateStudentsSection(students) {
        if (!students) return '';

        return `
            <div class="section">
                <h2>ğŸ‘¥ í•™ìƒ í˜„í™©</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${students.total}</div>
                        <div class="stat-label">ì´ í•™ìƒ ìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${students.active}</div>
                        <div class="stat-label">í™œì„± í•™ìƒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${students.new_this_month}</div>
                        <div class="stat-label">ì´ë²ˆ ë‹¬ ì‹ ê·œ</div>
                    </div>
                </div>
            </div>
        `;
    }

    static generateActivitiesSection(activities) {
        if (!activities) return '';

        return `
            <div class="section">
                <h2>ğŸ“– í•™ìŠµ í™œë™</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${activities.total_sessions}</div>
                        <div class="stat-label">ì´ ì„¸ì…˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${activities.avg_accuracy}%</div>
                        <div class="stat-label">í‰ê·  ì •ë‹µë¥ </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round(activities.total_study_time / 60)}h</div>
                        <div class="stat-label">ì´ í•™ìŠµì‹œê°„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${activities.completion_rate}%</div>
                        <div class="stat-label">ì™„ë£Œìœ¨</div>
                    </div>
                </div>
            </div>
        `;
    }

    static generateBooksSection(books) {
        if (!books) return '';

        return `
            <div class="section">
                <h2>ğŸ“š ë„ì„œ í†µê³„</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${books.total_books}</div>
                        <div class="stat-label">ë“±ë¡ ë„ì„œ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${books.avg_completion_rate}%</div>
                        <div class="stat-label">í‰ê·  ì™„ë£Œìœ¨</div>
                    </div>
                </div>
            </div>
        `;
    }

    static generateAnalyticsSection(analytics) {
        if (!analytics) return '';

        return `
            <div class="section">
                <h2>ğŸ“Š ì„±ê³¼ ë¶„ì„</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${analytics.retention_rate}%</div>
                        <div class="stat-label">ì¬ë“±ë¡ë¥ </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${analytics.satisfaction_score}</div>
                        <div class="stat-label">ë§Œì¡±ë„</div>
                    </div>
                </div>
            </div>
        `;
    }
}

// ===== 5ë‹¨ê³„: ì´ë©”ì¼ ë°œì†¡ ë° UI ì¸í„°ë™ì…˜ =====

// ì‹œìŠ¤í…œ ì„¤ì • ë°ì´í„° ë¡œë“œ
async function loadSettingsData() {
    if (document.getElementById('settings-section').style.display === 'none') return;

    console.log('âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì • ë°ì´í„° ë¡œë“œ ì‹œì‘...');

    try {
        // ë¦¬í¬íŠ¸ ì„¤ì • ë¡œë“œ
        const settings = testDB.getData('report_settings') || {};
        const subscribers = testDB.getData('report_subscribers') || [];
        const history = testDB.getData('report_history') || [];

        // í†µê³„ ì—…ë°ì´íŠ¸
        updateSettingsStats(settings, subscribers, history);

        // UI ì—…ë°ì´íŠ¸
        updateSettingsUI(settings);
        renderSubscribersList(subscribers);
        renderReportHistory(history);

    } catch (error) {
        console.error('âŒ ì‹œìŠ¤í…œ ì„¤ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ì‹œìŠ¤í…œ ì„¤ì • ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

function updateSettingsStats(settings, subscribers, history) {
    // ë°œì†¡ëœ ë¦¬í¬íŠ¸ ìˆ˜
    const sentReports = history.filter(h => h.status === 'success').length;
    animateCounter('settings-reports-sent', sentReports);

    // êµ¬ë…ì ìˆ˜
    const activeSubscribers = subscribers.filter(s => s.status === 'active').length;
    animateCounter('settings-subscribers', activeSubscribers);

    // ë§ˆì§€ë§‰ ë¦¬í¬íŠ¸
    const lastReport = history.length > 0 ? history[0] : null;
    if (lastReport) {
        document.getElementById('settings-last-report').textContent = formatRelativeTime(lastReport.sent_date);

        const statusEl = document.getElementById('last-report-status');
        if (lastReport.status === 'success') {
            statusEl.innerHTML = '<span>âœ…</span><span>ì„±ê³µì ìœ¼ë¡œ ë°œì†¡</span>';
            statusEl.className = 'stat-change positive';
        } else {
            statusEl.innerHTML = '<span>âŒ</span><span>ë°œì†¡ ì‹¤íŒ¨</span>';
            statusEl.className = 'stat-change negative';
        }
    }

    // ë‹¤ìŒ ë¦¬í¬íŠ¸ ì˜ˆì •ì¼
    const nextReport = calculateNextReportDate(settings.frequency);
    document.getElementById('settings-next-report').textContent = nextReport;
}

function calculateNextReportDate(frequency) {
    const now = new Date();
    let next;

    switch (frequency) {
        case 'monthly':
            next = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            break;
        case 'weekly':
            next = new Date(now);
            next.setDate(now.getDate() + (8 - now.getDay()) % 7);
            break;
        default:
            return 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
    }

    return next.toLocaleDateString('ko-KR');
}

// êµ¬ë…ì ê´€ë¦¬ í•¨ìˆ˜ë“¤
function addSubscriber() {
    const emailInput = document.getElementById('new-subscriber-email');
    const email = emailInput.value.trim();

    if (!email) {
        showAlert('ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    if (!InputValidator.validateEmail(email)) {
        showAlert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.', 'warning');
        return;
    }

    const subscribers = testDB.getData('report_subscribers') || [];

    // ì¤‘ë³µ í™•ì¸
    if (subscribers.some(s => s.email === email)) {
        showAlert('ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.', 'warning');
        return;
    }

    // ìƒˆ êµ¬ë…ì ì¶”ê°€
    const newSubscriber = {
        email: email,
        name: email.split('@')[0],
        status: 'active',
        added_date: new Date().toISOString()
    };

    subscribers.push(newSubscriber);
    testDB.setData('report_subscribers', subscribers);

    emailInput.value = '';
    renderSubscribersList(subscribers);
    updateSettingsStats(testDB.getData('report_settings'), subscribers, testDB.getData('report_history'));

    showAlert(`âœ… ${email}ì´ êµ¬ë…ìë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
}

function removeSubscriber(email) {
    if (confirm(`${email}ì„ êµ¬ë…ì ëª©ë¡ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        const subscribers = testDB.getData('report_subscribers') || [];
        const filteredSubscribers = subscribers.filter(s => s.email !== email);

        testDB.setData('report_subscribers', filteredSubscribers);
        renderSubscribersList(filteredSubscribers);
        updateSettingsStats(testDB.getData('report_settings'), filteredSubscribers, testDB.getData('report_history'));

        showAlert(`âŒ ${email}ì´ êµ¬ë…ì ëª©ë¡ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
    }
}

function renderSubscribersList(subscribers) {
    const listEl = document.getElementById('subscribers-list');
    if (!listEl) return;

    if (subscribers.length === 0) {
        listEl.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">ë“±ë¡ëœ êµ¬ë…ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    listEl.innerHTML = subscribers.map(subscriber => `
        <div class="subscriber-item">
            <div>
                <div class="subscriber-email">${subscriber.email}</div>
                <small style="color: #6c757d;">${formatRelativeTime(subscriber.added_date)} ì¶”ê°€</small>
            </div>
            <div class="subscriber-actions">
                <button class="subscriber-btn remove" onclick="removeSubscriber('${subscriber.email}')" title="ì œê±°">
                    ğŸ—‘ï¸
                </button>
            </div>
        </div>
    `).join('');
}

// ë¦¬í¬íŠ¸ ìƒì„± ë° ë°œì†¡ í•¨ìˆ˜ë“¤
async function generateTestReport() {
    console.log('ğŸ“‹ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘...');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ìƒì„± ì¤‘...';
    btn.disabled = true;

    try {
        const settings = testDB.getData('report_settings') || {};
        const report = await MonthlyReportGenerator.generateReport({
            format: settings.format || 'html',
            include: settings.include || { students: true, activities: true, books: true, analytics: true }
        });

        if (report.success) {
            // ìƒˆ ì°½ì—ì„œ ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(report.html);
            previewWindow.document.close();

            showAlert('ğŸ“‹ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ìƒˆ ì°½ì—ì„œ í™•ì¸í•˜ì„¸ìš”.', 'success');
        } else {
            throw new Error(report.error);
        }

    } catch (error) {
        console.error('âŒ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        showAlert(`í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }
}

async function sendImmediateReport() {
    console.log('ğŸ“¤ ì¦‰ì‹œ ë¦¬í¬íŠ¸ ë°œì†¡ ì‹œì‘...');

    const subscribers = testDB.getData('report_subscribers') || [];
    const activeSubscribers = subscribers.filter(s => s.status === 'active');

    if (activeSubscribers.length === 0) {
        showAlert('ë°œì†¡í•  êµ¬ë…ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € êµ¬ë…ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    if (!confirm(`${activeSubscribers.length}ëª…ì˜ êµ¬ë…ìì—ê²Œ ë¦¬í¬íŠ¸ë¥¼ ì¦‰ì‹œ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'ğŸ“¤ ë°œì†¡ ì¤‘...';
    btn.disabled = true;

    try {
        const settings = testDB.getData('report_settings') || {};

        // ë¦¬í¬íŠ¸ ìƒì„±
        const report = await MonthlyReportGenerator.generateReport({
            format: settings.format || 'html',
            include: settings.include || { students: true, activities: true, books: true, analytics: true }
        });

        if (!report.success) {
            throw new Error('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ' + report.error);
        }

        // ì´ë©”ì¼ ë°œì†¡ (ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œ API í˜¸ì¶œ)
        const emailData = {
            recipients: activeSubscribers.map(s => s.email),
            subject: settings.title || 'ìˆ˜ë¦¬ë”©ì–´í•™ì› ì›”ê°„ í•™ìŠµ ë¦¬í¬íŠ¸',
            html_content: report.html,
            pdf_attachment: report.pdf,
            sender_name: 'ìˆ˜ë¦¬ë”©ì–´í•™ì› ê´€ë¦¬ì'
        };

        // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì´ ë¶€ë¶„ì´ ì‹¤ì œ API í˜¸ì¶œ
        const sendResult = await simulateEmailSending(emailData);

        // ë°œì†¡ íˆìŠ¤í† ë¦¬ ì €ì¥
        const history = testDB.getData('report_history') || [];
        history.unshift({
            id: history.length + 1,
            sent_date: new Date().toISOString(),
            type: 'manual',
            recipients: activeSubscribers.length,
            success_count: sendResult.success_count,
            failed_count: sendResult.failed_count,
            data_included: Object.keys(settings.include || {}).filter(key => settings.include[key]),
            file_size: '2.1MB',
            method: 'manual',
            status: sendResult.failed_count === 0 ? 'success' : 'partial'
        });

        testDB.setData('report_history', history);

        showAlert(`ğŸ“¤ ë¦¬í¬íŠ¸ ë°œì†¡ ì™„ë£Œ!\nì„±ê³µ: ${sendResult.success_count}ëª…\nì‹¤íŒ¨: ${sendResult.failed_count}ëª…`, 'success');

        // UI ìƒˆë¡œê³ ì¹¨
        setTimeout(() => loadSettingsData(), 1000);

    } catch (error) {
        console.error('âŒ ë¦¬í¬íŠ¸ ë°œì†¡ ì‹¤íŒ¨:', error);
        showAlert(`ë¦¬í¬íŠ¸ ë°œì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }
}

// ì´ë©”ì¼ ë°œì†¡ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬)
async function simulateEmailSending(emailData) {
    console.log('ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì‹œë®¬ë ˆì´ì…˜...', emailData);

    // ë°œì†¡ ì‹œë®¬ë ˆì´ì…˜ (2-3ì´ˆ ì†Œìš”)
    await new Promise(resolve => setTimeout(resolve, 2500));

    // 90% ì„±ê³µë¥ ë¡œ ì‹œë®¬ë ˆì´ì…˜
    const successRate = 0.9;
    const successCount = Math.floor(emailData.recipients.length * successRate);
    const failedCount = emailData.recipients.length - successCount;

    return {
        success_count: successCount,
        failed_count: failedCount,
        total_sent: emailData.recipients.length
    };
}

// ì„¤ì • ì €ì¥ í•¨ìˆ˜
function saveReportSettings() {
    const settings = {
        frequency: document.getElementById('report-frequency').value,
        title: document.getElementById('report-title').value,
        format: document.getElementById('report-format').value,
        include: {
            students: document.getElementById('include-students').checked,
            activities: document.getElementById('include-activities').checked,
            books: document.getElementById('include-books').checked,
            analytics: document.getElementById('include-analytics').checked
        },
        enabled: true
    };

    testDB.setData('report_settings', settings);
    showAlert('ğŸ’¾ ë¦¬í¬íŠ¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// loadSectionDataì— settings ì¼€ì´ìŠ¤ ì¶”ê°€
const originalLoadSectionDataSettings = loadSectionData;
loadSectionData = function(sectionName) {
    switch(sectionName) {
        case 'settings':
            loadSettingsData(); // âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì • ë¡œë“œ ì¶”ê°€
            break;
        default:
            if (originalLoadSectionDataSettings) {
                originalLoadSectionDataSettings(sectionName);
            }
    }
};

// ì´ˆê¸°í™”
setTimeout(() => {
    replaceSettingsSection();
    initializeReportSystem();
}, 2500);

console.log('âœ… ì›” ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ!');
console.log('ğŸ“§ ê¸°ëŠ¥: ì›”ê°„ ë¦¬í¬íŠ¸ ìë™ ìƒì„±, ì´ë©”ì¼ ë°œì†¡, êµ¬ë…ì ê´€ë¦¬, ë°œì†¡ íˆìŠ¤í† ë¦¬');
</script>
